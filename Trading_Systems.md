Trading Systems
A new approach to system development and
portfolio optimisation


# Part I: 交易系统开发&评估实践指导

## Chapter 1: 什么是交易系统?

交易系统就是一个自动定义入场点和出场点的, 不包含任何人为介入因素的规则集合.
因为交易规则并没有定义交易时间和交易地点, 这样使得交易系统是静态可测试的.
通过历史数据, 我们可以在一定程度上计算交易系统的可信度.
如果我们向已有规则中添加资金管理规则和投资组合规则, 我们就拥有了一个交易策略, 或者换句话说, 就是对市场进行完全自动化模拟.

我们提到的资金管理并不是我们通常认为的风险管理, 而是如何去止损和止盈.

### 1.1 简易交易系统示例

* 入场规则
  买入2份最近20天内价格创最高的合约;
  卖空2份最近20天内价格创新低的合约;
* 离场规则
  如果 marketposition = 1, 那么在最接近 avgtruerange(14) 的价位卖出平仓;
  如果 marketposition = -1, 那么在最接近 avgtruerange(14) 的价位买入平仓.

quantitative traders 量化交易者

### 1.2 为什么你需要交易系统

统计结果毫无疑问地表明只有百分之几的交易者能够年复一年地打败市场.大部分是私人和机构交易者迟早会破产.如果你不属于幸运的随意交易者, 那么为了生存, 唯一的选择就是使用交易系统.如果你购买了这本书, 你很可能并不是一个成功的自由交易者.按照我的经验, 成功的自主交易者拥有天生的直觉, 能够依靠本能预测市场动向.与之对应的是, 有许多成功的基金经理, 机构和私募交易者利用预设的交易策略和投资方法获利.如果有人认为交易系统可以很容易地战胜所有的交易中的阻碍, 那么这是对交易系统的一种误解.一方面交易系统可以帮助交易者击败市场, 另一方面它也会引入一些新的问题.

首先, 如果交易者在勇气方面有些问题, 面对机会时没有足够的魄力及时行事.这种情况下交易系统并非一个完美的解决方案.正如 Larry Williams 所说, "trading systems work, system traders do not".对应一个有系统的交易者而言, 没有什么比忽略交易信号更大的恶行, Bill Eckhardt 写到：

*如果你做了一笔坏交易, 你还有资金管理, 你还有一大堆东西能够帮助你, 做一笔坏交易真的没有你想的这么严重.但是, 如果你错过了一笔好的交易, 不要找任何理由.如果你遇到了一笔注定盈利的交易, 而你却错过了它, 你注定会在这个游戏中完蛋.*

其次, 为了信任交易系统, 特别是在利润回撤抹去交易者对交易系统能力的信心时, 一定要做大量的研究和统计工作, 这并不是每个人都能够做到的.开发, 实施, 测试和评估一个交易系统并不是一个简单的事情.

最后, 影响自由交易的许多因素同样影响着系统性交易, 例如 缺乏足够的启动资金, 投资组合多样化的可能性, 全职, 24小时, 敬业.

更重要的是, 我们可以说做交易并不像在一个理性的企业工作, 你做出计划, 得出结论, 一切可以用逻辑的方式来解释. 恐惧和贪婪用一种大脑无法掌控的方式操纵价格. 当然有一些幸运交易者可以凭直觉地打败市场, 但在这些情况下, 他们并不能清晰的解释他们为什么买或卖. 如果这一切都是真的, 意味着你需要一个不理智和不合逻辑的工具来进入和退出市场, 这东西不能让你完全理解, 而且违反直觉. 通常情况下, 那些你认为是不合逻辑的, 或者只会导致失败的信号会让你成为赢家.

使用机械的交易系统意味着你需要放弃自己持有的关于金融的信念, 放弃所有让你"感觉良好"的交易方式：通常每个人买入下跌中的合约会感觉良好, 买入价格创新高的合约则会感觉不舒服, 但有很大概率是后者的方法更好. 测试交易系统, 意味着数字的野蛮力量将会强加于你, 让你感觉倍受约束. 成为一名完全机械的交易者意味着与自己搏斗. 这是赢利的唯一途径, 除非你是一个幸运的劫匪, 日复一日地赚钱, 但却不知道如何赚钱.

### 1.3 交易系统的相关知识

主观技术分析(subjective technical analysis)和客观技术分析(objective technical analysis)之间有很大的区别.

客观的技术分析方法是定义清晰的, 可重复的, 能够产生明确交易信号的过程.这使得它们可以用计算机程序来实现, 并且可以使用历史数据做回测. 同时, 回测产生的结果可以通过严格的评估来做定量分析.主观技术分析方法没有明确的分析过程.由于其天生的模糊性, 必须依赖分析师的私人解释.这种特性妨碍了电脑化, 回测和客观的性能评估.换句话说, 我们没有方法能确认或否定主观方法的功效.因为这个原因, 他们很难被证实是有效的.

因为其模糊性和缺乏科学的方法, 主观技术分析在学术圈和严肃的市场从业人员中并没有获得良好的声誉. 要成为一个图表或技术分析师, 而不是投资组合经理, 有一套个人的技术分析绝活可能是金融业中最好的跳板.关于为什么人们会相信奇怪的东西, 如教条, 信仰, 神话和轶事, 已经有很多的社会学和心理学的文献来解释, 同样这也是使用科学方法推导反而更容易错过好的科学技术分析的原因. 当然, 我并不是要在这里讲授关于科学哲学, 我只是想简要提醒读者什么是科学知识.科学知识是经验的, 是基于对现实的观察：

*技术分析的实质是统计推断.它试图从历史数据中归纳出模式, 规则等形式并进行概括, 然后推断他们的未来.*

因此, 技术分析利用统计推断工具, 从单个样本开始观察, 目的是评估整个人群的统计学属性. 通过这种方式, 技术分析是可以量化的, 就像统计学一样.此外, 技术分析和科学一样, 试图通过变量之间的函数关系来预测未来. 如果一个变量变了, 那么因变量会随之变化.技术分析中的规则对应统计学中的函数, 这里函数是有一定概率的.科学技术分析和统计学之间没有任何障碍, 那些不喜欢主观技术分析的人提出的疑惑突然消失了.定量技术分析借用了应用科学中的典型分析方法：由牛顿发起并由波普尔推广的假设 - 演绎方法.该假设演绎法有五个阶段：
1.观察.系统开发人员, 通过持续观察金融市场上的日内波动及日间波动, 设计变量之间的关系, 例如当天交易量和收盘价之间的关联, 或者指数和第二天开盘价之间的关联.
2.假设.假设来自系统开发人员的创新思维 - 一个智力火花, 其中的起源无法得知.系统开发人员必须清晰的知道他的假设不是来源于分析样本的特殊性, 而是从全部数据中推演出来, 对其中的大部分数据都是适用的.
3.预测.如果这种关系是真的, 那么可以依据假设来构建一个条件命题或一个预测, "如果这个假设确实是真实的, 预测将准确的告诉我们可以在新的集合中观察到什么".
4.验证.系统开发人员验证预测在新集合中是否成立.
5.结论.系统开发人员, 通过使用统计推断工具(例如信任区间和假设测试), 将通过衡量实际观察结果与预测是否一致, 确认假设是否成立.
这个过程与化学或生物学等应用科学中用到的科学评估方法没有任何区别.

## Chapter 2: 设计, 测试, 优化和评估一个交易系统 

### 2.1 设计

交易系统从一个像创业愿景一样的想法开始. 创新是介于创意和幻想之间的一类东西, 但是想法能否成为现实则取决于你为它奉献了多少时间. 有些系统交易员说一个关于交易系统的好主意是在你最不期待的时候出现的, 但是与优秀交易者聊天很好会有些帮助, 强烈建议你参加研讨会, 大会和专业交易者之间的聚会.即使能够亲眼看到自由交易如何交易也是有用的.不幸的是, 创新并没有确定的道路, 但下面是
提示可以促使你走出想象的边界.

#### 开始

书单：
1.Traders www.traders-mag.co.uk
2.Active Trader www.activetradermag.com
3.Futures www.futuresmag.com
4.The Technical Analyst www.technicalanalyst.co.uk
5.Technical Analysis of Stocks & Commodities www.traders.com

TradeStation 论坛
"System Traders and Development Club" (STAD)

#### 编程目标

一个系统由一个入场公式, 一个离场公式和一个资金管理公式组成. 离场公式与 "风险管理" 有关, 即初始止损, 移动止损, 目标退出, 通俗一点来讲就是我们承担多少风险以及在每一笔交易如何承担风险. "资金管理"关心的是我们在每笔交易中投资多少, 就是我们买或卖多少股票或期货合约. 系统交易的初学者不愿意相信的是, 只要积极地使用杠杆和资金管理技术, 回报就会是惊人的, 换句话来说, 如果没有合适的资金和风险管理工具, 即使交易系统优秀的令人屏息, 也不会成为可行的投资工具.

#### 交易时机

期货价格系列没有任何问题, 股票要考虑回购, 分红, 增发

### 2.2 测试

#### 市场数据的重要性

#### 回测时间长度

文献指出, 一个交易系统为了确保健壮性和一致性, 必须在多时段多市场测试(multi-period multi-market test)中达到一定的成功率.
一些机械交易者(mechanical traders)声称, 支持多市场的交易规则是不存在的, 因为交易系统有自己的个性, 交易系统只能适合部分而非全部市场.如果多市场测试是指在许多不同的市场 (债券, 股票, 商品, 货币, 股票, 等等) 中表现的都一样好, 从这个角度来讲, 能够通过多市场测试的系统确实很少.我们与这些交易者看法一致 - 不过, 经过20年的不断尝试, 今天的我们称得上是屈指可数的真正多市场交易系统之一.

反过来说, 正因为多周期测试是令人厌恶的, 机械交易者才认为过去只能是过去(意思是对未来并没有指导意义)：市场是随着经济结构和社会的变化而不断变化的.为什么会认为市场是一成不变呢？很多使用日内交易系统的系统交易者的绝不会用12个月之前的数据做回测, 甚至有些只用3个月内的数据.

我们认为, 回测周期的长度由长期交易中形成的智慧决定.举个例子, 一支银行股的价格是波动的, 在2000年的泡沫期间, 这家银行突然与一家网上银行合并.那么在2001年, 使用之前的交易系统进行测试是不合适的, 因为股票的走势已经因为合并而改变了.所以严肃的交易者会去掉非正常环境下的数据, 比如说 1999-2000 的股市泡沫, 或者是2008年的原油危机.每个系统在波动巨大的时候都是有效的(意思是单向趋势), 但是只有一个稳健的系统才能在正常情况下始终保持稳定工作.不正常的情况时有发生, 我们知道将会面对它们, 然而市场在80%的时间中都是正常的, 当它变得疯狂导致风险太高时, 一个好的系统能够感知到.

#### 规则复杂度和自由度

多市场测试的首要目标是检查一个系统是否按照预期的方式执行(如果手动测试, 系统发出的信号与程序员想要的信号位于同一位置), 并且当它们应用到市场上是否有利可图.我们不应该期望系统在我们测试的每个市场上都能盈利, 但能够盈利市场越多, 系统就越优秀.

测试可以对系统在统计学上的有效性进行初步验证, 而优化则是关注市场的特定行为特征, 并以此为依据对系统进行微调.尽管这只是一个不完全的定义, 但它有助于澄清为什么优化是在测试后进行 - 此时我们已经确认系统是可运行的.

通常的结果是, 一个系统在相似的合约上都是有利可图的; 换句话说, 例如, 在所有的能源期货上, 它们的表现都是一样的, 但在完全不同的债券市场上表现会差一些, 而在货币市场上则表现平平.

测试系统时最重要的是测试窗口大小的选择; 也就是说, 我们需要将系统应用到什么样的价格序列.这个决定并不遵循明确的时间表或经验法则, 而是需要遵守两个统计要求：价格系列必须足够长才能囊括不同的市场走势, 并随之产生大量的交易信号.

变量的数量和它们消耗的数据, 一般被认为也和整个数据样本相关, 这种相关关系我们称之为 **自由度** -- 也就是说, 变量和条件的数量和他们使用的数据不应超过整个数据样本的 10%. 避免一件事情是至关重要的, 那就是在我们拥有 500 个交易日数据的情况下, 为交易系统选取 500 个不同的条件.可能每个条件都不同于其余的499个, 而且只适合于那个特定的交易日, 这样每一天都有一个能赚到最多的钱的最优条件, 但是却对未来的市场没有任何预测能力(详见第5章).

对于那些没有数学思维的人, 规则的复杂性和自由度是一个难题.即使很多数学家也不能说清楚什么是自由度.在解释自由度时(通常表示为df), 也许最恰当和容易理解的解释就是那个关于已婚男人的笑话: "我只有一个妻子, 我的自由度是零.我应该通过观察其他女性来增加我的"样本量"."

严格来讲, 从统计到数学, 几何, 物理, 和力学, 自由度这个概念有很多定义. 在互联网上有一篇免费的论文尝试简单解释这个概念, 当然这是个困难的任务. 自由度的第一个定义(Larry Toothaker, 1986)可能是 "独立组件的数量减去估计参数的数量(the number of independent components minus the number of estimated parameters)". 这个定义源于Walker(1940)的定义："观察的次数减去这些观察之间必要关系的数量(The number of observations minus the number of necessary relations among these observations)". 但是如果从实践出发, 最好的解释是 Robert Schulle 博士(俄克拉荷马大学)的一个说法:

**在只有一个数据点的散点图(scatter plot)中, 你不可能对回归线(regression line)做任何估计. 这条线可以走向任何方向...此时你没有自由度(n-1 = 0, 其中 n = 1)用于估计(这可能会让你想起那个关于已婚男人的笑话). 为了绘制回归线, 你必须至少有两个数据点(一个妻子和一个情妇). 在这种情况下, 你有一个自由度用于估计 (n-1 = 1, 其中 n = 2). 换句话说, 自由度告诉你用于估计的有效数据数量. 但是, 如果只有两个数据点, 则可以将它们连成一条直线回归线, 并得到完美的相关性 (确定指数 = 1.00). 因此自由度越低, 评估效果越差.**

所以我们从直觉上就能得出结论, **样本规模越大, 使用的变量数量越少, 评估效果越好**. 罗伯特·帕尔多是当前唯一能在文献中把这事讲清楚的作者, 他在自己的书中给出了精辟的描述：

**自由度的计算 = 整个数据样本 - 规则和条件 - 规则和条件消耗的数据**

一般来说, 剩余自由度少于 90% 都被认为是太少了. 除了帕尔多的公式, 从实践的角度来看, 如果要在一个有 20 个变量的系统上进行适当的优化, 不能在仅有 6 个月日线数据的数据集上进行, 这一点非常重要. 变量的数量以及交易系统的条件集合, 与测试周期的长度密切相关. 换句话说, 一些度量需要更多的信息. 度量所需自由度的值, 是基于数据集中信息独立片段的数量. 信息越多, 度量越准确, 自由度越高.

至少剩下 90% 自由度的理念, 也可以反过来应用, 这就是表示用于系统计算的数据与测试窗口长度之间关系的 10 倍法则. 如果你使用 30 天移动平均收盘价格进行拟合, 测试时至少需要 300天 (30 x 10) 的数据.

让我们举个例子：我们现在有一个数据集, 包括三年内每个交易日的最高价格, 最低价格, 开盘价格和收盘价格, 这样共有(每年260个交易日)260 x 3 x 4 = 3120 个数据点. 我们假设有一个交易策略使用基于最高价格的 20 日平均线和基于最低价格的 60 日平均线.第一个均线使用 21 个自由度：20 个最高价格加上另外 1 个作为一条规则, 第二个均线使用 61 个自由度：60 个最低价格加上 1 个作为一条规则. 合起来总共是 82 个自由度. 以百分比计, 结果是 82/3120 = 2.6%, 剩下 97.4% 的自由度.

在计算中使用两次的数据点仅被计为一次, 如果你同时使用 5 日收盘价均线和 10 日收盘价均线, 对于后一个条件来说你将有 11 个自由度(10 数据 + 1 规则), 而对于第一个条件, 你将只有 1 个自由度(1规则). 总共消耗了 12 个数据. 很明显, 因为 5 日均线包含在 10 日均线中, 只有后者才与自由度的度量有关.

衡量系统是否可信需要的交易数量也与测试窗口的长度有关. 如果一个测试在产生多笔交易的过程中, 始终让错误的风险保持在最低水平, 这样的测试结果对于评估系统是否可信是非常重要的. 测试窗口的长度应该考虑到这个因素. 标准错误应该依据交易样本从交易系统的报告范围中添加或减去.
标准差的定义是:
标准差 = n + 1 的平方根
其中 n 是交易的数量

交易次数越多, 交易系统指标的可能误差就越小. 换句话说, 如果我们很少交易, 那么这些交易只是意外盈利的风险很高. 如果你一枪就射中了靶心, 要么你是一个神射手, 要么说你纯粹就是运气好. 相反, 如果你 100 次都射中靶心, 你就有很大概率是一名神射手.

一个系统要被认为是值得信赖的, 至少需要交易 100 笔, 这样其标准误差将是 100 + 1 的平方根, +10.04% 或者 -10.04% .

所有的交易系统指标都会在 +10% 和 -10% 的范围内变化.也就是说, 如果净利润是 100 美元, 那么实际净利润可能分布在从 90 美元到 110 美元的区间内.

### 2.3 交易系统的预测能力

#### 优化

优化在很多交易者中名声并不好. 甚至可以是对系统交易者的一种冒犯(系统交易者总是认为自己的系统已经足够好). 优化系统意味着在系统中找到那些能使利润最大化的系统变量, 或者能让交易者趋向主要目标的约束条件(例如, 系统更倾向于减少利润回吐, 而不是最大化利润). 让我们举一个例子：你有一个移动平均线交叉系统; 即系统在短期移动平均线穿过长期均线时买入. 针对这个系统的优化问题是短期均线是多短, 长期均线又是多长. 优化意味着"适合"一个系统; 也就是说让系统适应我们打算交易的市场[4].

但是优化是一把双刃剑：从波动性, 初始风险, 回报等角度, 让系统来适应市场是一回事.但是, 寻找那些可能让你在过去赚得最多, 却对未来没有预测能力的输入则是另外一回事. 让我们假设有一个系统, 每天都会以最低的价格购买并在最高的价格出售, 系统具有精确的入场和出场价格, 使其能够达成利润最大的目标. 这是一种错误的优化, 因为我们寻找一个每天都在变化, 而只能在每天收市后才能确认的最好价格. 这个系统没有任何预测能力(泛化, 规则必须有普遍意义).

在交易系统的开发过程中避免优化是绝对不可能的. 只要想想每个交易者目前正在做什么, 你就会明白, 优化是我们不得不面对的东西. 有交易者拒绝投入优化过程, 因为根据他们的观点, 一个系统可以在相同输入的情况下永远工作. 然后他们决定在一批系统选中某个交易系统, 就因为这个系统在过去比其他系统赚了更多的钱. 这难道不是一种优化吗？又一次他们改变了原系统的代码, 在原系统上添加约束和条件, 依据市场价格行为对系统进行调整, 然后选择在历史数据中表现最好的系统调整：这不也是一种优化吗？ 如果你现在不是特别倾向于优化, 请回顾下你的立场, 并考虑下你有多少次不经意地使用了优化.

优化在系统交易中是有价值的, 我们需要区分正常的优化过程及过度优化, 称为曲线拟合或过度优化. 例如：我们交易债券期货的日间系统会受到货币政策的影响. 货币政策不会每天都变, 它必须与经济扩张-衰退周期匹配, 所以我们谈论的实际上是持续多年的事情.在这种情况下, 很明显我们需要将优化窗口设置为6,12或18个月 - 这是依据市场和货币政策来调整系统的合理时间长度.

如果系统产生了大量的交易, 我们将在系统启用后的前两年测试系统, 然后我们微调系统, 上线后则在每6,12或18个月重新优化一次. 这种方法针对的是真正的交易, 而不是对系统的理论评估. 当然, 为了尽快确认系统是否可行, 系统必须用我们现有的最长价格序列进行测试和优化. 但这个过程并不能帮助我们找出适当的参数来进行下一笔交易. 这只是一个评估过程, 帮助我们确定系统是否适合该特定市场; 那就是如果净值曲线正在增长(净值可能不会像我们希望的那样平滑增长, 但至少应该果断向上).

换句话说, 通过应用已有的最长价格序列进行测试, 可以帮助我们检查系统是否能够捕捉指定市场的动向, 而在优化过程中我们通过改变输入, 观察系统是否仍有改进的空间. 然后, 我们在6到12个月的周期上持续优化, 对系统进行微调, 从输入的角度, 考虑特定市场的特点, 使系统与市场保持同步变化.

对于日内系统来说, 所有的测试, 优化和重新优化周期都会比日间或周间系统要短.

#### 走势分析(Walk forward analysis)

总之, 为了同步系统与市场, 我们可以说, 就数据窗口而言, 优化是可变的. 在电脑计算在大多数市场参与者中普及之前, 优化后"样本外周期(out-of-sample period)"对于所有交易系统开发人员都是值得推荐的. "样本外周期" 是一个与优化过程无关的数据窗口(通常是整个优化数据窗口的 10% 到 20%), 它会被应用到优化后的交易系统上, 以便在未知的数据上验证系统的预测能力. 如果系统在 "样本外数据" 上的表现与在训练集上表现一致, 这意味着该系统是稳健的, 能够进行可信的交易.
 
**到目前为止, 我们讨论的关于交易系统的想法, 在任何流通的书籍中都可以找到. 但是这些关于优化的观点都过时了, 它们来自那些计算机没有被广泛使用的年代. 今天的优化已经发展成为一种更有效和更适当的测试方法, 可以让一个系统与长期价格序列匹配. 这个方法以 "前向分析(walk forward analysis)" 或 "前向测试(walk forward testing)" 的名义不断发展.**

前向测试是一种多轮的, 连续的样本外数据测试, 它不停的用样本外数据测试同一个数据序列. 让我们举个例子: 先用数据集中前两年的数据对系统进行优化, 然后用随后6个月的数据进行验证. 此时再将优化窗口前移6个月, 对系统进行新的优化, 再用未来6个月的数据进行验证, 就这样继续下去. 这种优化是一种 "滚动" 的前向分析, 因为每次我们重新优化时, 优化窗口总是前移6个月. 如果开始时间不变, 随着时间的推移增加优化窗口长度, 这种方式称为 "锚定" 前向分析. "滚动" 前向分析更适合于盘中交易系统, 因为盘中交易系统面对的是不断变化的市场条件.

<p align="left" style="color:red;"><font size=5><b>注: 因为短期趋势不断变化, 不可捉摸, 所以减小分析的时间跨度, 保持对趋势的跟踪, 提升灵敏度.</b></font></p>

```
Rolling walk forward: out-of-sample (OOS) = 20%:
Run #1 |--------- In-sample 80% -------------- | OOS 20% |
Run #2                 |---------- In-sample 80% ------------ | OOS 20% |
Run #3                       |---------- In-sample 80% ---------------------| OOS 20% |
Anchored walk forward: out-of-sample (OOS) = 20%:

Run #1 |--------------In-sample 80% --------------- | OOS 20% |
Run #2 |----------------------------- In-sample 80% ---------------| OOS 20% |
Run #3 |-------------------------------------------- In-sample 80% --------------- | OOS 20% |
```

<p align="center"><font size=2>Figure 2.1: A graphical description of a  "rolling" and  "anchored" walk forward analysis</font></p>

前向测试中产生的净值线是交易系统开发过程中最接近真实的地方, 因为这就是真正的交易将带给我们的. 显而易见的是, 同基于整个价值序列测试或优化交易系统生成的净值线相比, 这种前向分析生成的净值线将完全不同. <font color=#fd0209 size=5><b>注: 一个关注长期趋势, 一个追踪短期波动</b></font> 所以交易员在决定是否放弃一个交易系统时往往会欺骗自己, 依赖交易系统在整个价格序列上生成的净值线, 实际上这样的净值线压根就没有反映经过定期重优化后的真实交易情况<font color=#fd0209 size=5 ><b>注: 定期重优化拟合的是最近的波动, 对于全周期未必是适用的</b></font>.

一种被广泛接受的衡量系统预测能力及其一致性的方法, 是计算前向测试年化净利润与优化期间年化净利润的比率. 这就是前向有效率(walk forward efficiency ratio). 如果该比率高于 100%, 那么系统是高效的, 在实际交易中保持预测能力的可能性也比较高. 如果交易者决定使用前向有效率为 50% 的系统进行交易(许多交易者认为这个水平已经是最低了), 他们应该期望该系统的实际表现至少是优化测试结果的一半. 统计学证据还指出, 一些优化的不够好的系统, 也可能在前向测试的一两步中幸运的有良好表现. 为了规避这个陷阱, 应该执行尽可能多的执行前向测试, 或者至少让测试窗口(即我们在优化后的交易系统上应用的数据窗口)前进 10 步, 并且测试窗口涉及的数据至少占整个优化价格序列的 10% 至 20%.

讨论 "静态的基于数据集中部分数据的 '样本外' 测试" 或 "如何优化交易系统" 都已经过时, 因为大多数专业交易系统开发软件都集成了前向分析功能. 这并不意味着交易者不用熟悉常见的测试和优化过程. 我们建议在使用 WFA 之前, 你应该做关于优化的作业, 从而获得系统及其性能的完整视图. 要运行完整的前向分析耗时巨大, 为了提升速度, 我们可以通过先进行一轮测试, 再进行一轮优化来检查系统的稳健性. 无论如何, 为了简单起见, 我们将总结一些好的优化提示.

如果我们有许多输入需要优化, 最好的方法是每轮测试一到两个输入, 与此同时其他输入都保持不变.<font color=#fd0209 size=5><b>注: 数学思维</b></font> 这样能将过度优化的风险降到最低, 因为当所有的输入不在同一轮优化时, 不可能简单的找到一组输入能让我们给方程的约束最大化.(since it is impossible to find the batch of inputs that will maximise the constraint we gave to the equation simply because the inputs will not be optimised together in the same run.)

#### 健壮性

我们是否能从后优化窗口 (post-optimisation window) 中推断出, 系统是健壮的, 抑或是过度优化的产物? 我们不需要迷信最优执行输入 (the best performing inputs), 将其视为必胜的条件. 如果足够的飞镖投掷在板上, 必然会有高分组, 或者换句话说, 如果把一只猴子放在钢琴前, 只要有足够的时间, 最终它能弹出一首奏鸣曲. 这个笑话表明, 如果我们相信性能最好的输入 (the most performing inputs) 的存在, 至少结果的平均值应该是盈利的. 如果仅有 1% 到 5% 的结果是有利可图的, 这可能是偶然的: 如果系统的变量有足够大的输入区间, 这个系统最终能依靠历史数据发财. 一个稳健的系统不仅仅在 5% 的测试中表现良好, 而是在所有测试的平均值. 换句话说, 如果平均结果是盈利的, 那么我们可以假设交易系统是稳健的. 如果你更倾向于统计结果, 你也可以从平均净利润和支票中减去标准偏差(或其倍数), 然后检查在这种情况下平均净利润是否仍为正数.

因此, 输入, 条件和变量的数量必须可控并尽量减少至最小. 但多少个输入, 条件和变量算太多? 这是一个存在争议的领域, 其中唯一的标志是必须始终遵守我们在前一段中描述的数值条件的自由度数. 在考虑输入之前, 如果输入变化或者在优化下结果没有任何变化, 则快速粗略地检查是非常重要的. 如果不是, 请保持不变以增加自由度.

要考虑的另一点是每个输入(在时间序列上)的扫描范围. 举个例子将更清楚地说明这个问题: 如果要测试一个基于每日数据的移动平均线交叉系统, 它包括短期移动平均线和长期移动平均线, 你不能在下面两条均线上进行测试 -- 从 1 到 20 (这里指日线中的短期)的短期移动平均线和 20 到 200 (通常被认为是长期移动平均线对应的日线间隔)的长期移动平均线. 对于短期均线(20 日均线)来说, 扫描窗口从第 1 项数据移动到第 2 项数据的变化是 100%, 而从第 19 项数据移动到第 20 项数据的变化是 5%. 而对于长期均线(200 日均线)来说, 扫描窗口边界从第 199 项数据移动到第 200 项数据只有 0.5% 的变化. 你需要在两个区间上进行等幅扫描, 即以 2 的步长执行从 1 到 20 的扫描, 同时以 20 的步长执行从 20 到 200 的扫描.

优化完成后, 应该做出关键的决定: 我们应该选择哪些输入批次? 首先我们需要做的是创建一个函数图表, 显示变量输入扫描范围与净利润的关系(或者选择其他标准进行优化).

![same_level](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_2.2.png)

<p align="center"><font size=2>Figure 2.2: In the middle of the chart as the variable varies the net profit stays almost at the same level.</font></p>

我们寻找的是理想情况下尽可能接近水平线的线, 在这条线上净利润不依赖于输入值. 当然, 实际情况与理论有很大不同, 所以我们应该满足于这样一条线, 它轻柔地上升, 在顶点维持一段时间然后下降. 顶部的水平区域正是我们想要的, 在这个区域中, 即使改变输入, 净利润几乎保持不变. 这是输入值表现出 **鲁棒性** 的区域. 与利润尖峰截然不同, 它是净利润相对较高的一个点, 但在它的周围净利润陡然下降. 换句话说, 我们需要找到一个甚至在改变输入值后净利润仍然能够保持稳定的区域.

![profit_spike](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_2.3.png)

<p align="left"><font size=2>Figure 2.3: As much as the variable changes the net profit shows deep and wide swings: there is no area where at the variable’s changing net profit stays more or less stable.</font></p>

<p align="left" style="color:red;"><font size=5><b>注: 鲁棒性是指控制系统在一定(结构, 大小)的参数摄动下, 维持其它某些性能的特性.</b></font></p>

总而言之, 我们可以得出以下结论: 输入和结果间应该有一条逻辑路径, 会产生一些与输入批次相关的东西. 当输入和净利润不存在线性关系时, 或者不存在回退关系, 或者不存在任何作为优化主要规则的约束, 整套结果必须是存疑的.

### 2.4 交易系统的评估

评估交易系统看起来很容易. 谨慎的交易者最后必须做的事情是违反直觉的: 乍一看, 我们确实会说净利润越高系统越好. 不幸的是, 这种感觉与事实毫无关系. 我们将提出一些不基于净利润和纯数字的通用方法标准, 以便淘汰这种具有欺骗性的方法. 然后我们将介绍指标 RINA 指数, 该指数由 TradeStation 详细说明. RINA 指数在系统交易者中越来越常见, 我们认为它的分析比任何其他工具都要好.

#### What to look for in an indicator

净利润是系统在测试期间带回家的钱. 即使绝对数量可以取悦读者, 它并没有从根本说明系统的真实性能, 而且它也没有说明风险. 在没有量化风险的情况下谈论利润是系统分析中的致命错误. 此外, 如果您添加适当的佣金和 **滑点**, 权益线形状可能会发生变化, 直至向下倾斜或变为负数(暗指亏损).

<p align="left" style="color:red;"><font size=5><b>注: 滑点(slippage)是订单的执行价格和期望不同, 滑点的原因是市场变化过快, 网速流量太低, 或交易者执行速度太慢.。</b></font></p>

因此我们得到两个初始的一般考虑因素, 如下:

1. 应对多功能回报指标进行标准化, 以便在多个资产类别或多个交易系统之间轻松进行比较.
2. 谨慎的指标总是将回报与风险进行比较, 而净利润指标两者都不包含.

此外, **一个指标应该始终传达的观念是他希望度量的是什么, 对于交易系统来说这就是"一致".** 什么是一致性? 一致性的同义词可以是 "稳定性": **一致性衡量指标的稳定程度.** 让我们以净利润为例: 净利润本身并未说明什么时候获利. 年与年之间利润可能变化很大, 甚至是仅在某一年内产生利润, 在其他年份都是亏损. 您会信任哪一个系统, 一个年复一年赚钱的系统, 或是一个 10 年前赚钱然后每年都亏钱的系统? 最后的结论是后面的系统更好, 因为 10 年前赚取的利润如此巨大, 后面的损失相比之下是可以接受的; 但是谁会遵循这个系统继续交易呢? 没有人会采用这样一个交易系统, 因为很明显 10 年前的意外收获可能是一个异常值, 一个永远不会重复的异常事件.

因此我们可以得出结论: 一个一致的交易系统不仅包括利润和亏损的均匀分布, 而且还包括连续且均匀分布的输赢交易序列. 如果您逐年查看一致交易系统的统计数据, 您会发现所有指标几乎相同. 如果逐年或逐月都出现显著差异, 则交易系统是不一致的. 盘中系统也可以采用类似的方式, 通过每周表现来衡量.

#### Average trade

如何评判一个交易系统是否优秀, 关于这个问题有一个重要指标 -- **平均交易收益(the average trade)**, 即净利润除以交易数量. 平均交易告诉我们每笔交易赚取或者亏损多少钱. 从绝对意义上来讲, 平均交易在弥补滑点和佣金后, 应该仍能为交易者留下一些利润. 按百分比计算, 平均交易在整个测试期间应保持一致. 通常情况下, 交易者将绝对平均交易(the absolute average trade)与特定交易的入场价格进行比较, 并以百分比的形式表示. 其他交易者将名义平均交易值(the nominal average trade value)与给定时期内合约的名义价值(the nominal value)进行比较. 我们推荐绘制交易的历史平均百分比值, 以便清楚地了解多年来系统的盈利趋势.

#### Percentage of profitable trades(盈利交易百分比)

盈利交易百分比表示盈利交易数量与总交易数量的比值. 它本身并不重要(一个趋势跟随交易系统的盈利交易百分比可能会比较低, 如 35%, 但它仍然是一个可行的系统), 重要的是它可以用来衡量系统如何平衡, 而系统平衡与 "平均交易赢利/平均交易亏损"的比值相关. 通常情况下, 如果你赢了很多次, "平均交易赢利/平均交易亏损" 比值会很低(盈利平均分布在每笔交易上, 导致每笔交易的盈利变少), 相反, 如果你的盈利交易百分比很低, 那么比值就会较高(两者之间是反比关系). 50% 的盈利交易百分比是健康的. 但是如果它大大超过 50%(例如 60% 或 70%), 请务必小心, 因为这意味着某些地方出了问题: 为了抗衡如此高的百分比, "平均交易赢利/平均交易亏损"比值应该特别低, 甚至常常低于 1(警戒水平). 如果您使用目标点位退出(让我们假设你以止盈价格退出 50% 的头寸), 那么盈利交易百分比超过 60% 是一件很正常的事情, 同时 "平均交易赢利/平均交易亏损" 比值会低于 2.

盈利交易百分比对于计算交易系统的数学期望也很重要. 盈利交易的百分比乘以平均交易赢利应该高于亏损交易的百分比乘以平均交易亏损. 换句话说, 数学期望应该是正数, 并且越高越好. 您可以使用这种数学期望度量来对系统进行排名, 然后选出最好的系统.

就盈利交易的百分比而言, 必须谨慎注意一个警告: 50% 的盈利交易比绝不意味着亏损之后就是盈利, 反之亦然. 如果一个交易序列声称两次盈利/亏损的交易之间有着特定的排列, 这其实进入了一个存在争议的领域. 即使这个话题很吸引人, 谨慎的交易也应该始终与最坏的交易作斗争, 并期待最好的交易, 就我们的经验来说, 相信"交易之间存在依赖"特别危险, 因为这个假设非常强大. 实际上你是假设在交易序列中存在重复的排列; 也就是说, 过去的概率表明, 在连续三场胜利后, 更有可能有两场失利, 而不是第四场胜利.

轮盘赌玩家真的相信, 如果你这次得到了一个黑色的数字, 那么在下一轮中获得红色数字的机会就会增加. 更糟糕的是, 他们认为如果随后出现了一排黑色数字, 那么获得红色数字的机会会变得越来越大, 例如连续 7 次或 10 次. 然而, 从逻辑思维和统计理论来看, 赌场中轮盘赌的每一轮都是完全独立的. 上一轮是否有红色数字, 黑色数字或绿色数字, 其实是没有任何意义的, 既不意味着好也不预示着坏. 每次出现的数字都完全独立于其他数字. 因此, 在下一轮中投注, 正确的概率总是相同的：18/37 = 48.6%(因为有 18 个黑色和 18 个红色数字加上一个绿色 0).

虽然金融市场, 特别是对初学者来说, 有时看起来特别像赌场, 但它们实际上是非常不同的, 且金融市场会更复杂. 在许多情况下, 他们表现得很意外, 指数上蹿下跳并且没人知道原因. 然而, 人类的贪婪和恐惧心理会产生一些特殊情况, 这些情况与市场的偶然行为不同. 正是在这些走势中, 特殊情况下的特殊交易系统, 可能会发生交易依赖. 但这是一个超出本书范围的复杂主题. 无论如何, 我们建议读者以极其谨慎的态度对待这一主题.

#### Profit factor(利润系数)

利润系数是一个完美指标, 用来比较不同交易系统或不同市场上的相同交易系统. 当然, 该指标是一个比率, 因此它不会受其他绝对值比率缺点的影响. 利润系数是毛利润除以毛损, 基本上揭示了毛利与毛损相关的规模. 当然是越高越好. 通常, 健康的交易系统的利润系数为 2, 平均交易盈利/平均交易亏损的比率为 2, 盈利交易数量的百分比等于 50%. 但也有一些利润系数介于 1.5 和 3 之间的良好系统. 考虑一下, 当你的利润系数超过 3 时, 你将如何优化系统, 以及如何进行交易系统的设计和开发.

#### Drawdown(亏损)

亏损的广义定义是在交易系统中最大损失和最大的连跌中, 选取最大的那个. 从图形上来看, 我们可以将亏损描述为在权益线创出新高之前, 权益线最高点和连续低点之间的下跌. 换句话说, "总权益亏损" 是指您账户中的未平仓合约的损益加上已经平仓的权益. 只考虑未平仓头寸还是只考虑平仓头寸, 这两种条件下亏损具有更微妙的含义. 事实上, 区分三种不同类型的亏损非常重要:

1. 终止交易亏损(end trade drawdown)告诉我们在允许退出指定交易之前, 我们允许回撤多少浮盈(账面盈利).
2. 关闭交易亏损(close trade drawdown)是进场和出场价格之间的差异, 而不考虑交易中的情况.
3. 初始交易亏损(start trade drawdown)度量的是在入场后和开始出现浮盈之间, 逆向走势导致的亏损.

为简单起见, 我们将使用 "关闭交易亏损" 定义, 因为它是最重要的. 同时有一点也很重要, 在用真金白银交易时, 我们可以忍受比依据理论计算出的 "关闭交易亏损" 规模大得多的浮亏(open trade drawdown).

不可否认的是, 亏损的绝对值对交易者产生了深刻的心理影响, 因为他将被迫处理它, 这可能是让人痛心的. 但是亏损就像盈利指标一样, 我们需要谨慎地以比较的方式使用这一度量. 为了达到这个目的, "水下权益线" (underwater equity line)的概念出现了; **水下权益线即亏损绝对值除以权益线的前最高值.**  这表示相对于权益线的缩减百分比. 因此, 即使我们基于 40 年的长期价格序列中测试系统, 这期间合约价值发生了巨大变化, 我们仍然能够有一个百分点参考值, 能够发现基于当前价格的实际预期亏损: 只需要基于当前市场价值绘制出最高的 "水下权益线" 百分比.

许多分析师正试图通过优化退出规则和初始止损来对抗亏损, 实际上进一步了解亏损发生的原因会更合适. 如果市场上出现历史性的怪异事件, 那么显然会出现异常亏损. 如果没有什么特别的事情发生, 那么才会怀疑系统的逻辑出现了问题.

为了评估我们必须担心哪种亏损, 以及哪种亏损是正常的, 计算平均亏损及其标准偏差是至关重要的. 如果最大亏损介于平均值的一到两个标准差之间, 那么我们预计未来的亏损将与我们过去的水平接近. 如果平均亏损超过平均值的两个标准差, 那么我们需要重新思考系统的逻辑, 前提是确认过去没有发生任何导致异常亏损的特殊情况.

<p align="left" style="color:red;"><font size=5><b>注: 统计学思维</b></font></p>

大多数专业交易员和基金经理的能够忍受的亏损是 20% 至 30%. 10% 的亏损可以算是一个精彩的成就, 但是 30% 的亏损则让人痛苦和令人担忧. 对于大多数市场参与者来说, 40% 到 50% 的亏损是无法忍受的.

<p align="left" style="color:red;"><font size=5><b>注: 这是暗示交易中的浮亏无法避免?</b></font></p>

#### Time averages(平均时间)

其他重要指标包括时间平均值. 根据 TradeStation 术语, 交易的平均时间显示在策略的指定期间内完成的所有交易花费的平均时间(年, 日, 分钟). 其他交易平台也有类似指标. 平均交易时间对于投资组合构建至关重要, 因为利用权益线之间的负相关性(套利), 您的系统需要同时进入市场或者至少具有相同的 "平均交易时间". 如果你使用两个系统组成投资组合, 其中一个较少交易但是需要长时间保持在线, 而另一个交易频繁, 但是每笔交易交易时间较短(快进快出), 那么您的累积权益线永远不会平稳.

<p align="left" style="color:red;"><font size=5><b>注: 这是是说不同周期的叠加, 导致累积权益线频繁出现上升下降, 无法保持水平.</b></font></p>

无论是做多还是做空, 交易系统都必须确保利润和风险是平衡的(不能高风险低收益). TradeStation 分别列出了做多交易和做空交易的系统报告, 在特殊情况下除非您可以找到合理的原因, 否则做多交易产生的利润应该始终能跟上做空交易产生的利润. 做多和做空利润不平衡的交易系统必须得到质疑.

#### RINA Index

RINA 指数是由 RINA Systems 创建并包含在 TradeStation 交易系统报告中的强大指标, 它代表单位时间内的回报风险比率, 这个指标实际上比较的是: "选择净利润(select net profit)" (净利润减去正负外部交易, 即减去超出平均值的三个标准差限制的异常交易) 除以平均亏损并再次除以市场指标中的时间百分比(the percentage of time, 总是取自 TradeStation 系统报告). 该指标应始终超过 30, 并且越高越好.

为了衡量结果的一致性, TradeStation 系统报告会针对平均交易收益(the average trade)和几乎所有指标自动计算三个标准差异正负极限. 这可以了解指标在这些边界之间自然振荡的程度. 通常, 变异系数(the coefficient of variation, 标准差除以平均值)不应高于 250%.

在本段中, 我们试图在不需要深入研究太多理论或哲学的前提下, 为系统开发人员整理出一些实用指南. 拥有 20 年经验的我们敢于公开承认, 我们可以一眼就看出交易系统是否值得被关注, 并且不担心任何人的质疑. 我们检查的第一个方面是权益线, 它需要平稳增长, 并且没有多少深度回撤. 就个人而言, **我们也很欣赏许多 "平静的时段", 即权益线的一部分是水平的: 这意味着过滤器让系统退出了市场(停止交易), 因此在此期间没有进行任何交易.** 我们认为没有必要不断进行交易, 当一些可以被利用的优势出现时, 一个好的系统应该能够及时感知, 反之则更适合待在场外. 然后, 除了权益线, 我们立即检查平均交易, 利润系数, 盈利百分比, "平均赢利/平均损失"比值以及多年来每月回报的分布方式. 仅从这些指标中可以得出关于交易系统的正确判断, 而不必担心掉入错误的陷阱.

### 2.5 结论

到目前为止, 我们已经涵盖了交易系统优化和性能评估中最重要的理论方面. 它简要概述了本主题所包含的概念, 但我们希望这份简洁将引导你进入更深刻的理解.

我们可以断言, 交易系统是一种科学的交易方法, 不需要任何人为介入. 显然, 这不是一个稳定的业务, 但它是一个应对概率的业务, 允许交易者利用统计优势入场搏杀.

通过阅读本书末尾参考书目中的文本, 您将会扩展这些知识, 深入研究交易系统评估和优化的细微差别.

不幸的是, 如果不处理交易系统的实际应用, 就不可能完全掌握这个主题. 交易系统的发展不是理论的挑战, 而是一种实用的市场实验方法. 编写代码, 测试它们然后优化它们是一个过程, 它允许交易者认识实际市场, 这有时比理论更重要. 知道如何遵循这个过程将节省大量的工作, 同时这个过程将有助于解决普通交易者无法接触到的情况.

在接下来的章节中, 您将对系统交易者在开发, 评估和优化交易系统时所做的工作有一个切实的看法. 我们相信这是我们工作中最重要的部分.

# Part II: 交易系统开发&演进真实案例

## Chapter 3: How to develop a trading system step-by-step – using the example of the British pound/US dollar pair

* **Introduction**

货币市场对所有类型的交易者都很有吸引力, 包括个人日间交易者, 交易公司, 金融和非金融公司, 银行和政府. 从新西兰的周一早上到美国的周五晚上, 他们每天24小时交易. 像英镑这样流动性充沛的市场, 为交易者提供了在任何时间尺度上, 实现任何不同想法, 开发任何类型的交易系统的可能性.

在本章中, 我们不会介绍最好的交易系统, 它承诺最高的利润. 相反, 我们的目标是向您展示一个交易系统, 该系统基于一个合理的想法并且经过改进以获得高稳健性. 为了帮助理解我们的交易系统开发概念, 您将在以下章节中逐步了解如何开发一个全新的交易系统并测试其稳定性.

我们选择具有突破组件(breakout component)的趋势跟随系统作为例子. 我们采用这个系统, 并展示如何通过下面的步骤改进它, 以使其成为一个有利可图的交易系统.

3.1 输入逻辑和代码. 如何利用突破过滤器(breakout filter)改进一个常见的移动平均线交叉系统.

3.2 评估没有参数优化和退出(exits)的交易系统 - 佣金和滑点的重要性.

3.3 输入参数的变化: 优化和稳定性图.

3.4 插入日内时间过滤器: 短期交易中时间重要性.

3.5 通过检查所有系统交易的演化来决定系统的适当出口. John Sweeney 的最大不利和最大有利游览将如何为您提供支持.

我们首先描述系统的逻辑.

### 3.1 The birth of a trading system

正如在介绍中提到的, 有很多来源可以用来开发自己的交易系统池. 其中之一必须是欧米茄研究(TradeStation)的战略交易和发展俱乐部(简称 "STAD"). 作为起点, 我们采用以下入口逻辑, 如 STAD 第 13 卷中所述:

卢克索系统通过两条移动平均线 - 快速平均线和慢速平均线的相交来触发交易. 当然, 有许多类型的移动平均线; 卢克索是 STAD 俱乐部中第一个使用三角形移动平均线的策略. 三角形移动平均线(TMA)的目的是增加价格数据平滑度,同时避免增加价格到指标之间的滞后时间. TMA 首先简单计算价格的算术平均值(通常使用收盘价). 然后, TMA 指标基于刚刚计算出的平均值再次计算算术平均值.

所以描述中的关键点是移动平均线的特殊类型. 然而, 当我们测试交易系统时, 我们发现移动平均线的类型并不重要, 最好的结果是用简单的移动平均线而不是更复杂的三角形移动平均线产生的! 因此, 您可以忘记这个三角形, 复杂的移动平均线并没有比普通移动平均线表现更好. 这证实了我们在开发交易系统时的一个观点, 最简单的也是最有效的.

系统开发的主要步骤如下: 获得符合交易市场个性的想法, 测试它们并使其符合您自己的需求. 我们在这里为 LUXOR 系统做这件事. 我们只讨论如何使用移动平均线并进行一些小改动.

#### The free LUXOR system code

想要实现这种逻辑的程序员可以在下面 TradeStation 的 Easy Language 中找到交易系统的代码. 我们在代码中添加了一些注释, 以便您了解所做的工作, 同时也便于您根据需要轻松修改代码.

<p align="center"><font size=2>Text 3.1: Easy Language Code of the LUXOR trading system. Bold letters: Code for the entries. Normal letters: added time filter. In comment brackets: possible simple exits.</font></p>

>{Copyright 2000. OMEGA RESEARCH, INC. MIAMI, FLORIDA.
>Strategy Trading and Development Club STAD, Volume 13,
>
>Modified 18 June 2006 and 15 July 2008 by Urban Jaekle
>Modified 1 January 2007 by Russell Stagg}
>
>{1. Definition of necessary inputs and variables}
>Inputs:
>FastLength( 3 ),  {The input parameters of the two moving averages… }
>SlowLength( 30 ),
>tset(1600),       {…start time for the intraday time window filter…}
>WindowDist(100);  {…window distance for the intraday time window filter…}
>                  {…can be changed – this makes optimisation possible}
>Variables:        {Definition of needed variables}
>    MP(0), Fast(0), Slow(0), GoLong(False), GoShort(False), BuyStop(0),
>SellStop(0), BuyLimit(0), SellLimit(0), tEnd(1700);
>
>MP = MarketPosition;
>
>{2. Time window filter; see below: 3.4, "Inserting an intraday time filter"}
>tend = tset + WindowDist;         {time window of 1 hour}
>if time > tset - 5 and time < tend then begin
>
>{3. Definition of moving averages and entry conditions}
>Fast = Average(Close, FastLength);
>Slow = Average(Close, SlowLength);
>
>GoLong = Fast > Slow;
>GoShort = Fast < Slow;
>
>{4. Entry Setup}
>If Fast crosses above Slow then begin
>    BuyStop = High + 1 point;
>    BuyLimit = High + 5 points;
>end;
>
>If Fast crosses below Slow then begin
>    SellStop = Low - 1 point;
>    SellLimit = Low - 5 points;
>end;
>
>If GoLong and C < BuyLimit then
>    Buy ("Long") next bar at BuyStop Stop;
>If GoShort and C > SellLimit then
>    Sell Short ("Short") next bar at SellStop Stop;
>
>{5. Exits: Derived from the slow moving average. These exits are not used here since
>we take different standard exits! Feel free to change the exits according to your needs}
>
>{If MP = 1 then Begin
>    Sell next bar at Slow - 1 point Stop;
>End;
>If MP = -1 then Begin
>    Buy to Cover next bar at Slow + 1 point Stop;
>End;}
>end;

Easy Language 代码可以分为不同部分:

1. 定义输入和变量.
2. 时间过滤器(在 3.4 中讨论).
3. 入场和出场设置.

由于本章的第一部分侧重于入场逻辑, 我们将交易系统的退出部分放在括号中的 Easy Language 代码中. 这意味着首先我们忽略出场并仅从该系统中生成交易. 在本章的后面, 我们将基于这些生成的交易应用出场逻辑.

#### The entry logic

现在让我们解释代码创建如何入场点(图 3.1). 入场点基于常见的移动平均线系统, 其工作原理如下: 在快速移动平均线上穿慢速移动平均线时, 你进入市场并买入, 如果快速移动平均线下穿慢速移动平均线时, 则以同样的方式入场做空.

<p align="left" style="color:red;"><font size=5><b>注: long(买入) short(卖出)</b></font></p>

众所周知, 在长期稳定趋势中, 这类趋势跟踪方法能够获取巨额利润. LUXOR 的入场逻辑使用了趋势跟踪的基本思想, 仅仅通过两条简单的移动平均值作为入场信号发生器. 但是它也按以下方式进行了修改: 均线交叉后还必须经过价格确认才能入场. 仅仅移动平均线并不足以启动交易. 如果是买入, 您希望当前价格超过近期高点后再入场交易(图 3.1). 类似地, 价格必须低于近期低点才能触发卖空. 请注意, 我们在这里只解释了系统代码中的做多逻辑, 而做空逻辑是对称构建的.

<p align="left"><font size=2>Figure 3.1: Entry Logic. The entry is not triggered by the crossing of the two moving averages. Instead, at the crossover bar the high is kept and used as a long entry level. Short entries are taken symmetrically. Chart example was taken from British pound/US dollar, 30 min, FOREX from 26 Dec 2007. Chart and datafeed from TradeStation 8.</font></p>

![Entry Logic](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.1.png)

系统具有以下两个输入参数, 可以进行改变和优化:

Inputs: FastLength (3), SlowLength (30);

这两个输入参数 "FastLength" 和 "SlowLength" 分别用于快速和慢速移动平均值:

Fast = Moving Average (Close, FastLength);
Slow = Moving Average (Close, SlowLength);

现在我们添加重要的突破过滤器. 在快速移动平均线向上穿过慢速移动平均线时, 交易不会在穿过的那一刻直接触发. 只要快速移动平均值始终保持在慢速移动平均线之上, 我们取这个柱的高点("交叉柱", 图 3.1 中用红色标记)并将其作为入场止损点(entry stop point):

If Fast crosses above Slow Then EntryLevel = High;
If Fast > Slow then Buy ("Long") next bar at BuyStop Stop;

这种条件判断虽然简单但是有效, 它提高了简单的趋势跟随系统捕获最有利可图的突破的概率, 而不是在任意均线交叉点都触发. 与常用的普通移动平均线交叉系统不同的是, 因为添加的过滤器必须确认移动平均线交叉有效, 这种方法能够过滤掉一些假突破.

### 3.2 First evaluation of the trading system

----------

#### Calculation without slippage and commissions

现在我们将该策略应用到从 2002 年 10 月 21 日至 2008 年 4 月 7 日的 30 分钟 FOREX 数据. 本章中所有的后续计算均基于单个合约. 为了便于入门, 我们在计算交易系统结果时不考虑任何滑点和佣金. 这些会在下一节中提及, 我们将会在那里检查它们对系统性能的影响. 此外请注意, 我们只通过入场和交易逆转来审视系统, 忽略交易退出.

<p align="left" style="color:red;"><font size=5><b>注: 逆转(trade reversals)指的是价格趋势方向的变化</b></font></p>

作为交易系统众多输入的第一个输入参数, 我们选择 10 个柱用于快速平均线, 30 个柱用于慢速移动平均线. 如果柱状图中的每个柱都是 30 分钟, 意味着快速移动平均线是从最近 5 个小时的交易数据中计算出来的, 同时也意味着慢速移动平均线依赖于过去的 15 个小时. 图 3.2 以详细形式显示了交易系统生成的权益曲线. "详细形式" 是指该曲线显示在其生命周期内发生的所有交易导致的权益上升和下降. 与那些只显示日末甚至月末权益的权益线相比, 这样的权益线包含了更多信息量.

<p align="left" style="color:red;"><font size=5><b>注: 这是的输入(entries)包括变量和均线</b></font></p>

<p align="left"><font size=2>Figure 3.2: Detailed Equity Curve of the trading system LUXOR on British pound/US dollar (FOREX), 30 minute bars, 21/10/2002-4/7/2008. Input parameters: SLOW=30, FAST=10. System without exits, always in the market. Back-test without any slippage and commissions. Chart from TradeStation 8.</font></p>

![Detailed Equity Curve](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.2.png)

从权益线上来看, 对于一个可行的交易系统来说这是一个良好的起点. 尽管出现了一些下滑, 但系统总是能够快速恢复并达到新高, 从而使初始资本得到相对稳定的增长. 交易数据也显示了交易系统的盈利能力(表 3.1). 在表中您可以看到 LUXOR 在 2002 年 10 月至 2008 年 7 月的测试期间内仅交易了一份合约, 然后赢得了 66,000 美元的净利润. 此期间的最大亏损为 16,000 美元. 如果假设起始资本为 30,000 美元, 那么这意味着您的总利润在过去六年中超过 200%, 同时最大亏损约为 50%.

<p align="left"><font size=2>Table 3.1: Main system figures of the LUXOR system. British pound/US dollar (FOREX), 30 minute bars, 21/10/2002-4/7/2008. Input parameters: SLOW=30, FAST=10. System without exits, always in the market. Back-test calculation without any slippage and commission.</font></p>

![Main system figures](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Table_3.1.png)

上文中的交易系统显示了趋势跟随交易策略的主要属性:

* 盈利交易百分比较低(36.5%). 在 1913 笔交易中, 只有 698 笔是盈利的, 大部分(1215)以亏损结束.
* 系统的整体收益来自于较高的 "平均盈利/平均亏损" 比值. 交易平均盈利为 846 美元, 比平均亏损(435 美元)高出两倍.
* 盈利交易的平均时间(所有盈利花费的时间/盈利交易的数量)约为亏损交易平均时间的三倍(62 个柱比上 24 个柱).

这些属性表明系统逻辑可能遵循了交易中最重要的规则, 每个人都知道但仍然难以遵守, 那就是 "减少亏损并让利润奔跑". 这种交易规则在心理上很难坚持, 因为你经常会直接遭受损失(减少损失意味着砍仓止损), 另一方面在你能够获得罕见而巨额的收益前, 你不得不等待很长时间.

值得一提的是, 系统做多比做空赚取的利润更多(56,900 美元对比 9,400 美元). 当我们在 讨论所谓的 5.3 章讨论 "**市场偏见(market bias)**" 时, 将继续讨论这一观察结果. "市场偏见" 意味着市场动向倾向于支持交易系统的指定功能或部分, 例如在这种情况下, 在被测市场处于总体上升趋势时, 趋势跟踪系统的做多机制会有更好的盈利能力. 我们的交易系统的优点在于, 虽然存在上升趋势的市场偏见, 但是交易系统的做空交易仍是盈利的. 这凸显了这种对称构建系统的稳定性.

此外, 因为交易系统仅反转头寸, 做多交易(957)与做空交易(956)的数量必然相同. 由于我们没有添加任何退出机制, 系统始终待在市场中, 持有多头或空头头寸.

<p align="left" style="color:red;"><font size=5><b>注: 反转意味着用做空交易直接代替做多, 反过来也一样, 同时将反转视为前一笔做空/做多交易的平仓.</b></font></p>

最后, 我们想强调一个在开发交易系统时永远不应低估的事实: 执行测试的统计意义. 如果您开发一个新系统并且在测试中您只有 100 个信号(交易信号, 可以理解为 100 笔交易), 甚至更少, 那么有很大可能这些盈利仅仅是偶然的. 在我们的回测中有近 2000 笔交易, 意味着该策略在未来(较近时段)稳定发挥的统计概率很高.

那么到目前为止你获得了什么? 统计数据表明, 入场逻辑是合理的, 并且具有较大可能在未来保持其行为一致. 但是, 如果您仔细查看交易数据, 您会发现该系统仅产生 35 美元的平均利润; 在不计任何交易成本前提下, 这样的 "每笔交易平均利润" 水平非常低! 所以到目前为止, 你拥有的只是一个能够检测出价格间微小利润的交易规则.

因此, 我们现在处于交易系统开发工作的起步阶段 在您完成一个完整的交易系统之前, 还需要执行许多步骤. 必须增加该系统的盈利能力, 并且必须增加退出机制. 在我们这样做之前, 我们先考虑交易成本, 使整个实现更加接近现实中的情况.

#### Calculation after adding slippage and commissions

从上面提到的 35 美元的交易平均利润中扣除 5 美元的佣金和 25 美元的滑点(总共三个点)后, 每笔交易的平均利润仅为 5 美元. 详细的权益曲线和下降图显示了这种更真实计算的结果(图 3.3). 虽然权益曲线正在横向移动并出现大量波动, 但水下权益曲线显示出大幅下降(高达 15%), 并且交易系统要花费很长时间才能从这些下降中恢复.

<p align="left"><font size=2>Figure 3.3: Result of the trading system LUXOR with added $30 slippage and commission per round turn. A: Detailed equity curve; B: Underwater equity curve. British pound/US dollar(FOREX), 30 minute bars, 21/10/2002-4/7/2008. Input parameters: SLOW=30, FAST=10. System without exits, always in the market. Chart from TradeStation 8.</font></p>

![Detailed Equity Curve With Slippage & Commissions](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.3.png)

LUXOR 交易系统现在看起来似乎毫无希望. 使用这个系统, 你与目标 - "在英镑/美元外汇市场上获利" 还有很大一段距离. 但请记住, 我们刚刚只是随意选择了两个输入参数, 它们可能是不合适的. 现在必须回答的关键问题是:这个交易系统是完全无用呢, 还是仅仅因为选择了错误的输入参数?

要回答这个问题, 需要基于多个不同的输入参数继续进行系统测试. 为了准备好这些测试, 同时也为了避免一些陷阱, 我们首先要解释清楚, 当我们执行这样的优化时我们真正寻找的是什么.

### 3.3 Variation of the input parameters: optimisation and stability diagrams

----------

#### What does stability of a system’s input parameter mean? A short theoretical excursion

在你开发一个交易系统时, 优化可以成为您最好的朋友, 也可以变成你最大的敌人. 重要的是, 当您改变系统的某些输入参数时, 您总是明白自己正在做什么. 请记住, 每个交易系统都是优化的结果. 当您选择系统参数时, 您是在比较不同的参数后才选择了它, 那是因为它在数据集上展示出一种特别的行为, 而您确信这种特别的行为在未来会继续保持. 即使您在淘汰其他类似的交易系统时没有调整任何输入参数, 但是胜出和被淘汰的交易系统本质上都是通过使用计算机 "事后" 优化输入参数的方式来完成的.

悬而未决的问题仍然存在: 系统的开发和选择参数阶段何时结束以及系统的优化何时开始? 由于这两个问题永远不可能完全分离, 最好接受这样一个事实: 每个交易系统都以某种方式适应过去, 因而也就进行了优化.(优化也是基于已有数据) 因此, 对于系统开发人员来说关键问题始终是: 您在回测中选择哪个参数? 哪些设置更有可能在未来的交易继续产生真实利润? 这个问题的答案对于每个交易系统都是不同的, 但是一条规则是通用的: 当您使用系统参数的邻近数字作为参数时, 交易系统的盈利必须和采用原参数时差不多, 并且满足上述条件的参数范围越大越好. Murray Ruggiero 是一位经验丰富的专业交易系统开发人员, 他有关此主题撰写了一篇文章[7]:

>"如果你不喜欢相邻的数字, 你就会遇到问题, 因为有很大可能你会在相邻参数集上栽跟头."

让我们看一个例子(图 3.4), 我们在其中检查假想系统的输出结果, 为了找出能让系统稳定的输入参数. 在横轴上您可以看到此假设系统有一个输入参数, 这个参数可以是任何值, 移动平均值, 止损或止盈目标的距离. 延迟时间等. 净利润与系统参数的关系可以用函数来表示, 您可以在垂直轴上找到以任意单位表示的净利润.

就净利润而言, 该人工交易系统的最佳输入参数是 17. 使用此参数时, 系统获得 80,000 单位的盈利. 但是看看它的邻居. 在邻域中, 当参数是 16 时, 系统的利润非常差(5000 单位), 当参数是 18 时, 甚至会造成损失(-10,000 单位). 如果您参与的市场在未来稍有变化, 您将永远无法再次获得在回测中使用参数 17 显示的良好利润. 因此, 尽管在这个假设系统中 17 是 "过去" 最好的参数, 但它肯定不是您未来的最佳选择.

但是, 如果您在 4 到 10 之间的区间中选择一个参数, 例如 8, 你会处于更安全的区域. 在该区域中, 您的回测净利润不如您采用最佳拟合参数(17)时高, 但邻域中的参数与您选择的参数相比, 回测净利润是差不多的, 利润在 60,000 单位上下波动. 如果未来市场发生变化, 您的交易系统参数如果采用 8 或 4 到 10 区间内的其他值, 很大可能产生的利润与回测时相似. 因此, 你应该选择的是表现良好(不一定是最好的!)且在领域上表现出泛化能力的参数.

<p align="left"><font size=2>Figure 3.4: Choosing stable parameters for your trading system: Net profit as a function of one system input parameter in arbitrary units. Artificially generated result of a hypothetical trading system.</font></p>

![Choosing stable parameters for your trading system](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.4.png)

#### Dependency of main system figures on the two moving averages

从理论回归现实. 让我们来看看我们的交易系统 LUXOR 在改变两个输入参数后的表现, 每笔交易包含 30 美元的滑点和佣金成本. 我们希望看到当快速和慢速移动平均线的长度变化时, 趋势跟踪交易系统的结果会如何变化. 我们将在较大的范围内改变两个平均值, 快速移动平均线的长度从 1 个柱到 20 个柱, 步长为 1, 慢速移动平均线的长度从 21 个柱到 80 个柱, 步长同样为 1. 一台快速的 PC 大概需要三分钟完成所有 1200 次系统测试.

从这些测试中, 您可以认为总净利润是两个不同输入参数的函数, 然后绘制到图上. 您可以分别为每个输入参数执行此操作(如图 3.4 所示), 但您也可以在一个三维区域图中为两个系统参数执行此操作(图 3.5). 这样您可以得到一个三维面, 向您展示输入参数如何影响交易系统结果. 使用指定的软件, 您甚至可以在每个方向上转动这个三维面, 并从不同的角度查看. 图 3.5 A 和 3.5 B 显示了不同视角下的相同图形. 图 3.5 A 显示了侧面, 图 3.5 B 显示了俯视图. 从这两个图中可以看出, 交易系统在很大的输入参数范围(深蓝色区域)内都可以盈利, 但在其他参数设置范围内(黄色, 绿色和浅蓝色区域)只有微薄的利润, 甚至会产生亏损.

<p align="left"><font size=2>Figure 3.5: Three-dimensional area diagrams for all trades of the system LUXOR. a) side view, b) top view. Net profit in US dollars as a function of the two input parameters: fast and slow moving average. Tested on British pound/US dollar (FOREX), 30 minute bars, 21/10/2002-4/7/2008, incl. $30 S+C per RT. Diagrams generated with RINA 3D Smart View.</font></p>

![Three-dimensional area diagrams](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.5.png)

当然, 我们正在寻找的是能够在过去产生高净利润的输入参数. 但是如图 3.4 所示, 对于系统参数来说更重要的是, 在它们附近有足够的同等参数, 使得交易系统的盈利几乎与采用 "最佳" 参数时一样. 在我们开发的交易系统中, 到目前为止, 右下方的整个区域(图 3.5 B)乍一看似乎满足了这一要求. 我们现在将放大镜对准这个较短的区域并对其进行仔细研究(图 3.6 A-D). 从这些图表中可以看出, 系统对所选区域中的参数变化并不敏感, 始终保持了较稳定的收益. 尽管总净利润在相对较大的范围内变化剧烈(在 20,000 美元到 100,000 美元之间), 但对于所有选定区域中的输入参数, 它毫无疑问的保持了盈利. 当快速移动平均线非常小(小于 3)且慢速移动平均线在 30-50 之间时, 选定区域实现了近 100,000 美元的最佳利润. 该区域也对应了最小的 "盘中最大跌幅"(见图 3.6 B), 约为 15,000 美元. 在所有参数中, 最大盘中跌幅确实变化很大, 但从未越限 - 它总是低于约 35,000 美元.

<p align="left" style="color:red;"><font size=5><b>注: 同等参数指能够让交易系统与所选参数产生类似净利润的参数.</b></font></p>

与 "总净利润" 和 "最大日内亏损" 一样, 您可以将更重要的统计数据绘制为两个输入参数的函数(图 3.6 C 和 D). 如果您这样做, 您可以进一步了解您的交易系统. 例如, 如果您观察 "系统的交易总数"(图 3.6 D), 您会一个存在于许多趋势跟踪系统中的事实, 那就是: 您响应的速度越慢(在我们的例子中, 这意味着两条移动平均线的周期越长), 系统的交易量越少. 通过改变系统的输入参数, 您可以影响某些关键属性, 从而使系统可以更好地匹配您的交易方式或大型投资组合中资金管理方案的要求. 假设您的投资组合中有许多快速反应系统, 需要一些反应迟缓的组件 - 您可以通过为移动平均线设置更长的回溯周期来实现这一点. 如果您需要更快速的反应系统, 则可以将输入参数更小. 当不同交易系统及其不同的时间尺度之间的相关性变得重要时, 我们将在我们的投资组合构建部分回顾这一结论.

有趣的是, 在我们的交易系统中, 虽然交易数量随着系统的输入参数变化巨大, 但另一个交易数据 "每笔交易的平均利润" 却保持了相对稳定(图 3.6 C). 它在 10 美元到 50 美元之间变化, 但大多数时间位于 30 美元到 40 美元之间, 特别是对于 1 到 9 之间的所有快速移动平均线与 30 到 50 之间的慢速移动平均线构成的系统.

根据这些结果, 您可以得出结论, "好的" 系统参数将是包括瞬时反应的快速移动平均值(小于 3)和 30 到 50 之间的慢速移动平均线. 让我们将值 "1" 作为快速移动平均值的输入值. 很明显, 单周期移动平均线不是真正的移动平均线, 但为了简单起见, 我们仍然将其称为移动平均线. 事实上, 快速移动平均线本身就是收盘价. 对于较慢的均线, 您可以选择 30 到 50 之间的任何值. 我们在此选择 44 作为输入值, 因为它产生最高的总净利润并且具有广阔的同等参数邻域。

当然, 您应该在接下来的几个月内密切观察系统的行为, 如果经过较长时间的筛选后发现所选参数(1/44)不是最稳定的选择, 那么您必须更改它们, 例如 3/30(如果这些参数证明比最初选择的 1/44 更稳定). 这种参数变化是重新优化的一个例子. 您将在第 6 章中找到关于 "周期重新优化" 和 "前向优化"(walk forward optimisation)的更系统的方法.  目前我们保持参数 1(快速均线) 和 44(慢速均线), 我们将仔细研究交易系统的表现.

<p align="left"><font size=2>Figure 3.6: Three-dimensional area diagrams for all trades of the trading system LUXOR. Main system figures as a function of the two input parameters: fast and slow moving average. Tested on British pound/US dollar (FOREX), 30 minute bars, 21/10/2002-4/7/2008, including $30 S+C per RT. A: net profit B: maximum intraday drawdown C: average trade net profit D: number of total trades generated. Diagrams generated with RINA 3D Smart View.</font></p>

![Three-dimensional area diagrams A](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.6_A.png)
![Three-dimensional area diagrams B](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.6_B.png)
![Three-dimensional area diagrams C](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.6_C.png)
![Three-dimensional area diagrams D](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.6_D.png)

#### Result with optimised input values

随着将快速均线设置为 1 个柱(等于收盘价)而慢速均线设置为 44 个柱, 您将获得稳定增长的收益曲线(图 3.7 A). 这一结果通过水下权益曲线得到证实, 该曲线在每次下降后总是迅速恢复(图 3.7 B). 最大的回撤发生在 2003 年 11 月, 值为 8%, 只有我们通过未优化的输入参数(10/30)获得的超过 15% 的最大回撤的一半.

<p align="left"><font size=2>Figure 3.7: Trading system LUXOR, tested on British pound/US dollar (FOREX), 30 minute bars, 21/10/2002-4/7/2008. Optimised input parameters in terms of net profit: SLOW=44, FAST=1. System without exits, always in the arket, long or short. Back-test includes $30 slippage and commission. Chart from TradeStation 8. A: Detailed equity curve; B: Weekly underwater equity curve.</font></p>

![Optimised input parameters in terms of net profit](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.7.png)

<p align="left"><font size=2>Table 3.2: Main system figures of the trading system LUXOR. British pound/US dollar (FOREX), 30 minute bars, 21/10/2002-4/7/2008. Input parameters: SLOW=44, FAST=1. System without exits, always in the market. Back-test includes $30 slippage and commission per round turn.</font></p>

![Table 3.2](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Table_3.2.png)

尽管 LUXOR 系统的总体 "回报/亏损" 比率是可以接受的, 但仔细观察系统数据可以发现, 我们迄今为止开发的系统尚无法进行交易(表3.2). 尽管该系统显然是盈利的且交易系统表现稳健, 但 33 美元的平均交易利润仍然不算是有利可图.

此外, 因为平仓机制(exits)缺失, 系统不得不始终保持在场内. 因此, 这种状态下系统是不可用的, 因为与预期收益相比风险太高. 因此, 在接下来的两章中, 我们将进一步扩展我们的交易系统.

首先, 我们将寻找有用的日内时间过滤器, 以提高系统的盈利能力. 本章的最后一节将讨论添加必要的出口(exits).

### 3.4 Inserting an intraday time filter

历史上, 我们遇到过很多交易大师和赚钱的交易系统, 它们在交易日的不同阶段利用了金融市场的不同行为. 有些交易员和系统仅仅在下午使用短期突破策略盈利, 还有一些交易者和系统需要他们那缓慢的趋势跟踪策略运行一整夜后才能获利. "时间" 因素在您的交易策略中非常重要, 原因很简单, 即市场由人控制, 而人们则受到日常时间表的制约. 由于货币市场 24 小时交易, 当天的时间对于市场的行为而言特别重要. 大型美国做市商活跃与否, 是欧洲, 美国或亚洲的夜晚或白天, 都会使得市场表现有所不同. 每日外汇交易量清晰的显示了市场活动在每个交易日内发生了很大变化. 一些时段市场表现的很活跃, 因而有可能获得更高的利润, 另外一些时段市场风平浪静, 除了一些意外横向移动导致的市场噪音. 因此, 研究不同的时间过滤器如何改变交易系统的结果是很有价值的, 特别是在面对英镑和美元等货币市场时.

----------

#### Finding the best entry time

我们现在以下列方式执行系统测试. 我们采用已有的 LUXOR 入场点, 但我们将每天的入场时间限制为一个 4 小时的时间窗口. 我们将在一天中以 30 分钟为单位调整窗口的开始时间, 以便找到最佳窗口. (对于 Easy Language 程序员来说: 您必须在 LUXOR 代码中添加一些行, 如上所示, Text 3.1, point 2, Time Window Filter.)

图 3.8 显示了交易系统的总净利润与 4 小时时间窗口开始时间的函数关系. 结果非常重要! 您看到我们交易系统的利润很大程度上取决于所选择的时间窗口. 当您从格林威治标准时间(GMT)下午 5 点开始交易时, 交易系统会亏钱, 而在 GMT 白天时段, 尤其是早上 8 点到 12 点之间, 它可以获得高额利润.

<p align="left"><font size=2>Figure 3.8: Total Net Profit as a function of the entry time of a 4-hour time window. LUXOR system, tested on British pound/US dollar (FOREX), 30 minute bars, 21/10/2002-4/7/2008. SLOW=44, FAST=1. Calculation incl. $30 S+C per RT. No exits are in place.</font></p>

![Total Net Profit](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.8.png)

当您以 7.30 am 作为时间窗口的起点时, 交易系统获得了最高的净利润, 这意味着您只允许在早上 7:30 到上午 11:30 间入场和反手. 在上文关于输入参数的稳定性和稳健性的讨论中, 您已经知道, 所选系统参数具有表现良好且广泛的邻域非常重要. 这个邻域表明交易系统具有最高的可靠性, 实际交易中的表现奖符合其在反向测试中的结果. 因此, 我们将窗口的开始时间设置为上午 9:30 - 盈利参数区域的中间, 而不是在早上 7:30 的最有利可图的位置. 选择的时间过滤器意味着我们只允许在 GMT 上午 9:30 到下午 1:30 之间交易. 这是下午(格林尼治标准时间)来自美国的大量交易尚未到来的时候. 在一天开始的时候进入趋势, 之后通过美国的交易量来放大, 我们的交易系统看起来非常不错.

#### Result with added time filter

增加了时间过滤器后, 我们交易系统的详细权益曲线似乎没有太大变化(图 3.9 A). 相反, 看一下水下权益曲线就可以发现, 5 年交易中的回撤幅度从没加过滤器时的 8% 增加到了 10%. 此外, 我们修改后的交易系统现在需要更长时间才能从这些回撤中恢复. 那么我们从过滤器中获得了什么? 您可以仔细查看交易数据来评估时间过滤器的影响. 如果你看一下交易的数量, 你看到它们已经大幅减少到 902, 而系统之前生成了近 3000 笔交易. 比没有时间过滤器的 100,000 美元, 总净利润略微增加到 115,000 美元, 这些推导出了一个结论, 对于使用系统来说非常重要:

现在每笔交易的平均利润为 128 美元(包括 30 美元的滑点和佣金), 相比之前在全天候交易时获得的少得可怜的 33 美元利润, 这是一个四倍的改进!

<p align="left"><font size=2>Figure 3.9: LUXOR system results with added time filter. Entries only allowed in the 4-hour time window from 9.30am–1.30pm GMT. A: detailed equity curve. B: weekly underwater equity curve. British pound/US dollar (FOREX), 30 minute bars, 21/10/2002-4/7/2008. Optimised input parameters in terms of net profit: SLOW=44, FAST=1. Test without exits. Back-test includes $30 slippage and commission. Charts from TradeStation 8.</font></p>

![LUXOR system results with added time filter](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.9.png)

<p align="left"><font size=2>Table 3.3: Main system figures of the LUXOR system with added time filter: Entries only allowed in the 4-hour time window from 9.30am– 1.30pm GMT. British pound/US dollar(FOREX), 30 minute bars, 21/10/2002-4/7/2008. Optimised input parameters: SLOW=44, FAST=1. System without exits, always in the market, long or short. Back-test includes $30 slippage and commission.</font></p>

![Table 3.3](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Table_3.3.png)

但是, 尽管有这些令人振奋的交易数据, 该系统仍有一些明显的弱点.

正如我们已经提到的那样, 回撤幅度轻微增大 - 最大回撤为 18,900 美元, 而之前为 13,400 美元. 但是回撤增大以及交易系统权益不像以前那样稳定的事实并不是新系统最糟糕的特征. 当前状态下交易系统的弱点在于它真的很危险, 因为交易只能在格林尼治标准时间上午 9:30 到下午 1:30 之间的 4 小时窗口内进行. 如果在此窗口之外得到反转信号, 例如在格林威治标准时间凌晨 1 点, 由于不允许交易，系统无法退出或反手持有的仓位. 在您的交易窗口之外, 无论发生什么, 您都必须在市场上停留 20 个小时. 因为窗口的限制, 系统肯定不可能像以前一样一直交易, 但是考虑到无论窗口期外行情有何发展, 您都不得不在市场上发呆 20 个小时, 系统在这种情况下会有过高风险. 我们不得不紧急添加退出来改变这种情况. 通过添加退出, 我们不仅要创建一个能够盈利的交易系统, 还要创建一个风险可控的交易系统.

### 3.5 Determination of appropriate exits – risk management

----------

> 以这种方式看待它: 你的交易系统是类似一个从屁股上射击的快枪手(随时应战), 还是像一个为了伏击而埋伏好的狙击手，了解你的交易走向何方, 决定了
> 你是骑在马上享受落日美景(暗示胜利), 还是重伤后倒在正午尘土飞扬的街道上(暗示失败). 为了活着, 你必须知道什么时候撤退, 什么时候前进.
> Thomas Stridsman

每个人都知道止损(stops)是必要的, 但没有人真正喜欢它们. 通常你会感觉到止损(stops)只是在市场转向你的方向之前就把你赶出了市场, 结果是让你错过重大行情.

<p align="left" style="color:red;"><font size=5><b>注: 平仓(close position) 入场(Entry) 退出(Exit) 止损(Stop Loss) 止盈(Stop-Profit).</b></font></p>

在本节中, 我们使用统计研究方法来探讨量化出口. 在我们过去的所有统计探索过程中, 很明显的一个结论是, 出场永远不能独立于相关的入场. 重要的是要意识到, 入场的动态对于有效出场的动态, 甚至是仓位的反转都有着重大的影响. 想象一下, 进入一个安静的, 没有波动的低成交量市场，并将其与在市场活跃阶段触发的入场进行比较, 例如 "新闻触发的突破"(图 3.10). 在第一种情况下, 市场横向移动而没有明显方向, 最好以近期利润目标(close profit target)获利出场. 在第二种情况下, 一个宽泛的止损点加上不设置止盈点位, 这两个出口将为交易提供足够的发展空间. 过于接近(入场价位)的每个止盈点位或止损点位都会让您过早地退出盈利的交易. 在这种情况下, "最优" 的退出将是发生在 "大笔交易减少且突破已经明显结束时" 的日末退出.

<p align="left" style="color:red;"><font size=5><b>注: "入场的动态对于有效出场的动态, 甚至是仓位的反转都有着重大的影响", 这里的意思应该是不能仅仅看点位, 入场点位与入场时的市场走向应该放在一起看, 将在后面决定在何种走势下的哪个点位出场.</b></font></p>

出于这个原因, 我们不建议使用人工生成的合约测试出口, 例如: 随机入场或在每个交易日开盘时入场. 我们发现使用这些随机入场点会将统计结果导向歧途. 测试结果(最优出口)总是被常见的市场走势把持(出口更多的是与市场走势相关), 并没有与你指定的市场策略相匹配.

<p align="left"><font size=2>Figure 3.10: The Dynamic of Exits. In the phase of low volume and low volatility different exits are needed than in the phase of increasing volume with the short breakout. Chart example was taken from Light Crude Oil, 5 minute, NYMEX from 22 August 2008. Chart and datafeed from TradeStation 8.</font></p>

![The Dynamic of Exits](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.10.png)

没有放之四海而皆准的最优出口! 如果您使用的是其他类型的系统或在其他时间尺度上, 则无法直接转换现有出口来匹配新的入口逻辑. 当然, 您可以将这些已有的出口作为大致的方向, 但您必须花时间基于不同的入口或时间尺度来开发合适的出口.

为了找到上述策略的适当出口, 我们将对统计领域进行一次小规模的纵览. 我们分析单笔交易的过程, 以确定可用的止损水平和利润目标. 这个分析在开始时看起来有点异国情调. 但是, 只要您熟悉它, 您就会对您的交易系统及其适用的出口有一个很好的理解.

#### The concept of Maximum Adverse Excursion (MAE 最大逆向偏移)

为了找到适合您系统的止损点, 您应该深入了解交易的分布并单独检查每笔交易. 当你这样做时, 你会发现它们之间既有相似之处, 也有自己的一套特征. 这些特征可以通过使用 John Sweeney 在不到十年前开发的最大逆向偏移(MAE)技术来检验. MAE 被定义为相对您的头寸的最大日内反向价格变动. 换句话说, 它是单笔交易在生命周期中的最低权益. MAE 概念允许您评估系统的个别交易, 从而决定将保护性止损设置在哪个价位或百分比.

让我们来看看我们交易系统的 MAE 图形(图 3.11). 该图显示了在测试期内产生的所有 902 笔交易. 对于每笔交易, 您都可以查看与每笔已实现的损益相关的亏损. 获利交易显示为绿色向上箭头, 亏损交易显示为红色向下箭头. 在 MAE 图的垂直 y 轴上, 您可以看到最终的利润, 而水平的 x 轴则显示每笔交易的日内亏损.

由于我们使用此图形来确定止损位置, 因此我们将所有盈利和亏损交易放在同一个集群图上. 这意味着虽然图 3.11 中交易 A 和 B 看起来相似, 但是实际上它们是完全不同的. 交易 A 最大亏损是 2400 美元, 平仓亏损 1000 美元. 另一方面, 交易 B 遭受了更大幅度的 2500 美元的缩减, 但最终恢复并以 1000 美元的收益平仓. 沿 y 轴指示的美元金额是利润还是损失取决于小三角形的颜色和方向. 保持交易聚集在同一图表上可以更容易地判断在通常情况下, 一笔交易在最终确认亏损前通常会产生多少权益上的损失. 通过这种方式, MAE 图形可以告诉您何时止损, 因为与交易相关的风险变得不再合理. 这为您确定保护性止损位置提供了有价值的指示.

<p align="left"><font size=2>Figure 3.11: The MAE graph of LUXOR system. Green: winning trades, red: losing trades. System tested on British pound/US dollar (FOREX), 30 minute bars, 21/10/2002-4/7/2008, with entry time window 9.30am-1.30pm GMT. Input parameters SLOW=44, FAST=1. Without exits, always in the market, including $30 S+C per RT. Diagram created with TradeStation 8.</font></p>

![The MAE graph of LUXOR system](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.11.png)

为了确定止损位置, 我们以百分比单位展示相同的 MAE 图(图 3.12 A). 我们切换到百分比单位, 因为相对于美元单位, 百分比可以更好地适应不断变化的市场条件. 特别是在具有巨大点位变化的市场上, 基于百分比计算的优势变得显而易见. 在这种情况下, 最好灵活的选择匹配当前市场价位的出口, 而不是死板的保持固定点位.

<p align="left"><font size=2>Figure 3.12A: MAE graph in percentage terms. Green up arrows = winning trades, red down arrows = losing trades. Trend-following system British pound/US dollar (FOREX), 30 minute bars, 21/10/2002-4/7/2008, with entry time window 9.30am-1.30pm GMT. Input parameters SLOW=44, FAST=1. Without exits, always in the market, including $30 S+C per RT. Diagram created with TradeStation 8.</font></p>

![MAE graph in percentage terms](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.12_A.png)

<p align="left"><font size=2>Figure 3.12B: Maximum Adverse Excursion graph in percentage terms after inserting a 0.3% stop loss into the system. LUXOR system tested on British pound/US dollar (FOREX), 30 minute bars, 21/10/2002-4/7/2008, with entry time window 9.30am-1.30pm GMT. Input parameters SLOW=44, FAST=1. Diagram created with TradeStation 8.</font></p>

![Maximum Adverse Excursion graph in percentage terms](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.12_B.png)

为了熟悉 MAE., 让我们简单解释 MAE 图中的一些交易. 首先你看到上面提到的交易 A 和 B 的相对位置发生了变化. 由于两笔交易发生不同时间, 对应的市场成交价也不同, 因此交易 A 现在处于 y 方向的较高位置. 由于现在计算基于相关市场的百分比, 因此相同的美元值通常意味着不同的百分比值.

在 MAE 图中观察所有这 902 笔交易时, 您可以看到交易系统的一些特征. 第一点是, 在图表的左侧, 您会发现盈利的交易比亏损交易更多. 这很明显, 因为盈利交易通常不会像亏损交易那样遭受如此大的亏损. 对你而言, "最好" 交易显然是那些表现如同交易 C 那样的交易 - 一开始就盈利, 在其生命周期中不会承受任何负面权益敞口, 并且位于靠近图表 y 轴的最左侧(盈利/亏损轴).

<p align="left" style="color:red;"><font size=5><b>注: 权益敞口(open equity), 指账面上存在但未最终实现的盈利或亏损.</b></font></p>

另一个有趣的交易领域是我们所谓的 "**亏损对角线**"(loss diagonal). 在这条特征线上你可以找到很多亏损的交易. 像交易 D 一样, 所有这些交易都以亏损结束, 同时平仓亏损也是他们的最大亏损. 另一方面, 也存在像 E 这样的交易. 该交易在入场点大幅下跌超过 3.5%, 但最终平仓损失确恢复到仅有约 0.5%.

现在, 为了限制交易风险, 我们希望在距离入口点的特定距离(市场价格百分比)处设置保护性止损. MAE 图如何帮助您确定入场点到止损点的距离?

让我们先看看 MAE 图, 它可以帮助你理解插入的止损点对于你的交易系统来说有啥作用.

MAE 图中的止损可以绘制为垂直线. 从理论上讲, 这条垂直线会干掉所有在入场后遭受的损失大于止损的交易(图 3.12 B). 在 MAE 图中, 这意味着止损拦住了 0.3% 线右侧的所有交易, 并将其移亏损移到该线附近. 对于因为止损而亏损变小的所有交易(红点)而言, 这听起来不错. 但想想那些盈利的交易, 一旦他们到达止损线后便永远没有机会成为赢利交易, 取而代之的是变成图表中的红点, 亏损 0.3%.

<p align="left" style="color:red;"><font size=5><b>注: 不能一刀切</b></font></p>

我们试图将止损放在这样一个区域, 既能捕获大多数盈利的交易, 同时也能限制策略的利润侵蚀风险. 显然, 好的止损设置是在不影响盈利的交易, 或者至少是那些能够从最低点恢复的交易的前提下, 将尽可能多的(亏损)交易终结在亏损对角线上.

所以问题是如果你让止损小于 0.6%, 比如说 0.4%, 0.3% 甚至 0.1% 会发生什么? 显然, 你会越来越多地进行以亏损对角线结束的交易, 并且止损在尽早的将它们平仓方面做得很好. 但是你将止损线向左侧移动的越多, 你所终止的特定类型的交易就越多, 那些交易能够从最大亏损中恢复, 甚至能够以盈利的状态平仓.

#### Inserting a risk stop loss

在 MAE 图中, 您可以看到所有交易的表现, 以及在寻找合适的风险止损点位的时候是否有特殊的点需要考虑. MAE 图可以提示 "最优" 止损值介于 0.2% 和 1% 之间. 但是, MAE 不会直接告诉您最优止损点的具体点位. 出于这个原因, 我们现在通过如下方式执行系统测试, 尝试从另一面来审视这个任务. 我们在交易系统中添加风险止损, 并以 0.01% 的步进在 0.01% 到 1% 的范围内改变止损点与交易入口点的距离. 在撰写本文时, 英镑的交易价格接近 2.00 美元, 按照这个速度, 1% 的止损距离相当于 2 美分. 换句话说, 2 美分是 200 点, 等同于钱包中的 2000 美元. 因此, 在这个市场条件下, 0.01% 的精细步骤意味着 0.02 美分或 2 个点( 20 美元).

<p align="left"><font size=2>Figure 3.13: Ratio of total net profit/maximum intraday drawdown as a function of the stop loss distance in per cent. LUXOR system tested on British pound/US dollar (FOREX), 30 minute bars, 21/10/2002-4/7/2008, with entry time window 9.30am-1.30pm GMT. SLOW=44, FAST=1. Including $30 S+C per RT.</font></p>

![Ratio of total net profit](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.13.png)

测试给出了每个止损水平的重要统计数据: 净利润, 最大回撤, 最大交易亏损等. 您可以根据设定的止损距离绘制这些数据的图表. 我们在图中绘制了 "总净利润/最大亏损"(NP/DD)的比值, 见图 3.13. 我们没有只考虑总净利润, 是因为它没有告诉您有关系统风险的更多信息, 而 NP/DD 比率则给出了有意义的估算. 让我们看一下所有交易相对于止损距离的 "总净利润/最大亏损" 值. 该图表告诉您, 定位过于靠近区间左侧的止损点会大幅降低 NP/ DD 比值. 很明显, 许多交易一开始时就被终止, 低风险下滑点和佣金将吃掉微小的盈利.

当距离越来越大时, 系统盈利能力变得越强, 但是对于低于 0.15% 的所有止损距离, NP/DD 比值持续降低并且始终低于没有止损机制的突破交易系统. 但是, 如果您将止损点设置为远离入口点, 并给交易更多的空间来发展, NP/DD 将获得的良好改进. 在 0.2-0.5% 的范围内, 任何增加的止损距离都会增加基本系统的 "回报/风险" 比值. 因此, 我们可以选择 0.3% 的止损作为可用距离 - 该值位于此稳定参数区域的中间. 在英镑兑美元汇率为 2 美元时, 0.3% 相当于 60 点或 600 美元. 值得一提的是, 您无法找到一个止损水平, 能够提高每个交易系统或整个市场的整体净利润. 通常情况下, 止损所带来的界限会让利润减少, 特别是在波动较大的市场中(例如标准普尔 500 指数或富时 100 指数等股指期货).

让我们简要了解 0.3% 风险止损如何影响我们交易系统(图 3.14 A 和 B). 详细的权益曲线似乎没有太大变化. 系统数据证实了交易系统的盈利能力几乎没有变化(表 3.4, 左侧两列). 总净利润得到改善, 止损仅从 115,000 美元小幅上涨不到 1% 至 116,000 美元, 而交易平均净利润则从 128 美元下降至 113 美元.

因此可以得出结论, 交易系统的盈利能力没有随着插入的止损变化. 但是, 让我们检查系统的风险现在是否受到更好的控制.

<p align="left"><font size=2>Figure 3.14A: Detailed equity curve, B: underwater equity curve with 0.3% risk stop loss in place. LUXOR system tested on British pound/US dollar (FOREX), 30 minute bars, 21/10/2002-4/7/2008, with entry time window 9.30am-1.30pm GMT. SLOW=44, FAST=1. Including 30 $ S+C per RT. Charts from TradeStation 8.</font></p>

![Detailed equity curve](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.14_A.png)

![underwater equity curve](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.14_B.png)

从水下权益曲线可以看出, 交易系统的最大回撤现在从 10% 降至 5%(比较图 3.14 B 和 3.9 B). 查看交易数据证实了这一观察结果(表 3.4).

在插入风险止损后, 最大日内峰谷回撤幅度从 18,894 美元大幅减少至 11,266 美元. 更重要的是, 相对于没有止损的系统时, 最大交易亏损从超过 2500 美元减少到 810 美元. 这种接近初始值三分之一的显著减少可以帮助你控制风险, 特别是在使用该系统交易大型投资组合的多个批次的时候. 您可能会问为什么最大交易亏损没有减少到大约 600 美元, 这相当于我们的止损设定的当前市场价值的 0.3%. 原因是行情跳空缺口(gap)没有让系统以指定的止损价格执行交易, 而是在更坏的价格 - 250 美元上成交. 虽然这种不良执行是微不足道的, 在 1000 次交易中通常发生的次数少于 10 次, 并且远小于 30 美元的滑点和佣金, 但您必须记住, 这种情况在每次交易中都有可能发生. 最后, 我们想指出系统的市场风险(market exposure)在插入止损后首次降低. 虽然没有任何退出机制, 且系统时刻保持在线, 但这种风险敞口现在降低到 73%. 剩余的 27% 的时间, 系统未处于活动状态, 可将资金投入其他地方或赚取利息.

<p align="left" style="color:red;"><font size=5><b>注: 行情跳空缺口(gap). <br> 市场风险(market exposure)是指未来市场价格的不确定性对企业实现其既定目标的不利影响. <br> 风险敞口(risk exposure)这里指可能导致亏损的交易时段, 显然只要交易就有可能亏损, 所以这里等同于交易时段. </b></font></p>

#### Adding a trailing stop

<p align="left" style="color:red;"><font size=5><b>注: 移动止损(trailing stop)</b></font></p>

移动止损是适应当前市场价格的止损单. 在新开多头头寸的情况下, 它最初设定为低于入场价格的固定百分比. 如果市场价格上涨, 移动止损价格按比例上涨, 但是如果价格下跌, 移动止损价格则不会改变(图 3.15 A).

<p align="left"><font size=2>Figure 3.15A: The principle of a trailing stop. Chart example from British pound/US dollar (FOREX), 30 minute bars, September 2008. Chart from TradeStation 8</font></p>

![The principle of a trailing stop](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.15_A.png)

空头头寸的移动止损类似. 此技术允许您在设置最大可能亏损限制的同时, 不对最大可能盈利造成影响. 接下来, 我们在现有的交易系统中添加移动止损. 在寻找合适的移动止损距离时, 我们保持 0.3% 的初始风险止损(initial risk stop). 如上一节所述, 初始风险止损的职责是控制最大亏损, 新增的移动止损旨在尽可能的保留利润而不是失去它.

如果添加移动止损并以 0.01% 的步长将其从 0.01% 变化到 1.5%, 则可以绘制 NP/DD 的比值作为移动止损距离的函数(图 3.15 B). 与风险止损类似, 微小的移动止损削减了太多的利润, 因为它们没有给交易足够的发展空间. 特别是, 所有低于 0.2% 的移动止损值都会导致一场灾难. 然而, 从 0.2% 到 0.5%, 系统盈利稳定地增加, 在 0.5% 和 1% 之间, 你会发现一个广阔的移动止损参数区域, 可以增加系统的 NP/DD 比率. 如果您将移动止损设置得更大一点, 那么 NP/DD 比率会收敛到没有加入移动止损之前的状态, 止损距离变得如此之大, 以至于很少交易受其影响.

<p align="left"><font size=2>Figure 3.15B: Ratio of total net profit/maximum intraday drawdown as a function of the distance of an added trailing stop. Risk stop loss of 0.3% kept in place. LUXOR system tested on British pound/US dollar (FOREX), 30 minute bars, 21/10/2002-4/7/2008, with entry time window 9.30am-1.30pm GMT. SLOW=44, FAST=1. Including $30 S+C per RT.</font></p>

![Ratio of total net profit/maximum intraday drawdown](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.15_B.png)

值得一提的是, NP/DD 比值(图 3.15 B)非常稳定. 在 0.5% 和 1% 之间, 您会发现一个广泛的区域, 可以产生相近的 NP/DD 结果. 这增加了进行过的测试对于实际交易具有高预测能力的可能性. 交易数据(表格 3.4)显示, 0.8% 的移动止损(在盈利参数区域中间)能够改善系统, 特别是在盈利能力方面. 通过加入的移动止损, 总净利润可以从 116,209 美元增加到 126,772 美元, 增幅接近 10%. 每笔交易的平均利润从 113 美元增加到 122 美元, 增幅大致相同. 增加的移动止损也略微改善了风险数据. 交易系统的最大亏损额从 11,266 美元进一步下降至 10,292 美元, 入场时间比率现在也略微降低(69.98%, 而此前为 73.56%).

有了两种类型的止损, 我们现在将检查加入的利润目标是否会进一步改善交易系统.

#### Looking for profit targets: Maximum Favourable Excursion(MFE)

John Sweeney 的 MFE 概念是对 MAE 的补充. MFE 被定义为您头寸的最大正向价格变动. 因此, 它对应于交易生命周期内的敞口资产的最高位. 虽然 MAE 对于研究您的交易回撤和设置良好的止损非常有用, 但 MFE 揭示了交易的最大市值并有助于找到有用的止盈目标(图 3.16).

<p align="left" style="color:red;"><font size=5><b>注: MFE 度量可从指定交易中获取的最大利润.  MAE 减小亏损(针对亏损交易止损), MFE 增大利润(针对盈利交易止盈). </b></font></p>

<p align="left"><font size=2>Figure 3.16: The MFE graph shows the realised profit/loss vs. run-ups of all trades. Green: winning trades, red: losing trades. LUXOR system tested on British pound/US dollar (FOREX), 30 minute bars, 21/10/2002-4/7/2008, with 0.3% risk stop and 0.8% trailing stop. Input parameters SLOW=44, FAST=1, including $30 S+C per RT. Diagram created with TradeStation 8.</font></p>

![The MFE graph shows the realised profit/loss vs. run-ups of all trades](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.16.png)

与 MAE 一样, 交易的最终利润(或亏损)显示在垂直方向的 y 轴上. 输赢的交易再次在同一轴上绘制, 只是颜色不同(绿点=盈利交易, 红点=亏损交易). 但与 MAE 图形成对比的是, 在 MFE 图中, 水平 x 轴表示最大市值(run-up), 这意味着交易在其生命周期中获得的最高利润.

从拥有两个出口(止损= 0.3%, 移动止损= 0.8%)的趋势跟踪系统的 MFE 图中, 您可以发现以下特征:

大多数盈利交易分布在盈利对角线(win diagonal)附近, 这标志着交易以盘中最高涨幅平仓. 最大盈利交易就是一个典型的例子. 盘中一度上涨 4.5%, 平仓价接近该最高值, 最终盈利略高于 4%. 此外, MFE 图显示了我们在上一节中加入的 0.8% 移动止损的影响: 所有获利超过 0.8% 的交易都保持盈利 - 移动止损确保高利润交易无法完全逆转他们的方向. MFE 图还显示亏损交易(红点)主要停留在最左侧, 这意味着他们通常只经历了很小的上涨.

这些研究结果表明, 利润目标对于我们的趋势跟踪系统来说不是非常有效, 因为两个止损点已经在工作了. 如果亏损的交易从未获得大的利润, 并且获胜的交易没有显著改变他们的方向, 那么利润目标将是无效的. 加入的利润目标(止盈)无法在交易转向之前从市场找到一个点出场, 从而留下利润.

<p align="left" style="color:red;"><font size=5><b>注: 止盈是用在什么场景下呢, 主要还是波动巨大的交易, 但是风险止损会把这类交易剔除(先跌再涨), 移动止损(先涨再跌)一般来说会比盈利目标做的更好, 只有在很少部分的交易上, 止盈可能比移动止损做的更好(止盈 > 最高涨幅 - 移动止损), 所以止盈在有双止损(风险止损 + 移动止损)的系统上作用有限. </b></font></p>

让我们验证下这些发现是否可以支持进一步的计算机测试. 我们在采用两个止损的突破系统上, 加上利润目标. 如果利润达到市场价值的 x%, 盈利目标会立即对交易进行平仓(图 3.17). 该图显示, 利润目标设置太小时, 正如止损太小一样, 会降低交易系统的整体利润. 您设置的利润目标越小, 结果越差. 只有一小部分相当大的利润目标设置, 在 2% 左右(在英镑交易价格为 2 美元时, 等于 4 美分或 400 点, 或一个 4000 美元的合约)会让利润大于只有止损而没有利润目标的系统. 如果您将利润目标设置为 2.5% 以上, 则结果会与基本系统近似. MFE 图表显示, 这个利润非常高的领域只能不到 10% 的交易能达到. 因此, "通过利润目标离场" 对于我们在英镑/美元外汇市场的入场设置来说只有很小的作用.

<p align="left"><font size=2>Figure 3.17: Ratio of total net profit/maximum intraday drawdown as a function of the distance of an added profit target. Risk stop loss of 0.3% and trailing stop of 0.8% are kept in place during tests. LUXOR system tested on British pound/US dollar (FOREX), 30 minute bars, 21/10/2002-4/7/2008, with entry time window 9.30am-1.30pm GMT. SLOW=44, FAST=1. Including. $30 S+C per RT.</font></p>

![Ratio of total net profit/maximum intraday drawdown](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.17.png)

测试证实了 MFE 图表显示的内容: 我们无法预测突破将在多大程度上引领市场(突破后走势会持续多久, 运行至多高/低). 因此, 除了距入场点约 1.8% 至 2.4% 的止盈之外, 最好不要设定任何其他利润目标, 而是让市场自由运行. 同样, 与止损一样, 这个结论可能不适用其他市场, 或在不同时间尺度上且具有完全不同入场设置的 "英镑/美元外汇市场". 利润目标的一个正面例子是股指期货, 该市场上趋势方向的变化频繁发生. 此外, 如果将利润目标设定为重要的点位, 则利润目标会变得更有价值, 例如在支撑位和阻力位, 跳空等等, 市场在这些位置有很大可能转向. 利润目标有效的另一个原因将在本章末尾的资金管理部分进行简要讨论.

#### Summary: Result of the entry logic with the three added exits

您可以使用经典优化测试分别确定交易系统中的止损和止盈, 如图 3.13, 3.15B 和 3.17 所示. 这样的优化可以显示最优的止损和止盈水平, 并为您提供关于我们找到的最佳参数稳定性的宝贵信息. 但是, 这些图表并没有向您揭示最终的净利润和回撤是如何发生的. 您无法从这些图表中看出, 是一笔高利润的交易还是一百笔低盈利的交易支撑了交易系统的总净利润. 这些缺失的, 有关所有交易分布的有价值信息仅由 MAE/MFE 图表提供. 他们在一张图表中向您显示所有交易的日内高点和回撤. 通过这种方式, MAE/MFE 方法提供了有关您交易系统的有用的附加信息, 并补充了优化图.

因此, 在本章中, 我们使用优化图和 MAE/MFE 图的组合来确定 LUXOR 系统的有用止损水平和利润目标. 在英镑/美元外汇市场上的测试表明, 止损和移动止损位置具有足够宽广的领域, 在降低系统风险的同时也略微增加了利润. 我们最终添加的利润目标是没有必要的, 如果设置为 2% 左右的区域, 可以有一点点帮助. 让我们看看经过上面的开发和讨论后, 我们交易系统的所有出口: 0.3% 的风险止损, 0.8% 的移动止损和 1.9% 利润目标(图 3.18 A-C).

<p align="left"><font size=2>Figure 3.18: LUXOR system with all three exits in place: 0.3% risk stop, 0.8% trailing stop and 1.9% profit target, tested on British pound/US dollar (FOREX), 30 minute bars, 21/10/2002-4/7/2008, with entry time window 9.30am-1.30pm GMT. SLOW=44, FAST=1. Including $30 S+C per RT. A: detailed equity curve, B: end of month equity curve, C: average profit per month. Charts created with TradeStation 8.</font></p>

![detailed equity curve](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.18_A.png)

![end of month equity curve](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.18_B.png)

![average profit per month](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.18_C.png)

如果将其与没有退出机制交易系统的权益曲线进行比较, 详细的权益曲线似乎没有太大变化(图 3.19A). 只不过它看起来更稳定, 伴有更少和幅度更小的回撤. 现在最大幅的回撤是 6%(相比之下没有退出机制的 10%), 而且系统总能在几周内迅速恢复到新的权益高点. 对于所有回撤, 最长的恢复期为 6 个月. 这也通过月末权益曲线得到确认, 该曲线每月对交易账户的市值进行一次绘制. 如果您按照从 1 月到 12 月的顺序对利润进行排序, 您可以看到交易系统在所有月份都是盈利的(图 3.18C), 这是其可靠性的另一个证明. 这些发现也在交易系统的数据中得到了强调, 该数据在计算时已包含了所有的出口(表 3.4, 右列). 一个值得注意的点是, 1.9% 的利润目标将最大赢利交易从 7510 美元降至 3900 美元, 但同时并未降低总体净利润.

<p align="left"><font size=2>Table 3.4: How additional exits change the result of the LUXOR system; change of trading figures of the system tested on British pound/US dollar (FOREX), with one exit added after another, 30 minute bars, 21/10/2002-4/7/2008, with entry time window 9.30am-1.30pm GMT. SLOW=44, FAST=1. Including $30 S+C per RT.</font></p>

![Table_3.4](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Table_3.4.png)

#### How exits are affected by money management

对于交易系统或多个系统的组合来说, 风险和资金管理永远不可能完全分开. 这两个组件彼此高度依赖. 因此, 将资金管理策略整合到系统设计和开发过程中是至关重要的. 资金管理并不是凭空得出的, 而是基于风险管理方案中预先计算的出口, 这里的风险管理方案与每个交易系统是匹配的. 在本节中, 我们将基于趋势跟踪交易系统 LUXOR 的实际示例来展示两个组件的相互作用.

<p align="left"><font size=2>Figure 3.19: Scatter graph of profits for all generated trades of the LUXOR system. Tested on British pound/US dollar (FOREX), 30 minute bars, 21/10/2002-4/7/2008, with entry time window 9.30am-1.30pm GMT. SLOW=44, FAST=1. Including $30 S+C per RT. A: without added exits. B: with 0.3% risk stop loss (red line), 1.9% profit target (green line) and 0.8% trailing stop. The exits act like borders for the trade distribution. Graphs created with TradeStation 8.</font></p>

![without added exits](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.19_A.png)

![with 0.3% risk stop loss](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.19_B.png)

图 3.19 显示了生成的系统所有交易的利润和亏损. 在图 3.19A 中, 您可以看到没有退出机制的交易系统最终的结果, 图 3.19B 显示了基于以下退出机制交易系统的输出结果: 利润目标为 1.9%, 风险止损为 0.3%, 移动止损为 0.8%.

与 MAE/MFE 图相比, 散点图的横轴显示的是交易的数量. 没有显示交易在其生命周期中的亏损或盈利的情况. 我们从这个简单的演示开始, 因为它可以清楚地显示应用退出机制后的效果. 当您比较没有退出机制和应用退出机制后的交易散点图时, 可以明显看出退出机制的一些有趣影响.

第一点是, 最大交易盈利和最大交易亏损之间的差异在引入退出机制后变小(散点在垂直方向上分布的宽度变小). 在没有任何退出机制的情况下, 交易广泛分布在 -2000+ 美元(最大亏损)和 6000+ 美元(最大盈利)之间, 在采用止损和利润目标后, 它们被挤压得更紧密, 分布在 -500 美元(最大亏损)和 4000 美元(最大盈利)之间的区间. 看起来像一群蜜蜂的交易黑云似乎现在被捕获在地面(止损)和屋顶(利润目标)之间. 这两个边界不是直线, 因为我们使用的是基于百分比的出场, 而不是固定的美元点位. 这些动态类型的出场与英镑/美元市场中的点位相匹配.

<p align="left" style="color:red;"><font size=5><b>注: 动态类型的出场指出场点随着成交价格(止损百分比)或当前价格(移动止损)动态变化. </b></font></p>

 Keep in mind that in the reality of trading, especially
when dealing with higher lots in non-liquid markets, bigger losses than your pre-
calculated ones can always happen.

 They will not harm you much, however, if you
consider them in advance and if your trading system is stable enough to produce the
results which you have calculated nearly 100% of the time – like in the case we show
here.

关于止损, 您可以看到并非所有该线附近的交易都位于 1.9% 的利润目标和 0.3% 的止损之间. 四个负异常值导致损失高于预先计算的 0.3%, 因为止损有时会因发生的跳空而越限. 如上所述, 最大交易亏损因此约为 0.4%(810 美元)而不是 0.3%(600 美元). 请记住, 在真实交易中, 尤其是在流动性较差的市场中处理较高的交易时, 实际损失超过预先计算的损失是常见的. 但是, 如果您事先考虑它们, 并且您的交易系统足够稳定以产生几乎 100% 时间计算的结果, 它们不会对您造成太大伤害 - 就像我们在此处展示的情况一样.

In contrast to the permeable behaviour of the initial stop loss you find no trades above
the 1.9% target line. Because the target is chosen very far away from the entry point only
few trades are able to reach it and no trade manages to pass it by using a market gap. So
the scatter graphs show the effects of the 0.3% risk stop loss and the 1.9% profit target.

与初始止损的渗透行为相反, 您发现没有超过 1.9% 目标线的交易. 因为目标选择距离入口点非常远, 所以只有少数交易能够到达它, 并且没有交易通过利用市场缺口来设法通过它. 因此, 散点图显示 0.3% 风险止损和 1.9% 利润目标的影响.

The MFE scatter graph shows how the trailing stop (marked blue)
affects both some of the losing trades (red points, left side) and some of the winning
trades (right side). The trailing stop follows trades which have a big run-up and pulls the
stop with a distance of 0.8% behind them in order to keep their profits. The diagram
shows that this stop is very effective in most cases and was only over-rolled by a negative
outlier trade in one case. On the left side of the MFE graphic you see again the effect of
the risk stop loss with the four outliers mentioned above.

但是 0.8% 的移动止损呢? 虽然原始散点图不显示移动止损的效果, 但它可以在 MFE 图中显示(图 3.20). MFE 散点图显示追踪止损(标记为蓝色)如何影响一些亏损交易(红点, 左侧)和一些获胜交易(右侧). 追踪止损跟随具有大幅上涨的交易, 并在止损位置后移动 0.8%, 以保持其利润. 该图显示, 在大多数情况下, 此止损非常有效, 并且仅在一个案例中由负离群值交易过度推销. 在 MFE 图形的左侧, 您可以再次看到上述四个异常值对风险止损的影响.

<p align="left"><font size=2>Figure 3.20: How the Exits prepare for Money Management. MFE diagram of all trades. How risk stop loss and trailing stops affect the trade distribution and make trades more calculable. Graph created with TradeStation 8.</font></p>

![How the Exits prepare for Money Management](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.20.png)

The added exits make the risks of the LUXOR trading system more calculable. Although
you do not know if the initiated position will be a winning or a losing trade, after having
added the exits you know that it is very likely in the area between a 0.3% loss and a 1.9%
win. You cannot tell this for sure, since there are some outlier trades which cannot always
be stopped by your exits exactly at the pre-calculated values, but you can have fairly high
confidence. This knowledge is useful in order to determine how much money you can
spend on the next trade if you want to risk a certain percentage of your trading capital.
This is an important step in order to apply a money management scheme which helps
you to enhance your returns (see Chapter 7).

增加的退出使 LUXOR 交易系统的风险更易于计算. 虽然您不知道发起的位置是赢还是输掉交易, 但在添加退出后, 您知道很可能在 0.3% 的损失和 1.9% 的赢额之间. 你无法确定这一点, 因为有一些离群值交易并不总是完全按照预先计算的值从你的出口停止, 但你可以有相当高的信心. 如果您想要冒一定比例的交易资金风险, 这些知识对于确定您可以在下一笔交易中花多少钱是有用的. 这是一个重要的步骤, 以便应用资金管理计划, 帮助您提高您的回报(见第 7 章).

### 3.6 Summary: Step-by-step development of a trading system

----------

In this chapter we have shown in the example of the GBP/USD currency pair how to
develop a new trading system step-by-step (Figure 3.21). Every trading system starts with
an idea and a sound logic. The idea for our trading system LUXOR was taken from the
STAD TradeStation Development Club but there are many other good sources of ideas
including books, the internet and seminars. Once you have found the idea, you have to 
test it and change it according to your needs. Therefore you should somehow transfer the
idea into an algorithm, a sequence of rules, which you can apply to historic market data.
During this test process you will find new ideas and you will face new problems, e.g.
how to program your code correctly and how to handle weak points of your software.

在本章中, 我们在 GBP/USD 货币对的例子中展示了如何逐步开发新的交易系统(图 3.21). 每个交易系统都以一个想法和一个合理的逻辑开始。 我们的交易系统LUXOR的想法来自STAD TradeStation发展俱乐部，但还有许多其他好的想法来源，包括书籍，互联网和研讨会。 一旦找到了想法，就必须对其进行测试并根据需要进行更改。 因此，您应该以某种方式将想法转换为算法，一系列规则，您可以将其应用于历史市场数据。 在此测试过程中，您将找到新的想法，您将面临新的问题，例如如何正确编写代码以及如何处理软件的弱点。

Although this process is time-consuming it is valuable since you get a very detailed
knowledge of your trading system. This knowledge is a key factor for your success when
applying your system, since confidence and trust in your trading system is the most
important factor. If you don’t trust your system, you will stop trading it when the first
drawdown occurs. So all the tests – with and without slippage and commissions, with
and without exits, with optimisations and stability tests – are later rewarded with a good
expertise about what you are doing and why you are doing it. In this way you come up
with a trading system that contains a reliable risk management and prepares you for
money management since you get a better estimation of the outcome of the trades.

虽然这个过程非常耗时，但是因为您对交易系统有了非常详细的了解，所以它很有价值。 这些知识是您在应用系统时取得成功的关键因素，因为您对交易系统的信心和信任是最重要的因素。 如果您不信任您的系统，您将在第一次缩减时停止交易。 因此，所有测试 - 无论是否有滑点和佣金，有无退出，优化和稳定性测试 - 都会获得关于您正在做什么以及为什么要这样做的良好专业知识。 通过这种方式，您可以建立一个包含可靠风险管理的交易系统，并为您进行资金管理做好准备，因为您可以更好地估算交易结果。

<p align="left"><font size=2>Figure 3.21: Step-by-step development of a trading system. From an idea to a final system including entries, exits, trading costs etc.</font></p>

![How the Exits prepare for Money Management](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.21.png)

## Chapter 4: Two methods for evaluating the system’s predictive power

>"一旦你拥有了一个系统, 最大的障碍就是相信它."
>汤姆.威尔斯

In order to check the robustness of the LUXOR trading system we now perform the
following two reliability tests.
4.1 Timescale analysis. We keep the system’s input parameters unchanged while we
change the bar length of the tested market.
4.2 Monte Carlo analysis. Changing the order of the performed trades gives you valuable
estimations about expected maximum drawdowns.
Whereas Monte Carlo analysis is a well-known tool for anyone who has had experience
with the evaluation of risks, timescale analysis is a new method which we have not seen
in any publications so far. We find it a useful tool which can be easily performed with
any standard software package that allows the bar compression of the used price data to
be changed.

为了检查 LUXOR 交易系统的稳健性, 我们现在执行以下两个可靠性测试.

4.1 时间尺度分析. 当我们改变测试市场的条形长度时, 我们保持系统的输入参数不变.

4.2 蒙特卡罗分析. 更改已执行交易的顺序可为您提供有关预期最大下降的有价值估计.

蒙特卡洛分析对于有风险评估经验的人来说是一个众所周知的工具, 而时间尺度分析是迄今为止我们在任何出版物中都没有看到过的新方法. 我们发现它是一个有用的工具, 可以使用任何标准软件包轻松执行, 允许更改使用价格数据的条形压缩.

### 4.1 Timescale analysis

----------

#### Changing the compression of the price data

In order to perform a test we need to have data that was not used during the building and
the development of the trading system. This data is called out-of-sample data. The
simplest way to get such out-of-sample data for your trading system is just apply it to the
same market and the same data but to change the timescale. Although in this way the
new timescale is not really different, its price structure changes a lot within diverse
timescales. Therefore many valuable trading systems which work well on one timescale
fail completely on another scale in the same market.

为了执行测试，我们需要拥有在构建和开发交易系统期间未使用的数据。 该数据称为样本外数据。 获取交易系统的这种样本外数据的最简单方法是将其应用于相同的市场和相同的数据，但要更改时间表。 虽然通过这种方式新的时间表并没有真正不同，但其价格结构在不同的时间尺度内发生了很大的变化。 因此，许多在一个时间尺度上运行良好的有价值的交易系统在同一市场中完全失败。

As far as the trading system LUXOR is concerned, for timescale analysis, you first
develop and test a trading system step-by-step on one timescale, like we did on 30 minute
data. You develop the entries, you add trading costs, then through optimisation and
filtering you will arrive at a complete system with stops and profit targets. Then you just
take this whole trading system and apply it like it is to the same market on different
timescales. With today’s software platforms like TradeStation 8 such system tests can be
performed very easily.

就交易系统LUXOR而言，对于时间尺度分析，您首先在一个时间尺度上逐步开发和测试交易系统，就像我们在30分钟数据上所做的那样。 您开发条目，添加交易成本，然后通过优化和过滤，您将到达一个包含止损和利润目标的完整系统。 然后你就可以把这整个交易系统应用到不同时间尺度的同一个市场。 使用今天的软件平台，如TradeStation 8，可以非常轻松地执行此类系统测试。

You keep all your applied strategies on the chart while changing the symbol properties:
in this case you are changing the bar length from 30 minute to any other, for example 5
minute, 10 minute, 120 minute, daily etc. If you perform such a change you see that the
chart and the indicators which you use for signal generation look very similar, although
you are working on different timescales (Figure 4.1). Since the indicators, in our case the
two moving averages, are calculated on the basis of the chart bars, it does not matter very
much if the bars are calculated every 5 minutes, 30 minutes or 120 minutes. But although
the properties of some indicators look similar, the market in fact behaves very differently
when looking at its different timescales in more detail. Keep in mind that on the 5 minute
scale you watch the price data over 5 years much more closely than on larger timescales
like the 120 minute timeframe.

在更改符号属性时，您可以在图表上保留所有应用策略：在这种情况下，您将条形长度从30分钟更改为任何其他，例如5分钟，10分钟，120分钟，每天等。如果您执行此类操作 改变你看到你用于信号生成的图表和指标看起来非常相似，尽管你正在研究不同的时间尺度（图4.1）。 由于指标（在我们的例子中是两个移动平均线）是根据图表条计算的，因此如果每隔5分钟，30分钟或120分钟计算一条线，则无关紧要。 但是，尽管某些指标的属性看起来相似，但实际上市场在更详细地研究其不同的时间尺度时表现得非常不同。 请记住，在5分钟的比例范围内，您可以比在120分钟的时间范围内更大的时间尺度更密切地观察5年的价格数据。

Whereas in the 120 minute timescale 120 bars mean half a month of price data, the same
amount of bars on a 5 minute timescale just contains half a day (Figure 4.1).

而在120分钟时间尺度中，120个柱子意味着半个月的价格数据，而5分钟时间尺度上的相同数量的柱子只包含半天（图4.1）。

<p align="left"><font size=2>Figure 4.1 British pound/US dollar FOREX on different timescales: A: 5 minute bars, B: 30 minute bars, C: 120 minute bars. Chart examples from July 2008. The two moving averages like all other parameters for signal generation are kept the same while changing the timescale of the chart. Each of the three figures shows about 100-150 bars.</font></p>

![5 minute bars](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_4.1_A.png)

![30 minute bars](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_4.1_B.png)

![120 minute bars](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_4.1_C.png)

#### LUXOR tested on different bar compressions

It is fascinating to check how a trading strategy changes on different timescales regarding
its important system figures and equity lines. Let’s do such a timescale analysis for the
LUXOR trading system. As you remember LUXOR was developed on 30 minute data
of the British pound/US dollar FOREX market. Let’s have a look at the equity lines on
different timescales (Figure 4.2). You see from these curves that our developed system
logic gains steady profits on all the different timescales, starting from 5 minute up to 180
minute bar calculations.

检查交易策略在不同的时间尺度上如何改变其重要的系统数据和权益线是很有意思的。 让我们对LUXOR交易系统进行这样的时间尺度分析。 你还记得LUXOR是基于英镑/美元外汇市场的30分钟数据开发的。 让我们看看不同时间尺度的权益线（图4.2）。 从这些曲线可以看出，我们开发的系统逻辑在所有不同的时间尺度上获得稳定的利润，从5分钟到180分钟的条形计算。

<p align="left"><font size=2>Figure 4.2 Detailed equity curves from system tests on different timescales – from 5 minute up to 180 minute bar calculations. Trend-following system British pound/US dollar (FOREX), 30 minute bars, 21/10/2002-4/7/2008, with entry time window 9.30am-1.30pm GMT. SLOW=44, FAST=1. All three exits in place: 0.3% risk stop, 0.8 trailing stop and 1.9% profit target. Including $30 S+C per RT.</font></p>

![Detailed equity curves](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_4.2.png)

Although the trading system makes profits on all the different timescales, the shapes of
the equity curves with their drawdown phases appear a bit different.

虽然交易系统在所有不同的时间尺度上获利，但股权曲线的形状与其缩减阶段看起来有点不同。

#### Net profit and maximum drawdown dependent on the traded bar length

We’ll now have a closer look at the trading system’s behaviour by comparing important
trading figures as a function of the chosen bar lengths.

我们现在通过比较重要交易数据作为所选条形长度的函数，仔细研究交易系统的行为。

When plotting the total net profit and the maximum intraday drawdown of the trading
system for the test period as a function of the chosen timescale some interesting features
are revealed (Figure 4.3). You see a very broad region of bar lengths between 5 and 35
minutes which all produce relatively similar good returns with similar low drawdowns.
The 30 minute timescale is the most profitable but it is well placed in an area of other
useful timescales. However, you should pay attention to the fact that at about 40 minutes
the profit decreases quite a lot. As a consequence of this graph it could be even safer to
use the LUXOR system on smaller timeframes like 20 minutes or 25 minutes where you
also have good results but you are further away from the less profitable timescales. As
you can see when you go down to very small timescales, like 1 minute bars, the system
is not profitable any more. For larger timescales above the most profitable region of 5-
35 minute bars the gained total net profit goes further and further down until it diminishes
completely for bar lengths above 210 minutes.

当绘制测试期间交易系统的总净利润和最大日内缩幅作为所选时间尺度的函数时，会显示一些有趣的特征（图4.3）。您会看到一个非常宽的区域，长度在5到35分钟之间，所有这些都会产生相对类似的良好回报，并且具有类似的低水平下降。 30分钟的时间表是最有利可图的，但它可以放在其他有用的时间范围内。但是，你应该注意这样一个事实，即在大约40分钟时，利润会下降很多。由于这个图表，在较短的时间范围内使用LUXOR系统甚至可能更安全，例如20分钟或25分钟，您也可以获得良好的结果，但距离利润较低的时间尺度更远。正如您所看到的那样，当您进入非常小的时间尺度时，例如1分钟的条形图，系统就不再有利可图了。对于在5-35分钟柱的最有利可图区域之上的较大时间尺度，获得的总净利润进一步下降，直到其在210分钟以上的条长度完全减小。

<p align="left"><font size=2>Figure 4.3: Timescale analysis. Total net profit and maximum drawdown as a function of the bar length. Trend-following system British pound/US dollar (FOREX), 30 minute bars, 21/10/2002-4/7/2008, with entry time window 9.30am- 1.30pm GMT. SLOW=44, FAST=1. All three exits in place: 0.3% risk stop, 0.8 trailing stop and 1.9% profit target. Including $30 S+C per RT.</font></p>

![Timescale analysis](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_4.3.png)

#### Explanation for the time dependency of the system

What are the reasons for the system’s total net profit time dependency?

系统总净利润时间依赖性的原因是什么？

To understand this you need to remind yourself that the total net profit of a trading system
is the number of all trades multiplied with the average profit per trade (Figure 4.4). For
example let’s say that you have a trading system which generates 1000 trades. In this
case an average profit per trade of $100 leads to a total net profit of $100,000 (1000 x
$100).

要理解这一点，您需要提醒自己，交易系统的总净利润是所有交易的数量乘以每笔交易的平均利润（图4.4）。 例如，假设您有一个交易系统，可以生成1000笔交易。 在这种情况下，每笔交易的平均利润为100美元，总净利润为100,000美元（1000 x 100美元）。

<p align="left"><font size=2>Figure 4.4: The total net profit of a trading system is the product of two factors: number of trades and average profit per trade.</font></p>

![two factors](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_4.4.png)

Therefore to understand the total net profit of a trading system, you must investigate the
two factors which contribute to it: number of trades and average profit per trade. If you
first look at the number of trades which are generated within the test period 2002-2008
you see that it strongly depends on the selected timeframe (Figure 4.5). The smaller you
set the timeframe, the higher is the number of generated trades. On a 1 minute scale our
trading logic generates over 14,000 trades in the 5 years whereas on a 210 minute basis
only 210 trades are generated. In other words: on a 1 minute basis you get more than
2000 trades per year or 10 trades per day whereas on a 120 minute basis you only get
about 40 trades per year, which means about one per week. This is plausible because on
a smaller time scale you have many more bars for calculation, as discussed above (see
Figure 4.1).

因此，要了解交易系统的总净利润，您必须调查导致它的两个因素：交易数量和每笔交易的平均利润。 如果您首先查看2002年测试期间生成的交易数量，您会发现它在很大程度上取决于所选的时间范围（图4.5）。 您设置的时间范围越小，生成的交易数量就越高。 在1分钟的范围内，我们的交易逻辑在5年内产生超过14,000笔交易，而在210分钟的基础上，仅产生210笔交易。 换句话说：在1分钟的基础上，您每年可获得超过2000笔交易或每天10笔交易，而在120分钟的基础上，您每年只能获得约40笔交易，这意味着每周约一笔交易。 这是合理的，因为在较小的时间尺度上，您有更多的计算条，如上所述（参见图4.1）。

<p align="left"><font size=2>Figure 4.5: Timescale analysis. Number of generated trades as a function of the bar length. Trend-following system British pound/US dollar (FOREX), 30 minute bars, 21/10/2002-4/7/2008, with entry time window 9.30am-1.30pm GMT. SLOW=44, FAST=1. All three exits in place: 0.3% risk stop, 0.8 trailing stop and 1.9% profit target. Including $30 S+C per RT.</font></p>

![two factors](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_4.5.png)

Let’s look at the second factor in the calculation of total net profit; the average profit per
trade as a function of the selected timescale (Figure 4.6). You see that the smaller the
timescale chosen, the smaller the profit per trade you get. The worst situation appears on
the 1 minute timescale, where the profit per trade becomes negative. It seems that the
statistical noise is too high within the very small timescales of 1 minute to 5 minute bars.
Too many arbitrary movements take place there which are difficult to exploit
systematically with our trading system. Furthermore, trading costs and slippage matter
more on the very small timescales. If you stay away from the very small bar lengths and
set them to values between 25 and 180 minutes then the system produces an average
profit per trade between $80 and $120 (green area in Figure 4.6). This is really a
remarkable result since you have to keep in mind how much the market structure changes
when varying the timescale in this big range.

让我们看一下计算总净利润的第二个因素;每笔交易的平均利润与所选时间表的函数关系（图4.6）。您看到所选择的时间尺度越小，您获得的每笔交易的利润就越小。最糟糕的情况出现在1分钟的时间尺度上，每笔交易的利润变为负值。在1分钟到5分钟的非常小的时间尺度内，统计噪声似乎太高了。在那里发生了太多的任意运动，这些运动难以与我们的交易系统系统地利用。此外，交易成本和滑点对非常小的时间尺度更重要。如果您远离非常小的条形长度并将它们设置为25到180分钟之间的值，那么系统产生的平均每笔交易利润在80美元到120美元之间（图4.6中的绿色区域）。这真是一个非常了不起的结果，因为在这个大范围内改变时间尺度时，你必须记住市场结构的变化。

<p align="left"><font size=2>Figure 4.6: Timescale analysis. Average profit per trade as a function of the bar length. Trend-following system British pound/US dollar (FOREX), 30 minute bars, 21/10/2002-4/7/2008, with entry time window 9.30am-1.30pm GMT. SLOW=44, FAST=1. All three exits in place: 0.3% risk stop, 0.8 trailing stop and 1.9% profit target. Including $30 S+C per RT.</font></p>

![two factors](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_4.6.png)

From the variation of the total number of trades and average profit per trade depending
on the selected bar length you can conclude how the total net profit varies with changing
timescale. On the very short timescales the total net profit suffers from a too low profit
per trade. But already with timescales longer than 5 minutes the low average profit per
trade can be compensated with the higher number of trades and leads the trading system
to a high total net profit with low maximum drawdown. If you increase the timescale
further, above 40 minutes and more, the total net profit becomes lower and lower since
less and less trades are generated while the single trade profit does not increase. As a
consequence our trading system works best in the medium timescales between 10 and
35 minutes.

根据所选择的条形长度，从交易总数和每笔交易的平均利润的变化，您可以得出总净利润如何随时间变化而变化。 在非常短的时间尺度上，总净利润受到每笔交易利润过低的影响。 但是，由于时间跨度超过5分钟，每笔交易的低平均利润可以通过较高的交易数量得到补偿，并导致交易系统获得较高的总净利润和较低的最大亏损。 如果您进一步增加时间表，超过40分钟或更长时间，总净利润会变得越来越低，因为在单一贸易利润不增加的情况下产生的交易越来越少。 因此，我们的交易系统在10到35分钟的中等时间段内效果最佳。

Now what do all these findings mean for the predictive power of our trading system? The
trading system which was developed and optimised on the 30 minute timescale shows
promising results under variation of the timescale. From these results with the proven
stability you can draw the conclusion that the trading logic has a good chance of standing
up to further out-of-sample data tests and can be profitable in real trading.

现在，所有这些发现对我们交易系统的预测能力意味着什么？ 在30分钟时间尺度上开发和优化的交易系统在时间尺度的变化下显示出有希望的结果。 从这些具有经过验证的稳定性的结果中，您可以得出结论：交易逻辑很有可能经得起进一步的样本外数据测试，并且可以在实际交易中获利。

### 4.2 Monte Carlo analysis

----------

‘What is the last thing you do before you climb on a ladder? You shake it. And that
is Monte Carlo simulation.’
Sam Savage, Stanford University [10]

>“在爬上梯子之前，你做的最后一件事是什么？ 你摇动它。 这就是蒙特卡罗模拟。
>斯坦福大学 Sam Savage [10]

Nearly everybody has heard of it, but nobody uses it. Many people are afraid that Monte
Carlo analysis is such a complex method that in order to understand it you must be a
professor in mathematics. However the truth is that it is not that difficult and it should be
used by everybody who wants to do more than just to look at the gained equity lines of
system back-tests.

几乎每个人都听说过，但没有人使用它。 许多人担心蒙特卡洛分析是如此复杂的方法，为了理解它，你必须是数学教授。 然而事实是，并不是那么困难，每个想做更多事情的人都应该使用它，而不仅仅是看一下系统反测试所获得的权益线。

#### The principle of Monte Carlo analysis

But what does Sam Savage mean when he says that Monte Carlo analysis is just a
technique to shake a ladder before climbing on it? To understand his sentence you first
must know what the ladder is and what can be shaken on it.

但是当Sam Savage说蒙特卡洛分析只是一种在攀爬之前摇动梯子的技术时，他的意思是什么？ 要理解他的句子，首先必须知道梯子是什么以及可以动摇什么。

As you probably assume, in our case the ladder is a trading system. Figure 4.7 shows this
ladder, the detailed equity curve of the trading system LUXOR, with all filters and exits
applied as explained in Chapter 3.

正如您可能认为的那样，在我们的例子中，梯子是一个交易系统。 图4.7显示了这个梯形图，交易系统LUXOR的详细权益曲线，所有过滤器和出口都按照第3章的说明进行了应用。

<p align="left"><font size=2>Figure 4.7: Detailed Equity Curve of system LUXOR. Tested on British pound/US dollar(FOREX), 30 minute bars, 21/10/2002-4/7/2008. With entry time window 9.30am-1.30pm GMT. SLOW=44, FAST=1. All three exits in place: 0.3% risk stop, 0.8% trailing stop and 1.9% profit target. Including $30 S+C per RT. Calculation based on one contract basis, results incl. $30 slippage and commissions per trade. Chart created with Market System Analyzer (see www.adaptrade.com).</font></p>

![Detailed Equity Curve](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_4.7.png)

This detailed equity curve represents all the 1051 trades performed by the trading system
within the test period 21/10/2002-4/7/2008, one after another in a chronological order.

该详细权益曲线代表交易系统在测试期间21/10 / 2002-4 / 7/2008中按时间顺序一个接一个地执行的所有1051交易。

Now let’s shake the ladder as following: you keep all these 1051 trades (e.g. trade 1=$120
win, trade 2=$90 loss, trade 3=$445 win … trade 1051=$150 loss) and you put them into
a new order. Figure 4.8 shows an example of how you do this with a trading system that
contains six trades: each of the six trades is kept but put into a new position.

现在让我们按照以下步骤动摇：你保留所有这些1051交易（例如交易1 = 120美元赢，交易2 = 90美元损失，交易3 = 445美元赢...交易1051 = 150美元损失）然后你将它们放入新订单。 图4.8显示了如何使用包含六笔交易的交易系统执行此操作的示例：六笔交易中的每一笔都被保留但处于新的位置。

<p align="left"><font size=2>Figure 4.8: The principle of Monte Carlo analysis: A trading system which contains six trades is "shaken" – this means that the positions of the six trades are exchanged accidentally.</font></p>

![The principle of Monte Carlo analysis](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_4.8.png)

You can do it in the same way with every arbitrary number of trades. The new positions
of the trades are determined randomly. For example, in our system trade 1 is now in
position 842, trade 2 in position 66, trade 1051 in position 980 etc. The important point
is that every trade still exists like before – no trade is deleted and no trade is added. This
permutation method is called “selection without replacement” 4 .

您可以使用相同的方式对每个任意数量的交易执行此操作。 交易的新头寸是随机确定的。 例如，在我们的系统中，交易1现在位于第842位，交易2在第66位，交易1051在位置980等。重要的是每笔交易仍然像以前一样存在 - 没有交易被删除而且没有交易。 这种置换方法称为“无需替换的选择”4。

Another possible permutation method is selection with replacement. The advantage of a selection
without replacement is that it exactly duplicates the probability distribution of the input sequence,
whereas selection with replacement may not. The drawback to selection without replacement is
that the randomly sampled trade sequences are limited to the number of trades in the input
sequence. Thus if you have a short sequence of trades (e.g. less than 50 trades), this may limit the
accuracy of your calculations. The first method is similar to random selection with replacement
with the advantage that the final list of trades will have the same statistical properties as the original
list. The second method introduces more randomness into the trade sequence, which may be
preferable if the expected trades in the future will likely be different than those of the original
sequence.

另一种可能的排列方法是选择替换。 没有替换的选择的优点在于它完全重复输入序列的概率分布，而替换的选择可能不是。 没有替换的选择的缺点是随机采样的交易序列限于输入序列中的交易数量。 因此，如果您有一个较短的交易顺序（例如少于50笔交易），这可能会限制您的计算准确性。 第一种方法类似于随机选择，具有替换的优点，即最终交易列表将具有与原始列表相同的统计属性。 第二种方法在交易序列中引入了更多随机性，如果未来的预期交易可能与原始序列的交易可能不同，则这可能是优选的。

#### Exchanging the order of the performed trades

The above example suggests that the final outcome of all trades must stay the same,
independent of whatever new order the trades are placed in. Since the sum of your trades
stays the same all new equity curves must reach the same amount in the end. But since
the trades are now in a new order, the shape of the new equity lines and especially the
occurring drawdowns become different (Figure 4.9).

上面的例子表明，所有交易的最终结果必须保持不变，与交易所处的新订单无关。由于您的交易总和保持不变，所有新的权益曲线最终必须达到相同的金额。 但由于交易现在处于新秩序，新股权线的形状，特别是发生的下跌变得不同（图4.9）。

<p align="left"><font size=2>Figure 4.9: Blue: detailed equity curve, Black: 15 permutations of the trades sequence("shaken trades"). Trend-following system LUXOR British pound/US dollar (FOREX), 30 minute bars, 21/10/2002-4/7/2008. Calculation based on one contract basis, results including $30 slippage and commissions per trade.</font></p>

![Figure 4.9](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_4.9.png)

This figure shows the original trade sequence (thick blue line) and 15 permuted trade
sequences (thin black lines). All the permutated equity curves have the same starting and
ending points because we did not add or remove any trades but just changed the order of
their appearance. The change of the trade orders leads to the effect that between the equity
curves there are big variations with different drawdown phases that occur at different
times.

该图显示了原始交易顺序（粗蓝线）和15个置换交易序列（细黑线）。 所有排列的权益曲线都有相同的起点和终点，因为我们没有添加或删除任何交易，只是改变了它们的外观顺序。 贸易订单的变化导致股权曲线之间存在很大差异，不同时期出现不同的亏损阶段。

#### Probabilities and confidence levels

#### Performing a Monte Carlo analysis with the LUXOR trading system

#### Limitations of the Monte Carlo method

## Chapter 5: The factors around your system

### 5.1 The market’s long/short bias

----------

#### The trend is your friend?

#### Consequences for system development

### 5.2 Out-of-sample deterioration

----------

#### A Bollinger Band system with logic and code

#### Optimising the Bollinger Band system

#### Out-of-sample result

#### Reasons for the out-of-sample deterioration

### 5.3 The market data bias

----------

#### Expanding the training period

#### Conclusion: How to choose your training data

### 5.4 Optimisation and over-fitting

----------

#### Step-by-step optimisation of the LUXOR system

#### Results depending on the number of optimised parameters

#### The meaning of the trading system’s complexity

### 5.5 Rule complexity explained with polynomial curve fitting

----------

#### Interpolating data points with polynomial functions

#### Predictive power of the different polynomials

#### Conclusions for trading system development

## Chapter 6: Periodic re-optimisation and walk forward analysis

### 6.1 Short repetition: “normal”, static optimisation

----------

### 6.2 Anchored vs. rolling walk forward analysis (WFA)

----------

### 6.3 Rolling WFA on the LUXOR system

----------

#### Periodic optimisation of the two main system parameters

#### Out-of-sample test result

#### Conclusion

### 6.4 The meaning of sample size and market structure

----------

## Chapter 7: Position sizing example, using the LUXOR system

### 7.1 Definitions: money management vs. risk management

----------

#### Risk management (RM)

#### Money management (MM)

### 7.2 Application of different MM schemes

----------

#### Reference: The system traded with one lot

#### Maximum drawdown MM

#### Fixed fractional MM

#### Fixed ratio MM

### 7.3 Monte Carlo analysis of the position sized system

----------

### 7.4 Conclusion

----------

# Part III: Systematic Portfolio Trading

## Chapter 8: Dynamic portfolio construction

### 8.1 Introduction to portfolio construction

----------

#### A list of the main available software

#### The role of correlations

#### Publications and theoretical tools

#### Portfolio trading in practice

#### Total vs. partial equity contribution

### 8.2 Correlation among equity lines

----------

### 8.3 A dynamic approach: equity line crossover

----------

### 8.4 Dynamic portfolio composition: the walk forward analysis activator

----------

### 8.5 Largest losing trade/largest losing streak/largest drawdown

----------

### Conclusion

#### Rule complexity

#### Testing

#### Optimisation

#### Monte Carlo analysis

#### Portfolio building

#### Dynamic risk management

#### Money management

## Appendices (Systems and ideas)

### Appendix 1: Bollinger Band system

### Appendix 2: The triangle system

### Appendix 3: Portfolios with the LUXOR trading system
