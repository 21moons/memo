Trading Systems
A new approach to system development and
portfolio optimisation


# Part I: 交易系统开发&评估实践指导

## Chapter 1: 什么是交易系统?

交易系统就是一个自动定义入场点和出场点的, 不包含任何人为介入因素的规则集合.
因为交易规则并没有定义交易时间和交易地点, 这样使得交易系统是静态可测试的.
通过历史数据, 我们可以在一定程度上计算交易系统的可信度.
如果我们向已有规则中添加资金管理规则和投资组合规则, 我们就拥有了一个交易策略, 或者换句话说, 就是对市场进行完全自动化模拟.

我们提到的资金管理并不是我们通常认为的风险管理, 而是如何去止损和止盈.

### 1.1 简易交易系统示例

* 入场规则
  买入2份最近20天内价格创最高的合约;
  卖空2份最近20天内价格创新低的合约;
* 离场规则
  如果 marketposition = 1, 那么在最接近 avgtruerange(14) 的价位卖出平仓;
  如果 marketposition = -1, 那么在最接近 avgtruerange(14) 的价位买入平仓.

quantitative traders 量化交易者

### 1.2 为什么你需要交易系统

统计结果毫无疑问地表明只有百分之几的交易者能够年复一年地打败市场.大部分是私人和机构交易者迟早会破产.如果你不属于幸运的随意交易者, 那么为了生存, 唯一的选择就是使用交易系统.如果你购买了这本书, 你很可能并不是一个成功的自由交易者.按照我的经验, 成功的自主交易者拥有天生的直觉, 能够依靠本能预测市场动向.与之对应的是, 有许多成功的基金经理, 机构和私募交易者利用预设的交易策略和投资方法获利.如果有人认为交易系统可以很容易地战胜所有的交易中的阻碍, 那么这是对交易系统的一种误解.一方面交易系统可以帮助交易者击败市场, 另一方面它也会引入一些新的问题.

首先, 如果交易者在勇气方面有些问题, 面对机会时没有足够的魄力及时行事.这种情况下交易系统并非一个完美的解决方案.正如 Larry Williams 所说, "trading systems work, system traders do not".对应一个有系统的交易者而言, 没有什么比忽略交易信号更大的恶行, Bill Eckhardt 写到：

*如果你做了一笔坏交易, 你还有资金管理, 你还有一大堆东西能够帮助你, 做一笔坏交易真的没有你想的这么严重.但是, 如果你错过了一笔好的交易, 不要找任何理由.如果你遇到了一笔注定盈利的交易, 而你却错过了它, 你注定会在这个游戏中完蛋.*

其次, 为了信任交易系统, 特别是在利润回撤抹去交易者对交易系统能力的信心时, 一定要做大量的研究和统计工作, 这并不是每个人都能够做到的.开发, 实施, 测试和评估一个交易系统并不是一个简单的事情.

最后, 影响自由交易的许多因素同样影响着系统性交易, 例如 缺乏足够的启动资金, 投资组合多样化的可能性, 全职, 24小时, 敬业.

更重要的是, 我们可以说做交易并不像在一个理性的企业工作, 你做出计划, 得出结论, 一切可以用逻辑的方式来解释. 恐惧和贪婪用一种大脑无法掌控的方式操纵价格. 当然有一些幸运交易者可以凭直觉地打败市场, 但在这些情况下, 他们并不能清晰的解释他们为什么买或卖. 如果这一切都是真的, 意味着你需要一个不理智和不合逻辑的工具来进入和退出市场, 这东西不能让你完全理解, 而且违反直觉. 通常情况下, 那些你认为是不合逻辑的, 或者只会导致失败的信号会让你成为赢家.

使用机械的交易系统意味着你需要放弃自己持有的关于金融的信念, 放弃所有让你"感觉良好"的交易方式：通常每个人买入下跌中的合约会感觉良好, 买入价格创新高的合约则会感觉不舒服, 但有很大概率是后者的方法更好. 测试交易系统, 意味着数字的野蛮力量将会强加于你, 让你感觉倍受约束. 成为一名完全机械的交易者意味着与自己搏斗. 这是赢利的唯一途径, 除非你是一个幸运的劫匪, 日复一日地赚钱, 但却不知道如何赚钱.

### 1.3 交易系统的相关知识

主观技术分析(subjective technical analysis)和客观技术分析(objective technical analysis)之间有很大的区别.

客观的技术分析方法是定义清晰的, 可重复的, 能够产生明确交易信号的过程.这使得它们可以用计算机程序来实现, 并且可以使用历史数据做回测. 同时, 回测产生的结果可以通过严格的评估来做定量分析.主观技术分析方法没有明确的分析过程.由于其天生的模糊性, 必须依赖分析师的私人解释.这种特性妨碍了电脑化, 回测和客观的性能评估.换句话说, 我们没有方法能确认或否定主观方法的功效.因为这个原因, 他们很难被证实是有效的.

因为其模糊性和缺乏科学的方法, 主观技术分析在学术圈和严肃的市场从业人员中并没有获得良好的声誉. 要成为一个图表或技术分析师, 而不是投资组合经理, 有一套个人的技术分析绝活可能是金融业中最好的跳板.关于为什么人们会相信奇怪的东西, 如教条, 信仰, 神话和轶事, 已经有很多的社会学和心理学的文献来解释, 同样这也是使用科学方法推导反而更容易错过好的科学技术分析的原因. 当然, 我并不是要在这里讲授关于科学哲学, 我只是想简要提醒读者什么是科学知识.科学知识是经验的, 是基于对现实的观察：

*技术分析的实质是统计推断.它试图从历史数据中归纳出模式, 规则等形式并进行概括, 然后推断他们的未来.*

因此, 技术分析利用统计推断工具, 从单个样本开始观察, 目的是评估整个人群的统计学属性. 通过这种方式, 技术分析是可以量化的, 就像统计学一样.此外, 技术分析和科学一样, 试图通过变量之间的函数关系来预测未来. 如果一个变量变了, 那么因变量会随之变化.技术分析中的规则对应统计学中的函数, 这里函数是有一定概率的.科学技术分析和统计学之间没有任何障碍, 那些不喜欢主观技术分析的人提出的疑惑突然消失了.定量技术分析借用了应用科学中的典型分析方法：由牛顿发起并由波普尔推广的假设 - 演绎方法.该假设演绎法有五个阶段：
1.观察.系统开发人员, 通过持续观察金融市场上的日内波动及日间波动, 设计变量之间的关系, 例如当天交易量和收盘价之间的关联, 或者指数和第二天开盘价之间的关联.
2.假设.假设来自系统开发人员的创新思维 - 一个智力火花, 其中的起源无法得知.系统开发人员必须清晰的知道他的假设不是来源于分析样本的特殊性, 而是从全部数据中推演出来, 对其中的大部分数据都是适用的.
3.预测.如果这种关系是真的, 那么可以依据假设来构建一个条件命题或一个预测, "如果这个假设确实是真实的, 预测将准确的告诉我们可以在新的集合中观察到什么".
4.验证.系统开发人员验证预测在新集合中是否成立.
5.结论.系统开发人员, 通过使用统计推断工具(例如信任区间和假设测试), 将通过衡量实际观察结果与预测是否一致, 确认假设是否成立.
这个过程与化学或生物学等应用科学中用到的科学评估方法没有任何区别.

## Chapter 2: 设计, 测试, 优化和评估一个交易系统 

### 2.1 设计

交易系统从一个像创业愿景一样的想法开始. 创新是介于创意和幻想之间的一类东西, 但是想法能否成为现实则取决于你为它奉献了多少时间. 有些系统交易员说一个关于交易系统的好主意是在你最不期待的时候出现的, 但是与优秀交易者聊天很好会有些帮助, 强烈建议你参加研讨会, 大会和专业交易者之间的聚会.即使能够亲眼看到自由交易如何交易也是有用的.不幸的是, 创新并没有确定的道路, 但下面是
提示可以促使你走出想象的边界.

#### 开始

书单：
1.Traders www.traders-mag.co.uk
2.Active Trader www.activetradermag.com
3.Futures www.futuresmag.com
4.The Technical Analyst www.technicalanalyst.co.uk
5.Technical Analysis of Stocks & Commodities www.traders.com

TradeStation 论坛
"System Traders and Development Club" (STAD)

#### 编程目标

一个系统由一个入场公式, 一个离场公式和一个资金管理公式组成. 离场公式与 "风险管理" 有关, 即初始止损, 移动止损, 目标退出, 通俗一点来讲就是我们承担多少风险以及在每一笔交易如何承担风险. "资金管理"关心的是我们在每笔交易中投资多少, 就是我们买或卖多少股票或期货合约. 系统交易的初学者不愿意相信的是, 只要积极地使用杠杆和资金管理技术, 回报就会是惊人的, 换句话来说, 如果没有合适的资金和风险管理工具, 即使交易系统优秀的令人屏息, 也不会成为可行的投资工具.

#### 交易时机

期货价格系列没有任何问题, 股票要考虑回购, 分红, 增发

### 2.2 测试

#### 市场数据的重要性

#### 回测时间长度

文献指出, 一个交易系统为了确保健壮性和一致性, 必须在多时段多市场测试(multi-period multi-market test)中达到一定的成功率.
一些机械交易者(mechanical traders)声称, 支持多市场的交易规则是不存在的, 因为交易系统有自己的个性, 交易系统只能适合部分而非全部市场.如果多市场测试是指在许多不同的市场 (债券, 股票, 商品, 货币, 股票, 等等) 中表现的都一样好, 从这个角度来讲, 能够通过多市场测试的系统确实很少.我们与这些交易者看法一致 - 不过, 经过20年的不断尝试, 今天的我们称得上是屈指可数的真正多市场交易系统之一.

反过来说, 正因为多周期测试是令人厌恶的, 机械交易者才认为过去只能是过去(意思是对未来并没有指导意义)：市场是随着经济结构和社会的变化而不断变化的.为什么会认为市场是一成不变呢？很多使用日内交易系统的系统交易者的绝不会用12个月之前的数据做回测, 甚至有些只用3个月内的数据.

我们认为, 回测周期的长度由长期交易中形成的智慧决定.举个例子, 一支银行股的价格是波动的, 在2000年的泡沫期间, 这家银行突然与一家网上银行合并.那么在2001年, 使用之前的交易系统进行测试是不合适的, 因为股票的走势已经因为合并而改变了.所以严肃的交易者会去掉非正常环境下的数据, 比如说 1999-2000 的股市泡沫, 或者是2008年的原油危机.每个系统在波动巨大的时候都是有效的(意思是单向趋势), 但是只有一个稳健的系统才能在正常情况下始终保持稳定工作.不正常的情况时有发生, 我们知道将会面对它们, 然而市场在80%的时间中都是正常的, 当它变得疯狂导致风险太高时, 一个好的系统能够感知到.

#### 规则复杂度和自由度

多市场测试的首要目标是检查一个系统是否按照预期的方式执行(如果手动测试, 系统发出的信号与程序员想要的信号位于同一位置), 并且当它们应用到市场上是否有利可图.我们不应该期望系统在我们测试的每个市场上都能盈利, 但能够盈利市场越多, 系统就越优秀.

测试可以对系统在统计学上的有效性进行初步验证, 而优化则是关注市场的特定行为特征, 并以此为依据对系统进行微调.尽管这只是一个不完全的定义, 但它有助于澄清为什么优化是在测试后进行 - 此时我们已经确认系统是可运行的.

通常的结果是, 一个系统在相似的合约上都是有利可图的; 换句话说, 例如, 在所有的能源期货上, 它们的表现都是一样的, 但在完全不同的债券市场上表现会差一些, 而在货币市场上则表现平平.

测试系统时最重要的是测试窗口大小的选择; 也就是说, 我们需要将系统应用到什么样的价格序列.这个决定并不遵循明确的时间表或经验法则, 而是需要遵守两个统计要求：价格系列必须足够长才能囊括不同的市场走势, 并随之产生大量的交易信号.

变量的数量和它们消耗的数据, 一般被认为也和整个数据样本相关, 这种相关关系我们称之为 **自由度** -- 也就是说, 变量和条件的数量和他们使用的数据不应超过整个数据样本的 10%. 避免一件事情是至关重要的, 那就是在我们拥有 500 个交易日数据的情况下, 为交易系统选取 500 个不同的条件.可能每个条件都不同于其余的499个, 而且只适合于那个特定的交易日, 这样每一天都有一个能赚到最多的钱的最优条件, 但是却对未来的市场没有任何预测能力(详见第5章).

对于那些没有数学思维的人, 规则的复杂性和自由度是一个难题.即使很多数学家也不能说清楚什么是自由度.在解释自由度时(通常表示为df), 也许最恰当和容易理解的解释就是那个关于已婚男人的笑话: "我只有一个妻子, 我的自由度是零.我应该通过观察其他女性来增加我的"样本量"."

严格来讲, 从统计到数学, 几何, 物理, 和力学, 自由度这个概念有很多定义. 在互联网上有一篇免费的论文尝试简单解释这个概念, 当然这是个困难的任务. 自由度的第一个定义(Larry Toothaker, 1986)可能是 "独立组件的数量减去估计参数的数量(the number of independent components minus the number of estimated parameters)". 这个定义源于Walker(1940)的定义："观察的次数减去这些观察之间必要关系的数量(The number of observations minus the number of necessary relations among these observations)". 但是如果从实践出发, 最好的解释是 Robert Schulle 博士(俄克拉荷马大学)的一个说法:

**在只有一个数据点的散点图(scatter plot)中, 你不可能对回归线(regression line)做任何估计. 这条线可以走向任何方向...此时你没有自由度(n-1 = 0, 其中 n = 1)用于估计(这可能会让你想起那个关于已婚男人的笑话). 为了绘制回归线, 你必须至少有两个数据点(一个妻子和一个情妇). 在这种情况下, 你有一个自由度用于估计 (n-1 = 1, 其中 n = 2). 换句话说, 自由度告诉你用于估计的有效数据数量. 但是, 如果只有两个数据点, 则可以将它们连成一条直线回归线, 并得到完美的相关性 (确定指数 = 1.00). 因此自由度越低, 评估效果越差.**

所以我们从直觉上就能得出结论, **样本规模越大, 使用的变量数量越少, 评估效果越好**. 罗伯特·帕尔多是当前唯一能在文献中把这事讲清楚的作者, 他在自己的书中给出了精辟的描述：

**自由度的计算 = 整个数据样本 - 规则和条件 - 规则和条件消耗的数据**

一般来说, 剩余自由度少于 90% 都被认为是太少了. 除了帕尔多的公式, 从实践的角度来看, 如果要在一个有 20 个变量的系统上进行适当的优化, 不能在仅有 6 个月日线数据的数据集上进行, 这一点非常重要. 变量的数量以及交易系统的条件集合, 与测试周期的长度密切相关. 换句话说, 一些度量需要更多的信息. 度量所需自由度的值, 是基于数据集中信息独立片段的数量. 信息越多, 度量越准确, 自由度越高.

至少剩下 90% 自由度的理念, 也可以反过来应用, 这就是表示用于系统计算的数据与测试窗口长度之间关系的 10 倍法则. 如果你使用 30 天移动平均收盘价格进行拟合, 测试时至少需要 300天 (30 x 10) 的数据.

让我们举个例子：我们现在有一个数据集, 包括三年内每个交易日的最高价格, 最低价格, 开盘价格和收盘价格, 这样共有(每年260个交易日)260 x 3 x 4 = 3120 个数据点. 我们假设有一个交易策略使用基于最高价格的 20 日平均线和基于最低价格的 60 日平均线.第一个均线使用 21 个自由度：20 个最高价格加上另外 1 个作为一条规则, 第二个均线使用 61 个自由度：60 个最低价格加上 1 个作为一条规则. 合起来总共是 82 个自由度. 以百分比计, 结果是 82/3120 = 2.6%, 剩下 97.4% 的自由度.

在计算中使用两次的数据点仅被计为一次, 如果你同时使用 5 日收盘价均线和 10 日收盘价均线, 对于后一个条件来说你将有 11 个自由度(10 数据 + 1 规则), 而对于第一个条件, 你将只有 1 个自由度(1规则). 总共消耗了 12 个数据. 很明显, 因为 5 日均线包含在 10 日均线中, 只有后者才与自由度的度量有关.

衡量系统是否可信需要的交易数量也与测试窗口的长度有关. 如果一个测试在产生多笔交易的过程中, 始终让错误的风险保持在最低水平, 这样的测试结果对于评估系统是否可信是非常重要的. 测试窗口的长度应该考虑到这个因素. 标准错误应该依据交易样本从交易系统的报告范围中添加或减去.
标准差的定义是:
标准差 = n + 1 的平方根
其中 n 是交易的数量

交易次数越多, 交易系统指标的可能误差就越小. 换句话说, 如果我们很少交易, 那么这些交易只是意外盈利的风险很高. 如果你一枪就射中了靶心, 要么你是一个神射手, 要么说你纯粹就是运气好. 相反, 如果你 100 次都射中靶心, 你就有很大概率是一名神射手.

一个系统要被认为是值得信赖的, 至少需要交易 100 笔, 这样其标准误差将是 100 + 1 的平方根, +10.04% 或者 -10.04% .

所有的交易系统指标都会在 +10% 和 -10% 的范围内变化.也就是说, 如果净利润是 100 美元, 那么实际净利润可能分布在从 90 美元到 110 美元的区间内.

### 2.3 交易系统的预测能力

#### 优化

优化在很多交易者中名声并不好. 甚至可以是对系统交易者的一种冒犯(系统交易者总是认为自己的系统已经足够好). 优化系统意味着在系统中找到那些能使利润最大化的系统变量, 或者能让交易者趋向主要目标的约束条件(例如, 系统更倾向于减少利润回吐, 而不是最大化利润). 让我们举一个例子：你有一个移动平均线交叉系统; 即系统在短期移动平均线穿过长期均线时买入. 针对这个系统的优化问题是短期均线是多短, 长期均线又是多长. 优化意味着"适合"一个系统; 也就是说让系统适应我们打算交易的市场[4].

但是优化是一把双刃剑：从波动性, 初始风险, 回报等角度, 让系统来适应市场是一回事.但是, 寻找那些可能让你在过去赚得最多, 却对未来没有预测能力的输入则是另外一回事. 让我们假设有一个系统, 每天都会以最低的价格购买并在最高的价格出售, 系统具有精确的入场和出场价格, 使其能够达成利润最大的目标. 这是一种错误的优化, 因为我们寻找一个每天都在变化, 而只能在每天收市后才能确认的最好价格. 这个系统没有任何预测能力(泛化, 规则必须有普遍意义).

在交易系统的开发过程中避免优化是绝对不可能的. 只要想想每个交易者目前正在做什么, 你就会明白, 优化是我们不得不面对的东西. 有交易者拒绝投入优化过程, 因为根据他们的观点, 一个系统可以在相同输入的情况下永远工作. 然后他们决定在一批系统选中某个交易系统, 就因为这个系统在过去比其他系统赚了更多的钱. 这难道不是一种优化吗？又一次他们改变了原系统的代码, 在原系统上添加约束和条件, 依据市场价格行为对系统进行调整, 然后选择在历史数据中表现最好的系统调整：这不也是一种优化吗？ 如果你现在不是特别倾向于优化, 请回顾下你的立场, 并考虑下你有多少次不经意地使用了优化.

优化在系统交易中是有价值的, 我们需要区分正常的优化过程及过度优化, 称为曲线拟合或过度优化. 例如：我们交易债券期货的日间系统会受到货币政策的影响. 货币政策不会每天都变, 它必须与经济扩张-衰退周期匹配, 所以我们谈论的实际上是持续多年的事情.在这种情况下, 很明显我们需要将优化窗口设置为6,12或18个月 - 这是依据市场和货币政策来调整系统的合理时间长度.

如果系统产生了大量的交易, 我们将在系统启用后的前两年测试系统, 然后我们微调系统, 上线后则在每6,12或18个月重新优化一次. 这种方法针对的是真正的交易, 而不是对系统的理论评估. 当然, 为了尽快确认系统是否可行, 系统必须用我们现有的最长价格序列进行测试和优化. 但这个过程并不能帮助我们找出适当的参数来进行下一笔交易. 这只是一个评估过程, 帮助我们确定系统是否适合该特定市场; 那就是如果净值曲线正在增长(净值可能不会像我们希望的那样平滑增长, 但至少应该果断向上).

换句话说, 通过应用已有的最长价格序列进行测试, 可以帮助我们检查系统是否能够捕捉指定市场的动向, 而在优化过程中我们通过改变输入, 观察系统是否仍有改进的空间. 然后, 我们在6到12个月的周期上持续优化, 对系统进行微调, 从输入的角度, 考虑特定市场的特点, 使系统与市场保持同步变化.

对于日内系统来说, 所有的测试, 优化和重新优化周期都会比日间或周间系统要短.

#### 走势分析(Walk forward analysis)

总之, 为了同步系统与市场, 我们可以说, 就数据窗口而言, 优化是可变的. 在电脑计算在大多数市场参与者中普及之前, 优化后"样本外周期(out-of-sample period)"对于所有交易系统开发人员都是值得推荐的. "样本外周期" 是一个与优化过程无关的数据窗口(通常是整个优化数据窗口的 10% 到 20%), 它会被应用到优化后的交易系统上, 以便在未知的数据上验证系统的预测能力. 如果系统在 "样本外数据" 上的表现与在训练集上表现一致, 这意味着该系统是稳健的, 能够进行可信的交易.
 
**到目前为止, 我们讨论的关于交易系统的想法, 在任何流通的书籍中都可以找到. 但是这些关于优化的观点都过时了, 它们来自那些计算机没有被广泛使用的年代. 今天的优化已经发展成为一种更有效和更适当的测试方法, 可以让一个系统与长期价格序列匹配. 这个方法以 "前向分析(walk forward analysis)" 或 "前向测试(walk forward testing)" 的名义不断发展.**

前向测试是一种多轮的, 连续的样本外数据测试, 它不停的用样本外数据测试同一个数据序列. 让我们举个例子: 先用数据集中前两年的数据对系统进行优化, 然后用随后6个月的数据进行验证. 此时再将优化窗口前移6个月, 对系统进行新的优化, 再用未来6个月的数据进行验证, 就这样继续下去. 这种优化是一种 "滚动" 的前向分析, 因为每次我们重新优化时, 优化窗口总是前移6个月. 如果开始时间不变, 随着时间的推移增加优化窗口长度, 这种方式称为 "锚定" 前向分析. "滚动" 前向分析更适合于盘中交易系统, 因为盘中交易系统面对的是不断变化的市场条件.

<p align="left" style="color:red;"><font size=5><b>注: 因为短期趋势不断变化, 不可捉摸, 所以减小分析的时间跨度, 保持对趋势的跟踪, 提升灵敏度.</b></font></p>

```
Rolling walk forward: out-of-sample (OOS) = 20%:
Run #1 |--------- In-sample 80% -------------- | OOS 20% |
Run #2                 |---------- In-sample 80% ------------ | OOS 20% |
Run #3                       |---------- In-sample 80% ---------------------| OOS 20% |
Anchored walk forward: out-of-sample (OOS) = 20%:

Run #1 |--------------In-sample 80% --------------- | OOS 20% |
Run #2 |----------------------------- In-sample 80% ---------------| OOS 20% |
Run #3 |-------------------------------------------- In-sample 80% --------------- | OOS 20% |
```

<p align="center"><font size=2>Figure 2.1: A graphical description of a  "rolling" and  "anchored" walk forward analysis</font></p>

前向测试中产生的净值线是交易系统开发过程中最接近真实的地方, 因为这就是真正的交易将带给我们的. 显而易见的是, 同基于整个价值序列测试或优化交易系统生成的净值线相比, 这种前向分析生成的净值线将完全不同. <font color=#fd0209 size=5><b>注: 一个关注长期趋势, 一个追踪短期波动</b></font> 所以交易员在决定是否放弃一个交易系统时往往会欺骗自己, 依赖交易系统在整个价格序列上生成的净值线, 实际上这样的净值线压根就没有反映经过定期重优化后的真实交易情况<font color=#fd0209 size=5 ><b>注: 定期重优化拟合的是最近的波动, 对于全周期未必是适用的</b></font>.

一种被广泛接受的衡量系统预测能力及其一致性的方法, 是计算前向测试年化净利润与优化期间年化净利润的比率. 这就是前向有效率(walk forward efficiency ratio). 如果该比率高于 100%, 那么系统是高效的, 在实际交易中保持预测能力的可能性也比较高. 如果交易者决定使用前向有效率为 50% 的系统进行交易(许多交易者认为这个水平已经是最低了), 他们应该期望该系统的实际表现至少是优化测试结果的一半. 统计学证据还指出, 一些优化的不够好的系统, 也可能在前向测试的一两步中幸运的有良好表现. 为了规避这个陷阱, 应该执行尽可能多的执行前向测试, 或者至少让测试窗口(即我们在优化后的交易系统上应用的数据窗口)前进 10 步, 并且测试窗口涉及的数据至少占整个优化价格序列的 10% 至 20%.

讨论 "静态的基于数据集中部分数据的 '样本外' 测试" 或 "如何优化交易系统" 都已经过时, 因为大多数专业交易系统开发软件都集成了前向分析功能. 这并不意味着交易者不用熟悉常见的测试和优化过程. 我们建议在使用 WFA 之前, 你应该做关于优化的作业, 从而获得系统及其性能的完整视图. 要运行完整的前向分析耗时巨大, 为了提升速度, 我们可以通过先进行一轮测试, 再进行一轮优化来检查系统的稳健性. 无论如何, 为了简单起见, 我们将总结一些好的优化提示.

如果我们有许多输入需要优化, 最好的方法是每轮测试一到两个输入, 与此同时其他输入都保持不变.<font color=#fd0209 size=5><b>注: 数学思维</b></font> 这样能将过度优化的风险降到最低, 因为当所有的输入不在同一轮优化时, 不可能简单的找到一组输入能让我们给方程的约束最大化.(since it is impossible to find the batch of inputs that will maximise the constraint we gave to the equation simply because the inputs will not be optimised together in the same run.)

#### 健壮性

我们是否能从后优化窗口 (post-optimisation window) 中推断出, 系统是健壮的, 抑或是过度优化的产物? 我们不需要迷信最优执行输入 (the best performing inputs), 将其视为必胜的条件. 如果足够的飞镖投掷在板上, 必然会有高分组, 或者换句话说, 如果把一只猴子放在钢琴前, 只要有足够的时间, 最终它能弹出一首奏鸣曲. 这个笑话表明, 如果我们相信性能最好的输入 (the most performing inputs) 的存在, 至少结果的平均值应该是盈利的. 如果仅有 1% 到 5% 的结果是有利可图的, 这可能是偶然的: 如果系统的变量有足够大的输入区间, 这个系统最终能依靠历史数据发财. 一个稳健的系统不仅仅在 5% 的测试中表现良好, 而是在所有测试的平均值. 换句话说, 如果平均结果是盈利的, 那么我们可以假设交易系统是稳健的. 如果你更倾向于统计结果, 你也可以从平均净利润和支票中减去标准偏差(或其倍数), 然后检查在这种情况下平均净利润是否仍为正数.

因此, 输入, 条件和变量的数量必须可控并尽量减少至最小. 但多少个输入, 条件和变量算太多? 这是一个存在争议的领域, 其中唯一的标志是必须始终遵守我们在前一段中描述的数值条件的自由度数. 在考虑输入之前, 如果输入变化或者在优化下结果没有任何变化, 则快速粗略地检查是非常重要的. 如果不是, 请保持不变以增加自由度.

要考虑的另一点是每个输入(在时间序列上)的扫描范围. 举个例子将更清楚地说明这个问题: 如果要测试一个基于每日数据的移动平均线交叉系统, 它包括短期移动平均线和长期移动平均线, 你不能在下面两条均线上进行测试 -- 从 1 到 20 (这里指日线中的短期)的短期移动平均线和 20 到 200 (通常被认为是长期移动平均线对应的日线间隔)的长期移动平均线. 对于短期均线(20 日均线)来说, 扫描窗口从第 1 项数据移动到第 2 项数据的变化是 100%, 而从第 19 项数据移动到第 20 项数据的变化是 5%. 而对于长期均线(200 日均线)来说, 扫描窗口边界从第 199 项数据移动到第 200 项数据只有 0.5% 的变化. 你需要在两个区间上进行等幅扫描, 即以 2 的步长执行从 1 到 20 的扫描, 同时以 20 的步长执行从 20 到 200 的扫描.

优化完成后, 应该做出关键的决定: 我们应该选择哪些输入批次? 首先我们需要做的是创建一个函数图表, 显示变量输入扫描范围与净利润的关系(或者选择其他标准进行优化).

![same_level](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_2.2.png)

<p align="center"><font size=2>Figure 2.2: In the middle of the chart as the variable varies the net profit stays almost at the same level.</font></p>

我们寻找的是理想情况下尽可能接近水平线的线, 在这条线上净利润不依赖于输入值. 当然, 实际情况与理论有很大不同, 所以我们应该满足于这样一条线, 它轻柔地上升, 在顶点维持一段时间然后下降. 顶部的水平区域正是我们想要的, 在这个区域中, 即使改变输入, 净利润几乎保持不变. 这是输入值表现出 **鲁棒性** 的区域. 与利润尖峰截然不同, 它是净利润相对较高的一个点, 但在它的周围净利润陡然下降. 换句话说, 我们需要找到一个甚至在改变输入值后净利润仍然能够保持稳定的区域.

![profit_spike](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_2.3.png)

<p align="left"><font size=2>Figure 2.3: As much as the variable changes the net profit shows deep and wide swings: there is no area where at the variable’s changing net profit stays more or less stable.</font></p>

<p align="left" style="color:red;"><font size=5><b>注: 鲁棒性是指控制系统在一定(结构, 大小)的参数摄动下, 维持其它某些性能的特性.</b></font></p>

总而言之, 我们可以得出以下结论: 输入和结果间应该有一条逻辑路径, 会产生一些与输入批次相关的东西. 当输入和净利润不存在线性关系时, 或者不存在回退关系, 或者不存在任何作为优化主要规则的约束, 整套结果必须是存疑的.

### 2.4 交易系统的评估

评估交易系统看起来很容易. 谨慎的交易者最后必须做的事情是违反直觉的: 乍一看, 我们确实会说净利润越高系统越好. 不幸的是, 这种感觉与事实毫无关系. 我们将提出一些不基于净利润和纯数字的通用方法标准, 以便淘汰这种具有欺骗性的方法. 然后我们将介绍指标 RINA 指数, 该指数由 TradeStation 详细说明. RINA 指数在系统交易者中越来越常见, 我们认为它的分析比任何其他工具都要好.

#### What to look for in an indicator

净利润是系统在测试期间带回家的钱. 即使绝对数量可以取悦读者, 它并没有从根本说明系统的真实性能, 而且它也没有说明风险. 在没有量化风险的情况下谈论利润是系统分析中的致命错误. 此外, 如果您添加适当的佣金和 **滑点**, 权益线形状可能会发生变化, 直至向下倾斜或变为负数(暗指亏损).

<p align="left" style="color:red;"><font size=5><b>注: 滑点(slippage)是订单的执行价格和期望不同, 滑点的原因是市场变化过快, 网速流量太低, 或交易者执行速度太慢.。</b></font></p>

因此我们得到两个初始的一般考虑因素, 如下:

1. 应对多功能回报指标进行标准化, 以便在多个资产类别或多个交易系统之间轻松进行比较.
2. 谨慎的指标总是将回报与风险进行比较, 而净利润指标两者都不包含.

此外, **一个指标应该始终传达的观念是他希望度量的是什么, 对于交易系统来说这就是"一致".** 什么是一致性? 一致性的同义词可以是 "稳定性": **一致性衡量指标的稳定程度.** 让我们以净利润为例: 净利润本身并未说明什么时候获利. 年与年之间利润可能变化很大, 甚至是仅在某一年内产生利润, 在其他年份都是亏损. 您会信任哪一个系统, 一个年复一年赚钱的系统, 或是一个 10 年前赚钱然后每年都亏钱的系统? 最后的结论是后面的系统更好, 因为 10 年前赚取的利润如此巨大, 后面的损失相比之下是可以接受的; 但是谁会遵循这个系统继续交易呢? 没有人会采用这样一个交易系统, 因为很明显 10 年前的意外收获可能是一个异常值, 一个永远不会重复的异常事件.

因此我们可以得出结论: 一个一致的交易系统不仅包括利润和亏损的均匀分布, 而且还包括连续且均匀分布的输赢交易序列. 如果您逐年查看一致交易系统的统计数据, 您会发现所有指标几乎相同. 如果逐年或逐月都出现显著差异, 则交易系统是不一致的. 盘中系统也可以采用类似的方式, 通过每周表现来衡量.

#### Average trade

如何评判一个交易系统是否优秀, 关于这个问题有一个重要指标 -- **平均交易收益(the average trade)**, 即净利润除以交易数量. 平均交易告诉我们每笔交易赚取或者亏损多少钱. 从绝对意义上来讲, 平均交易在弥补滑点和佣金后, 应该仍能为交易者留下一些利润. 按百分比计算, 平均交易在整个测试期间应保持一致. 通常情况下, 交易者将绝对平均交易(the absolute average trade)与特定交易的入场价格进行比较, 并以百分比的形式表示. 其他交易者将名义平均交易值(the nominal average trade value)与给定时期内合约的名义价值(the nominal value)进行比较. 我们推荐绘制交易的历史平均百分比值, 以便清楚地了解多年来系统的盈利趋势.

#### Percentage of profitable trades(盈利交易百分比)

盈利交易百分比表示盈利交易数量与总交易数量的比值. 它本身并不重要(一个趋势跟随交易系统的盈利交易百分比可能会比较低, 如 35%, 但它仍然是一个可行的系统), 重要的是它可以用来衡量系统如何平衡, 而系统平衡与 "平均交易赢利/平均交易亏损"的比值相关. 通常情况下, 如果你赢了很多次, "平均交易赢利/平均交易亏损" 比值会很低(盈利平均分布在每笔交易上, 导致每笔交易的盈利变少), 相反, 如果你的盈利交易百分比很低, 那么比值就会较高(两者之间是反比关系). 50% 的盈利交易百分比是健康的. 但是如果它大大超过 50%(例如 60% 或 70%), 请务必小心, 因为这意味着某些地方出了问题: 为了抗衡如此高的百分比, "平均交易赢利/平均交易亏损"比值应该特别低, 甚至常常低于 1(警戒水平). 如果您使用目标点位退出(让我们假设你以止盈价格退出 50% 的头寸), 那么盈利交易百分比超过 60% 是一件很正常的事情, 同时 "平均交易赢利/平均交易亏损" 比值会低于 2.

盈利交易百分比对于计算交易系统的数学期望也很重要. 盈利交易的百分比乘以平均交易赢利应该高于亏损交易的百分比乘以平均交易亏损. 换句话说, 数学期望应该是正数, 并且越高越好. 您可以使用这种数学期望度量来对系统进行排名, 然后选出最好的系统.

就盈利交易的百分比而言, 必须谨慎注意一个警告: 50% 的盈利交易比绝不意味着亏损之后就是盈利, 反之亦然. 如果一个交易序列声称两次盈利/亏损的交易之间有着特定的排列, 这其实进入了一个存在争议的领域. 即使这个话题很吸引人, 谨慎的交易也应该始终与最坏的交易作斗争, 并期待最好的交易, 就我们的经验来说, 相信"交易之间存在依赖"特别危险, 因为这个假设非常强大. 实际上你是假设在交易序列中存在重复的排列; 也就是说, 过去的概率表明, 在连续三场胜利后, 更有可能有两场失利, 而不是第四场胜利.

轮盘赌玩家真的相信, 如果你这次得到了一个黑色的数字, 那么在下一轮中获得红色数字的机会就会增加. 更糟糕的是, 他们认为如果随后出现了一排黑色数字, 那么获得红色数字的机会会变得越来越大, 例如连续 7 次或 10 次. 然而, 从逻辑思维和统计理论来看, 赌场中轮盘赌的每一轮都是完全独立的. 上一轮是否有红色数字, 黑色数字或绿色数字, 其实是没有任何意义的, 既不意味着好也不预示着坏. 每次出现的数字都完全独立于其他数字. 因此, 在下一轮中投注, 正确的概率总是相同的：18/37 = 48.6%(因为有 18 个黑色和 18 个红色数字加上一个绿色 0).

虽然金融市场, 特别是对初学者来说, 有时看起来特别像赌场, 但它们实际上是非常不同的, 且金融市场会更复杂. 在许多情况下, 他们表现得很意外, 指数上蹿下跳并且没人知道原因. 然而, 人类的贪婪和恐惧心理会产生一些特殊情况, 这些情况与市场的偶然行为不同. 正是在这些走势中, 特殊情况下的特殊交易系统, 可能会发生交易依赖. 但这是一个超出本书范围的复杂主题. 无论如何, 我们建议读者以极其谨慎的态度对待这一主题.

#### Profit factor(利润系数)

利润系数是一个完美指标, 用来比较不同交易系统或不同市场上的相同交易系统. 当然, 该指标是一个比率, 因此它不会受其他绝对值比率缺点的影响. 利润系数是毛利润除以毛损, 基本上揭示了毛利与毛损相关的规模. 当然是越高越好. 通常, 健康的交易系统的利润系数为 2, 平均交易盈利/平均交易亏损的比率为 2, 盈利交易数量的百分比等于 50%. 但也有一些利润系数介于 1.5 和 3 之间的良好系统. 考虑一下, 当你的利润系数超过 3 时, 你将如何优化系统, 以及如何进行交易系统的设计和开发.

#### Drawdown(亏损)

亏损的广义定义是在交易系统中最大损失和最大的连跌中, 选取最大的那个. 从图形上来看, 我们可以将亏损描述为在权益线创出新高之前, 权益线最高点和连续低点之间的下跌. 换句话说, "总权益亏损" 是指您账户中的未平仓合约的损益加上已经平仓的权益. 只考虑未平仓头寸还是只考虑平仓头寸, 这两种条件下亏损具有更微妙的含义. 事实上, 区分三种不同类型的亏损非常重要:

1. 终止交易亏损(end trade drawdown)告诉我们在允许退出指定交易之前, 我们允许回撤多少浮盈(账面盈利).
2. 关闭交易亏损(close trade drawdown)是进场和出场价格之间的差异, 而不考虑交易中的情况.
3. 初始交易亏损(start trade drawdown)度量的是在入场后和开始出现浮盈之间, 逆向走势导致的亏损.

为简单起见, 我们将使用 "关闭交易亏损" 定义, 因为它是最重要的. 同时有一点也很重要, 在用真金白银交易时, 我们可以忍受比依据理论计算出的 "关闭交易亏损" 规模大得多的浮亏(open trade drawdown).

不可否认的是, 亏损的绝对值对交易者产生了深刻的心理影响, 因为他将被迫处理它, 这可能是让人痛心的. 但是亏损就像盈利指标一样, 我们需要谨慎地以比较的方式使用这一度量. 为了达到这个目的, "水下权益线" (underwater equity line)的概念出现了; **水下权益线即亏损绝对值除以权益线的前最高值.**  这表示相对于权益线的缩减百分比. 因此, 即使我们基于 40 年的长期价格序列中测试系统, 这期间合约价值发生了巨大变化, 我们仍然能够有一个百分点参考值, 能够发现基于当前价格的实际预期亏损: 只需要基于当前市场价值绘制出最高的 "水下权益线" 百分比.

许多分析师正试图通过优化退出规则和初始止损来对抗亏损, 实际上进一步了解亏损发生的原因会更合适. 如果市场上出现历史性的怪异事件, 那么显然会出现异常亏损. 如果没有什么特别的事情发生, 那么才会怀疑系统的逻辑出现了问题.

为了评估我们必须担心哪种亏损, 以及哪种亏损是正常的, 计算平均亏损及其标准偏差是至关重要的. 如果最大亏损介于平均值的一到两个标准差之间, 那么我们预计未来的亏损将与我们过去的水平接近. 如果平均亏损超过平均值的两个标准差, 那么我们需要重新思考系统的逻辑, 前提是确认过去没有发生任何导致异常亏损的特殊情况.

<p align="left" style="color:red;"><font size=5><b>注: 统计学思维</b></font></p>

大多数专业交易员和基金经理的能够忍受的亏损是 20% 至 30%. 10% 的亏损可以算是一个精彩的成就, 但是 30% 的亏损则让人痛苦和令人担忧. 对于大多数市场参与者来说, 40% 到 50% 的亏损是无法忍受的.

<p align="left" style="color:red;"><font size=5><b>注: 这是暗示交易中的浮亏无法避免?</b></font></p>

#### Time averages(平均时间)

其他重要指标包括时间平均值. 根据 TradeStation 术语, 交易的平均时间显示在策略的指定期间内完成的所有交易花费的平均时间(年, 日, 分钟). 其他交易平台也有类似指标. 平均交易时间对于投资组合构建至关重要, 因为利用权益线之间的负相关性(套利), 您的系统需要同时进入市场或者至少具有相同的 "平均交易时间". 如果你使用两个系统组成投资组合, 其中一个较少交易但是需要长时间保持在线, 而另一个交易频繁, 但是每笔交易交易时间较短(快进快出), 那么您的累积权益线永远不会平稳.

<p align="left" style="color:red;"><font size=5><b>注: 这是是说不同周期的叠加, 导致累积权益线频繁出现上升下降, 无法保持水平.</b></font></p>

无论是做多还是做空, 交易系统都必须确保利润和风险是平衡的(不能高风险低收益). TradeStation 分别列出了做多交易和做空交易的系统报告, 在特殊情况下除非您可以找到合理的原因, 否则做多交易产生的利润应该始终能跟上做空交易产生的利润. 做多和做空利润不平衡的交易系统必须得到质疑.

#### RINA Index

RINA 指数是由 RINA Systems 创建并包含在 TradeStation 交易系统报告中的强大指标, 它代表单位时间内的回报风险比率, 这个指标实际上比较的是: "选择净利润(select net profit)" (净利润减去正负外部交易, 即减去超出平均值的三个标准差限制的异常交易) 除以平均亏损并再次除以市场指标中的时间百分比(the percentage of time, 总是取自 TradeStation 系统报告). 该指标应始终超过 30, 并且越高越好.

为了衡量结果的一致性, TradeStation 系统报告会针对平均交易收益(the average trade)和几乎所有指标自动计算三个标准差异正负极限. 这可以了解指标在这些边界之间自然振荡的程度. 通常, 变异系数(the coefficient of variation, 标准差除以平均值)不应高于 250%.

在本段中, 我们试图在不需要深入研究太多理论或哲学的前提下, 为系统开发人员整理出一些实用指南. 拥有 20 年经验的我们敢于公开承认, 我们可以一眼就看出交易系统是否值得被关注, 并且不担心任何人的质疑. 我们检查的第一个方面是权益线, 它需要平稳增长, 并且没有多少深度回撤. 就个人而言, **我们也很欣赏许多 "平静的时段", 即权益线的一部分是水平的: 这意味着过滤器让系统退出了市场(停止交易), 因此在此期间没有进行任何交易.** 我们认为没有必要不断进行交易, 当一些可以被利用的优势出现时, 一个好的系统应该能够及时感知, 反之则更适合待在场外. 然后, 除了权益线, 我们立即检查平均交易, 利润系数, 盈利百分比, "平均赢利/平均损失"比值以及多年来每月回报的分布方式. 仅从这些指标中可以得出关于交易系统的正确判断, 而不必担心掉入错误的陷阱.

### 2.5 结论

到目前为止, 我们已经涵盖了交易系统优化和性能评估中最重要的理论方面. 它简要概述了本主题所包含的概念, 但我们希望这份简洁将引导你进入更深刻的理解.

我们可以断言, 交易系统是一种科学的交易方法, 不需要任何人为介入. 显然, 这不是一个稳定的业务, 但它是一个应对概率的业务, 允许交易者利用统计优势入场搏杀.

通过阅读本书末尾参考书目中的文本, 您将会扩展这些知识, 深入研究交易系统评估和优化的细微差别.

不幸的是, 如果不处理交易系统的实际应用, 就不可能完全掌握这个主题. 交易系统的发展不是理论的挑战, 而是一种实用的市场实验方法. 编写代码, 测试它们然后优化它们是一个过程, 它允许交易者认识实际市场, 这有时比理论更重要. 知道如何遵循这个过程将节省大量的工作, 同时这个过程将有助于解决普通交易者无法接触到的情况.

在接下来的章节中, 您将对系统交易者在开发, 评估和优化交易系统时所做的工作有一个切实的看法. 我们相信这是我们工作中最重要的部分.

# Part II: 交易系统开发&演进真实案例

## Chapter 3: How to develop a trading system step-by-step – using the example of the British pound/US dollar pair

* **Introduction**

货币市场对所有类型的交易者都很有吸引力, 包括个人日间交易者, 交易公司, 金融和非金融公司, 银行和政府. 从新西兰的周一早上到美国的周五晚上, 他们每天24小时交易. 像英镑这样流动性充沛的市场, 为交易者提供了在任何时间尺度上, 实现任何不同想法, 开发任何类型的交易系统的可能性.

在本章中, 我们不会介绍最好的交易系统, 它承诺最高的利润. 相反, 我们的目标是向您展示一个交易系统, 该系统基于一个合理的想法并且经过改进以获得高稳健性. 为了帮助理解我们的交易系统开发概念, 您将在以下章节中逐步了解如何开发一个全新的交易系统并测试其稳定性.

我们选择具有突破组件(breakout component)的趋势跟随系统作为例子. 我们采用这个系统, 并展示如何通过下面的步骤改进它, 以使其成为一个有利可图的交易系统.

3.1 输入逻辑和代码. 如何利用突破过滤器(breakout filter)改进一个常见的移动平均线交叉系统.

3.2 评估没有参数优化和退出(exits)的交易系统 - 佣金和滑点的重要性.

3.3 输入参数的变化: 优化和稳定性图.

3.4 插入日内时间过滤器: 短期交易中时间重要性.

3.5 通过检查所有系统交易的演化来决定系统的适当出口. John Sweeney 的最大不利和最大有利游览将如何为您提供支持.

我们首先描述系统的逻辑.

### 3.1 The birth of a trading system

正如在介绍中提到的, 有很多来源可以用来开发自己的交易系统池. 其中之一必须是欧米茄研究(TradeStation)的战略交易和发展俱乐部(简称 "STAD"). 作为起点, 我们采用以下入口逻辑, 如 STAD 第 13 卷中所述:

卢克索系统通过两条移动平均线 - 快速平均线和慢速平均线的相交来触发交易. 当然, 有许多类型的移动平均线; 卢克索是 STAD 俱乐部中第一个使用三角形移动平均线的策略. 三角形移动平均线(TMA)的目的是增加价格数据平滑度,同时避免增加价格到指标之间的滞后时间. TMA 首先简单计算价格的算术平均值(通常使用收盘价). 然后, TMA 指标基于刚刚计算出的平均值再次计算算术平均值.

所以描述中的关键点是移动平均线的特殊类型. 然而, 当我们测试交易系统时, 我们发现移动平均线的类型并不重要, 最好的结果是用简单的移动平均线而不是更复杂的三角形移动平均线产生的! 因此, 您可以忘记这个三角形, 复杂的移动平均线并没有比普通移动平均线表现更好. 这证实了我们在开发交易系统时的一个观点, 最简单的也是最有效的.

系统开发的主要步骤如下: 获得符合交易市场个性的想法, 测试它们并使其符合您自己的需求. 我们在这里为 LUXOR 系统做这件事. 我们只讨论如何使用移动平均线并进行一些小改动.

#### The free LUXOR system code

想要实现这种逻辑的程序员可以在下面 TradeStation 的 Easy Language 中找到交易系统的代码. 我们在代码中添加了一些注释, 以便您了解所做的工作, 同时也便于您根据需要轻松修改代码.

<p align="center"><font size=2>Text 3.1: Easy Language Code of the LUXOR trading system. Bold letters: Code for the entries. Normal letters: added time filter. In comment brackets: possible simple exits.</font></p>

>{Copyright 2000. OMEGA RESEARCH, INC. MIAMI, FLORIDA.
>Strategy Trading and Development Club STAD, Volume 13,
>
>Modified 18 June 2006 and 15 July 2008 by Urban Jaekle
>Modified 1 January 2007 by Russell Stagg}
>
>{1. Definition of necessary inputs and variables}
>Inputs:
>FastLength( 3 ),  {The input parameters of the two moving averages… }
>SlowLength( 30 ),
>tset(1600),       {…start time for the intraday time window filter…}
>WindowDist(100);  {…window distance for the intraday time window filter…}
>                  {…can be changed – this makes optimisation possible}
>Variables:        {Definition of needed variables}
>    MP(0), Fast(0), Slow(0), GoLong(False), GoShort(False), BuyStop(0),
>SellStop(0), BuyLimit(0), SellLimit(0), tEnd(1700);
>
>MP = MarketPosition;
>
>{2. Time window filter; see below: 3.4, "Inserting an intraday time filter"}
>tend = tset + WindowDist;         {time window of 1 hour}
>if time > tset - 5 and time < tend then begin
>
>{3. Definition of moving averages and entry conditions}
>Fast = Average(Close, FastLength);
>Slow = Average(Close, SlowLength);
>
>GoLong = Fast > Slow;
>GoShort = Fast < Slow;
>
>{4. Entry Setup}
>If Fast crosses above Slow then begin
>    BuyStop = High + 1 point;
>    BuyLimit = High + 5 points;
>end;
>
>If Fast crosses below Slow then begin
>    SellStop = Low - 1 point;
>    SellLimit = Low - 5 points;
>end;
>
>If GoLong and C < BuyLimit then
>    Buy ("Long") next bar at BuyStop Stop;
>If GoShort and C > SellLimit then
>    Sell Short ("Short") next bar at SellStop Stop;
>
>{5. Exits: Derived from the slow moving average. These exits are not used here since
>we take different standard exits! Feel free to change the exits according to your needs}
>
>{If MP = 1 then Begin
>    Sell next bar at Slow - 1 point Stop;
>End;
>If MP = -1 then Begin
>    Buy to Cover next bar at Slow + 1 point Stop;
>End;}
>end;

Easy Language 代码可以分为不同部分:

1. 定义输入和变量.
2. 时间过滤器(在 3.4 中讨论).
3. 入场和出场设置.

由于本章的第一部分侧重于入场逻辑, 我们将交易系统的退出部分放在括号中的 Easy Language 代码中. 这意味着首先我们忽略出场并仅从该系统中生成交易. 在本章的后面, 我们将基于这些生成的交易应用出场逻辑.

#### The entry logic

现在让我们解释代码创建如何入场点(图 3.1). 入场点基于常见的移动平均线系统, 其工作原理如下: 在快速移动平均线上穿慢速移动平均线时, 你进入市场并买入, 如果快速移动平均线下穿慢速移动平均线时, 则以同样的方式入场做空.

<p align="left" style="color:red;"><font size=5><b>注: long(买入) short(卖出)</b></font></p>

众所周知, 在长期稳定趋势中, 这类趋势跟踪方法能够获取巨额利润. LUXOR 的入场逻辑使用了趋势跟踪的基本思想, 仅仅通过两条简单的移动平均值作为入场信号发生器. 但是它也按以下方式进行了修改: 均线交叉后还必须经过价格确认才能入场. 仅仅移动平均线并不足以启动交易. 如果是买入, 您希望当前价格超过近期高点后再入场交易(图 3.1). 类似地, 价格必须低于近期低点才能触发卖空. 请注意, 我们在这里只解释了系统代码中的做多逻辑, 而做空逻辑是对称构建的.

<p align="left"><font size=2>Figure 3.1: Entry Logic. The entry is not triggered by the crossing of the two moving averages. Instead, at the crossover bar the high is kept and used as a long entry level. Short entries are taken symmetrically. Chart example was taken from British pound/US dollar, 30 min, FOREX from 26 Dec 2007. Chart and datafeed from TradeStation 8.</font></p>

![Entry Logic](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.1.png)

系统具有以下两个输入参数, 可以进行改变和优化:

Inputs: FastLength (3), SlowLength (30);

这两个输入参数 "FastLength" 和 "SlowLength" 分别用于快速和慢速移动平均值:

Fast = Moving Average (Close, FastLength);
Slow = Moving Average (Close, SlowLength);

现在我们添加重要的突破过滤器. 在快速移动平均线向上穿过慢速移动平均线时, 交易不会在穿过的那一刻直接触发. 只要快速移动平均值始终保持在慢速移动平均线之上, 我们取这个柱的高点("交叉柱", 图 3.1 中用红色标记)并将其作为入场止损点(entry stop point):

If Fast crosses above Slow Then EntryLevel = High;
If Fast > Slow then Buy ("Long") next bar at BuyStop Stop;

这种条件判断虽然简单但是有效, 它提高了简单的趋势跟随系统捕获最有利可图的突破的概率, 而不是在任意均线交叉点都触发. 与常用的普通移动平均线交叉系统不同的是, 因为添加的过滤器必须确认移动平均线交叉有效, 这种方法能够过滤掉一些假突破.

### 3.2 First evaluation of the trading system

----------

#### Calculation without slippage and commissions

现在我们将该策略应用到从 2002 年 10 月 21 日至 2008 年 4 月 7 日的 30 分钟 FOREX 数据. 本章中所有的后续计算均基于单个合约. 为了便于入门, 我们在计算交易系统结果时不考虑任何滑点和佣金. 这些会在下一节中提及, 我们将会在那里检查它们对系统性能的影响. 此外请注意, 我们只通过入场和交易逆转来审视系统, 忽略交易退出.

<p align="left" style="color:red;"><font size=5><b>注: 逆转(trade reversals)指的是价格趋势方向的变化</b></font></p>

作为交易系统众多输入的第一个输入参数, 我们选择 10 个柱用于快速平均线, 30 个柱用于慢速移动平均线. 如果柱状图中的每个柱都是 30 分钟, 意味着快速移动平均线是从最近 5 个小时的交易数据中计算出来的, 同时也意味着慢速移动平均线依赖于过去的 15 个小时. 图 3.2 以详细形式显示了交易系统生成的权益曲线. "详细形式" 是指该曲线显示在其生命周期内发生的所有交易导致的权益上升和下降. 与那些只显示日末甚至月末权益的权益线相比, 这样的权益线包含了更多信息量.

<p align="left" style="color:red;"><font size=5><b>注: 这是的输入(entries)包括变量和均线</b></font></p>

<p align="left"><font size=2>Figure 3.2: Detailed Equity Curve of the trading system LUXOR on British pound/US dollar (FOREX), 30 minute bars, 21/10/2002-4/7/2008. Input parameters: SLOW=30, FAST=10. System without exits, always in the market. Back-test without any slippage and commissions. Chart from TradeStation 8.</font></p>

![Detailed Equity Curve](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.2.png)

从权益线上来看, 对于一个可行的交易系统来说这是一个良好的起点. 尽管出现了一些下滑, 但系统总是能够快速恢复并达到新高, 从而使初始资本得到相对稳定的增长. 交易数据也显示了交易系统的盈利能力(表 3.1). 在表中您可以看到 LUXOR 在 2002 年 10 月至 2008 年 7 月的测试期间内仅交易了一份合约, 然后赢得了 66,000 美元的净利润. 此期间的最大亏损为 16,000 美元. 如果假设起始资本为 30,000 美元, 那么这意味着您的总利润在过去六年中超过 200%, 同时最大亏损约为 50%.

<p align="left"><font size=2>Table 3.1: Main system figures of the LUXOR system. British pound/US dollar (FOREX), 30 minute bars, 21/10/2002-4/7/2008. Input parameters: SLOW=30, FAST=10. System without exits, always in the market. Back-test calculation without any slippage and commission.</font></p>

![Main system figures](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Table_3.1.png)

上文中的交易系统显示了趋势跟随交易策略的主要属性:

* 盈利交易百分比较低(36.5%). 在 1913 笔交易中, 只有 698 笔是盈利的, 大部分(1215)以亏损结束.
* 系统的整体收益来自于较高的 "平均盈利/平均亏损" 比值. 交易平均盈利为 846 美元, 比平均亏损(435 美元)高出两倍.
* 盈利交易的平均时间(所有盈利花费的时间/盈利交易的数量)约为亏损交易平均时间的三倍(62 个柱比上 24 个柱).

这些属性表明系统逻辑可能遵循了交易中最重要的规则, 每个人都知道但仍然难以遵守, 那就是 "减少亏损并让利润奔跑". 这种交易规则在心理上很难坚持, 因为你经常会直接遭受损失(减少损失意味着砍仓止损), 另一方面在你能够获得罕见而巨额的收益前, 你不得不等待很长时间.

值得一提的是, 系统做多比做空赚取的利润更多(56,900 美元对比 9,400 美元). 当我们在 讨论所谓的 5.3 章讨论 "**市场偏见(market bias)**" 时, 将继续讨论这一观察结果. "市场偏见" 意味着市场动向倾向于支持交易系统的指定功能或部分, 例如在这种情况下, 在被测市场处于总体上升趋势时, 趋势跟踪系统的做多机制会有更好的盈利能力. 我们的交易系统的优点在于, 虽然存在上升趋势的市场偏见, 但是交易系统的做空交易仍是盈利的. 这凸显了这种对称构建系统的稳定性.

此外, 因为交易系统仅反转头寸, 做多交易(957)与做空交易(956)的数量必然相同. 由于我们没有添加任何退出机制, 系统始终待在市场中, 持有多头或空头头寸.

<p align="left" style="color:red;"><font size=5><b>注: 反转意味着用做空交易直接代替做多, 反过来也一样, 同时将反转视为前一笔做空/做多交易的平仓.</b></font></p>

最后, 我们想强调一个在开发交易系统时永远不应低估的事实: 执行测试的统计意义. 如果您开发一个新系统并且在测试中您只有 100 个信号(交易信号, 可以理解为 100 笔交易), 甚至更少, 那么有很大可能这些盈利仅仅是偶然的. 在我们的回测中有近 2000 笔交易, 意味着该策略在未来(较近时段)稳定发挥的统计概率很高.

那么到目前为止你获得了什么? 统计数据表明, 入场逻辑是合理的, 并且具有较大可能在未来保持其行为一致. 但是, 如果您仔细查看交易数据, 您会发现该系统仅产生 35 美元的平均利润; 在不计任何交易成本前提下, 这样的 "每笔交易平均利润" 水平非常低! 所以到目前为止, 你拥有的只是一个能够检测出价格间微小利润的交易规则.

因此, 我们现在处于交易系统开发工作的起步阶段 在您完成一个完整的交易系统之前, 还需要执行许多步骤. 必须增加该系统的盈利能力, 并且必须增加退出机制. 在我们这样做之前, 我们先考虑交易成本, 使整个实现更加接近现实中的情况.

#### Calculation after adding slippage and commissions

从上面提到的 35 美元的交易平均利润中扣除 5 美元的佣金和 25 美元的滑点(总共三个点)后, 每笔交易的平均利润仅为 5 美元. 详细的权益曲线和下降图显示了这种更真实计算的结果(图 3.3). 虽然权益曲线正在横向移动并出现大量波动, 但水下权益曲线显示出大幅下降(高达 15%), 并且交易系统要花费很长时间才能从这些下降中恢复.

<p align="left"><font size=2>Figure 3.3: Result of the trading system LUXOR with added $30 slippage and commission per round turn. A: Detailed equity curve; B: Underwater equity curve. British pound/US dollar(FOREX), 30 minute bars, 21/10/2002-4/7/2008. Input parameters: SLOW=30, FAST=10. System without exits, always in the market. Chart from TradeStation 8.</font></p>

![Detailed Equity Curve With Slippage & Commissions](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.3.png)

LUXOR 交易系统现在看起来似乎毫无希望. 使用这个系统, 你与目标 - "在英镑/美元外汇市场上获利" 还有很大一段距离. 但请记住, 我们刚刚只是随意选择了两个输入参数, 它们可能是不合适的. 现在必须回答的关键问题是:这个交易系统是完全无用呢, 还是仅仅因为选择了错误的输入参数?

要回答这个问题, 需要基于多个不同的输入参数继续进行系统测试. 为了准备好这些测试, 同时也为了避免一些陷阱, 我们首先要解释清楚, 当我们执行这样的优化时我们真正寻找的是什么.

### 3.3 Variation of the input parameters: optimisation and stability diagrams

----------

#### What does stability of a system’s input parameter mean? A short theoretical excursion

在你开发一个交易系统时, 优化可以成为您最好的朋友, 也可以变成你最大的敌人. 重要的是, 当您改变系统的某些输入参数时, 您总是明白自己正在做什么. 请记住, 每个交易系统都是优化的结果. 当您选择系统参数时, 您是在比较不同的参数后才选择了它, 那是因为它在数据集上展示出一种特别的行为, 而您确信这种特别的行为在未来会继续保持. 即使您在淘汰其他类似的交易系统时没有调整任何输入参数, 但是胜出和被淘汰的交易系统本质上都是通过使用计算机 "事后" 优化输入参数的方式来完成的.

悬而未决的问题仍然存在: 系统的开发和选择参数阶段何时结束以及系统的优化何时开始? 由于这两个问题永远不可能完全分离, 最好接受这样一个事实: 每个交易系统都以某种方式适应过去, 因而也就进行了优化.(优化也是基于已有数据) 因此, 对于系统开发人员来说关键问题始终是: 您在回测中选择哪个参数? 哪些设置更有可能在未来的交易继续产生真实利润? 这个问题的答案对于每个交易系统都是不同的, 但是一条规则是通用的: 当您使用系统参数的邻近数字作为参数时, 交易系统的盈利必须和采用原参数时差不多, 并且满足上述条件的参数范围越大越好. Murray Ruggiero 是一位经验丰富的专业交易系统开发人员, 他有关此主题撰写了一篇文章[7]:

>"如果你不喜欢相邻的数字, 你就会遇到问题, 因为有很大可能你会在相邻参数集上栽跟头."

让我们看一个例子(图 3.4), 我们在其中检查假想系统的输出结果, 为了找出能让系统稳定的输入参数. 在横轴上您可以看到此假设系统有一个输入参数, 这个参数可以是任何值, 移动平均值, 止损或止盈目标的距离. 延迟时间等. 净利润与系统参数的关系可以用函数来表示, 您可以在垂直轴上找到以任意单位表示的净利润.

就净利润而言, 该人工交易系统的最佳输入参数是 17. 使用此参数时, 系统获得 80,000 单位的盈利. 但是看看它的邻居. 在邻域中, 当参数是 16 时, 系统的利润非常差(5000 单位), 当参数是 18 时, 甚至会造成损失(-10,000 单位). 如果您参与的市场在未来稍有变化, 您将永远无法再次获得在回测中使用参数 17 显示的良好利润. 因此, 尽管在这个假设系统中 17 是 "过去" 最好的参数, 但它肯定不是您未来的最佳选择.

但是, 如果您在 4 到 10 之间的区间中选择一个参数, 例如 8, 你会处于更安全的区域. 在该区域中, 您的回测净利润不如您采用最佳拟合参数(17)时高, 但邻域中的参数与您选择的参数相比, 回测净利润是差不多的, 利润在 60,000 单位上下波动. 如果未来市场发生变化, 您的交易系统参数如果采用 8 或 4 到 10 区间内的其他值, 很大可能产生的利润与回测时相似. 因此, 你应该选择的是表现良好(不一定是最好的!)且在领域上表现出泛化能力的参数.

<p align="left"><font size=2>Figure 3.4: Choosing stable parameters for your trading system: Net profit as a function of one system input parameter in arbitrary units. Artificially generated result of a hypothetical trading system.</font></p>

![Choosing stable parameters for your trading system](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.4.png)

#### Dependency of main system figures on the two moving averages

从理论回归现实. 让我们来看看我们的交易系统 LUXOR 在改变两个输入参数后的表现, 每笔交易包含 30 美元的滑点和佣金成本. 我们希望看到当快速和慢速移动平均线的长度变化时, 趋势跟踪交易系统的结果会如何变化. 我们将在较大的范围内改变两个平均值, 快速移动平均线的长度从 1 个柱到 20 个柱, 步长为 1, 慢速移动平均线的长度从 21 个柱到 80 个柱, 步长同样为 1. 一台快速的 PC 大概需要三分钟完成所有 1200 次系统测试.

从这些测试中, 您可以认为总净利润是两个不同输入参数的函数, 然后绘制到图上. 您可以分别为每个输入参数执行此操作(如图 3.4 所示), 但您也可以在一个三维区域图中为两个系统参数执行此操作(图 3.5). 这样您可以得到一个三维面, 向您展示输入参数如何影响交易系统结果. 使用指定的软件, 您甚至可以在每个方向上转动这个三维面, 并从不同的角度查看. 图 3.5 A 和 3.5 B 显示了不同视角下的相同图形. 图 3.5 A 显示了侧面, 图 3.5 B 显示了俯视图. 从这两个图中可以看出, 交易系统在很大的输入参数范围(深蓝色区域)内都可以盈利, 但在其他参数设置范围内(黄色, 绿色和浅蓝色区域)只有微薄的利润, 甚至会产生亏损.

<p align="left"><font size=2>Figure 3.5: Three-dimensional area diagrams for all trades of the system LUXOR. a) side view, b) top view. Net profit in US dollars as a function of the two input parameters: fast and slow moving average. Tested on British pound/US dollar (FOREX), 30 minute bars, 21/10/2002-4/7/2008, incl. $30 S+C per RT. Diagrams generated with RINA 3D Smart View.</font></p>

![Three-dimensional area diagrams](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.5.png)

当然, 我们正在寻找的是能够在过去产生高净利润的输入参数. 但是如图 3.4 所示, 对于系统参数来说更重要的是, 在它们附近有足够的同等参数, 使得交易系统的盈利几乎与采用 "最佳" 参数时一样. 在我们开发的交易系统中, 到目前为止, 右下方的整个区域(图 3.5 B)乍一看似乎满足了这一要求. 我们现在将放大镜对准这个较短的区域并对其进行仔细研究(图 3.6 A-D). 从这些图表中可以看出, 系统对所选区域中的参数变化并不敏感, 始终保持了较稳定的收益. 尽管总净利润在相对较大的范围内变化剧烈(在 20,000 美元到 100,000 美元之间), 但对于所有选定区域中的输入参数, 它毫无疑问的保持了盈利. 当快速移动平均线非常小(小于 3)且慢速移动平均线在 30-50 之间时, 选定区域实现了近 100,000 美元的最佳利润. 该区域也对应了最小的 "盘中最大跌幅"(见图 3.6 B), 约为 15,000 美元. 在所有参数中, 最大盘中跌幅确实变化很大, 但从未越限 - 它总是低于约 35,000 美元.

<p align="left" style="color:red;"><font size=5><b>注: 同等参数指能够让交易系统与所选参数产生类似净利润的参数.</b></font></p>

与 "总净利润" 和 "最大日内亏损" 一样, 您可以将更重要的统计数据绘制为两个输入参数的函数(图 3.6 C 和 D). 如果您这样做, 您可以进一步了解您的交易系统. 例如, 如果您观察 "系统的交易总数"(图 3.6 D), 您会一个存在于许多趋势跟踪系统中的事实, 那就是: 您响应的速度越慢(在我们的例子中, 这意味着两条移动平均线的周期越长), 系统的交易量越少. 通过改变系统的输入参数, 您可以影响某些关键属性, 从而使系统可以更好地匹配您的交易方式或大型投资组合中资金管理方案的要求. 假设您的投资组合中有许多快速反应系统, 需要一些反应迟缓的组件 - 您可以通过为移动平均线设置更长的回溯周期来实现这一点. 如果您需要更快速的反应系统, 则可以将输入参数更小. 当不同交易系统及其不同的时间尺度之间的相关性变得重要时, 我们将在我们的投资组合构建部分回顾这一结论.

有趣的是, 在我们的交易系统中, 虽然交易数量随着系统的输入参数变化巨大, 但另一个交易数据 "每笔交易的平均利润" 却保持了相对稳定(图 3.6 C). 它在 10 美元到 50 美元之间变化, 但大多数时间位于 30 美元到 40 美元之间, 特别是对于 1 到 9 之间的所有快速移动平均线与 30 到 50 之间的慢速移动平均线构成的系统.

根据这些结果, 您可以得出结论, "好的" 系统参数将是包括瞬时反应的快速移动平均值(小于 3)和 30 到 50 之间的慢速移动平均线. 让我们将值 "1" 作为快速移动平均值的输入值. 很明显, 单周期移动平均线不是真正的移动平均线, 但为了简单起见, 我们仍然将其称为移动平均线. 事实上, 快速移动平均线本身就是收盘价. 对于较慢的均线, 您可以选择 30 到 50 之间的任何值. 我们在此选择 44 作为输入值, 因为它产生最高的总净利润并且具有广阔的同等参数邻域。

当然, 您应该在接下来的几个月内密切观察系统的行为, 如果经过较长时间的筛选后发现所选参数(1/44)不是最稳定的选择, 那么您必须更改它们, 例如 3/30(如果这些参数证明比最初选择的 1/44 更稳定). 这种参数变化是重新优化的一个例子. 您将在第 6 章中找到关于 "周期重新优化" 和 "前向优化"(walk forward optimisation)的更系统的方法.  目前我们保持参数 1(快速均线) 和 44(慢速均线), 我们将仔细研究交易系统的表现.

<p align="left"><font size=2>Figure 3.6: Three-dimensional area diagrams for all trades of the trading system LUXOR. Main system figures as a function of the two input parameters: fast and slow moving average. Tested on British pound/US dollar (FOREX), 30 minute bars, 21/10/2002-4/7/2008, including $30 S+C per RT. A: net profit B: maximum intraday drawdown C: average trade net profit D: number of total trades generated. Diagrams generated with RINA 3D Smart View.</font></p>

![Three-dimensional area diagrams A](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.6_A.png)
![Three-dimensional area diagrams B](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.6_B.png)
![Three-dimensional area diagrams C](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.6_C.png)
![Three-dimensional area diagrams D](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.6_D.png)

#### Result with optimised input values

随着将快速均线设置为 1 个柱(等于收盘价)而慢速均线设置为 44 个柱, 您将获得稳定增长的收益曲线(图 3.7 A). 这一结果通过水下权益曲线得到证实, 该曲线在每次下降后总是迅速恢复(图 3.7 B). 最大的回撤发生在 2003 年 11 月, 值为 8%, 只有我们通过未优化的输入参数(10/30)获得的超过 15% 的最大回撤的一半.

<p align="left"><font size=2>Figure 3.7: Trading system LUXOR, tested on British pound/US dollar (FOREX), 30 minute bars, 21/10/2002-4/7/2008. Optimised input parameters in terms of net profit: SLOW=44, FAST=1. System without exits, always in the arket, long or short. Back-test includes $30 slippage and commission. Chart from TradeStation 8. A: Detailed equity curve; B: Weekly underwater equity curve.</font></p>

![Optimised input parameters in terms of net profit](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.7.png)

<p align="left"><font size=2>Table 3.2: Main system figures of the trading system LUXOR. British pound/US dollar (FOREX), 30 minute bars, 21/10/2002-4/7/2008. Input parameters: SLOW=44, FAST=1. System without exits, always in the market. Back-test includes $30 slippage and commission per round turn.</font></p>

![Table 3.2](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Table_3.2.png)

尽管 LUXOR 系统的总体 "回报/亏损" 比率是可以接受的, 但仔细观察系统数据可以发现, 我们迄今为止开发的系统尚无法进行交易(表3.2). 尽管该系统显然是盈利的且交易系统表现稳健, 但 33 美元的平均交易利润仍然不算是有利可图.

此外, 因为平仓机制(exits)缺失, 系统不得不始终保持在场内. 因此, 这种状态下系统是不可用的, 因为与预期收益相比风险太高. 因此, 在接下来的两章中, 我们将进一步扩展我们的交易系统.

首先, 我们将寻找有用的日内时间过滤器, 以提高系统的盈利能力. 本章的最后一节将讨论添加必要的出口(exits).

### 3.4 Inserting an intraday time filter

历史上, 我们遇到过很多交易大师和赚钱的交易系统, 它们在交易日的不同阶段利用了金融市场的不同行为. 有些交易员和系统仅仅在下午使用短期突破策略盈利, 还有一些交易者和系统需要他们那缓慢的趋势跟踪策略运行一整夜后才能获利. "时间" 因素在您的交易策略中非常重要, 原因很简单, 即市场由人控制, 而人们则受到日常时间表的制约. 由于货币市场 24 小时交易, 当天的时间对于市场的行为而言特别重要. 大型美国做市商活跃与否, 是欧洲, 美国或亚洲的夜晚或白天, 都会使得市场表现有所不同. 每日外汇交易量清晰的显示了市场活动在每个交易日内发生了很大变化. 一些时段市场表现的很活跃, 因而有可能获得更高的利润, 另外一些时段市场风平浪静, 除了一些意外横向移动导致的市场噪音. 因此, 研究不同的时间过滤器如何改变交易系统的结果是很有价值的, 特别是在面对英镑和美元等货币市场时.

----------

#### Finding the best entry time

我们现在以下列方式执行系统测试. 我们采用已有的 LUXOR 入场点, 但我们将每天的入场时间限制为一个 4 小时的时间窗口. 我们将在一天中以 30 分钟为单位调整窗口的开始时间, 以便找到最佳窗口. (对于 Easy Language 程序员来说: 您必须在 LUXOR 代码中添加一些行, 如上所示, Text 3.1, point 2, Time Window Filter.)

图 3.8 显示了交易系统的总净利润与 4 小时时间窗口开始时间的函数关系. 结果非常重要! 您看到我们交易系统的利润很大程度上取决于所选择的时间窗口. 当您从格林威治标准时间(GMT)下午 5 点开始交易时, 交易系统会亏钱, 而在 GMT 白天时段, 尤其是早上 8 点到 12 点之间, 它可以获得高额利润.

<p align="left"><font size=2>Figure 3.8: Total Net Profit as a function of the entry time of a 4-hour time window. LUXOR system, tested on British pound/US dollar (FOREX), 30 minute bars, 21/10/2002-4/7/2008. SLOW=44, FAST=1. Calculation incl. $30 S+C per RT. No exits are in place.</font></p>

![Total Net Profit](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.8.png)

当您以 7.30 am 作为时间窗口的起点时, 交易系统获得了最高的净利润, 这意味着您只允许在早上 7:30 到上午 11:30 间入场和反手. 在上文关于输入参数的稳定性和稳健性的讨论中, 您已经知道, 所选系统参数具有表现良好且广泛的邻域非常重要. 这个邻域表明交易系统具有最高的可靠性, 实际交易中的表现奖符合其在反向测试中的结果. 因此, 我们将窗口的开始时间设置为上午 9:30 - 盈利参数区域的中间, 而不是在早上 7:30 的最有利可图的位置. 选择的时间过滤器意味着我们只允许在 GMT 上午 9:30 到下午 1:30 之间交易. 这是下午(格林尼治标准时间)来自美国的大量交易尚未到来的时候. 在一天开始的时候进入趋势, 之后通过美国的交易量来放大, 我们的交易系统看起来非常不错.

#### Result with added time filter

增加了时间过滤器后, 我们交易系统的详细权益曲线似乎没有太大变化(图 3.9 A). 相反, 看一下水下权益曲线就可以发现, 5 年交易中的回撤幅度从没加过滤器时的 8% 增加到了 10%. 此外, 我们修改后的交易系统现在需要更长时间才能从这些回撤中恢复. 那么我们从过滤器中获得了什么? 您可以仔细查看交易数据来评估时间过滤器的影响. 如果你看一下交易的数量, 你看到它们已经大幅减少到 902, 而系统之前生成了近 3000 笔交易. 比没有时间过滤器的 100,000 美元, 总净利润略微增加到 115,000 美元, 这些推导出了一个结论, 对于使用系统来说非常重要:

现在每笔交易的平均利润为 128 美元(包括 30 美元的滑点和佣金), 相比之前在全天候交易时获得的少得可怜的 33 美元利润, 这是一个四倍的改进!

<p align="left"><font size=2>Figure 3.9: LUXOR system results with added time filter. Entries only allowed in the 4-hour time window from 9.30am–1.30pm GMT. A: detailed equity curve. B: weekly underwater equity curve. British pound/US dollar (FOREX), 30 minute bars, 21/10/2002-4/7/2008. Optimised input parameters in terms of net profit: SLOW=44, FAST=1. Test without exits. Back-test includes $30 slippage and commission. Charts from TradeStation 8.</font></p>

![LUXOR system results with added time filter](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.9.png)

<p align="left"><font size=2>Table 3.3: Main system figures of the LUXOR system with added time filter: Entries only allowed in the 4-hour time window from 9.30am– 1.30pm GMT. British pound/US dollar(FOREX), 30 minute bars, 21/10/2002-4/7/2008. Optimised input parameters: SLOW=44, FAST=1. System without exits, always in the market, long or short. Back-test includes $30 slippage and commission.</font></p>

![Table 3.3](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Table_3.3.png)

但是, 尽管有这些令人振奋的交易数据, 该系统仍有一些明显的弱点.

正如我们已经提到的那样, 回撤幅度轻微增大 - 最大回撤为 18,900 美元, 而之前为 13,400 美元. 但是回撤增大以及交易系统权益不像以前那样稳定的事实并不是新系统最糟糕的特征. 当前状态下交易系统的弱点在于它真的很危险, 因为交易只能在格林尼治标准时间上午 9:30 到下午 1:30 之间的 4 小时窗口内进行. 如果在此窗口之外得到反转信号, 例如在格林威治标准时间凌晨 1 点, 由于不允许交易，系统无法退出或反手持有的仓位. 在您的交易窗口之外, 无论发生什么, 您都必须在市场上停留 20 个小时. 因为窗口的限制, 系统肯定不可能像以前一样一直交易, 但是考虑到无论窗口期外行情有何发展, 您都不得不在市场上发呆 20 个小时, 系统在这种情况下会有过高风险. 我们不得不紧急添加退出来改变这种情况. 通过添加退出, 我们不仅要创建一个能够盈利的交易系统, 还要创建一个风险可控的交易系统.

### 3.5 Determination of appropriate exits – risk management

----------

> 以这种方式看待它: 你的交易系统是类似一个从屁股上射击的快枪手(随时应战), 还是像一个为了伏击而埋伏好的狙击手，了解你的交易走向何方, 决定了
> 你是骑在马上享受落日美景(暗示胜利), 还是重伤后倒在正午尘土飞扬的街道上(暗示失败). 为了活着, 你必须知道什么时候撤退, 什么时候前进.
> Thomas Stridsman

每个人都知道止损(stops)是必要的, 但没有人真正喜欢它们. 通常你会感觉到止损(stops)只是在市场转向你的方向之前就把你赶出了市场, 结果是让你错过重大行情.

<p align="left" style="color:red;"><font size=5><b>注: 平仓(close position) 入场(Entry) 退出(Exit) 止损(Stop Loss) 止盈(Stop-Profit).</b></font></p>

在本节中, 我们使用统计研究方法来探讨量化出口. 在我们过去的所有统计探索过程中, 很明显的一个结论是, 出场永远不能独立于相关的入场. 重要的是要意识到, 入场的动态对于有效出场的动态, 甚至是仓位的反转都有着重大的影响. 想象一下, 进入一个安静的, 没有波动的低成交量市场，并将其与在市场活跃阶段触发的入场进行比较, 例如 "新闻触发的突破"(图 3.10). 在第一种情况下, 市场横向移动而没有明显方向, 最好以近期利润目标(close profit target)获利出场. 在第二种情况下, 一个宽泛的止损点加上不设置止盈点位, 这两个出口将为交易提供足够的发展空间. 过于接近(入场价位)的每个止盈点位或止损点位都会让您过早地退出盈利的交易. 在这种情况下, "最优" 的退出将是发生在 "大笔交易减少且突破已经明显结束时" 的日末退出.

<p align="left" style="color:red;"><font size=5><b>注: "入场的动态对于有效出场的动态, 甚至是仓位的反转都有着重大的影响", 这里的意思应该是不能仅仅看点位, 入场点位与入场时的市场走向应该放在一起看, 将在后面决定在何种走势下的哪个点位出场.</b></font></p>

出于这个原因, 我们不建议使用人工生成的合约测试出口, 例如: 随机入场或在每个交易日开盘时入场. 我们发现使用这些随机入场点会将统计结果导向歧途. 测试结果(最优出口)总是被常见的市场走势把持(出口更多的是与市场走势相关), 并没有与你指定的市场策略相匹配.

<p align="left"><font size=2>Figure 3.10: The Dynamic of Exits. In the phase of low volume and low volatility different exits are needed than in the phase of increasing volume with the short breakout. Chart example was taken from Light Crude Oil, 5 minute, NYMEX from 22 August 2008. Chart and datafeed from TradeStation 8.</font></p>

![The Dynamic of Exits](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.10.png)

没有放之四海而皆准的最优出口! 如果您使用的是其他类型的系统或在其他时间尺度上, 则无法直接转换现有出口来匹配新的入口逻辑. 当然, 您可以将这些已有的出口作为大致的方向, 但您必须花时间基于不同的入口或时间尺度来开发合适的出口.

为了找到上述策略的适当出口, 我们将对统计领域进行一次小规模的纵览. 我们分析单笔交易的过程, 以确定可用的止损水平和利润目标. 这个分析在开始时看起来有点异国情调. 但是, 只要您熟悉它, 您就会对您的交易系统及其适用的出口有一个很好的理解.

#### The concept of Maximum Adverse Excursion (MAE 最大逆向偏移)

为了找到适合您系统的止损点, 您应该深入了解交易的分布并单独检查每笔交易. 当你这样做时, 你会发现它们之间既有相似之处, 也有自己的一套特征. 这些特征可以通过使用 John Sweeney 在不到十年前开发的最大逆向偏移(MAE)技术来检验. MAE 被定义为相对您的头寸的最大日内反向价格变动. 换句话说, 它是单笔交易在生命周期中的最低权益. MAE 概念允许您评估系统的个别交易, 从而决定将保护性止损设置在哪个价位或百分比.

让我们来看看我们交易系统的 MAE 图形(图 3.11). 该图显示了在测试期内产生的所有 902 笔交易. 对于每笔交易, 您都可以查看与每笔已实现的损益相关的亏损. 获利交易显示为绿色向上箭头, 亏损交易显示为红色向下箭头. 在 MAE 图的垂直 y 轴上, 您可以看到最终的利润, 而水平的 x 轴则显示每笔交易的日内亏损.

由于我们使用此图形来确定止损位置, 因此我们将所有盈利和亏损交易放在同一个集群图上. 这意味着虽然图 3.11 中交易 A 和 B 看起来相似, 但是实际上它们是完全不同的. 交易 A 最大亏损是 2400 美元, 平仓亏损 1000 美元. 另一方面, 交易 B 遭受了更大幅度的 2500 美元的缩减, 但最终恢复并以 1000 美元的收益平仓. 沿 y 轴指示的美元金额是利润还是损失取决于小三角形的颜色和方向. 保持交易聚集在同一图表上可以更容易地判断在通常情况下, 一笔交易在最终确认亏损前通常会产生多少权益上的损失. 通过这种方式, MAE 图形可以告诉您何时止损, 因为与交易相关的风险变得不再合理. 这为您确定保护性止损位置提供了有价值的指示.

<p align="left"><font size=2>Figure 3.11: The MAE graph of LUXOR system. Green: winning trades, red: losing trades. System tested on British pound/US dollar (FOREX), 30 minute bars, 21/10/2002-4/7/2008, with entry time window 9.30am-1.30pm GMT. Input parameters SLOW=44, FAST=1. Without exits, always in the market, including $30 S+C per RT. Diagram created with TradeStation 8.</font></p>

![The MAE graph of LUXOR system](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.11.png)

为了确定止损位置, 我们以百分比单位展示相同的 MAE 图(图 3.12 A). 我们切换到百分比单位, 因为相对于美元单位, 百分比可以更好地适应不断变化的市场条件. 特别是在具有巨大点位变化的市场上, 基于百分比计算的优势变得显而易见. 在这种情况下, 最好灵活的选择匹配当前市场价位的出口, 而不是死板的保持固定点位.

<p align="left"><font size=2>Figure 3.12A: MAE graph in percentage terms. Green up arrows = winning trades, red down arrows = losing trades. Trend-following system British pound/US dollar (FOREX), 30 minute bars, 21/10/2002-4/7/2008, with entry time window 9.30am-1.30pm GMT. Input parameters SLOW=44, FAST=1. Without exits, always in the market, including $30 S+C per RT. Diagram created with TradeStation 8.</font></p>

![MAE graph in percentage terms](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.12_A.png)

<p align="left"><font size=2>Figure 3.12B: Maximum Adverse Excursion graph in percentage terms after inserting a 0.3% stop loss into the system. LUXOR system tested on British pound/US dollar (FOREX), 30 minute bars, 21/10/2002-4/7/2008, with entry time window 9.30am-1.30pm GMT. Input parameters SLOW=44, FAST=1. Diagram created with TradeStation 8.</font></p>

![Maximum Adverse Excursion graph in percentage terms](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.12_B.png)

为了熟悉 MAE., 让我们简单解释 MAE 图中的一些交易. 首先你看到上面提到的交易 A 和 B 的相对位置发生了变化. 由于两笔交易发生不同时间, 对应的市场成交价也不同, 因此交易 A 现在处于 y 方向的较高位置. 由于现在计算基于相关市场的百分比, 因此相同的美元值通常意味着不同的百分比值.

在 MAE 图中观察所有这 902 笔交易时, 您可以看到交易系统的一些特征. 第一点是, 在图表的左侧, 您会发现盈利的交易比亏损交易更多. 这很明显, 因为盈利交易通常不会像亏损交易那样遭受如此大的亏损. 对你而言, "最好" 交易显然是那些表现如同交易 C 那样的交易 - 一开始就盈利, 在其生命周期中不会承受任何负面权益敞口, 并且位于靠近图表 y 轴的最左侧(盈利/亏损轴).

<p align="left" style="color:red;"><font size=5><b>注: 权益敞口(open equity), 指账面上存在但未最终实现的盈利或亏损.</b></font></p>

另一个有趣的交易领域是我们所谓的 "**亏损对角线**"(loss diagonal). 在这条特征线上你可以找到很多亏损的交易. 像交易 D 一样, 所有这些交易都以亏损结束, 同时平仓亏损也是他们的最大亏损. 另一方面, 也存在像 E 这样的交易. 该交易在入场点大幅下跌超过 3.5%, 但最终平仓损失确恢复到仅有约 0.5%.

现在, 为了限制交易风险, 我们希望在距离入口点的特定距离(市场价格百分比)处设置保护性止损. MAE 图如何帮助您确定入场点到止损点的距离?

让我们先看看 MAE 图, 它可以帮助你理解插入的止损点对于你的交易系统来说有啥作用.

MAE 图中的止损可以绘制为垂直线. 从理论上讲, 这条垂直线会干掉所有在入场后遭受的损失大于止损的交易(图 3.12 B). 在 MAE 图中, 这意味着止损拦住了 0.3% 线右侧的所有交易, 并将其移亏损移到该线附近. 对于因为止损而亏损变小的所有交易(红点)而言, 这听起来不错. 但想想那些盈利的交易, 一旦他们到达止损线后便永远没有机会成为赢利交易, 取而代之的是变成图表中的红点, 亏损 0.3%.

<p align="left" style="color:red;"><font size=5><b>注: 不能一刀切</b></font></p>

我们试图将止损放在这样一个区域, 既能捕获大多数盈利的交易, 同时也能限制策略的利润侵蚀风险. 显然, 好的止损设置是在不影响盈利的交易, 或者至少是那些能够从最低点恢复的交易的前提下, 将尽可能多的(亏损)交易终结在亏损对角线上.

所以问题是如果你让止损小于 0.6%, 比如说 0.4%, 0.3% 甚至 0.1% 会发生什么? 显然, 你会越来越多地进行以亏损对角线结束的交易, 并且止损在尽早的将它们平仓方面做得很好. 但是你将止损线向左侧移动的越多, 你所终止的特定类型的交易就越多, 那些交易能够从最大亏损中恢复, 甚至能够以盈利的状态平仓.

#### Inserting a risk stop loss

在 MAE 图中, 您可以看到所有交易的表现, 以及在寻找合适的风险止损点位的时候是否有特殊的点需要考虑. MAE 图可以提示 "最优" 止损值介于 0.2% 和 1% 之间. 但是, MAE 不会直接告诉您最优止损点的具体点位. 出于这个原因, 我们现在通过如下方式执行系统测试, 尝试从另一面来审视这个任务. 我们在交易系统中添加风险止损, 并以 0.01% 的步进在 0.01% 到 1% 的范围内改变止损点与交易入口点的距离. 在撰写本文时, 英镑的交易价格接近 2.00 美元, 按照这个速度, 1% 的止损距离相当于 2 美分. 换句话说, 2 美分是 200 点, 等同于钱包中的 2000 美元. 因此, 在这个市场条件下, 0.01% 的精细步骤意味着 0.02 美分或 2 个点( 20 美元).

<p align="left"><font size=2>Figure 3.13: Ratio of total net profit/maximum intraday drawdown as a function of the stop loss distance in per cent. LUXOR system tested on British pound/US dollar (FOREX), 30 minute bars, 21/10/2002-4/7/2008, with entry time window 9.30am-1.30pm GMT. SLOW=44, FAST=1. Including $30 S+C per RT.</font></p>

![Ratio of total net profit](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.13.png)

测试给出了每个止损水平的重要统计数据: 净利润, 最大回撤, 最大交易亏损等. 您可以根据设定的止损距离绘制这些数据的图表. 我们在图中绘制了 "总净利润/最大亏损"(NP/DD)的比值, 见图 3.13. 我们没有只考虑总净利润, 是因为它没有告诉您有关系统风险的更多信息, 而 NP/DD 比率则给出了有意义的估算. 让我们看一下所有交易相对于止损距离的 "总净利润/最大亏损" 值. 该图表告诉您, 定位过于靠近区间左侧的止损点会大幅降低 NP/ DD 比值. 很明显, 许多交易一开始时就被终止, 低风险下滑点和佣金将吃掉微小的盈利.

当距离越来越大时, 系统盈利能力变得越强, 但是对于低于 0.15% 的所有止损距离, NP/DD 比值持续降低并且始终低于没有止损机制的突破交易系统. 但是, 如果您将止损点设置为远离入口点, 并给交易更多的空间来发展, NP/DD 将获得的良好改进. 在 0.2-0.5% 的范围内, 任何增加的止损距离都会增加基本系统的 "回报/风险" 比值. 因此, 我们可以选择 0.3% 的止损作为可用距离 - 该值位于此稳定参数区域的中间. 在英镑兑美元汇率为 2 美元时, 0.3% 相当于 60 点或 600 美元. 值得一提的是, 您无法找到一个止损水平, 能够提高每个交易系统或整个市场的整体净利润. 通常情况下, 止损所带来的界限会让利润减少, 特别是在波动较大的市场中(例如标准普尔 500 指数或富时 100 指数等股指期货).

让我们简要了解 0.3% 风险止损如何影响我们交易系统(图 3.14 A 和 B). 详细的权益曲线似乎没有太大变化. 系统数据证实了交易系统的盈利能力几乎没有变化(表 3.4, 左侧两列). 总净利润得到改善, 止损仅从 115,000 美元小幅上涨不到 1% 至 116,000 美元, 而交易平均净利润则从 128 美元下降至 113 美元.

因此可以得出结论, 交易系统的盈利能力没有随着插入的止损变化. 但是, 让我们检查系统的风险现在是否受到更好的控制.

<p align="left"><font size=2>Figure 3.14A: Detailed equity curve, B: underwater equity curve with 0.3% risk stop loss in place. LUXOR system tested on British pound/US dollar (FOREX), 30 minute bars, 21/10/2002-4/7/2008, with entry time window 9.30am-1.30pm GMT. SLOW=44, FAST=1. Including 30 $ S+C per RT. Charts from TradeStation 8.</font></p>

![Detailed equity curve](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.14_A.png)

![underwater equity curve](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.14_B.png)

从水下权益曲线可以看出, 交易系统的最大回撤现在从 10% 降至 5%(比较图 3.14 B 和 3.9 B). 查看交易数据证实了这一观察结果(表 3.4).

在插入风险止损后, 最大日内峰谷回撤幅度从 18,894 美元大幅减少至 11,266 美元. 更重要的是, 相对于没有止损的系统时, 最大交易亏损从超过 2500 美元减少到 810 美元. 这种接近初始值三分之一的显著减少可以帮助你控制风险, 特别是在使用该系统交易大型投资组合的多个批次的时候. 您可能会问为什么最大交易亏损没有减少到大约 600 美元, 这相当于我们的止损设定的当前市场价值的 0.3%. 原因是行情跳空缺口(gap)没有让系统以指定的止损价格执行交易, 而是在更坏的价格 - 250 美元上成交. 虽然这种不良执行是微不足道的, 在 1000 次交易中通常发生的次数少于 10 次, 并且远小于 30 美元的滑点和佣金, 但您必须记住, 这种情况在每次交易中都有可能发生. 最后, 我们想指出系统的市场风险(market exposure)在插入止损后首次降低. 虽然没有任何退出机制, 且系统时刻保持在线, 但这种风险敞口现在降低到 73%. 剩余的 27% 的时间, 系统未处于活动状态, 可将资金投入其他地方或赚取利息.

<p align="left" style="color:red;"><font size=5><b>注: 行情跳空缺口(gap). <br> 市场风险(market exposure)是指未来市场价格的不确定性对企业实现其既定目标的不利影响. <br> 风险敞口(risk exposure)这里指可能导致亏损的交易时段, 显然只要交易就有可能亏损, 所以这里等同于交易时段. </b></font></p>

#### Adding a trailing stop

<p align="left" style="color:red;"><font size=5><b>注: 移动止损(trailing stop)</b></font></p>

移动止损是适应当前市场价格的止损单. 在新开多头头寸的情况下, 它最初设定为低于入场价格的固定百分比. 如果市场价格上涨, 移动止损价格按比例上涨, 但是如果价格下跌, 移动止损价格则不会改变(图 3.15 A).

<p align="left"><font size=2>Figure 3.15A: The principle of a trailing stop. Chart example from British pound/US dollar (FOREX), 30 minute bars, September 2008. Chart from TradeStation 8</font></p>

![The principle of a trailing stop](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.15_A.png)

空头头寸的移动止损类似. 此技术允许您在设置最大可能亏损限制的同时, 不对最大可能盈利造成影响. 接下来, 我们在现有的交易系统中添加移动止损. 在寻找合适的移动止损距离时, 我们保持 0.3% 的初始风险止损(initial risk stop). 如上一节所述, 初始风险止损的职责是控制最大亏损, 新增的移动止损旨在尽可能的保留利润而不是失去它.

如果添加移动止损并以 0.01% 的步长将其从 0.01% 变化到 1.5%, 则可以绘制 NP/DD 的比值作为移动止损距离的函数(图 3.15 B). 与风险止损类似, 微小的移动止损削减了太多的利润, 因为它们没有给交易足够的发展空间. 特别是, 所有低于 0.2% 的移动止损值都会导致一场灾难. 然而, 从 0.2% 到 0.5%, 系统盈利稳定地增加, 在 0.5% 和 1% 之间, 你会发现一个广阔的移动止损参数区域, 可以增加系统的 NP/DD 比率. 如果您将移动止损设置得更大一点, 那么 NP/DD 比率会收敛到没有加入移动止损之前的状态, 止损距离变得如此之大, 以至于很少交易受其影响.

<p align="left"><font size=2>Figure 3.15B: Ratio of total net profit/maximum intraday drawdown as a function of the distance of an added trailing stop. Risk stop loss of 0.3% kept in place. LUXOR system tested on British pound/US dollar (FOREX), 30 minute bars, 21/10/2002-4/7/2008, with entry time window 9.30am-1.30pm GMT. SLOW=44, FAST=1. Including $30 S+C per RT.</font></p>

![Ratio of total net profit/maximum intraday drawdown](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.15_B.png)

值得一提的是, NP/DD 比值(图 3.15 B)非常稳定. 在 0.5% 和 1% 之间, 您会发现一个广泛的区域, 可以产生相近的 NP/DD 结果. 这增加了进行过的测试对于实际交易具有高预测能力的可能性. 交易数据(表格 3.4)显示, 0.8% 的移动止损(在盈利参数区域中间)能够改善系统, 特别是在盈利能力方面. 通过加入的移动止损, 总净利润可以从 116,209 美元增加到 126,772 美元, 增幅接近 10%. 每笔交易的平均利润从 113 美元增加到 122 美元, 增幅大致相同. 增加的移动止损也略微改善了风险数据. 交易系统的最大亏损额从 11,266 美元进一步下降至 10,292 美元, 入场时间比率现在也略微降低(69.98%, 而此前为 73.56%).

有了两种类型的止损, 我们现在将检查加入的利润目标是否会进一步改善交易系统.

#### Looking for profit targets: Maximum Favourable Excursion(MFE)

John Sweeney 的 MFE 概念是对 MAE 的补充. MFE 被定义为您头寸的最大正向价格变动. 因此, 它对应于交易生命周期内的敞口资产的最高位. 虽然 MAE 对于研究您的交易回撤和设置良好的止损非常有用, 但 MFE 揭示了交易的最大市值并有助于找到有用的止盈目标(图 3.16).

<p align="left" style="color:red;"><font size=5><b>注: MFE 度量可从指定交易中获取的最大利润.  MAE 减小亏损(针对亏损交易止损), MFE 增大利润(针对盈利交易止盈). </b></font></p>

<p align="left"><font size=2>Figure 3.16: The MFE graph shows the realised profit/loss vs. run-ups of all trades. Green: winning trades, red: losing trades. LUXOR system tested on British pound/US dollar (FOREX), 30 minute bars, 21/10/2002-4/7/2008, with 0.3% risk stop and 0.8% trailing stop. Input parameters SLOW=44, FAST=1, including $30 S+C per RT. Diagram created with TradeStation 8.</font></p>

![The MFE graph shows the realised profit/loss vs. run-ups of all trades](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.16.png)

与 MAE 一样, 交易的最终利润(或亏损)显示在垂直方向的 y 轴上. 输赢的交易再次在同一轴上绘制, 只是颜色不同(绿点=盈利交易, 红点=亏损交易). 但与 MAE 图形成对比的是, 在 MFE 图中, 水平 x 轴表示最大市值(run-up), 这意味着交易在其生命周期中获得的最高利润.

从拥有两个出口(止损= 0.3%, 移动止损= 0.8%)的趋势跟踪系统的 MFE 图中, 您可以发现以下特征:

大多数盈利交易分布在盈利对角线(win diagonal)附近, 这标志着交易以盘中最高涨幅平仓. 最大盈利交易就是一个典型的例子. 盘中一度上涨 4.5%, 平仓价接近该最高值, 最终盈利略高于 4%. 此外, MFE 图显示了我们在上一节中加入的 0.8% 移动止损的影响: 所有获利超过 0.8% 的交易都保持盈利 - 移动止损确保高利润交易无法完全逆转他们的方向. MFE 图还显示亏损交易(红点)主要停留在最左侧, 这意味着他们通常只经历了很小的上涨.

这些研究结果表明, 利润目标对于我们的趋势跟踪系统来说不是非常有效, 因为两个止损点已经在工作了. 如果亏损的交易从未获得大的利润, 并且获胜的交易没有显著改变他们的方向, 那么利润目标将是无效的. 加入的利润目标(止盈)无法在交易转向之前从市场找到一个点出场, 从而留下利润.

<p align="left" style="color:red;"><font size=5><b>注: 止盈是用在什么场景下呢, 主要还是波动巨大的交易, 但是风险止损会把这类交易剔除(先跌再涨), 移动止损(先涨再跌)一般来说会比盈利目标做的更好, 只有在很少部分的交易上, 止盈可能比移动止损做的更好(止盈 > 最高涨幅 - 移动止损), 所以止盈在有双止损(风险止损 + 移动止损)的系统上作用有限. </b></font></p>

让我们验证下这些发现是否可以支持进一步的计算机测试. 我们在采用两个止损的突破系统上, 加上利润目标. 如果利润达到市场价值的 x%, 盈利目标会立即对交易进行平仓(图 3.17). 该图显示, 利润目标设置太小时, 正如止损太小一样, 会降低交易系统的整体利润. 您设置的利润目标越小, 结果越差. 只有一小部分相当大的利润目标设置, 在 2% 左右(在英镑交易价格为 2 美元时, 等于 4 美分或 400 点, 或一个 4000 美元的合约)会让利润大于只有止损而没有利润目标的系统. 如果您将利润目标设置为 2.5% 以上, 则结果会与基本系统近似. MFE 图表显示, 这个利润非常高的领域只能不到 10% 的交易能达到. 因此, "通过利润目标离场" 对于我们在英镑/美元外汇市场的入场设置来说只有很小的作用.

<p align="left"><font size=2>Figure 3.17: Ratio of total net profit/maximum intraday drawdown as a function of the distance of an added profit target. Risk stop loss of 0.3% and trailing stop of 0.8% are kept in place during tests. LUXOR system tested on British pound/US dollar (FOREX), 30 minute bars, 21/10/2002-4/7/2008, with entry time window 9.30am-1.30pm GMT. SLOW=44, FAST=1. Including. $30 S+C per RT.</font></p>

![Ratio of total net profit/maximum intraday drawdown](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.17.png)

测试证实了 MFE 图表显示的内容: 我们无法预测突破将在多大程度上引领市场(突破后走势会持续多久, 运行至多高/低). 因此, 除了距入场点约 1.8% 至 2.4% 的止盈之外, 最好不要设定任何其他利润目标, 而是让市场自由运行. 同样, 与止损一样, 这个结论可能不适用其他市场, 或在不同时间尺度上且具有完全不同入场设置的 "英镑/美元外汇市场". 利润目标的一个正面例子是股指期货, 该市场上趋势方向的变化频繁发生. 此外, 如果将利润目标设定为重要的点位, 则利润目标会变得更有价值, 例如在支撑位和阻力位, 跳空等等, 市场在这些位置有很大可能转向. 利润目标有效的另一个原因将在本章末尾的资金管理部分进行简要讨论.

#### Summary: Result of the entry logic with the three added exits

您可以使用经典优化测试分别确定交易系统中的止损和止盈, 如图 3.13, 3.15B 和 3.17 所示. 这样的优化可以显示最优的止损和止盈水平, 并为您提供关于我们找到的最佳参数稳定性的宝贵信息. 但是, 这些图表并没有向您揭示最终的净利润和回撤是如何发生的. 您无法从这些图表中看出, 是一笔高利润的交易还是一百笔低盈利的交易支撑了交易系统的总净利润. 这些缺失的, 有关所有交易分布的有价值信息仅由 MAE/MFE 图表提供. 他们在一张图表中向您显示所有交易的日内高点和回撤. 通过这种方式, MAE/MFE 方法提供了有关您交易系统的有用的附加信息, 并补充了优化图.

因此, 在本章中, 我们使用优化图和 MAE/MFE 图的组合来确定 LUXOR 系统的有用止损水平和利润目标. 在英镑/美元外汇市场上的测试表明, 止损和移动止损位置具有足够宽广的领域, 在降低系统风险的同时也略微增加了利润. 我们最终添加的利润目标是没有必要的, 如果设置为 2% 左右的区域, 可以有一点点帮助. 让我们看看经过上面的开发和讨论后, 我们交易系统的所有出口: 0.3% 的风险止损, 0.8% 的移动止损和 1.9% 利润目标(图 3.18 A-C).

<p align="left"><font size=2>Figure 3.18: LUXOR system with all three exits in place: 0.3% risk stop, 0.8% trailing stop and 1.9% profit target, tested on British pound/US dollar (FOREX), 30 minute bars, 21/10/2002-4/7/2008, with entry time window 9.30am-1.30pm GMT. SLOW=44, FAST=1. Including $30 S+C per RT. A: detailed equity curve, B: end of month equity curve, C: average profit per month. Charts created with TradeStation 8.</font></p>

![detailed equity curve](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.18_A.png)

![end of month equity curve](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.18_B.png)

![average profit per month](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.18_C.png)

如果将其与没有退出机制交易系统的权益曲线进行比较, 详细的权益曲线似乎没有太大变化(图 3.19A). 只不过它看起来更稳定, 回撤次数更少且回撤幅度更小. 现在最大的回撤幅度是 6%(相比之下没有退出机制的 10%), 而且系统总能在几周内迅速恢复到新的权益高点. 对于所有回撤, 最长的恢复期为 6 个月. 这也通过月末权益曲线得到确认, 该曲线每月对交易账户的市值进行一次绘制. 如果您按照从 1 月到 12 月的顺序对利润进行排序, 您可以看到交易系统在所有月份都是盈利的(图 3.18C), 这是其可靠性的另一个证明. 这些发现也在交易系统的数据中得到了强调, 该数据在计算时已包含了所有的出口(表 3.4, 右列). 一个值得注意的点是, 1.9% 的利润目标将最大赢利交易从 7510 美元降至 3900 美元, 但同时并未降低总体净利润.

<p align="left"><font size=2>Table 3.4: How additional exits change the result of the LUXOR system; change of trading figures of the system tested on British pound/US dollar (FOREX), with one exit added after another, 30 minute bars, 21/10/2002-4/7/2008, with entry time window 9.30am-1.30pm GMT. SLOW=44, FAST=1. Including $30 S+C per RT.</font></p>

![Table_3.4](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Table_3.4.png)

#### How exits are affected by money management

对于交易系统或多个系统的组合来说, 风险和资金管理永远不可能完全分开. 这两个组件彼此高度依赖. 因此, 将资金管理策略整合到系统设计和开发过程中是至关重要的. 资金管理并不是凭空得出的, 而是基于风险管理方案中预先计算的出场点, 这里的风险管理方案与每个交易系统是匹配的. 在本节中, 我们将基于趋势跟踪交易系统 LUXOR 的实际示例来展示两个组件的相互作用.

<p align="left"><font size=2>Figure 3.19: Scatter graph of profits for all generated trades of the LUXOR system. Tested on British pound/US dollar (FOREX), 30 minute bars, 21/10/2002-4/7/2008, with entry time window 9.30am-1.30pm GMT. SLOW=44, FAST=1. Including $30 S+C per RT. A: without added exits. B: with 0.3% risk stop loss (red line), 1.9% profit target (green line) and 0.8% trailing stop. The exits act like borders for the trade distribution. Graphs created with TradeStation 8.</font></p>

![without added exits](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.19_A.png)

![with 0.3% risk stop loss](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.19_B.png)

图 3.19 显示了生成的系统所有交易的利润和亏损. 在图 3.19A 中, 您可以看到没有退出机制的交易系统最终的结果, 图 3.19B 显示了基于以下退出机制交易系统的输出结果: 利润目标为 1.9%, 风险止损为 0.3%, 移动止损为 0.8%.

与 MAE/MFE 图相反, 散点图的横轴显示的是交易的数量. 没有显示交易在其生命周期中的亏损或盈利的情况. 我们从这个简单的演示开始, 因为它可以清楚地显示应用退出机制后的效果. 当您比较没有退出机制和应用退出机制后的交易散点图时, 可以明显看出退出机制的一些有趣影响.

第一点是, 最大交易盈利和最大交易亏损之间的差异在引入退出机制后变小(散点在垂直方向上分布的宽度变小). 在没有任何退出机制的情况下, 交易广泛分布在 -2000+ 美元(最大亏损)和 6000+ 美元(最大盈利)之间, 在采用止损和利润目标后, 它们被挤压得更紧密, 分布在 -500 美元(最大亏损)和 4000 美元(最大盈利)之间的区间. 看起来像一群蜜蜂的交易黑云似乎现在被捕获在地面(止损)和屋顶(利润目标)之间. 这两个边界不是直线, 因为我们使用的是基于百分比的出场, 而不是固定的美元点位. 这些动态类型的出场与英镑/美元市场中的点位相匹配.

<p align="left" style="color:red;"><font size=5><b>注: 动态类型的出场指出场点随着成交价格(止损百分比)或当前价格(移动止损)动态变化. </b></font></p>

关于止损, 您可以看到并非所有该线附近的交易都位于 1.9% 的利润目标和 0.3% 的止损之间. 四个负的异常值导致损失高于预先计算的 0.3%, 因为止损有时会因发生的跳空(gaps)而越限. 如上所述, 最大交易亏损约为 0.4%(810 美元), 而不是预计的 0.3%(600 美元). 请记住, 在真实交易中, 尤其是在流动性较差的市场中进行大笔交易时, 实际损失超过止损线是非常常见的. 但是, 如果您提前考虑这些因素, 并且您的交易系统足够稳定以至于运行结果与你的预期 100% 吻合, 它们不会对您造成太大损失 - 就像我们在此处展示的情况一样.

与越过止损线的现象相反, 您发现没有交易超过 1.9% 止盈线. 因为目标选择距离入口点非常远, 所以只有少数交易能够到达它, 并且没有交易通过利用市场跳空缺口来通过它. 因此, 散点图显示了 0.3% 风险止损和 1.9% 盈利目标的影响.

但是 0.8% 的移动止损呢? 虽然原始散点图显示不出移动止损的效果, 但它可以在 MFE 图中显示(图 3.20). MFE 散点图显示移动止损(标记为蓝色)如何影响一些亏损交易(红点, 左侧)和一些获利交易(右侧). 移动止损跟随具有大幅上涨的交易, 并将止损位设置为最高点回撤 0.8%, 以保持其利润. 该图显示, 在大多数情况下, 此止损非常有效, 仅有一笔交易中越过了移动止损线. 在 MFE 图形的左侧, 您可以再次看到之前提到的四个异常值对风险止损的影响.

<p align="left"><font size=2>Figure 3.20: How the Exits prepare for Money Management. MFE diagram of all trades. How risk stop loss and trailing stops affect the trade distribution and make trades more calculable. Graph created with TradeStation 8.</font></p>

![How the Exits prepare for Money Management](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.20.png)

增加的出场机制使 LUXOR 交易系统的风险更易于计算. 虽然您不知道买入的结果是盈利还是亏损, 但在添加出场机制后, 您知道交易结果很可能在 0.3% 的损失和 1.9% 的盈利之间. 你无法完全确定这一点, 因为有一些越界的交易并不会按预先计算的一样, 在预定的出场点了结, 但你有相当高的信心. 如果您愿意冒一定比例的交易资金风险, 这些知识对于确定您在下一笔交易中应该花多少钱是有用的. 这是一个重要的步骤, 以便应用资金管理计划, 帮助您提高回报(见第 7 章).

### 3.6 Summary: Step-by-step development of a trading system

在本章中, 我们在 GBP/USD 货币汇率的例子中展示了如何逐步开发新的交易系统(图 3.21). 每个交易系统都以一个想法和一个合理的逻辑开始. 我们的交易系统 LUXOR 的想法来自 STAD TradeStation 开发俱乐部, 但还有许多其他好的想法来源, 包括书籍,互联网和研讨会. 一旦有了主意, 就必须对其进行测试并根据需要进行修改. 因此, 您应该以某种方式将想法转换为算法, 一系列规则, 然后将其应用于历史市场数据. 在此测试过程中, 您将会得到启发, 也将面临新的问题, 例如如何正确编写代码以及如何规避软件的弱点.

虽然这个过程非常耗时, 但是因为您对交易系统有了非常详细的了解, 所以它是值得的. 这些知识是您在应用系统时取得成功的关键因素, 因为您对交易系统的信心和信任是最重要的因素. 如果您不信任您的系统, 您将在第一次亏损时停止交易. 因此, 所有测试 - 无论是否有滑点(slippage)和佣金, 有无出场点设置, 优化和稳定性测试 - 都会获得关于您正在做什么以及为什么要这样做的专业知识. 通过这种方式, 您可以建立一个包含可靠风险管理的交易系统, 并为您进行资金管理做好准备, 因为您可以更好地估算交易结果.

<p align="left"><font size=2>Figure 3.21: Step-by-step development of a trading system. From an idea to a final system including entries, exits, trading costs etc.</font></p>

![How the Exits prepare for Money Management](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_3.21.png)

## Chapter 4: Two methods for evaluating the system’s predictive power

>"一旦你拥有了一个系统, 最大的障碍就是相信它."
>汤姆.威尔斯

为了检查 LUXOR 交易系统的稳健性, 我们现在执行以下两个可靠性测试.

4.1 时间尺度分析. 改变测试市场的 bar 长度, 同时保持系统的其他参数不变.

4.2 蒙特卡罗分析. 更改已执行交易的顺序, 可为您提供有关预期最大亏损的有价值估计.

蒙特卡洛分析对于有风险评估经验的人来说是一个众所周知的工具, 而时间尺度分析是迄今为止我们在任何出版物中都没有看到过的新方法. 我们发现它是一个有用的工具, 可以使用任何标准软件包轻松执行, 允许更改 bar 的尺度.

### 4.1 Timescale analysis

----------

#### Changing the compression of the price data

为了执行测试, 我们需要那些在构建和开发交易系统期间未使用的数据. 该数据称为样本外数据. 获取这种样本外数据的最简单方法, 就是基于相同的市场和相同的数据, 但更改时间尺度. 通过这种方式, 虽然新的时间尺度算不上是真正的不同, 但其价格结构在不同的时间尺度内发生了很大的变化. 因此, 许多在某个时间尺度上运行良好的交易系统, 在同一市场的其他时间尺度下则是完全失败的.

就交易系统 LUXOR 而言, 对于时间尺度分析, 您首先在一个时间尺度上逐步开发和测试交易系统, 就像我们在 30 分钟数据上所做的那样. 您设置入场点, 添加交易成本, 然后通过优化和过滤, 您将得到一个包含止损和止盈的完整系统. 然后你就可以把这整个交易系统应用到同一个市场的不同时间尺度. 使用今天的软件平台, 如 TradeStation 8, 可以非常轻松地执行此类系统测试.

在更改符号属性时, 您可以在图表上保留所有应用策略: 在这种情况下, 您将 bar 的长度从 30 分钟更改为任何其他值, 例如 5 分钟, 10 分钟, 120 分钟, 每天等. 如果您执行此类操作, 你将看到用于信号生成的图表和指标看起来非常相似, 尽管你正在研究不同的时间尺度(图 4.1). 由于指标, 在我们的例子中是两条移动平均线, 是根据图表中的 bar 来计算的, 因此无论是每隔 5 分钟, 30分钟, 还是 120 分钟来计算一条线, 是无关紧要的. 但是, 尽管某些指标看起来相似, 在详细研究市场在不同时间尺度上的行为后, 会发现他们非常不同. 请记住, 相对于 120 分钟图,  5 分钟图将使你更密切的观察 5 年间的价格数据.

在 120 分钟图中, 120 个 bar 意味着半个月的价格数据, 而 5 分钟图上的相同数量的 bar 只包含半天的数据(图4.1).

<p align="left"><font size=2>Figure 4.1 British pound/US dollar FOREX on different timescales: A: 5 minute bars, B: 30 minute bars, C: 120 minute bars. Chart examples from July 2008. The two moving averages like all other parameters for signal generation are kept the same while changing the timescale of the chart. Each of the three figures shows about 100-150 bars.</font></p>

![5 minute bars](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_4.1_A.png)

![30 minute bars](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_4.1_B.png)

![120 minute bars](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_4.1_C.png)

#### LUXOR tested on different bar compressions

检查交易策略在不同的时间尺度上如何改变其重要的系统数据和权益线是很有意思的. 让我们对 LUXOR 交易系统进行这样的时间尺度分析. 你还记得 LUXOR 是基于英镑/美元外汇市场的 30 分钟数据开发的. 让我们看看不同时间尺度下的权益线(图 4.2). 从这些曲线可以看出, 我们开发的系统逻辑在所有不同的时间尺度上获得稳定的利润, 无论是 5 分钟图还是 180 分钟图.

<p align="left"><font size=2>Figure 4.2 Detailed equity curves from system tests on different timescales – from 5 minute up to 180 minute bar calculations. Trend-following system British pound/US dollar (FOREX), 30 minute bars, 21/10/2002-4/7/2008, with entry time window 9.30am-1.30pm GMT. SLOW=44, FAST=1. All three exits in place: 0.3% risk stop, 0.8 trailing stop and 1.9% profit target. Including $30 S+C per RT.</font></p>

![Detailed equity curves](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_4.2.png)

虽然交易系统在所有不同的时间尺度上都能获利, 但权益曲线的回撤阶段的形状看起来有点不同.

#### Net profit and maximum drawdown dependent on the traded bar length

现在我们通过比较不同 bar 下的重要交易数据, 来仔细研究交易系统的行为.

将测试期间交易系统的总净利润和最大日内回撤作为所选时间尺度的函数时, 并将其绘制下来, 会显示一些有趣的特征(图 4.3). 您会看到一个非常宽的区域, bar 长度在 5 到 35 分钟之间, 在这些区间里都会产生良好回报, 并且具有较低回撤. 30 分钟图是利润最高的, 但与附近的其他时间尺度相比, 差距并不太大. 但是, 你应该注意这样一个事实, 即在大约 40 分钟时, 利润会下降很多. 基于这个图表, 我们认为在较短的时间尺度下使用 LUXOR 系统会更安全, 例如 20 分钟或 25 分钟, 您也可以获得良好的结果, 但随着时间尺度变小, 会逐渐远离次高利润区. 正如您所看到的那样, 当您进入非常小的时间尺度时, 例如 1 分钟图, 系统就不再盈利了. 对于大于 35 分钟的区间, 随着时间尺度变大, 获得的总净利润进一步下降，直到盈利在 210 分钟图上完全消失.

<p align="left"><font size=2>Figure 4.3: Timescale analysis. Total net profit and maximum drawdown as a function of the bar length. Trend-following system British pound/US dollar (FOREX), 30 minute bars, 21/10/2002-4/7/2008, with entry time window 9.30am- 1.30pm GMT. SLOW=44, FAST=1. All three exits in place: 0.3% risk stop, 0.8 trailing stop and 1.9% profit target. Including $30 S+C per RT.</font></p>

![Timescale analysis](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_4.3.png)

#### Explanation for the time dependency of the system

系统总净利润为什么对时间存在依赖?

要理解这一点, 您需要提醒自己, 交易系统的总净利润是所有交易的数量乘以每笔交易的平均利润(图 4.4). 例如, 假设您有一个交易系统, 可以产生 1000 笔交易. 在这种情况下, 每笔交易的平均利润为 100 美元, 总净利润为 100,000 美元(1000 x 100 美元).

<p align="left"><font size=2>Figure 4.4: The total net profit of a trading system is the product of two factors: number of trades and average profit per trade.</font></p>

![two factors](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_4.4.png)

因此, 要了解交易系统的总净利润, 您必须调查与之关联的两个因素: 交易数量和每笔交易的平均利润. 如果您首先查看 2002 - 2008 年测试期间生成的交易数量, 您会发现它在很大程度上取决于所选的时间范围(图 4.5). 您设置的时间范围越小, 生成的交易数量就越高. 在 1 分钟图上, 我们的交易逻辑在 5 年内产生超过 14,000 笔交易, 而在 210 分钟图上, 仅产生 210 笔交易. 换句话说: 在 1 分钟图上, 您每年进行超过 2000 笔交易或每天交易 10 笔, 而在 120 分钟图上，您每年只进行 40 笔交易, 这意味着每周约一笔交易. 这是合理的, 因为在较小的时间尺度上, 您会计算更多的 bar, 如上所述(参见图 4.1).

<p align="left"><font size=2>Figure 4.5: Timescale analysis. Number of generated trades as a function of the bar length. Trend-following system British pound/US dollar (FOREX), 30 minute bars, 21/10/2002-4/7/2008, with entry time window 9.30am-1.30pm GMT. SLOW=44, FAST=1. All three exits in place: 0.3% risk stop, 0.8 trailing stop and 1.9% profit target. Including $30 S+C per RT.</font></p>

![two factors](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_4.5.png)

让我们看一下影响总净利润的第二个因素;每笔交易的平均利润与所选时间尺度的函数关系(图 4.6). 您看到所选择的时间尺度越小, 您获得的每笔交易的利润就越少. 最糟糕的情况出现在 1 分钟图上, 每笔交易的利润变为负值. 在 1 分钟到 5 分钟的非常小的时间尺度内, 统计噪声似乎太高了. 在那里发生了太多的任意运动, 这些运动难以被我们的交易系统系统地利用. 此外, 交易成本和滑点对非常小的时间尺度更重要. 如果您远离非常小的 bar 长度并将它们设置为 25 到 180 分钟之间的值, 那么系统产生的平均每笔交易利润在 80 美元到 120 美元之间(图 4.6 中的绿色区域). 这真是一个非常了不起的结果, 你必须记得在这个大范围内改变时间尺度时, 市场结构也随之发生了巨大的变化.

<p align="left"><font size=2>Figure 4.6: Timescale analysis. Average profit per trade as a function of the bar length. Trend-following system British pound/US dollar (FOREX), 30 minute bars, 21/10/2002-4/7/2008, with entry time window 9.30am-1.30pm GMT. SLOW=44, FAST=1. All three exits in place: 0.3% risk stop, 0.8 trailing stop and 1.9% profit target. Including $30 S+C per RT.</font></p>

![two factors](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_4.6.png)

伴随所选择的 bar 长度, 交易总数和每笔交易平均利润也发生了变化, 观察这些您可以得出总净利润如何随时间尺度变化而变化. 在非常短的时间尺度上, 总净利润受到每笔交易利润过低的影响. 但是当时间尺度超过 5 分钟, 每笔交易的低平均利润可以通过较高的交易数量得到补偿, 并导致交易系统获得较高的总净利润和较低的最大亏损. 如果您进一步增加时间尺度, 超过 40 分钟或更长时间, 总净利润会变得越来越低, 因为在单笔交易利润不增加的情况下产生的交易越来越少. 因此, 我们的交易系统在 10 到 35 分钟的区间内效果最佳.

现在, 所有这些发现对于我们交易系统的预测能力来说意味着什么? 基于 30 分钟时间尺度开发和优化的交易系统在时间尺度的变化下显示出有希望的结果. 从这些具有经过验证的稳定性的结果中, 您可以得出结论: 交易逻辑很有可能经得起进一步的样本外数据测试, 并且可以在实际交易中获利.

### 4.2 Monte Carlo analysis

----------

>"在爬上梯子之前, 你做的最后一件事是什么? 你摇动它. 这就是蒙特卡罗模拟."
>斯坦福大学 Sam Savage

几乎每个人都听说过, 但没有人使用它. 许多人担心蒙特卡洛分析是如此复杂的方法, 为了理解它, 你必须是数学教授. 然而事实是它并没有那么难, 每个想更进一步, 而不仅仅是看一下系统回测权益线的人都应该使用它.

#### The principle of Monte Carlo analysis

当 Sam Savage 说蒙特卡洛分析只是一种在爬梯子之前摇动梯子的技术时, 他的意思是什么? 要理解他的句子, 首先必须知道梯子是什么以及可以摇动什么.

正如您猜的那样, 在我们的例子中, 梯子是一个交易系统. 图 4.7 显示了这个梯子, 交易系统 LUXOR 的详细权益曲线, 所有过滤器和出场点都按照第 3 章的说明进行了设置.

<p align="left"><font size=2>Figure 4.7: Detailed Equity Curve of system LUXOR. Tested on British pound/US dollar(FOREX), 30 minute bars, 21/10/2002-4/7/2008. With entry time window 9.30am-1.30pm GMT. SLOW=44, FAST=1. All three exits in place: 0.3% risk stop, 0.8% trailing stop and 1.9% profit target. Including $30 S+C per RT. Calculation based on one contract basis, results incl. $30 slippage and commissions per trade. Chart created with Market System Analyzer (see www.adaptrade.com).</font></p>

![Detailed Equity Curve](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_4.7.png)

该详细权益曲线展示了交易系统在测试期间 21/10/2002-4/7/2008, 按时间顺序一个接一个的执行的所有 1051 笔交易.

现在让我们按照以下步骤摇动梯子: 你保留所有这些 1051 交易(例如 交易1 = 120美元盈利, 交易2 = 90美元损失, 交易3 = 445美元盈利...交易1051 = 150美元损失)然后你将它们重新排序.  图 4.8 显示了如何使用包含六笔交易的交易系统执行此操作的示例: 六笔交易中的每一笔都被保留但放到了新的位置.

<p align="left"><font size=2>Figure 4.8: The principle of Monte Carlo analysis: A trading system which contains six trades is "shaken" – this means that the positions of the six trades are exchanged accidentally.</font></p>

![The principle of Monte Carlo analysis](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_4.8.png)

您可以使用相同的方式对任意数量的交易集合执行此操作. 交易的新顺序是随机确定的. 例如, 在我们的系统中, 交易 1 现在位于第 842 位, 交易 2 在第 66 位, 交易 1051 在位置 980 等. 重要的是每笔交易仍然像以前一样存在 - 没有删除交易且没有新增交易. 这种置换方法称为 "没有替换的选择"(selection without replacement).

另一种可能的排列方法是"替换选择"(selection with replacement). "没有替换的选择"的优点在于它完全重复输入序列的概率分布, 而"替换选择"可能不是. "没有替换的选择"的缺点是随机采样的交易序列首先受限于输入序列中的交易数量. 因此, 如果您有一个较短的交易序列(例如少于 50 笔交易), 这可能会限制您的计算准确性. 第一种方法类似于随机替换选择, 优点是最终交易序列将具有与原始序列相同的统计属性. 第二种方法在交易序列中引入了更多随机性, 如果未来的预期交易可能与原交易序列不同, 则第二种方法可能是更合适的.

#### Exchanging the order of the performed trades

上面的例子表明, 所有交易的最终结果必须保持不变, 与交易排列后的新次序无关. 由于交易结果总和保持不变, 所以新老权益线最终必然具有相同的值. 但由于交易秩序的变化, 新权益线的形状, 特别是回撤会变得不同(图 4.9).

<p align="left"><font size=2>Figure 4.9: Blue: detailed equity curve, Black: 15 permutations of the trades sequence("shaken trades"). Trend-following system LUXOR British pound/US dollar (FOREX), 30 minute bars, 21/10/2002-4/7/2008. Calculation based on one contract basis, results including $30 slippage and commissions per trade.</font></p>

![Figure 4.9](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_4.9.png)

该图显示了原始交易顺序(粗蓝线)和 15 个置换交易序列(细黑线). 所有的权益线都有相同的起点和终点, 因为我们没有添加或删除任何交易, 只是改变了它们的顺序. 交易顺序的变化导致不同时期出现不同的亏损阶段, 权益线之间出现巨大差异.

#### Probabilities and confidence levels (概率和置信水平)

现在您已经掌握了如何摇动您的交易系统, 我们需要更进一步了解蒙特卡洛分析. 你可以取样超过 15 次. 事实上, 1051 笔交易的集合意味着 1051! = 1051 * 1050 * 1049 * 1048 * ... * 3 * 2 * 1 种可能的排列, 令人难以置信的数量! 请记住, 即使是只有 200 笔交易, 这些交易的全排列 200!(200 * 199 * 198 ... * 3 * 2 * 1)也大于宇宙中存在的所有原子的数量！ 计算所有这些不同组合的工作, 是不可能由计算机在有限的时间内完成的. 因为蒙特卡罗分析存在的这些实际问题, 您需要随机选择数百或数千个这样的任意交易序列. 对结果进行排序, 然后便可以从该分类列表中分配每个结果的概率. 下面的示例将演示如何确定此类概率:

让我们考虑这样一个场景, 翻转硬币 1000 次, 并估算正面和背面的次数. 如果硬币完全对称地构建(这在现实生活中是不可能的, 但是由进行统计计算的数学家使用)那么你可以称这个硬币 "公平". 虽然这种公平硬币的正面/背面次数很可能接近 500, 但它们也不太可能恰好都是 500. 更有可能的是, 正面次数将在 500 某个范围内, 而不是正面和背面都恰好是 500 次, 你得到是一个以 500 为中轴的高斯分布(图 4.10). 这导致我们引入所谓的 "置信水平"(confidence level) 和 "置信区间"(confidence interval).

这些值描述了围绕真实参数(在这个例子中是 500)的实验数据的分布. 置信水平(95%)表示实际数据落到预估值周围置信区间内的可能性有多大. 假如实验的高斯分布是理想的, 您有 95% 的把握确定实际值会落在 3.1% 的区间内. 这意味着, 在 1000 次试验中, 正面的次数在 469(500次 - 3.1%)和 531 (500次 + 3.1%)之间的概率是 95%.

<p align="left"><font size=2>Figure 4.10: Gaussian distribution of probabilities for flipping a coin 1000 times. You can tell with 95% confidence that the coin falls to heads between 469 and 531 times. Figure created with MATLAB.</font></p>

![Figure 4.10](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_4.10.png)

置信水平(例如 95%,99% 置信度等)用于蒙特卡洛分析.

#### Performing a Monte Carlo analysis with the LUXOR trading system

让我们看看基于我们的交易系统 LUXOR 进行蒙特卡洛分析的具体例子(表4.1).

<p align="left"><font size=2>Table 4.1: Monte Carlo analysis of 5000 permutations with worst case maximum drawdown and average drawdown as a function of confidence level. Trend-following system LUXOR British pound/US dollar (FOREX), 30 minute bars, 21/10/2002-4/7/2008. Calculation based on one contract basis, results including $30 slippage and commissions per trade. Calculation performed with Market System Analyzer.</font></p>

![Table 4.1](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Table_4.1.png)

从上面的表格可以看出, 大多数交易系统数据在不同的置信水平下保持不变. 从上面的讨论可以清楚地看出这一点. 在执行蒙特卡洛分析的过程中, 您只需在摇动时更改每笔交易的顺序, 但您不会取消或添加任何交易, 因为在我们选择了 "没有替换的选择" 的方法. 因此，当您对 5000 笔交易进行重新排列时, 大部分交易数据, 如平均交易损益, 总净利润, 交易总数, 最终账户权益, 最大盈利交易, 最大亏损交易, 平均交易盈利等保持不变.

蒙特卡洛分析最重要的作用是对于预期亏损的评估. 蒙特卡罗分析是一种用于检查最坏情况可能性的工具. 它寻找在交易逻辑运行过程中可能发生的最大亏损. 在我们的案例中, 交易系统的最大亏损额为 10,292 美元, 平均亏损额为 1976 美元(表 4.1). 蒙特卡罗分析的结果告诉您, 有 99% 概率, 我们交易系统在最坏情况下亏损不会超过 21,364 美元, 正常情况下平均亏损将在 2000 美元左右. 因此, 通过将所有交易进行 5000 次重新排序, 得出结论有 99% 的可能, 最坏情况下的亏损不会超过 21,364 美元.

虽然这个数值是原系统的两倍多, 但最高预期亏损 21,364 美元不超过每年的平均利润(22,000 美元 = 132,000 美元/6年), 因此该值对于交易系统来说是可接受的. 但我们的计算结果仍然意味着, 当您第一次启动系统, 您必须做好在盈利前有 1% 的概率面对 21,000 美元的亏损. 请记住, 99% 的置信度是一个相当高的水平. 如果您使用较低的置信水平进行计算, 预期的最坏情况亏损和平均亏损都会显著降低.

#### Limitations of the Monte Carlo method

如果您想估计隐藏在性能表后面的实际风险, 蒙特卡洛分析是正确的方法. 但是, 当从蒙特卡罗计算中得出结论时, 您仍然必须牢记它们所基于的假设及其局限性. 对于蒙特卡洛分析来说危险的是, 您基于交易逻辑进行交易, 然后基于这些交易数据构建后向测试数据集. 但是，如果这种交易逻辑只是曲线拟合和过度优化呢? 蒙特卡洛分析无法感知这种情况! 由于它只需要你的系统的交易(可能是过拟合), 如果反向测试结果 ok, 它通常会显示结果良好. 换句话说, 只有当反向测试结果不好时才会显示不良结果.

因此, 蒙特卡洛分析仅在正确应用时才有用, 不适用于过拟合的交易系统. 而且, 即使它被正确应用, 你也需要对结果谨慎解释. 有时市场上发生的事情是无法避免的:

有些事件超出了模型的预测能力. 1998 年内爆的对冲基金 LongTerm Capital Management 的聪明人选采用了复杂的概率模型. 但是这些模型在俄罗斯违约引发的金融灾难中失败了. 这是一个警告, 这种高科技手段并非万无一失. 我担心的是人们正在使用蒙特卡罗作为确定性测试. 事实并非如此. 这只是一个概率测试.

十年后我们知道, 与现在刚刚开始发生的情况相比, 1998 年的危机微不足道, 而任何数学模型都无法预测.

请记住, 在蒙特卡洛分析中, 使用了以下假设: 市场回报遵循高斯正态分布, 如在理想情况下翻转硬币(图 4.10). 然而, 金融市场的现实是不同的! 图 4.11 显示了过去 20 年来英镑兑美元的每日变化. 虽然市场的一般行为可以通过高斯模型来描述, 但是有些日子里有非常大的百分比变化, 这些变化超出了高斯曲线.

这样的日子是不可能预测的, 基于高斯分布的蒙特卡罗分析达到了极限. 为了在这种极端情况下获得更可靠的结果, 您必须选择比高斯分布更真实的分布, 从而引出了更复杂的数学模型, 这超出了本书的范围.

<p align="left"><font size=2>Figure 4.11: Daily changes of the British pound vs. US dollar in percent from August 1988-August 2008. Biggest gain was 2.8%, biggest loss 3.3%. The Gaussian distribution cannot describe the daily changes exactly, especially for large gains and losses (encircled areas). Figure generated with MATLAB, data taken from TradeStation 8.</font></p>

![Figure 4.11](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_4.11.png)

## Chapter 5: The factors around your system

许多交易者认为代码是成为成功交易者的重要因素. 事实上, 代码是最不重要的, 因为还有许多其他因素在影响着交易系统. 本章将讨论这些因素.

如果您是一名系统交易, 您可能已经拥有以下经验. 经过一些耗时的研究, 你偶然开发了一个交易系统. 它的回测结果看起来很有希望, 而且它的逻辑看似合理. 你决定用它开始交易, 但真正的表现不如你预期的那么好. 您的交易系统在实际交易中仍然存在轻微的向上偏差, 但它远离回测试显示的光明结果. 为什么会这样? 有没有办法避免这种情况, 并确保回测结果与实际交易结果一致? 虽然我们不想在本章中给出这些问题的最终答案, 但我们将尝试查明该主题的主要特征. 这个问题是复杂的, 遗憾的是, 并不存在一个简短易懂的公式, 读者可以通过遵循这个公式而轻易的得出结论. 因此, 我们关注的是您的交易系统对未来需要多大的预测能力, 并且我们试图找出交易系统的预测能力所依赖的因素.

这项工作的大部分理论基础是由 David Aronson 的书 EvidencedBased Technical Analysis 提供的. 我们将此书作为我们的主要参考, 将从实践的角度通过交易系统的真实示例来看待该主题.

### 5.1 The market’s long/short bias

----------

在开发交易系统时, 市场 "情绪" 是一个关键因素. 测试期间的市场处于向上, 横向(sideways)或向下的趋势时, 会有很大的不同. 在 1995 - 2000 年的牛市中, 许多交易系统在股票市场和期货上表现最好, 如富时 100 指数, 标准普尔 500 指数, 纳斯达克指数等. 当市场在 2001 年转向后, 这些系统破灭了. 虽然他们在 1997 年至 2000 年期间获得了巨额利润, 但他们在随后的熊市中遇到了严峻的困难.

#### The trend is your friend?

我们将以英镑/美元外汇为例讨论市场所谓的多头/空头趋势(图 5.1). 正如您所看到的, 市场在测试期间呈现整体上升趋势. 虽然六年前英镑的交易价格为 1.50 美元, 但在过去五年里它对美元的汇率变得非常强劲, 2008 年夏季的交易价格约为 2 美元. 如果您的交易系统在 2002 年入市并一直持有到 2008 年 7 月, 每张合约您将获利超过 50,000 美元(图 5.2). 但正如您所看到的, 这个简单系统的资产(=赚到的钱)走势与市场走势完全相同.

<p align="left" style="color:red;"><font size=5><b>注: 权益线与市场走势一致, 意味着交易系统没能放大盈利也没能减少反向亏损.</b></font></p>

正如你想象的那样, 每一个只做多的交易系统都会有相似的结果, 这个交易系统几乎可以说是没用. 由于市场本身具有上行趋势, 因此只有买入才能获利. 另一方面, 在 2002-2008 测试期内, 每个只做空并且没有损失任何资金的交易系统, 可能在未来会变成有用的交易逻辑. 一旦市场横盘整理甚至逆转为下跌趋势, 它可能会赚钱.

正如您从水下权益曲线中看到的那样(图 5.2B), 只做多的系统虽然具有良好的回报, 但风险巨大. 它全天保持入市, 因此遭受巨大的回撤. 此外, 该系统经过了将近两年的时间才从最大亏损区中恢复过来.

<p align="left"><font size=2>Figure 5.1: British pound/US dollar (FOREX), weekly bars, 1/7/2002-4/7/2008. A long entry signal is placed on 21/10/2002.</font></p>

![Figure 5.1](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_5.1.png)

<p align="left"><font size=2>Figure 5.2: Only long trading system for British pound/ US dollar (FOREX), 1/7/2002-4/7/2008. A long entry signal is placed on 21/10/2002 and the system stays in the market all the time. A: detailed equity curve; B: underwater equity curve showing all drawdowns</font></p>

![Figure 5.2](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_5.2.png)

#### Consequences for system development

The most important figure of your system tests is thereby the total percentage of time your trading system has been in the market. Only if the system was in the market 100% of time is the market bias 100% important. If you trade, however, a system which is only very seldom in the market, let’s say only 10%, the market bias becomes less important. Another reason to keep the time in the market low is to decrease the risk and exposure as discussed in Chapter 3.5 when we talked about exits and risk management.

在开发交易系统时, 您可以关注那些做多的交易, 将其与只做多的交易系统进行比较, 将其作为最低目标. 通过这种比较, 您可以明白与基准相比, 市场趋势和交易逻辑的额外成就给你带来了多少利润. 因此, 系统测试中最重要的指标是交易系统的入场时间比. 只有系统在市场上 100% 的时间是市场偏见 100% 重要. 然而，如果你交易一个只在市场上很少出现的系统，让我们说只有10％，那么市场偏见变得不那么重要了。 将入场时间保持在低水平的另一个原因是降低风险和风险, 正如在第 3.5 章我们讨论退出和风险管理时所说的那样.

作为系统交易者或系统开发者, 您可以从市场的上涨/下跌趋势中得出哪些其他结论? 当您查看我们在本书中提供的交易系统时, 您可以看到他们中的大多数生成的做多交易和做空交易的数量都差不多. 虽然在某些情况下(股票和股指期货), 市场崩盘的速度比上涨速度快, 但我们倾向于建立没有做多或做空倾向的系统. 我们的大多数系统(如 LUXOR)多头交易和空头交易的数量都差不多, 尽管当市场呈现上升趋势, 它们在做多或做空方向的盈利能力可能不同. 由于您不知道未来这种上涨趋势是否会持续, 因此如果交易系统产生相同数量的做多/做空信号, 可以认为您的系统稳定性较强, 而并不是与这种市场趋势过拟合.

### 5.2 Out-of-sample deterioration

----------

It is always possible to improve the fit of a rule to a given segment of data by increasing its complexity. In other words, given enough complexity, it is always possible to fashion a rule that buys at every market low point and sells at every market high point. This is a bad idea. Perfect timing on past data can only be the result of a rule that is contaminated with noise. In other words, perfect signals or anything approaching them almost certainly means the rule is, to a disturbing degree, a description of past random behaviour(i.e. overfitted). Overfitting is manifested when the rule is applied to the test data segment. There, its performance will be worse than in the training data. This is because the legitimate patterns found in a training set recur in the test set, but the noise in the training set does not. It can be inferred that profitability in the training set that does not repeat in the testing set was most likely a consequence of over-fitting.

This is a meaningful description of the concept of degrees of freedom as depicted more formally in Chapter 2. In this chapter we will have a look at a real example of such an over fitted system.

David Aronson 说明了一个事实, 根据我们在系统评估方面的经验, 我们完全同意:

市场行为被认为是系统行为(重复模式)和随机噪声的组合. 通过增加规则的复杂性，始终可以改进规则对给定数据段的拟合。换句话说，给定足够的复杂性，总是可以制定在每个市场低点购买并在每个市场高点销售的规则。这是一个坏主意。过去数据的完美时机只能是受噪声污染的规则的结果。换句话说，完美的信号或接近它们的任何东西几乎肯定意味着规则是在令人不安的程度上描述过去的随机行为（即过度拟合）。当规则应用于测试数据段时，表现出过度拟合。在那里，它的表现将比训练数据更差。这是因为训练集中的合法模式在测试集中重现，但训练集中的噪声却没有。可以推断，在测试集中不重复的训练集中的盈利能力很可能是过度拟合的结果。

这是对第 2 章中更正式描述的自由度概念的有意义的描述。在本章中，我们将看一个这种过度拟合系统的真实例子。

#### A Bollinger Band system with logic and code

We  will  stay  with  the  pound/dollar  FOREX  market  from  2002-2008  (Datafeed  = TradeStation 8) to test the system. We take a Bollinger Band system (Figure 5.4) and optimise all its main six input parameters for the entry and exit points on daily data within the training period between 30/04/2002 and 1/3/2006 (Figure 5.3). Please note that this Bollinger Band system allows a different optimisation of its input parameters concerning the long and the short side. For the upper and the lower Bollinger Band the length of the moving averages and their distance from the entry point can be varied. So you have four input parameters which you can optimise for the entries. Furthermore we insert two variable, percentage based exits, which can be optimised as well: a risk stop loss and a profit target.

我们将继续使用 2002 年至 2008 年的英镑/美元外汇市场(Datafeed = TradeStation 8)来测试该系统。 我们采用布林带系统（图5.4），并在培训期间的30/04/2002至2006年1月3日期间针对每日数据的入口和出口点优化其所有主要六个输入参数（图5.3）。 请注意，此布林带系统允许对输入参数进行不同的优化，包括长边和短边。 对于上部和下部布林带，移动平均线的长度和它们与入口点的距离可以变化。 因此，您有四个输入参数可以针对条目进行优化。 此外，我们插入两个基于百分比的可变退出，也可以进行优化：风险止损和利润目标。

<p align="left"><font size=2>Figure 5.3: British pound/US dollar, 30/04/2002-4/7/2008. The Bollinger Band trading system is optimised in six parameters within the training data range (30/04/2002-28/02/2006). Afterwards the results of this trading system are checked in the test data range (1/3/2006-4/7/2008).</font></p>

![Figure 5.3](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_5.3.png)

<p align="left"><font size=2>Figure 5.4A: Entry and exit logic of a Bollinger Band breakout system. Four parameters in the entry logic and two parameters in the exit logic can be optimised.</font></p>

![Figure 5.4A](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_5.4_A.png)

<p align="center"><font size=2>Figure 5.4B: Easy Language Code of a Bollinger Band breakout system with entry and exit logic. Four parameters in the entry logic and two parameters in the exit logic can be optimised.</font></p>

>Entry logic: Bollinger Band system
>inputs: LengthUp(18),
>        NumDevsUp(2),
>        LengthDn(20),
>        NumDevsDn(2);
>
>vars:   UpperBand(0),
>        LowerBand(0),
>        Price(0);
>
>Price = (O+H+L+C)/4 ;
>
>//UpperBand = BollingerBand( Price, LengthUp, NumDevsUp ) ;
>//LowerBand = BollingerBand( Price, LengthDn, -NumDevsDn ) ;
>UpperBand = BollingerBandFC( Price, LengthUp, NumDevsUp ) ;
>LowerBand = BollingerBandFC( Price, LengthDn, -NumDevsDn ) ;
>
>if CurrentBar > 1 and High crosses under UpperBand then
>    Sell Short ( “BBandSE” ) next bar at UpperBand stop ;
>
>if CurrentBar > 1 and Low crosses over LowerBand then
>    Buy ( “BBandLE” ) next bar at LowerBand stop ;
>
>Exit Logic:
>
>(for both long positions/short positions)
>1) Place an initial stop loss x % below entry price (Opt value: x =1.9)
>2) Place a profit target z % above entry price (Opt value: x =4.8)

#### Optimising the Bollinger Band system

If you optimise all these six input parameters together with an optimisation criteria focused on the highest net profit on daily data of the pound/dollar FOREX market in the period from 30/04/2002 to 28/2/2006 you get the following result (Figure 5.5).

如果您在2002年4月30日至2006年2月28日期间优化所有这六个输入参数以及针对英镑/美元外汇市场每日数据的最高净利润的优化标准，您将获得以下结果（ 图5.5）。

<p align="left"><font size=2>Figure 5.5: Bollinger Band system for British pound/dollar (FOREX), daily, all six input parameters optimised for maximum total net profit, 30/04/2002-28/2/2006. A: Detailed equity curve; B: Underwater equity curve showing all drawdowns.</font></p>

![Figure 5.5](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_5.5.png)

As you can see the gains of the system are steady. The drawdowns are not tiny (about 10%) but the system’s profitability is high. The trading system performs nearly as many short trades as long trades and so the long/short bias of the underlying market is under control, although the trading system has high market exposure, with it holding a position in the market 89% of the time.

正如您所看到的，系统的收益是稳定的。 下降幅度不小（约10％），但系统的盈利能力很高。 交易系统执行的交易系统与长期交易一样多，因此基础市场的多头/空头偏见受到控制，尽管交易系统具有较高的市场风险，并且它在89％的时间内占据市场地位。

#### Out-of-sample result

Now let’s see what happens if you apply the optimised trading logic to test data on which no optimisation has taken place. In this test period of two years from 1/3/2006 to 4/7/2008 you keep the same input parameters as you found in the training period (Figure 5.6).

现在让我们看看如果您应用优化的交易逻辑来测试没有进行优化的数据会发生什么。 在2006年1月3日至2008年4月7日的两年测试期间，您保留与训练期间相同的输入参数（图5.6).

<p align="left"><font size=2>Figure 5.6: Detailed equity curve of Bollinger Band system for British pound/ dollar (FOREX), daily, training and test period. All six input parameters optimised for maximum total net profit within the training period 30/04/2002-28/02/2006. Test period from 1/3/2006-4/7/2008.</font></p>

![Figure 5.6](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_5.6.png)

As you can see the system has completely lost its bright performance. The smoothly increasing equity curve of the training period transformed itself into a directionless sideways movement. The steady equity curve of the training set suffers a big drawdown at the beginning of the test set, from which it needs nearly a two-year recovery period.

正如您所看到的，系统已完全失去其明亮的性能。 培训期间平稳增加的公平曲线转变为无方向的横向运动。 在测试集开始时，训练集的稳定股权曲线遭受了大幅缩减，需要将近两年的恢复期。

These obvious observations within the equity line are confirmed with the system report (Table 5.1). Whereas within the training period the system has a total net profit of $78,000, it was only $379 in the test period. From the big average profit per trade of $1131 in the training period, only $10 is left in the test period. Even the biggest intraday drawdown was worse in the small test period: $20,000 in the test period compared with $14,000 in the training period.

系统报告确认了权益线内的这些明显观察结果（表5.1）。 在培训期内，该系统的总净利润为78,000美元，在测试期间仅为379美元。 从培训期间的每笔交易1131美元的平均利润来看，在测试期间只剩下10美元。 即便是最小的盘中跌幅在小测试期间也会更糟：测试期间为20,000美元，而培训期为14,000美元。

<p align="left"><font size=2>Table 5.1: Bollinger Band system for British pound/US dollar (FOREX), daily, training and test period. All six input parameters optimised for maximum total net profit within the training period 30/04/2002-28/2/2006. Test period from 1/3/2006-4/7/2008.</font></p>

![Table 5.1](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Table_5.1.png)

#### Reasons for the out-of-sample deterioration

We suggest the following reasons and discuss their possible contribution:

我们建议以下原因并讨论它们可能的贡献：

A:  The  trading  logic  generates  less  than  100  trades,  therefore  the  results  are  not statistically significant.

答：交易逻辑产生的交易少于100笔，因此结果无统计意义。

We conducted the same experiment with the same trading system on a 30 minute basis. There the system generated 3000 trades in the training period and got a similar out-ofsample deterioration. So although 69 trades of the daily system are not enough to be statistically significant, the results shown here are typical and the low number of trades is certainly not the main reason for the system deterioration.

我们在30分钟的基础上使用相同的交易系统进行了相同的实验。 该系统在训练期间产生了3000次交易，并且出现了类似的异常恶化。 因此，虽然日常系统的69个交易不足以具有统计显着性，但此处显示的结果是典型的，交易数量少当然不是系统恶化的主要原因。

B: The system was published at the beginning of 2006 and the trading logic has been adopted by too many traders which destroyed its performance.

B：该系统于2006年初发布，交易逻辑已经被太多交易者采用，从而破坏了其业绩。

This explanation is believed by some traders who have found a new trading system or just an interesting idea. They believe that when their trading system is published the performance will suffer since other traders will immediately adopt the logic. Since many people now trade this system its good performance could diminish because of increasing slippage at first, and later because of a changing market structure since more and more people change their trading style towards the successful system. System developers try to prevent this from happening with their trading systems by hiding them in a strongbox for some years and not showing them to anybody until they lose their predictive power anyway. David Aronson writes about the topic of system disclosure in his book:

一些交易者发现了新的交易系统或者只是一个有趣的想法，这种解释被认为。 他们认为，当他们的交易系统发布时，性能将受到影响，因为其他交易者将立即采用逻辑。 由于许多人现在交易这个系统，其良好的表现可能会因为开始时的滑点增加而减少，后来由于市场结构的变化，因为越来越多的人将交易方式改变为成功的系统。 系统开发人员试图通过将他们隐藏在保密箱中多年来防止这种情况发生在他们的交易系统中，并且在他们失去预测能力之前不向任何人展示它们。 David Aronson在他的书中写到了系统披露的主题：

‘This rationale also lacks plausibility. Even when numerous traders adopt similar rules, as in the case with futures trading funds that employ objective trend-following methods, reduced rule performance seems to be due to changes in market volatility that are not related to the usage of technical systems.’

'这个理由也缺乏合理性。 即使许多交易者采用类似的规则，如采用客观趋势跟踪方法的期货交易基金，减少的规则表现似乎是由于市场波动的变化与技术系统的使用无关。

In other words: although everybody knows that trend-following methods work they do still continue to work, so the disclosure of the system is not a big reason for its success or failure. Furthermore, this system has been open to the public since the day John Bollinger developed it, which was a long time before 2006.

换句话说：虽然每个人都知道趋势跟踪方法的工作仍然可以继续工作，但系统的披露并不是其成功或失败的重要原因。 此外，该系统自John Bollinger开发之日起就向公众开放，这是2006年之前的很长一段时间。

C: The market dynamics within the training data range is different from the one in the test data range.

In our opinion this can be one part of the explanation for deterioration. We’ll discuss this extensively in the next section.

C：训练数据范围内的市场动态不同于测试数据范围内的市场动态。

我们认为这可能是恶化解释的一部分。 我们将在下一节中对此进行广泛讨论。

D: The system has been adapted too much to market noise within the training period, i.e. curve over-fitting.

The process of optimisation favours a set of rules which fit the training data better than the test data. Let’s assume that the training data, like all real market data, consists partially of recurrent patterns (predictable data) and random noise (unpredictable data). Now you take a trading system and you adapt it to this data which is partially random and partially contains a special pattern. If your trading system is simple enough but has a sound logic with valid rules, it is able to capture some parts of the recurrent predictable patterns but does not adjust itself to the market noise. In this way the trading system keeps a certain amount of predictability for the future. If you, however, add more and more rules to this system it adjusts itself more and more to the existing noise. At a certain point the system becomes over-fitted and loses its predictability for the test period, or for the future, since the noise will be different. This is probably the most important aspect of the sample deterioration and we will investigate it with a step-by-step case study in the final section of this chapter.

You can also draw another conclusion from this thesis: all artificial market data, produced with computers by random processes, only consists of noise and are therefore useless for trading system development. If you develop a trading system based on this noisy data it will have no predictive part if applied to other data showing a different type of noise. What your trading system is trying to detect are the patterns which repeat themselves. These patterns are mainly produced by human behaviour like greed, fear and exaggeration and not by random, artificial mathematical processes.

我们建议以下原因并讨论它们可能的贡献：

答：交易逻辑产生的交易少于100笔，因此结果无统计意义。

我们在30分钟的基础上使用相同的交易系统进行了相同的实验。该系统在训练期间产生了3000次交易，并且出现了类似的异常恶化。因此，虽然日常系统的69个交易不足以具有统计显着性，但此处显示的结果是典型的，交易数量少当然不是系统恶化的主要原因。

B：该系统于2006年初发布，交易逻辑已经被太多交易者采用，从而破坏了其业绩。

一些交易者发现了新的交易系统或者只是一个有趣的想法，这种解释被认为。他们认为，当他们的交易系统发布时，性能将受到影响，因为其他交易者将立即采用逻辑。由于许多人现在交易这个系统，其良好的表现可能会因为开始时的滑点增加而减少，后来由于市场结构的变化，因为越来越多的人将交易方式改变为成功的系统。系统开发人员试图通过将他们隐藏在保密箱中多年来防止这种情况发生在他们的交易系统中，并且在他们失去预测能力之前不向任何人展示它们。 David Aronson在他的书中写到了系统披露的主题：

'这个理由也缺乏合理性。即使许多交易者采用类似的规则，如采用客观趋势跟踪方法的期货交易基金，减少的规则表现似乎是由于市场波动的变化与技术系统的使用无关。

换句话说：虽然每个人都知道趋势跟踪方法的工作仍然可以继续工作，但系统的披露并不是其成功或失败的重要原因。此外，该系统自John Bollinger开发之日起就向公众开放，这是2006年之前的很长一段时间。

C：训练数据范围内的市场动态不同于测试数据范围内的市场动态。

我们认为这可能是恶化解释的一部分。我们将在下一节中对此进行广泛讨论。

D：系统在训练期间过于适应市场噪声，即曲线过度拟合。

优化过程有利于一组规则，这些规则比测试数据更适合训练数据。让我们假设训练数据与所有真实市场数据一样，部分包括循环模式（可预测数据）和随机噪声（不可预测数据）。现在你采用一个交易系统，然后你将它调整到这个部分随机的数据，部分包含一个特殊的模式。如果您的交易系统足够简单但具有有效规则的合理逻辑，则它能够捕获周期性可预测模式的某些部分，但不会根据市场噪声进行调整。通过这种方式，交易系统对未来保持一定的可预测性。但是，如果您为此系统添加越来越多的规则，它会对现有噪声进行越来越多的调整。在某一时刻，系统变得过度拟合并且在测试期间或将来失去其可预测性，因为噪声将是不同的。这可能是样本恶化的最重要方面，我们将在本章的最后一节中逐步进行案例研究。

您还可以从本论文中得出另一个结论：所有通过随机过程用计算机生成的人工市场数据仅由噪声组成，因此对交易系统开发无用。如果您基于此噪声数据开发交易系统，则如果应用于显示不同类型噪声的其他数据，则它将没有预测部分。您的交易系统试图检测的是重复自己的模式。这些模式主要是由贪婪，恐惧和夸张等人类行为产生的，而不是由随机的人工数学过程产生的。

### 5.3 The market data bias

----------

#### Expanding the training period

Now the Bollinger Band trading system is optimised within a much longer training period of daily data from 1986 to 2006 (Figure 5.7). Afterwards the results are checked within the test data range which is the same as above, from 1/3/2006 to 4/7/2008 (Figure 5.8).

现在布林通道交易系统在1986年至2006年的日常数据培训期间进行了优化（图5.7）。 然后在2006年1月3日至2008年4月7日的测试数据范围内检查结果，该范围与上述相同（图5.8）。

As you can see, the result in the out-of-sample area (Test Set) is now positive and much better than in the test above with the optimised parameters from the short training range. A closer look at the trading figures confirms this observation (Table 5.2). You now get a total net profit of $16,757 in the test range and a good average trade net profit of nearly $600. Please note that the average monthly return within the test range is $591, which is even higher than the average monthly return of the long test data range of $321. However the risk of this trading system is still quite high, with a maximum drawdown of $16,939. This is nearly as much as the total net profit earned in the test period. We can summarise that the result of this out-of-sample test for the Bollinger Band system with the longer training period is much better than the one which had the shorter training period.

正如您所看到的，样本外区域（测试集）的结果现在是正面的，并且比上面的测试中的结果更好，优化的参数来自短训练范围。 仔细研究交易数据证实了这一观察结果（表5.2）。 您现在在测试范围内获得的总净利润为16,757美元，平均贸易净利润接近600美元。 请注意，测试范围内的平均月回报为591美元，甚至高于长测试数据范围321美元的平均月回报。 然而，这种交易系统的风险仍然很高，最大亏损为16,939美元。 这几乎与测试期间的净利润总额相当。 我们可以总结一下，对于具有较长训练周期的布林带系统的这种样本外测试的结果比具有较短训练周期的那样好得多。

<p align="left"><font size=2>Figure 5.7: British pound/US dollar, 03/03/1986-4/7/2008. The Bollinger Band trading system is now optimised within the long training data range 1986-2006. Afterwards the results of this trading system are checked in the test data range (green). See the shorter training range 2002-2006 which was used above.</font></p>

![Figure 5.7](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_5.7.png)

<p align="left"><font size=2>Figure 5.8: Bollinger Band system for British pound/US dollar (FOREX), daily, training and test period. All six input parameters are now optimised for maximum total net profit within a longer training period of 20 years: 03/03/1986-28/2/2006. Test period is kept the same, from 1/3/2006-4/7/2008. A: Detailed equity curve; B: Underwater equity curve showing all drawdowns.</font></p>

![Figure 5.8](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_5.8.png)

<p align="left"><font size=2>Table 5.2: Bollinger Band system for British pound/US dollar (FOREX), daily, training vs. test period. All six input parameters are now optimised for maximum total net profit within a longer training period of 20 years: 03/03/1986-28/2/2006. Test period is kept the same, from 1/3/2006-4/7/2008.</font></p>

![Table 5.2](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Table_5.2.png)

#### Conclusion: How to choose your training data

The results of our trading system during the test period are more similar to the results of the longer training period of 1986 to 2006 than the results of the shorter training period from 2002 to 2006. Although you cannot see this from the chart of the GBP/USD itself, the market data has a different behaviour during the different years of the test. This behaviour manifests itself in volatility, in trend duration, in a different frequency of breakouts or patterns etc, which affects the “best” parameters of the Bollinger Band system in the different training periods.

测试期间我们的交易系统的结果与1986年至2006年较长的培训期间的结果更相似，而不是2002年至2006年的较短培训期间的结果。虽然您无法从GBP /图表中看到这一点 美元本身，市场数据在不同的测试年份有不同的行为。 这种行为表现为波动性，趋势持续时间，突破或模式等不同频率，这影响了不同培训期间布林带系统的“最佳”参数。

The conclusion is that it’s advisable to make the training period as long as possible. Since a longer period contains much more data, there is a higher probability that within this longer data range there are some periods which behave similarly to your test data range and therefore train your system better. The longer you make the training period for your trading system the better your chances for similar results in the out-of-sample tests and later in real trading. On the other hand, keep in mind that this rule is only valid if your market data contains a lot of different market phases. If you choose a market which is always in an upward trend (like the Long Gilt from 1980 to 2000) you can train on it any trading system with a long-entry bias but it will be of no use when the market changes its bullish behaviour. If you are aware of this however, and you are careful in choosing the right training data, you can avoid having to adapt your trading system to such market biases.

结论是，建议尽可能长时间地进行培训。 由于较长的周期包含更多的数据，因此在这个较长的数据范围内，有一些周期与您的测试数据范围相似，从而更好地训练您的系统。 您为交易系统进行培训的时间越长，您在样本外测试和后续实际交易中获得类似结果的机会就越大。 另一方面，请记住，只有当您的市场数据包含许多不同的市场阶段时，此规则才有效。 如果你选择一个总是处于上升趋势的市场（如1980年至2000年的长期镀金），你可以对任何具有长期进入偏见的交易系统进行培训，但当市场改变其看涨行为时，它将毫无用处。 但是，如果您意识到这一点，并且在选择正确的培训数据时要小心，那么您可以避免让您的交易系统适应这种市场偏见。

### 5.4 Optimisation and over-fitting

----------

#### Step-by-step optimisation of the LUXOR system

We now switch back to our trading system LUXOR which we presented in Chapter 3. When optimising a trading system the first point you must be sure of is that the trading logic is based on an idea which is concrete and profitable. For the trading system LUXOR we have already shown that the logic seems to be sound and profitable and additionally we have performed some stability tests with it. We now take this system and perform a step-by-step optimisation of its six input parameters. First we optimise the slow moving average, second the fast moving average, then the time window filter before we finally optimise the three applied exits one after another: risk stop loss, trailing stop and profit target (Figure 5.9).

我们现在切换回我们在第3章中介绍的交易系统LUXOR。在优化交易系统时，您必须确定的第一点是交易逻辑基于具体且有利可图的想法。 对于交易系统LUXOR，我们已经证明逻辑似乎是合理且有利可图的，而且我们已经用它进行了一些稳定性测试。 我们现在采用该系统并对其六个输入参数进行逐步优化。 首先，我们优化慢速移动平均线，然后是快速移动平均线，然后是时间窗口滤波器，然后我们最终逐个优化三个应用出口：风险止损，追踪止损和利润目标（图5.9）。

<p align="left"><font size=2>Figure 5.9: Step-by-step optimisation of the six input parameters of the LUXOR system 1. Slow moving average, 2. Fast moving average 3. Time window filter 4. Risk stop loss 5. Trailing stop 6. Profit target. Chart example from British pound/US dollar, 30 minute, FOREX from 26 December 2007.</font></p>

![Figure 5.9](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_5.9.png)

To perform our tests we again use British pound/US dollar FOREX data but we return to the intraday 30 minute timescale. On this timescale we have nearly six years of intraday data available, from 21/10/2002 to 4/7/2008. From the above discussion of market data bias you know that it’s advisable to use as much data for the training period as possible. However, you must still have a big enough amount of data left for testing your strategy out-of-sample. As a compromise we use the period from 21/10/2002 to 28/02/2007 for training/optimisation and afterwards we check how the optimised system performs within the subsequent test period of more than one year from 1/3/2007 to 4/7/2008.

为了执行我们的测试，我们再次使用英镑/美元外汇数据，但我们回到盘中30分钟的时间尺度。 在这个时间表上，我们有近6年的日内数据，从2002年10月21日到2008年4月7日。 从上面对市场数据偏差的讨论中，您知道建议尽可能多地使用培训期间的数据。 但是，您仍必须留下足够大的数据用于测试样本外的策略。 作为折衷方案，我们使用2002年10月21日至2007年2月28日期间进行培训/优化，然后我们检查优化系统在从2007年1月3日到4年的一年多的后续测试期间的表现如何/ 7/2008

#### Results depending on the number of optimised parameters

If you look at the equity lines during the training periods you can see that they improve more and more with the optimised parameters. Starting from a directionless equity line when no parameters are optimised the equity curve becomes more enticing as more input parameters of the trading system are optimised. This is not surprising since the system better adapts to the training market data the more degrees of freedom it has. Now the main question is how the trading system behaves within the test data area, depending on the number of optimised parameters. When no optimisation took place (i.e. the system operated with a slow moving average based on 30 bars and a fast moving average of 10 bars, no time filter and exits in place) the result within the test data is negative (Figure 5.10A).

如果您在培训期间查看权益线，您可以看到它们通过优化的参数得到越来越多的改善。 当没有参数优化时，从无方向权益线开始，随着交易系统的更多输入参数被优化，权益曲线变得更加诱人。 这并不奇怪，因为系统更好地适应训练市场数据，它具有更多的自由度。 现在主要问题是交易系统在测试数据区域内的行为，具体取决于优化参数的数量。 当没有进行优化时（即系统使用基于30巴的慢速移动平均值和10巴的快速移动平均值操作，没有时间过滤器并且就地退出），测试数据内的结果是负的（图5.10A）。

If you now optimise the first parameter (slow moving average set to 40) for total net profit in the training range the system result is much improved in the training region, however the equity curve of this optimised system improves only slightly in the test data range (Figure 5.10B). If you look at the trading figures (Table 5.3) you can see this result confirmed.

如果您现在优化训练范围内总净利润的第一个参数（慢速移动平均值设置为40），则系统结果在训练区域得到很大改善，但此优化系统的权益曲线在测试数据范围内仅略有改善 （图5.10B）。 如果查看交易数据（表5.3），您可以看到此结果得到确认。

<p align="left"><font size=2>Table 5.3: System figures for training and test area after optimisation for total net profit of one parameter after another. The optimised values are different from the gained values in chapter 3 since the optimisation period is shorter now, not the complete data range as before.</font></p>

![Table 5.3](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Table_5.3.png)

For example, the total net profit within the test data range improves only from -$12,569 to  -$9,736  and  the  average  trade  from  -$27  to  -$26  after  optimisation  of  the  first parameter. This means practically no change. If you optimise the second important parameter for the trading system’s entry, the fast moving average (to a value of 2), then you can see a further improvement within the training set. But now the improvement within the test data range is even bigger than for the training area. This is underlined with the system figures, e.g. the average trade within the test region improves from -$26 to a positive value of $34. This is even better than the value within the training region ($33).

例如，在优化第一个参数后，测试数据范围内的总净利润仅从-12,569美元到-9,736美元以及平均交易从-27美元到-26美元。 这意味着几乎没有变化。 如果您优化交易系统的第二个重要参数，快速移动平均值（值为2），那么您可以在训练集中看到进一步的改进。 但是现在测试数据范围内的改进甚至比训练区域还要大。 用系统数字强调这一点，例如： 测试区域内的平均交易价格从26美元提高到34美元。 这甚至比训练区域内的价值（33美元）更好。

If you now insert a third parameter into the trading system and optimise it (to a value of 9.30am-1.30pm) a dramatic change occurs. The system’s results improve greatly within both the training region and the testing region. Please note, however, that the result in the test region improves more than in the training region. For example, the average profit per trade becomes $200 in the testing period against $118 in the training period. We can summarise that for the first three input parameters every optimisation of the trading system within the training period also leads to an improvement in the testing period. Sometimes the improvement in the testing period is smaller (like with parameter 1: slow moving average), sometimes it is even bigger than in the training period (like with parameter  2  and  3:  fast  moving  average  and  time  filter).  If  you  now  continue  the optimisation of the trading system within the training period by adding suitable exits you get some really interesting findings.

如果您现在将第三个参数插入交易系统并对其进行优化（到上午9:30至下午1:30），则会发生显着变化。系统的结果在训练区域和测试区域内都得到了极大的改善。但请注意，测试区域的结果比训练区域的结果更好。例如，测试期间每笔交易的平均利润为200美元，而培训期间为118美元。我们可以总结出，对于前三个输入参数，培训期内交易系统的每次优化也会导致测试期间的改善。有时测试期间的改善较小（如参数1：慢移动平均值），有时甚至比训练期间更大（如参数2和3：快速移动平均值和时间滤波器）。如果您现在通过添加合适的出口继续在培训期内优化交易系统，您将获得一些非常有趣的发现。

Adding more optimised parameters in the training period can improve results in that area, but these additional parameters will not improve results in the testing period any more. This out-of-sample deterioration cannot be seen directly from the equity curves (Figures 5.10C-5.10G). All equity lines keep steadily growing within the test regions with every added optimised system parameter, and drawdowns stay low. However, if you have a closer look at the system’s report you see that in fact some hidden worsening takes place in the trading system (Table 5.3). The average profit per trade decreases from $200 to $126 after the optimised risk stop loss is inserted and stays in the area between $120 and $125  after  inserting  the  next  exits,  trailing  stop  and  profit  target.  There  is  similar behaviour for the maximum intraday drawdown. While the inserted risk stop loss reduces the drawdown from $10,097 to $8,448, the additional exits increase the drawdown again to nearly $10,000.

在训练期间添加更多优化参数可以改善该区域的结果，但是这些附加参数不再能够改善测试期间的结果。 这种样本外的恶化不能直接从权益曲线中看出（图5.10C-5.10G）。 所有股权线在测试区域内保持稳定增长，每增加一个优化的系统参数，并且下降保持低水平。 但是，如果您仔细查看系统报告，您会发现事实上在交易系统中会发生一些隐藏的恶化（表5.3）。 在插入优化风险止损后，每笔交易的平均利润从200美元降至126美元，并在插入下一个出口，追踪止损和利润目标后保持在120美元至125美元之间。 最大盘中跌幅存在类似行为。 虽然插入的风险止损将减少从10,097美元减少到8,448美元，但额外的退出将再次下调至近10,000美元。

The behaviour of the trading system within the different stages of optimisation for training and test area can be seen best when you plot trading system figures against number of optimised input parameters. If you do this for the total net profit you get a good insight of what happens during the different stages of system optimisation (Figure 5.11). The figure reveals how the total net profit within the training range (blue line) steadily increases with every added optimisation parameter, whereas the performance within the test range (green line) changes with increasing system complexity. With only a few parameters being optimised the net profit in the test range increases with every additional parameter, reaching its high with the third parameter (time window filter) and then being reduced with the fourth optimised parameter (risk stop loss). It then cannot be made bigger again with further optimised parameters.

当您根据优化的输入参数数量绘制交易系统数据时，可以最好地看到交易系统在培训和测试区域优化的不同阶段中的行为。 如果您对总净利润这样做，您可以很好地了解系统优化的不同阶段会发生什么（图5.11）。 该图显示了训练范围内的总净利润（蓝线）如何随着每个增加的优化参数稳定增加，而测试范围内的性能（绿线）随着系统复杂性的增加而变化。 只有少数参数被优化，测试范围内的净利润随着每个附加参数而增加，通过第三个参数（时间窗口过滤器）达到其高，然后通过第四个优化参数（风险停止损失）减少。 然后，通过进一步优化的参数，它不能再变大。

<p align="left"><font size=2>Figures 5.10 A-G: System LUXOR for British pound/US dollar (FOREX) training and test period. Training period 21/10/2002-28/2/2007 (white), test period 1/3/2007-4/7/2008 (green). One input parameter is optimised after another. A: No optimisation. B: Slow moving average: optimised value = 40. C: Fast moving average: optimised value = 2. D: Time window: optimised setting 9.30am-1.30pm GMT. E: Risk stop loss: optimised setting = 0.47% F: Trailing stop: optimised setting = 0.67%. G: Profit target: optimised setting = 2.25%. The optimised values are different from the gained values in chapter 3 since the optimisation period is shorter now, not the complete data range as before.</font></p>

![Figure 5.10](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_5.10.png)

<p align="left"><font size=2>Figure 5.11: Finding an optimal rule complexity for system LUXOR for British pound/US dollar (FOREX) training and test period. The system’s input parameters are optimised for maximum total net profit, from left to right, one after another, within the training period 21/10/2002-28/2/2007 (blue line = training results). Then results are checked in test data range 1/3/2007-4/7/2008 (green line = test results).</font></p>

![Figure 5.11](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_5.11.png)

#### The meaning of the trading system’s complexity

How can you now interpret this behaviour of the trading system?

你现在怎么解释交易系统的这种行为？

Let’s start within the diagram (Figure 5.11) from the left side when no system parameter is optimised. There the trading system has a very low complexity, since the applied rules are quite simple and not optimised at all. If you start to optimise the first parameter the system’s performance changes markedly. The raw and simple trading logic used so far can easily be made better. Interestingly when not many optimised parameters have been introduced the behaviour within the test range sometimes changes more than within the training range. The change can be much worse, but it can be better than the improvement that takes place in the training range. The reason for this behaviour is that a system that has only been optimised a little reacts very sensitively to parameter changes because there are not many parameters in place yet. The rule complexity and the predictability for your test set is low.

当没有优化系统参数时，让我们从左侧开始（图5.11）。 交易系统的复杂性非常低，因为应用的规则非常简单，根本没有优化。 如果您开始优化第一个参数，系统的性能会发生显着变化。 到目前为止使用的原始和简单的交易逻辑可以很容易地变得更好。 有趣的是，当引入的优化参数不多时，测试范围内的行为有时会在训练范围内发生变化。 变化可能会更糟，但它可能比训练范围内的改善更好。 这种行为的原因是，只有一点点优化的系统对参数变化的反应非常敏感，因为还没有很多参数。 规则复杂性和测试集的可预测性很低。

Furthermore, keep in mind that much of what happens in different market phases and areas is accidental and also depends on the market sample bias. It can be that the out-ofsample data period is more “friendly” to our trading system logic in a certain stage than the training data period. With further parameters being optimised or added the changes in the system’s reaction become smaller but still performance improves in the out-ofsample test data range. With the first three parameters being optimised our trading system reaches an important point: it reaches its optimal complexity.

此外，请记住，不同市场阶段和领域发生的大部分事故都是偶然的，也取决于市场样本偏差。 可能是，在训练数据期间的某个阶段，异常数据周期对我们的交易系统逻辑更“友好”。 通过优化或添加其他参数，系统反应的变化变小，但在样本外测试数据范围内仍然可以提高性能。 随着前三个参数的优化，我们的交易系统达到了一个重点：它达到了最佳的复杂性。

From this point on every further optimised parameter (risk stop, trailing stop, profit target) decreases the system’s performance in the test region although the results still improve in the training region. You now have the situation of curve over-fitting. Every new optimised parameter improves the fit of the system to the training area but what happens here is more an adjustment to the existing market noise than an improvement in predictive capability. Thus the net profit within the test region does not become bigger with further optimised parameters but instead it decreases from the fourth parameter onwards. You now again have an out-of-sample deterioration.

从这一点开始，每个进一步优化的参数（风险停止，追踪止损，利润目标）都会降低系统在测试区域的表现，尽管结果在训练区域仍然有所改善。 你现在有曲线过拟合的情况。 每个新的优化参数都会改善系统对训练区域的适应性，但这里发生的更多是对现有市场噪声的调整，而不是预测能力的提高。 因此，测试区域内的净利润不会随着进一步优化的参数而变大，而是从第四个参数开始减小。 你现在再次出现样本外的恶化。

It should be remembered that although the results in the out-of-sample area cannot be improved any more with these exits, they still have an important function. As discussed in Chapter 3.5 when talking about risk management, every stop loss leads to a better control of risk. We see the valuable function of the stops when we look at the largest losing trades which take place in the testing region – the added stop losses decrease this figure drastically from $2,631 to $1,023 (not shown in Table 5.3). Another figure which improves with inserted exits is the time the system stays in the market, which goes down from 100% to about 80%. With exits in place the outcome of trades is more predictable and this helps you to include the trading system into a bigger portfolio and to apply position sizing methods.

从这一点开始，每个进一步优化的参数（风险停止，追踪止损，利润目标）都会降低系统在测试区域的表现，尽管结果在训练区域仍然有所改善。 你现在有曲线过拟合的情况。 每个新的优化参数都会改善系统对训练区域的适应性，但这里发生的更多是对现有市场噪声的调整，而不是预测能力的提高。 因此，测试区域内的净利润不会随着进一步优化的参数而变大，而是从第四个参数开始减小。 你现在再次出现样本外的恶化。...

### 5.5 Rule complexity explained with polynomial curve fitting

----------

#### Interpolating data points with polynomial functions

You have just seen how a trading system’s predictive power for the future changes with the number of rules which are involved in the strategy. In our system these rules have been the fast and slow moving average, the very effective intraday time filter and finally the three exits we added. You have seen that a simpler trading system has more predictive power than a more optimised one. We can state that this result was not just gained by accident but it is well founded on statistical rules. We will explain these rules now with a short discussion on interpolating data points with polynomial functions.

从这一点开始，每个进一步优化的参数（风险停止，追踪止损，利润目标）都会降低系统在测试区域的表现，尽管结果在训练区域仍然有所改善。 你现在有曲线过拟合的情况。 每个新的优化参数都会改善系统对训练区域的适应性，但这里发生的更多是对现有市场噪声的调整，而不是预测能力的提高。 因此，测试区域内的净利润不会随着进一步优化的参数而变大，而是从第四个参数开始减小。 你现在再次出现样本外的恶化。...

Let’s assume that you have 10 data points as your sample data (Figure 5.12).

假设您有10个数据点作为样本数据（图5.12）。

<p align="left"><font size=2>Figure 5.12: Ten points of sample data, generated with a sinus function and random distances from it. Curve generated with MATLAB.</font></p>

![Figure 5.12](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_5.12.png)

In our case the 10 points were not chosen randomly but with a combination of a rule and random behaviour. We took a sinus function which is a normal oscillation and placed the 10 points around the sinus function with randomly taken distances. Here these are just mathematical points but as a trader you can imagine that these values could also be the prices of any financial markets, for example values of a tick chart of the FTSE 100 future or any stock you like. Thus our data point simulation is an approximation for financial markets in the way that you assume that the markets have a certain order or direction (at least during special times or events) but that around this order you have lots of random behaviour and market noise.

在我们的例子中，10个点不是随机选择的，而是结合了规则和随机行为。 我们采用正常振荡的窦功能，并将窦功能周围的10个点随机取得距离。 这里只是数学点，但作为交易者，您可以想象这些价值也可能是任何金融市场的价格，例如富时100期货的价格图表或您喜欢的任何股票。 因此，我们的数据点模拟是对金融市场的近似，假设您认为市场具有某种顺序或方向（至少在特殊时期或事件期间），但在此顺序中您会有很多随机行为和市场噪音。

To interpolate these 10 data points as well as possible you can use mathematic polynomial functions with different complexity. The higher the order of the polynom, the greater its complexity becomes. The easiest polynomial function (degree = 0) is a constant (Figure 5.13).

要尽可能地插入这10个数据点，您可以使用具有不同复杂度的数学多项式函数。 多项式的阶数越高，其复杂性就越大。 最简单的多项式函数（degree = 0）是一个常数（图5.13）。

<p align="left"><font size=2>Figure 5.13: Approximation of the ten data points with a polynomial function of degree = 0, a constant with value = 0. Curve generated with MATLAB.</font></p>

![Figure 5.13](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_5.13.png)

You see that this horizontal function touches some data points, but other points are a long way from it. The next higher complexity level is to interpolate the 10 data points with a linear function, which is a polynomial of degree 1 (Figure 5.14). In the picture of a trading system this line could be a simple trend line. Since the results of the constant and the linear function are rather poor fits to the 10 data points, we have to increase the adaptive function’s complexity. The second order polynomial seems to give a quite good fit to the data points (Figure 5.15). This curve reaches more data points and comes quite close to all points, although not all are reached exactly. If we increase the degree of the polynomial function to 3 we already have a very nice fit to the data points and when we go to a much higher order of polynomial (degree = 9) we obtain a 100% fit to the training data (Figures 5.16 and 5.17). The polynomial of degree 9 passes exactly through each data point.

你看到这个水平函数接触了一些数据点，但其他点距离它很远。 下一个更高的复杂度级别是使用线性函数对10个数据点进行插值，这是1次多项式（图5.14）。 在交易系统的图片中，这条线可能是一条简单的趋势线。 由于常数和线性函数的结果相当不适合10个数据点，我们必须增加自适应函数的复杂性。 二阶多项式似乎非常适合数据点（图5.15）。 该曲线可以达到更多的数据点并且非常接近所有点，尽管并非所有点都准确到达。 如果我们将多项式函数的次数增加到3，我们已经非常适合数据点，当我们进入更高阶的多项式（度= 9）时，我们获得了100％的训练数据拟合（图 5.16和5.17）。 9阶多项式准确地通过每个数据点。

<p align="left"><font size=2>Figure 5.14: Approximation of the ten data points with a polynomial function of degree = 1, a linear function. Curve generated with MATLAB.</font></p>

![Figure 5.14](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_5.14.png)

<p align="left"><font size=2>Figure 5.15: Approximation of the ten data points with a polynomial function of degree = 2, a parabolic function. Curve generated with MATLAB.</font></p>

![Figure 5.15](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_5.15.png)

<p align="left"><font size=2>Figure 5.16: Approximation of the ten data points with a polynomial function of degree = 3. The fitness to the data points increases but also the complexity of the function. Curve generated with MATLAB.</font></p>

![Figure 5.16](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_5.16.png)

<p align="left"><font size=2>Figure 5.17: Approximation of the ten data points with a complex polynomial function of degree = 9. Curve generated with MATLAB.</font></p>

![Figure 5.17](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_5.17.png)

You can also plot the results of these graphs in a table (Table 5.4). There you see how the average error of the fitness function becomes smaller with a higher degree of polynomial. Whereas the polynomial of degree 0 has a big standard deviation from the 10 data points (5.39), the 9th degree polynomial nearly reaches the points without any error (0.0003).

您还可以在表格中绘制这些图表的结果（表5.4）。 在那里，您可以看到适应度函数的平均误差如何随着更高程度的多项式变得更小。 而0度多项式与10个数据点（5.39）的标准偏差较大，而9度多项式几乎达到没有任何误差的点（0.0003）。

<p align="left"><font size=2>Table 5.4: Average error of fit to data points (standard deviation) as a function of the degree of the polynomial. The higher the degree of the polynomial, the better its fit to the data points, but the higher its rule complexity becomes.</font></p>

![Table 5.4](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Table_5.4.png)

If you have a closer look at the result of the 9th degree polynomial fit you can see that the fitted curve oscillates wildly and gives only a very poor representation of the chosen sinus-function with the data points randomly around it. This 9th degree polynomial could stand for a very complex trading system with many components added until you have got a perfect fit of the trading logic to your market data.

如果仔细观察9度多项式拟合的结果，您可以看到拟合曲线疯狂地振荡，并且只给出了所选择的正弦函数的非常差的表示，其中数据点随机地围绕它。 这个9度多项式可以代表一个非常复杂的交易系统，添加了许多组件，直到您将交易逻辑与市场数据完美契合。

But what are the conclusions which you can draw from these fitness functions and what is the predictive power of the different polynomials for the future?

但是，您可以从这些适应度函数中得出什么结论，以及未来不同多项式的预测能力是什么？

#### Predictive power of the different polynomials

Let’s see what happens if we add further data points by letting the sinus function continue into the future (Figure 5.18). You can see that the polynomial of degree 0 continues to go sideways with the sinus function. Thus the predictive power of this very simple function for the future is quite poor, but it is worth mentioning that it stays exactly the same as the result of the back-test of the ten data points.

让我们看看如果我们通过让窦功能继续到未来来添加更多数据点会发生什么（图5.18）。 你可以看到0度的多项式继续与正弦函数一起侧向。 因此，这个非常简单的函数对于未来的预测能力非常差，但值得一提的是，它与十个数据点的反向测试结果完全相同。

<p align="left"><font size=2>Figure 5.18: Predictive capability of the polynomial of degree =0 for unseen test data. Curve generated with MATLAB.</font></p>

![Figure 5.18](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_5.18.png)

<p align="left"><font size=2>Figure 5.19: Predictive capability of the polynomial of degree = 9 for unseen test data. Curve generated with MATLAB.</font></p>

![Figure 5.19](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_5.19.png)

In contrast to this simple approximation of the training data set, let’s have a look at the the polynomial of degree 9 (Figure 5.19). Obviously this complex polynomial (or trading system) does not have any predictive power for the future! The well curve fitted complex function misses the new points completely.

与训练数据集的这种简单近似相反，让我们看一下9阶多项式（图5.19）。 显然，这个复杂的多项式（或交易系统）对未来没有任何预测能力！ 适合复杂功能的井曲线完全错过了新的点。

You might expect the best solution somewhere in between these two extremes. But this is not true. In fact no polynom of degree higher than 0 is a good approximation for the data points which are placed near a sine curve. All polynoms (even with degree 1)  grow quickly away from the horizontal line around which the sine function oscillates. Thus all polynoms,  except  the  polynom  of  degree  0,  are  useless  concerning  for  making predictions! Although the polynom of degree 0 is poor it is the only robust one.

您可能期望在这两个极端之间的某个地方找到最佳解决方案。 但是这是错误的。 实际上，没有高于0的多项式是对于放置在正弦曲线附近的数据点的良好近似。 所有多项式（即使是1度）都会快速远离水平线，正弦函数围绕该水平线振荡。 因此，除了0度的多项式之外的所有多项都无法用于预测！ 尽管0度的多项式很差，但它是唯一的强大的。

What is the way out of this situation? Does it mean that you must stop trading system development completely and look at the trend of the markets with simple lines?

出现这种情况的方法是什么？ 这是否意味着您必须完全停止交易系统开发并用简单的线条来看待市场趋势？

#### Conclusions for trading system development

What you have seen in this example is just that markets cannot be approached with pure mathematical methods. But this does not mean that all trading systems must be of zerocomplexity. Our mistake here was that we tried to approach a periodic sinus function with a non-periodic polynomial function. Like this we forced our algorithm to adapt to a situation for which it is not built. The polynomial function was not suited to the function we were trying to use it for because it is not the correct approximation for a periodic environment. The idea of periodicity was missing. The conclusion for you as a system developer and trader is that you must first have an idea of the market! Only when you have this can you start to code your idea and only like this will you get a code that makes sense. Just as it is useless to approach periodic functions with polynomials, it is useless to approach trendless markets with trend-following methods or to approach markets with no volatility with break-out systems. We know that this leads into further conflicts since markets are steadily changing, but using ideas and experience is the best approach you can take.

你在这个例子中看到的只是市场不能用纯粹的数学方法来处理。但这并不意味着所有交易系统都必须具有零复杂性。我们这里的错误是我们试图用非周期多项式函数逼近周期性正弦函数。像这样，我们强制我们的算法适应它没有构建的情况。多项式函数不适合我们尝试使用它的函数，因为它不是周期环境的正确近似。缺乏周期性的想法。您作为系统开发人员和交易员的结论是，您必须首先了解市场！只有当你拥有这个时才能开始编写你的想法，只有这样你才能得到一个有意义的代码。正如利用多项式处理周期函数一样无用，使用趋势跟踪方法接近无趋势市场或通过突破系统接近没有波动性的市场是没有用的。我们知道，由于市场正在稳步变化，这会导致进一步的冲突，但使用创意和经验是您可以采取的最佳方法。

Further consequences of these tests are that once you have a simple, robust logic with a proper risk management in place you can stop your system development process. It is often better to use just one or two indicators, or only the price itself, rather than several combined indicators. Adding more and more rules will just increase the adaptation of your trading system to past market data, but it will not increase its predictive power for real trading. Therefore it is better to save your time and invest it otherwise, for example in adding a money management scheme or by diversifying your strategy with further simple but robust systems within a portfolio.

这些测试的进一步结果是，一旦您拥有一个简单，强大的逻辑并且具有适当的风险管理，您就可以停止系统开发过程。 通常最好只使用一个或两个指标，或仅使用价格本身，而不是几个综合指标。 添加越来越多的规则只会增加您的交易系统对过去市场数据的适应性，但它不会增加其对实际交易的预测能力。 因此，最好是节省您的时间并以其他方式进行投资，例如在添加资金管理计划或通过投资组合中的更简单但更强大的系统来分散您的策略。

## Chapter 6: Periodic re-optimisation and walk forward analysis

### 6.1 Short repetition: “normal”, static optimisation

----------

Let’s first remind ourselves of the “normal” optimisation process which we set out in Chapter 5. In order to optimise your system you take a fixed training data set (“in sample data”) and then you apply the system to previously unseen data: this is the so called “test set” or “out-of-sample data” (Figure 6.1). In our example the training data set was about four years and four months, from 21/10/2002 to 28/2/2007 and the test set was one year and four months from 1/3/2007 to 4/7/2008.

让我们首先提醒自己我们在第5章中提出的“正常”优化过程。为了优化您的系统，您需要一个固定的训练数据集（“在样本数据中”），然后将系统应用于以前看不见的数据： 这就是所谓的“测试集”或“样本外数据”（图6.1）。 在我们的例子中，培训数据集大约是4年零4个月，从2002年10月21日到2007年2月28日，测试集是从2007年1月3日到2008年4月7日的一年零四个月。

<p align="left"><font size=2>Figure 6.1: Equity curve of system LUXOR for British pound/US dollar (FOREX) training and test period, 30 minute data. Training period 21/10/2002-28/2/2007 (white), test period 1/3/2007-4/7/2008 (green).</font></p>

![Figure 6.1](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_6.1.png)

Obviously this well-known procedure of optimising your trading system on a special market has some disadvantages. You only have one in-sample and one out-of-sample area. The out-of-sample test range is usually the most recent data. The more data you have in the training set the more efficiently you can train your system to different market conditions  (compare  with  Chapter  5.2).  Further,  keep  in  mind  that  this  “normal” optimisation process can work well for sound trading systems for a certain time. But be aware that over a longer period of time the market structure could change. In such a case you will need to adapt the trading system as well. A purely static approach with the input parameters fixed forever will fail sooner or later. Since there is no system code which can work forever you have to change your system parameters from time to time. These are good reasons to look at more dynamic optimisation methods.

显然，这种在特殊市场上优化交易系统的众所周知的程序有一些缺点。 您只有一个样本内和一个样本外区域。 样本外测试范围通常是最新的数据。 您在培训中获得的数据越多，您就可以更有效地将系统培训到不同的市场条件（与第5.2章相比）。 此外，请记住，这种“正常”优化过程可以在声音交易系统中使用一段时间。 但请注意，在较长一段时间内，市场结构可能会发生变化。 在这种情况下，您还需要调整交易系统。 输入参数永久固定的纯静态方法迟早会失败。 由于没有可以永久工作的系统代码，因此您必须不时更改系统参数。 这些是了解更多动态优化方法的好理由。

### 6.2 Anchored vs. rolling walk forward analysis (WFA)

----------

If you take the above example but make the optimisation window bigger and bigger you arrive at an anchored WFA. The optimisation is anchored since it always starts at the same point of time (Figure 6.2A). This is the simplest form of WFA. It usually works best, like the static optimisation we examined above, when the tested market keeps its personality within the tested sample.

如果你采用上面的例子，但是让优化窗口越来越大，你就会得到一个锚定的WFA。 优化是固定的，因为它始终在同一时间点开始（图6.2A）。 这是最简单的WFA形式。 当测试市场在测试样本中保持其个性时，它通常效果最好，就像我们上面检查的静态优化一样。

<p align="left"><font size=2>Figure 6.2A: Anchored walk forward analysis. For every new optimisation run the in-sample optimisation window starts at the same point of time but its length is subsequently increased. The unseen out-of-sample data follows.</font></p>

![Figure 6.2A](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_6.2_A.png)

However, as you know, markets and their personalities can be complex. Sometimes a market will show an equity curve that has some very profitable and some not-veryprofitable intervals within the tested data ranges. If a market appears to have such a changing personality then the anchored WFA may be not the best method. In these cases it is necessary to perform an optimisation method which better adapts to changing market conditions, the rolling WFA (Figure 6.2B). The rolling WFA is particularly appropriate for short-term intraday systems.

如果你采用上面的例子，但是让优化窗口越来越大，你就会得到一个锚定的WFA。 优化是固定的，因为它始终在同一时间点开始（图6.2A）。 这是最简单的WFA形式。 当测试市场在测试样本中保持其个性时，它通常效果最好，就像我们上面检查的静态优化一样。

<p align="left"><font size=2>Figure 6.2B: Rolling walk forward analysis. Shifting in-sample optimisation window = 1 year and shifting unseen out-of-sample data = the 3 following months.</font></p>

![Figure 6.2B](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_6.2_B.png)

The better adaptation of the rolling WFA may mean it is more appropriate, and may yield results that walk forward better, in live trading than results obtained from an anchored WFA.

滚动WFA的更好适应可能意味着它更合适，并且可能产生比实时交易更好的结果，而不是从锚定的WFA获得的结果。

### 6.3 Rolling WFA on the LUXOR system

----------

#### Periodic optimisation of the two main system parameters

Let’s try the rolling WFA on the LUXOR system with 30 minute data of the pound/dollar pair. So instead of optimising the code’s input settings within a fixed test data range, we now have to do a rolling re-optimisation of the two main system parameters, the fast and slow moving average. As seen in Chapter 5.4, the system is most reactive on these two moving averages that trigger the entry signals. During this re-optimisation process we keep all other system parameters (time filter and the three exits) constant with the values gained in Chapter 3. We optimise the two moving averages in periods of one year and shift this optimisation period three months further with every new run (Figure 6.2B). To complete the WFA and to check its results we apply the optimised values to the unseen data ranges. In this way we see how our periodically optimised system walks forward.

让我们尝试在LUXOR系统上滚动WFA，使用30分钟的英镑/美元对数据。 因此，我们不必在固定的测试数据范围内优化代码的输入设置，而是必须对两个主要系统参数（快速和慢速移动平均值）进行滚动重新优化。 如第5.4章所示，系统在触发进入信号的这两个移动平均线上最具反应性。 在此重新优化过程中，我们将所有其他系统参数（时间过滤器和三个出口）与第3章中获得的值保持一致。我们在一年的时间内优化两个移动平均值，并将此优化周期进一步延长三个月 新运行（图6.2B）。 要完成WFA并检查其结果，我们将优化值应用于看不见的数据范围。 通过这种方式，我们可以看到我们定期优化的系

With the rolling WFA we have a training set which is not static as before but which is moving forward as the time goes by. In our case we use one-year in-sample optimisation periods which move forward every three months. With each new optimisation you get two new optimal moving average values. For example, during the optimisation period between November 2002 and November 2003 you get an optimal fast moving average length of 3 bars and an optimal slow moving average length of 21 bars. If you shift the optimisation period by 3 months to February 2003 until February 2004 the parameter’s best values change to 1 (fast) and 39 (slow) for the moving averages. (Of course a “moving average” of length 1 is just the price itself.)

在滚动的WFA中，我们有一个训练集，它不像以前那样是静态的，但随着时间的推移正在向前发展。 在我们的案例中，我们使用一年的样本内优化期，每三个月推进一次。 通过每次新的优化，您将获得两个新的最佳移动平均值。 例如，在2002年11月到2003年11月的优化期间，您将获得3巴的最佳快速移动平均长度和21巴的最佳慢速移动平均长度。 如果将优化周期从2003年2月的3个月更改为2004年2月，则参数的最佳值将更改为移动平均值的1（快）和39（慢）。 （当然，长度为1的“移动平均线”只是价格本身。）

If you shift the optimisation window by 3 months again (now from May 2003 until May 2004) the two input parameters change again to 1 (fast) and 21 (slow) which is shown in (Table 6.1). So instead of the static optimisation you now have 19 optimisation runs for the two main input parameters within the training period. Please note that these 19 optimisation runs use nearly the whole market data range for both optimisation and for testing. Remember that the static optimisation from Chapter 5.4 just could use a small part of about one year of the data for the out-of-sample test. So you now get a much more detailed test of your trading system on much more data – not by having more data available (you still only have the 6 years from 2002 to 2008) but by using it in a cleverer way.

如果再次将优化窗口移动3个月（现在从2003年5月到2004年5月），则两个输入参数再次变为1（快速）和21（慢速），如（表6.1）所示。 因此，您不再使用静态优化，而是在训练期内对两个主要输入参数进行了19次优化运行。 请注意，这19项优化运行几乎使用了整个市场数据范围进行优化和测试。 请记住，第5.4章中的静态优化只能使用大约一年的一小部分数据进行样本外测试。 因此，您现在可以在更多数据上更详细地测试您的交易系统 - 不是通过提供更多数据（您仍然只有2002年至2008年的6年），而是以更聪明的方式使用它。

<p align="left"><font size=2>Table 6.1: Periodic re-optimisation of the trading system LUXOR on 30 minute data of the GBP/USD FOREX pair. The gained “best” parameters are applied subsequently to out-ofsample areas of 3-month test data.</font></p>

![Table 6.1](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Table_6.1.png)

If you plot the two optimised input parameters as a function of the start of the optimisation window you see their change within the five years (Figure 6.3). Please note that the two optimised parameters change rather slowly – an important aspect for the gained out-ofsample test results, which we will discuss now.

如果将两个优化的输入参数绘制为优化窗口起点的函数，则可以看到它们在五年内的变化（图6.3）。 请注意，两个优化参数的变化相当缓慢 - 这是获得的样本外测试结果的一个重要方面，我们现在将讨论这些结果。

<p align="left"><font size=2>Figure 6.3: Change of the optimal parameters for the fast and slow moving averages as a function of the shifting one year optimisation period. During the tests the following other parameters are kept in place: entry time window 9.30am-1.30pm GMT, exits: 0.3% risk stop, 0.8% trailing stop and 1.9% optimised for trading system LUXOR on 30 minute data of the GBP/USD FOREX pair.</font></p>

![Figure 6.3](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_6.3.png)

#### Out-of-sample test result

Let’s apply the trading system with these optimised parameters to the unseen data. In Table 6.1 you can see that the optimal parameters 3 (fast) and 21 (slow) which have been gained in the first one-year optimisation window between 1 November 2002 and 1 November 2003 are applied to the subsequent three months from 1 November 2003 until 1 February 2004 of unseen data. The optimal parameters for the subsequent optimisation period (February 2003 until February 2004: fast moving average = 1 bar, slow moving average = 39 bars) are applied to the unseen data between 1 February 2004 and 1 May 2004 and so forth for all the other 17 periods. In this way you get a complete out-ofsample test of the trading system applied to previously unseen data. The result is shown in Figure 6.4.

让我们将具有这些优化参数的交易系统应用于看不见的数据。 在表6.1中，您可以看到在2002年11月1日至2003年11月1日的第一个一年优化窗口中获得的最佳参数3（快速）和21（慢）适用于2003年11月1日的后续三个月 直到2004年2月1日的未见数据。 随后优化期间（2003年2月至2004年2月：快速移动平均值= 1 bar，慢速移动平均值= 39 bar）的最佳参数适用于2004年2月1日至2004年5月1日期间看不见的数据，等等所有其他参数 17个时期。 通过这种方式，您可以对应用于以前看不见的数据的交易系统进行完整的样本外测试。 结果如图6.4所示。

<p align="left"><font size=2>Figure 6.4: Out-of-sample test for the periodically optimised values. System LUXOR for British pound/US dollar (FOREX) 2/11/2003-4/7/2008. During the tests the following other parameters are kept in place: entry time window 9.30am-130pm GMT, exits: 0.3% risk stop, 0.8% trailing stop and 1.9% optimised for trading system LUXOR on 30 minute data of the GBP/USD FOREX pair.</font></p>

![Figure 6.4](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_6.4.png)

The total net profit is slightly higher and the maximum drawdown lower than with the originally developed system. This is an astonishing result since this equity line is a 100% out-of-sample test for the two main input parameters, the fast and slow moving average. The explanation for this result can partially be given by Figure 6.3 and Table 6.1. There you can see that the two moving averages have had little need to change during the five years within the different optimisation windows. In other words the market conditions have not changed a lot and the system was fast enough to adapt to the changing market conditions which have lead to these profitable results.

总净利润略高，最大亏损低于最初开发的系统。 这是一个令人惊讶的结果，因为该权益线是两个主要输入参数（快速和慢速移动平均值）的100％样本外测试。 图6.3和表6.1可以部分地给出对该结果的解释。 在那里你可以看到，在不同的优化窗口中，两个移动平均线几乎没有必要在五年内改变。 换句话说，市场条件没有太大变化，系统足够快，能够适应不断变化的市场条件，从而带来这些有利可图的结果。

#### Conclusion

The  30  minute  data  of  the  GBP/USD  pair  is  a  proper  example  of  a  periodic  reoptimisation working with the chosen optimisation window (1 year) and shifting period (every three months). Please note, however, that the right selection of this re-optimisation window and period is a complex topic of which you should be aware. The periodic walk forward optimisation is one of the most powerful tools available today, but like every method it has its pitfalls and needs to be applied correctly. As with every optimisation the settings of an appropriate walk forward analysis depend on the number of variables in your trading system.

GBP / USD对的30分钟数据是使用所选优化窗口（1年）和轮换期（每三个月）进行周期性重新优化的正确示例。 但请注意，正确选择此重新优化窗口和期间是一个复杂的主题，您应该知道。 定期向前推进优化是当今最强大的工具之一，但是像每种方法一样，它存在缺陷，需要正确应用。 与每次优化一样，适当的前瞻性分析的设置取决于交易系统中的变量数量。

As we saw in Chapter 5, the less rules your system contains, the more robust your strategy will be in real trading. A trading system with too much complexity leads to too much adaptation of your system to the data and therefore to curve over-fitting. This rule, which was found in “normal” optimisation with one training data and one test data set can be transferred to the periodic re-optimisation. However, with the periodic re-optimisation you have the advantage that your out-of-sample data range (the test data) is bigger and therefore an over-fitted system with too much complexity usually fails in the walk forward analysis more often than it does during the static system tests. Because of this you can trust your system more when it passes the WFA than “normal” static back-tests.

正如我们在第5章中看到的那样，您的系统包含的规则越少，您的策略在实际交易中的稳健性就越强。 过于复杂的交易系统会导致系统对数据的适应性过大，从而导致曲线过度拟合。 在具有一个训练数据和一个测试数据集的“正常”优化中找到的该规则可以转移到周期性重新优化。 但是，通过定期重新优化，您的优势在于您的样本外数据范围（测试数据）更大，因此过度复杂的过度拟合系统通常会在前进分析中失败，而不是 在静态系统测试期间。 因此，当您通过WFA而不是“正常”静态反向测试时，您可以更信任您的系统。

### 6.4 The meaning of sample size and market structure

----------

One point which is relevant during every optimisation process and especially of periodic re-optimisation is the question of how to choose your optimisation period. Do you reoptimise every day, every two weeks or every year? Your computer, with its limited power, may give an answer to this question but there are still other points there to investigate, one of which is the market’s inherent attributes, which we call “market structure”.

在每个优化过程中，尤其是定期重新优化过程中，有一点是如何选择优化周期的问题。 你是每天，每两周还是每年重复一次？ 你的计算机功能有限，可能会给出这个问题的答案，但还有其他一些需要调查的地方，其中一个就是市场的固有属性，我们称之为“市场结构”。

In our LUXOR system we had a rolling optimisation period of one year and a subsequent out-of-sample test period of three months. These chosen settings proved to be appropriate for our system/market combination. But what are good settings for other systems and markets? What if you work with daily data, with 10 minute data or with 1 minute data?

在我们的LUXOR系统中，我们有一年的滚动优化期和随后的三个月的样本外测试期。 这些选择的设置证明适合我们的系统/市场组合。 但是对于其他系统和市场有什么好的设置呢？ 如果使用每日数据，10分钟数据或1分钟数据，该怎么办？

On a TradeStation forum we recently found a double-edged comment about this topic: The problem is that if you use an inadequate sample size then your system is much more likely to get “blindsided” by price patterns that haven’t been previously observed when you implement it. Adequate sample size is the cheapest insurance a system trader can get. Unless a system is tested on an adequate sample of historical data, it is statistically impossible for it to walk forward reliably, no matter how good the test result looks. No amount of post-processing, analysis, walk-forward runs, out-of-sample testing or anything else can compensate for an inadequate historical data sample. If you sampled half a year of hourly wind speed data in Florida during a season when no hurricanes (or even any severe local thunderstorms) hit, you might come away with the impression that you had gathered a representative sample of Florida wind speeds.

在TradeStation论坛上，我们最近发现了一个关于这个主题的双刃评论：问题是，如果你使用的样本量不合适，那么你的系统更容易被以前没有观察到的价格模式“蒙住” 你实现它。 足够的样本量是系统交易者可以获得的最便宜的保险。 除非系统在足够的历史数据样本上进行测试，否则无论测试结果有多好，它在统计上都不可能可靠地向前推进。 没有任何后处理，分析，前进运行，样本外测试或任何其他可以补偿不充分的历史数据样本。 如果您在没有飓风（甚至任何严重的局部雷暴）袭击的季节中在佛罗里达州采样半年的小时风速数据，您可能会得到一个印象，即您已经收集了佛罗里达风速的代表性样本。

Let’s illustrate what this statement means. Figure 6.5 shows an artificial market as a function of time. As you can see our market is built in such a way that it has phases of slower  and  faster  oscillations. In this  case the structure of the market is a special oscillation or frequency. Of course markets can have hundreds of other typical attributes like opening gaps, trending behaviour, over-bought areas, etc. The fast and slow oscillation here is just a representation for a changing market structure.

让我们来说明这个陈述的含义。 图6.5显示了作为时间函数的人工市场。 正如您所看到的，我们的市场以这样的方式构建，即它具有更慢和更快振荡的阶段。 在这种情况下，市场结构是特殊的振荡或频率。 当然，市场可能有数百种其他典型属性，如开放空白，趋势行为，过度买入区域等。这里的快速和慢速振荡只是市场结构变化的一种表现形式。

<p align="left"><font size=2>Figure 6.5: The market changes as a function of the time. Every market has its special structure, frequency, trends etc.</font></p>

![Figure 6.5](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_6.5.png)

<p align="left"><font size=2>Figure 6.6: Optimisation window fits to the market structure. Ideal case: unseen data is same as data in optimisation window.</font></p>

![Figure 6.6](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_6.6.png)

<p align="left"><font size=2>Figure 6.7: Optimisation window fits to the market structure. Ideal case: unseen data is same as data in optimisation window.</font></p>

![Figure 6.7](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_6.7.png)

When you now apply your rolling WFA with shifting optimisation window and window of unseen out-of-sample data you can have the two extreme situations as shown in Figures 6.6 and 6.7. The optimisation window can catch a part of the market which contains all the information of the market (Figure 6.6) or it can be chosen in such a way that it just captures an area of market data which is completely different to the price structure which will follow (Figure 6.7). Obviously when doing WFA you will never have one situation or the other but always a mixture in between. What is ultimately suitable can only be discovered through a series of tests in order to gain the necessary experience of different scenarios.

现在，当您使用具有移动优化窗口和不可见的样本外数据窗口的滚动WFA时，您可以处于两种极端情况，如图6.6和6.7所示。 优化窗口可以捕获包含市场所有信息的市场的一部分（图6.6），或者可以选择它只捕获市场数据的一个区域，这个区域与价格结构完全不同。 遵循（图6.7）。 显然，在做WFA时，你永远不会有一种情况或另一种情况，但总是混合在一起。 只有通过一系列测试才能发现最终合适的内容，以获得不同场景的必要体验。

Imagine that you run walk-forward tests on the S&P500, FTSE or DAX with different out-of-sample exclusion percentages and stress test coefficients on that same short sample of data, in order to get a quantitative idea of the number of walk-forward run and out-ofsample exclusion percentages that work best when walk-forward analysing your system. And let’s also assume that you’re unlucky enough that everything you run passes all the logical tests for reliability above the accepted threshold and comes out looking OK. Unlucky, you say? Sure, because you can slice and dice your data until your computer goes obsolete but you’ll still never “see” the occasional market breakdown that occurs in the stock markets once in twenty years. That’s because you’re attempting to draw a set of complex statistical inferences out of a pathetically inadequate sample of data.

想象一下，您对S＆P500，FTSE或DAX进行了前瞻性测试，在相同的短数据样本上使用不同的样本外排除百分比和压力测试系数，以便定量了解前进的数量 在向前分析系统时，运行和超出样例的排除百分比最有效。 而且我们还假设你运气不好，你运行的所有东西都通过了所有可靠性的逻辑测试，超过了可接受的阈值，看起来还不错。 不走运，你说呢？ 当然，因为你可以对你的数据进行切片和切块，直到你的计算机过时，但你仍然不会“看到”20年后股市偶尔发生的市场崩溃。 那是因为你试图从可怜的数据样本中抽取一组复杂的统计推断。

The longer your sample, the higher the probability that it contains most of the conditions it’s likely to encounter in the future. It is human nature to want to curve fit a “beautiful” system to a short sample of data, but remember that sample sizing is a complex topic. There are high-risk but valid systems that trade very frequently, that may have a “shelf life” – the interval between re-optimisations – of a day or two and that might look at relatively short histories of data in n-tick or minute range timeframes. To a limited degree, data bars exhibit fractal properties. In other words, 20 years of daily data consists of about 5000 bars. A year of 15 minute cash session bars also consists of about 5000 bars. Both charts will exhibit similar patterns of trends, support and resistance, consolidations, double-bottoms, channel breakouts and other manifestations of the dynamic interaction of the group psychology of bulls and bears.

样本越长，它包含将来可能遇到的大多数条件的概率就越高。 想要将“漂亮”系统曲线拟合到简短的数据样本是人类本性，但请记住，样本大小调整是一个复杂的主题。 存在高风险但有效的系统，这些系统非常频繁地交易，可能具有“保质期” - 重新优化之间的间隔 - 一两天，并且可能在n-tick或分钟中查看相对较短的数据历史 范围时间表。 在有限的程度上，数据条表现出分形特性。 换句话说，20年的每日数据包括约5000条。 一年15分钟的现金酒吧也包括约5000酒吧。 这两个图表将展示类似的趋势，支撑和阻力，整合，双底，渠道突破以及多头和空头集团心理的动态互动的其他表现形式。

But does this mean that a year’s worth of 15 minute data is equivalent to 20 years of daily data? No, it doesn’t. The probability of recording a crash in six months’ of  data would not be any better if its sampling interval were three minutes instead of 60 minutes or daily bars. Be careful with short data samples regardless of timeframe or trading frequency. If your optimisation window is short, it is more likely you will miss important data outside of the window. You will be generalising on limited historical data, and this will lead to a weaker potential for predicting the future.

但这是否意味着一年的15分钟数据相当于20年的每日数据？ 不，它没有。 如果采样间隔为3分钟而不是60分钟或每日柱，则在六个月的数据中记录崩溃的概率将不会更好。 无论时间范围或交易频率如何，都要小心短数据样本。 如果您的优化窗口很短，则您很可能会错过窗口外的重要数据。 您将对有限的历史数据进行推广，这将导致预测未来的潜力较弱。

## Chapter 7: Position sizing example, using the LUXOR system

Steady money is not made by mysterious super trading systems, it is made by proper money management of average trading systems.

稳定的资金不是由神秘的超级交易系统制造的，而是由平均交易系统的适当资金管理制成的。

### 7.1 Definitions: money management vs. risk management

----------

In order to understand what money management really means, its relation towards risk management is essential. Thus we first of all want to work out the different meanings of the two terms.

为了理解资金管理的真正含义，它与风险管理的关系至关重要。 因此，我们首先想要弄清楚这两个术语的不同含义。

#### Risk management (RM)

Within a single trading system the simplest form of risk management is the control of the distance between the entry and the exit. As a practical example see in Chapter 3.5 how different stops and targets are added to an entry logic and how this changes the risk figures like maximum drawdown, average losing trade and largest losing trade. This step is the first in risk management and it is the implementation of the quantified risk values into your trading strategy. The second level of RM is the permanent measurement of risk during active trading. By screening your trading systems regularly, e.g. every month, you have to check if they continue to behave in reality as calculated during testing. You have to watch carefully if markets change concerning point value or volatility: this could affect your calculated risk figures and can mean that adjustments are necessary.

在单一交易系统中，最简单的风险管理形式是控制进入和退出之间的距离。 作为一个实际的例子，请参阅第3.5章，如何在条目逻辑中添加不同的止损和目标，以及这如何改变风险数据，如最大亏损，平均亏损交易和最大亏损交易。 此步骤是风险管理中的第一步，它是将量化风险值实施到您的交易策略中。 RM的第二个级别是在活跃交易期间永久性地衡量风险。 通过定期筛选您的交易系统，例如 每个月，你必须检查他们是否继续按照测试期间的计算行事。 您必须仔细观察市场是否有关于点值或波动性的变化：这可能会影响您计算的风险数据，并且可能意味着必须进行调整

#### Money management (MM)

In simpler words MM is called “position sizing”. It describes how to use your existing trading capital in the most efficient way and it provides answers to the following basic questions:
1.     What percentage of the available funds should be totally invested?
2.     What percentage of the available funds is it possible to risk in the next trade in a special market?
3.     What leverage and market exposure should be chosen?

简单来说，MM被称为“位置大小”。 它描述了如何以最有效的方式使用现有的交易资本，并提供以下基本问题的答案：
1.应该投入多少百分比的可用资金？
2.在特定市场的下一笔交易中，可用资金的百分比是多少？
3.应选择什么样的杠杆和市场曝光？

The success of a trading strategy is highly dependent on correct money management. With appropriate money management techniques the existing capital should not only be maintained but increased in an optimal way. With prudent money management the loss of a single trade is limited in such a way that even if the trade goes wrong often, there is trading capital remaining to try many additional successive similar trades. All MM schemes have one thing in common: they only work on the basis of a trading system with a positive expectancy. Although a proper MM decreases the lot size in unfavourable phases it can only make gains if the system comes back and shows a profit factor higher than 1 in the long run. Whether the profit factor is 1.5 or 1.001 is not that important. As long as it is higher than 1 and the system makes steady profits a good MM can improve the results of your trading system. You do not need to have an extraordinarily profitable trading system to gain money. In the long term it’s enough to have a stable strategy with a positive expectancy and proper money management.

交易策略的成功在很大程度上取决于正确的资金管理。利用适当的资金管理技术，不仅应维持现有资本，还应以最佳方式增加资本。通过谨慎的资金管理，单一交易的损失是有限的，即使交易经常出现问题，仍有交易资金可以尝试许多额外的连续类似交易。所有MM计划都有一个共同点：它们只能在具有正预期的交易系统的基础上工作。虽然合适的MM在不利的阶段减少了批量，但只有系统回来并且从长远来看显示利润率高于1时才能获得收益。利润因子是1.5还是1.001并不重要。只要它高于1并且系统获得稳定的利润，一个好的MM可以改善您的交易系统的结果。您无需拥有一个非常有利可图的交易系统来赚钱。从长远来看，它足以拥有一个稳定的战略，具有良好的预期和适当的资金管理。

From the above definitions of risk management and money management it is obvious that the two processes cannot be separated but they are highly dependent on each other(Figure 7.1).

从上述风险管理和资金管理的定义来看，很明显这两个过程不能分开，但它们彼此高度依赖（图7.1）。

<p align="left"><font size=2>Figure 7.1: The interaction of money and risk management. The goal of money management is to maximise your profits. The goal of risk management is to minimise your risks. The two different processes are connected with each other.</font></p>

![Figure 7.1](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_7.1.png)

The distance of your initial stops and therefore the risk of your trading system is important for  the  determination  of  the  number  of  lots  you  can  trade.  On  the  other  hand  the distribution of your trading capital is important in deciding how much you can risk in a single trade in a single market.

您初始止损的距离以及交易系统的风险对于确定您可以交易的手数非常重要。 另一方面，您的交易资本的分配对于决定单一市场中单笔交易的风险程度非常重要。

### 7.2 Application of different MM schemes

----------

It is time to go from theory to reality and check how MM affects the results of our trading system LUXOR on the pound/dollar FOREX pair within the last 5 years. To keep things comparable we again work with 30 minute data. All computer tests in this chapter are calculated with $30 slippage and commissions per round turn.

现在是时候从理论走向现实，并检查MM在过去5年内如何影响我们的交易系统LUXOR对英镑/美元外汇对的结果。 为了保持可比性，我们再次使用30分钟数据。 本章中的所有计算机测试均以每轮30美元的滑点和佣金计算。

You have probably heard about lots of different MM approaches like Kelly formula, Optimal F, Profit Risk Method, Martingale, Anti-Martingale etc. We do not want to indulge in an overview of all these methods with their pros and cons here. Instead we will choose only a few of them which we have found useful in our experience for real applications.

您可能已经听说过许多不同的MM方法，如Kelly公式，最优F，利润风险方法，鞅，反鞅等。我们不想在这里利用它们的优点和缺点来纵容所有这些方法的概述。 相反，我们将只选择其中一些我们发现在实际应用中有用的经验。

#### Reference: The system traded with one lot

Let’s  start  with  the  result  of  the  LUXOR  trading  system  developed  in  Chapter  3, calculated with one fixed lot and a starting account equity of $100,000 (Figure 7.2). This equity curve is the simplest method of position sizing. It can be called “fixed size money management”, which means in other words that you simply choose the number of shares or lots which are used for each trade. The main purpose of this approach is to provide a good baseline for comparison with more sophisticated money management methods which we will now expound.

让我们从第3章开发的LUXOR交易系统的结果开始，用一个固定的批次计算，起始账户净值为100,000美元（图7.2）。 此权益曲线是最简单的头寸调整方法。 它可以被称为“固定规模资金管理”，换句话说，您只需选择每笔交易所使用的股票数量。 这种方法的主要目的是为我们现在阐述的更复杂的资金管理方法提供一个良好的基线。

<p align="left"><font size=2>Figure 7.2: Detailed equity curve. Traded with one fixed lot. Starting account size = $100,000. LUXOR system British pound/US dollar (FOREX), 30 minute bars, 21/10/2002-4/7/2008, with entry time filter and exits in place. Including $30 S+C per RT. An area with a recent small drawdown is encircled as a comparison for the following MM schemes. Chart created with Market System Analyzer.</font></p>

![Figure 7.2](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_7.2.png)

#### Maximum drawdown MM

This method was used and described by Larry Williams [11]. The basic idea of this MM scheme is derived from risk management: you want to be sure you have enough equity in your account to withstand the worst-case drawdown the account has had in the past. At least, you would need enough equity to cover the size of the worst-case drawdown plus the margin requirement. This means that in order to trade one lot, you would need as a bottom line the one-lot margin requirement plus the worst-case one-lot drawdown. Larry Williams recommended, in order to make his MM a bit safer, to take 150% of the worst-case drawdown plus the margin for the first lot. Each subsequent lot is then added when the equity increases by 150% of the worst-case drawdown. This should ensure that you have enough equity to avoid losing everything even if the worst-case drawdown repeats itself. Let’s see what this simple MM scheme does with our trading system (Figure 7.3).

Larry Williams [11]使用并描述了这种方法。 这个MM计划的基本思想来自风险管理：您希望确保您的账户中有足够的资产来抵御账户过去最糟糕的亏损。 至少，您需要足够的资产来弥补最坏情况下降的幅度加上保证金要求。 这意味着，为了交易一手，您需要作为底线的一手保证金要求加上最坏情况下的一手跌幅。 拉里·威廉姆斯建议，为了让他的MM更安全一点，拿掉150％的最坏情况下降加上第一手的保证金。 然后，当权益增加最坏情况下降的150％时，每个后续批次都会被添加。 这应该确保你有足够的资产，以避免失去一切，即使最坏情况缩编重演。 让我们看看这个简单的MM方案对我们的交易系统的作用（图7.3）。

<p align="left"><font size=2>Figure 7.3: 150% maximum drawdown MM by Larry Williams. Upper blue line: equity curve. Lower black area: number of traded lots. Starting account size = $100,000. Trend-following system British pound/US dollar (FOREX), 30 minute bars, 21/10/2002-4/7/2008, with entry time filter and exits in place. Including $30 S+C per RT. An area with a recent drawdown is encircled. Chart created with Market System Analyzer.</font></p>

![Figure 7.3](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_7.3.png)

Instead of $120,000 profits without money management the system can now reach a final profit of $137 million with the applied MM scheme! But be careful. First of all the high number of 15,000 lots is not realistic. If you traded that much you certainly could not keep the same back-test result as with trading one lot. Even in the very liquid currency markets, such a high trading volume would change the market and lead to worse fills. Another point is the high risk of your trading system with the increased profits. Please note that the drawdown after the equity peak of $276 million is $139 million bigger than the left profit. So the higher gains have the price of higher risks. Let’s see how other MM methods perform.

如果没有资金管理，系统现在可以通过应用MM方案获得1.37亿美元的最终利润，而不是12万美元的利润！ 不过要小心。 首先，大量的15,000手是不现实的。 如果你交易那么多，你肯定无法保持与交易一手相同的回测结果。 即使在非常流动的货币市场中，如此高的交易量也会改变市场并导致更糟糕的填充。 另一点是您的交易系统的高风险与增加的利润。 请注意，在2.76亿美元的股票高峰后的缩编比左边的利润高出1.39亿美元。 因此，较高的收益具有较高风险的代价。 让我们看看其他MM方法的表现。

#### Fixed fractional MM

Fixed fractional MM was developed by another trader and book author, Ralph Vince, at around the same time as Larry Williams’ maximum drawdown scheme [12]. Ralph Vince’s method is also known as fixed risk position sizing because it risks the same percentage or fraction of the account equity on each trade. For example, with an account value of $10,000 a fixed fractional MM of 2% means that you want to risk a maximum of $200 per transaction.

固定的分数MM是由另一位交易员和书籍作者拉尔夫·文斯（Ralph Vince）在与拉里·威廉姆斯（Larry Williams）的最大缩编计划[12]同时开发的。 拉尔夫文斯的方法也被称为固定风险头寸规模，因为它在每笔交易中承担相同比例或部分的账户资产。 例如，如果帐户价值为10,000美元，则固定小数MM为2％意味着您希望每笔交易最多冒险200美元。

But how do you set this risk of $200 in real trading? Let’s check what this means with the example of our trading system and the pound/dollar. To answer this question we must go  back  to  our  previous  findings,  the  strong  interaction  between  risk  and  money management, and to Chapter 3 where we looked for exits.

但是，如何在实际交易中设置200美元的风险呢？ 让我们用我们的交易系统和英镑/美元的例子来检查这意味着什么。 要回答这个问题，我们必须回到我们之前的研究结果，风险和资金管理之间的强烈相互作用，以及我们寻找退出的第3章。

We found an optimal stop loss value of 0.3% for the pound/dollar. With the pound/dollar trading at $2.00 the 0.3% stop loss would mean a risk of $600 for one lot (0.3% x $2.00 x 100,000) and this approach has not yet taken into account the slippage and the fact that even in the back-test the biggest loss was much bigger ($810). So obviously there is a dilemma. You cannot trade the pound/dollar currency pair with a $10,000 account equity with that 0.3% initial stop loss and a risk of 2%. The way out is to make changes to your money management or your risk management. You have to choose one of the following two possibilities:
1. Change of risk management: you set a tighter stop to lower your risk per trade.
2. Change of money management: you increase the account equity or you increase the risk.

我们发现英镑/美元的最佳止损价值为0.3％。 当英镑/美元交易价格为2.00美元时，0.3％的止损将意味着一手的风险为600美元（0.3％x 2.00 x 100,000），这种方法尚未考虑到滑点和即使在后面的事实 - 测试最大的损失要大得多（810美元）。 显然存在两难问题。 您不能将英镑/美元货币对与10,000美元的账户净值进行交易，其初始止损为0.3％，风险为2％。 出路是改变您的资金管理或风险管理。 您必须选择以下两种可能之一：
1.风险管理的变化：您设置更严格的止损以降低每笔交易的风险。
2.资金管理变更：您增加账户资产或增加风险。

There is a possibility that option 1 directly affects the trading logic. From all our findings about stops and profit targets we know that the trading system performance suffers with stops that are too tight. From the discussion in Chapter 3 you have seen that trades need enough room to develop. Tight stops remove this room and can turn a profitable strategy into a losing strategy. Since we do not want to change this risk management it means we must change our money management (possibility 2) and set the initial account value higher. Doing this is much easier to calculate but means in practice that you must have enough funds available. That’s one reason why single traders very seldom use MM schemes and why bigger funds are more successful in the long run.

选项1有可能直接影响交易逻辑。 从我们关于止损和利润目标的所有发现中，我们都知道交易系统的表现受到了过于紧张的止损。 从第3章的讨论中可以看出，交易需要有足够的发展空间。 紧急停止移除这个房间，可以将盈利的策略变成失败的策略。 由于我们不想改变这种风险管理，这意味着我们必须改变我们的资金管理（可能性2）并将初始账户价值设置得更高。 这样做更容易计算，但在实践中意味着您必须有足够的资金。 这就是为什么单个交易者很少使用MM方案以及为什么更大的基金从长远来看更为成功的原因之一。

Let’s calculate how much should be the minimum account. We want to risk 2% of our account with the next transaction. Since our risk with one lot is chosen by the preset stop loss of the trading system ($600), this means that the account must be at least $30,000, when trading one lot at this risk ($600 is 2% of $30,000). We take double this value to be sure not to conflict with our risk settings. So we trade one lot with $60,000. With a starting account value of $100,000 this means that one lot is allowed per transaction until the account value has reached $120,000 (= 2 x $60,000). The third lot can be traded when the account reaches $180,000 and so on. Please note that when the account equity decreases, the number of traded lots also has to be lowered accordingly. The result of this MM is shown in Figure 7.4A. You see that while the equity curve (blue line) is growing, more lots can be added (lower black area), until the highest account value of $790,000, reached in May 2008, when 14 lots are traded. When trading with so many lots the trading system comes into a drawdown phase (red encircled) which then leads to a bigger drawdown. Please note how this drawdown phase is huge compared with the original trading system traded with one fixed lot since now the drawdown is amplified by the 14 lots.

让我们计算最低帐户应该是多少。我们希望在下一笔交易中承担2％的账户风险。由于我们通过交易系统的预设止损（600美元）选择一手的风险，这意味着当以一定风险交易一手（600美元是30,000美元的2％）时，该账户必须至少为30,000美元。我们将此值加倍，以确保不会与我们的风险设置发生冲突。所以我们以60,000美元交易一手。起始帐户值为100,000美元，这意味着每个交易允许一个批次，直到帐户价值达到$ 120,000（= 2 x $ 60,000）。当账户达到180,000美元时，第三批可以交易，依此类推。请注意，当账户净值减少时，交易手数也必须相应降低。该MM的结果如图7.4A所示。您可以看到，当权益曲线（蓝线）增长时，可以添加更多手数（较低的黑色区域），直到2008年5月达到最高账户价值790,000美元时，交易14手。当交易这么多手数时，交易系统进入亏损阶段（红色环绕），然后导致更大的缩减。请注意这个缩编阶段与原始交易系统相比是如何与一个固定手数交易相比，因为现在缩减被14个批次放大。

It is worth finding out what happens when we increase the risk per transaction more and more, to 5%, 10% then even to 30% (Figures 7.4B-D). As you can see the biggest equity point reached in May 2008 gets dramatically higher and higher. Whereas the fixed fractional MM with 2% risk reaches a biggest equity peak of $790,000, the MM with 5% risk reaches over $22 million, the MM with 10% reaches $981 million and the MM with 30% risk reaches over $6 billion!

值得一提的是，当我们将每笔交易的风险越来越高，达到5％，10％，甚至达到30％时，会发生什么（图7.4B-D）。 正如您所看到的，2008年5月达到的最大公平点变得越来越高。 风险为2％的固定分数MM达到790,000美元的最大股票峰值，风险为5％的MM超过2200万美元，10％的MM达到9.81亿美元，风险为30％的MM达到60亿美元以上！

But as you know, “trees do not grow to the sky” and the high profits have a high price. With the 30% fixed fractional MM finally “only” $538 million is left from the $6 billion reached before. So the suffered drawdown from the equity peak of over $6 billion was ten times higher than the final profit! The more aggressive the MM that is chosen, the higher the equity peak, but the bigger the drawdown which the equity curve suffers thereafter. The fixed fractional MM scheme works like an amplifier of the gains but also of the losses. You see again from this simple example, as with the above shown maximum drawdown MM, that although an aggressive MM seems to be attractive at the first glance because it promises big profits, the risks behind it quickly become too high.

但正如你所知，“树木不会长到天空”，高利润的代价很高。 随着30％的固定分数MM最终“仅”将从之前达到的60亿美元中留下5.38亿美元。 因此，超过60亿美元的股票峰值遭受的损失是最终利润的十倍！ 选择的MM越激进，股票峰值越高，但此后股票曲线遭受的跌幅越大。 固定分数MM方案的作用类似于增益的放大器，但也包括损耗的放大器。 你从这个简单的例子中再次看到，就像上面显示的最大缩幅MM一样，尽管咄咄逼人的MM乍一看似乎很有吸引力，因为它承诺了巨大的利润，但它背后的风险很快就会变得过高。

<p align="left"><font size=2>Figure 7.4: Applying fixed fractional MM. The aggressiveness of the MM is increased from 2%, 5%, 10% up to 30%. Upper blue line: equity curve. Lower black area: number of traded lots. Starting account size = $100,000. Trend-following system British pound/US dollar (FOREX), 30 minute bars, 21/10/2002-4/7/2008, with entry time filter and exits in place. Including $30 S+C per RT. An area with a recent drawdown is encircled. Charts created with Market System Analyzer.</font></p>

![Figure 7.4](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_7.4.png)

So let’s see if there are more conservative methods out there.
那么让我们看看是否有更保守的方法。

#### Fixed ratio MM

Fixed ratio MM was first introduced by Ryan Jones in his book The Trading Game in 1999 [13]. In the fixed ratio position sizing the key parameter is the so called “delta”. This delta is the dollar amount of profit per traded unit to increase the number of units by one. A delta of $10,000 means that if you’re currently trading one lot you would need to increase your account equity by $10,000 to start trading two lots. Once you get to two lots, you would need an additional profit of $20,000 to start trading three lots. Then, trading with three lots, you would need an additional profit of $30,000 to start trading four lots and so on. The base to calculate the number of traded lots in fixed ratio position sizing is the following equation:

$N = 0.5 * [((2 * N_0 – 1)^2 + 8 * P/delta)^{0.5} + 1]$

固定比率MM由Ryan Jones在其1999年的“交易游戏”一书中首次引入[13]。 在固定比率位置，调整关键参数是所谓的“delta”。 这个增量是每个交易单位的美元利润额，以便将单位数增加一个。 10,000美元的差值意味着如果您目前正在交易一手，您需要增加10,000美元的账户资产才能开始交易两手。 一旦你获得两个批次，你需要额外的20,000美元的利润才能开始交易三手。 然后，交易三手，您需要额外的30,000美元的利润才能开始交易四手，等等。 计算固定比率位置大小的交易手数的基数如下：

N is the traded position size, N0 is the starting position size, P is the total closed trade profit, and delta is the parameter discussed above. As the mathematicians know x0.5 means “square root of x”.

N是交易头寸大小，N0是起始头寸大小，P是总封闭交易利润，delta是上面讨论的参数。 正如数学家所知，x0.5的意思是“x的平方根”。

A few points are worth mentioning. The profit P is the accumulated profit over all trades leading  up  to  the  one  for  which  you  want  to  calculate  the  number  of  lots.  As  a consequence the position size for the first trade is always N0 because you start with zero profits (P = 0). Please note that the account equity is not a factor in this equation, so changing the starting account size will not change the number of traded lots. Neither is the trade risk a factor in this equation – if trade risks are defined for the current sequence of trades, they will be ignored when fixed ratio position sizing is in effect. All that matters is the accumulated profit and the delta. The delta determines how quickly the lots are added or subtracted.

有几点值得一提。 利润P是所有交易的累计利润，直至您想要计算的手数。 因此，第一笔交易的头寸规模始终为N0，因为您从零利润开始（P = 0）。 请注意，账户净值不是此等式中的一个因素，因此更改起始账户大小不会改变交易手数。 贸易风险也不是这个等式中的一个因素 - 如果贸易风险是针对当前的交易顺序定义的，那么当固定比率头寸规模生效时，它们将被忽略。 重要的是累计利润和增量。 增量确定添加或减少批次的速度。

Ryan Jones’ position sizing rule leads to a MM scheme which is a bit more conservative than the fixed fractional MM by Ralph Vince which was shown above. You can simply compare the two MM schemes as following (Figure 7.5):
Ralph Vince, fixed fractional lots = constant * account-size
Ryan Jones, fixed ratio lots = constant * squareroot(account-size)

Ryan Jones的位置大小规则导致MM方案比Ralph Vince的固定小数MM更保守，如上所示。 您可以简单地将两种MM方案进行比较，如下所示（图7.5）：
Ralph Vince，固定小数手数=常数*账户大小
Ryan Jones，固定比率很多=常数* squareroot（账户大小）

So in contrast to the above situation with fixed fractional MM where the number of traded lots is linearly increased with the account size, with the fixed ratio MM the number of lots is increased like a square root function. This MM type is a bit more agressive in the beginning, but becomes more conservative and slower with more gained trading capital.

因此，与具有固定分数MM的上述情况相反，其中交易批次的数量随账户大小线性增加，在固定比率MM中，批次数量增加，如平方根函数。 这种MM类型在开始时有点激进，但随着更多的交易资本获得更加保守和缓慢。

<p align="left"><font size=2>Figure 7.5: Fixed Ratio vs. Fixed Fractional MM. As trading capital increases, the fixed ratio MM increases the number of lots more slowly, with a square root function, than the fixed fractional MM, which works linearly.</font></p>

![Figure 7.5](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_7.5.png)

To see how fixed ratio MM works let’s start with a delta of $100,000. This means that you can add the second lot only after your account value has increased by another $100,000 to $200,000 (Figure 7.6A). Obviously this MM is very slow and not much different from just trading one lot all the time so let’s make it a bit more aggressive. (Figures 7.6B and C).

要了解固定比率MM如何运作，让我们从100,000美元的增量开始。 这意味着只有在您的帐户价值再增加100,000美元到200,000美元后才能添加第二批（图7.6A）。 显然这个MM非常慢，并且与一直交易一个批次没什么不同所以让我们让它更具侵略性。 （图7.6B和C）。

<p align="left"><font size=2>Figure 7.6: Applying fixed ratio MM. The aggressiveness of the MM is increased from A to C. Upper blue line: equity curve. Lower black area: number of traded lots. Starting account size = $100,000. LUXOR system on British pound/US dollar (FOREX), 30 minute bars, 21/10/2002-4/7/2008, with entry time filter and exits in place. Including $30 S+C per RT. An area with a recent drawdown is encircled. Chart created with Market System Analyzer.</font></p>

![Figure 7.6](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_7.6.png)

As with the fixed fractional MM the more aggressively you increase the lot size, the higher equity peaks you can reach, but also the bigger drawdowns you get in phases where the trading system shows some weakness. Compared with the fixed fractional MM the fixed ratio MM shows a better return/risk ratio as you can see when you have a closer look on the delta=$500 fixed ratio MM (Figure 7.6C). There you see that the equity high is $11.5 million and the drawdown is about $1.8 million. Although the drawdown is still excessive,  the  return/drawdown  ratio  is,  with  6.4  in  this  example,  better  than  the comparable 5% fixed fractional MM where you have an equity peak of $22 million but then a drawdown of $8 million leading to a return/drawdown ratio of 2.8.

与固定分数MM一样，您可以更积极地增加手数，可以达到更高的股票峰值，但也可以在交易系统显示出一些弱点的阶段获得更大的下降。 与固定分数MM相比，固定比率MM显示更好的回报/风险比，您可以看到当您仔细观察delta = $ 500固定比率MM时（图7.6C）。 在那里你看到股票高点是1150万美元，而缩编是大约180万美元。 尽管亏损仍然过大，但回报/缩编比率（在本例中为6.4）优于可比较的5％固定分数MM，其中您的股票峰值为2200万美元，但随后是800万美元的缩减导致回报/ 缩编比为2.8。

### 7.3 Monte Carlo analysis of the position sized system

----------

Position sizing increases your profits. But with the profits the risks also become higher. To get a better idea of how big the risks become we do a Monte Carlo analysis of the LUXOR system after position sizing and compare its results with the situation when no MM is applied (Table 7.1).

头寸调整可以增加您的利润。 但随着利润的增加，风险也会变得更高。 为了更好地了解风险的大小，我们对位置大小后的LUXOR系统进行蒙特卡罗分析，并将其结果与未应用MM的情况进行比较（表7.1）。

<p align="left"><font size=2>Table. 7.1: System figures without (green) and with money management (yellow). LUXOR system on British pound/US dollar (FOREX), 30 minute bars, 21/10/2002-4/7/2008, with entry time filter and exits in place. Including $30 S+C per RT.</font></p>

![Table 7.1](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Table_7.1.png)

This table shows that the $5000 fixed ratio MM trades up to 27 lots simultaneously. This MM leads to a total net profit of over $1.5 million, compared to the $132,000 when trading one fixed lot. The price for the higher gain is higher risk. The MM increases the largest losing trade to $15,418 (from $810) and the maximum drawdown to $229,560 (from $10,292). The Monte Carlo analysis reveals that the worst case drawdown which can happen with 1% probability (since with 99% it is avoided) is now $446,064 (from $21,364).

该表显示5000美元的固定比率MM同时交易多达27手。 这个MM的净利润总额超过150万美元，相比之下，交易一个固定手数时的净利润为132,000美元。 更高收益的价格是更高的风险。 MM将最大亏损交易增加至15,418美元（从810美元起），最大亏损额为229,560美元（从10,292美元起）。 蒙特卡洛分析显示，最坏情况下的跌幅可能以1％的概率发生（因为避免了99％）现在是446,064美元（从21,364美元起）。

### 7.4 Conclusion

----------

The type of MM to select depends on the risks which you are prone to take. MM works like an amplifier of your trading logic, independently of which method you chose for position sizing. If it is properly adjusted then it will increase the profits of your trading system, but never forget that the risks are increased too – even with the best MM. In order to increase profits and at the same time keep the risk low it is advantageous to combine different systems and markets. You will find some ideas about this topic in the following chapter.

要选择的MM类型取决于您倾向于采取的风险。 MM的工作方式类似于交易逻辑的放大器，与您选择的头寸选择方法无关。 如果它被适当调整，那么它将增加您的交易系统的利润，但永远不会忘记风险也增加 - 即使有最好的MM。 为了增加利润并同时保持低风险，将不同的系统和市场结合起来是有利的。 您将在下一章中找到有关此主题的一些想法。

# Part III: Systematic Portfolio Trading

## Chapter 8: Dynamic portfolio construction

So far this book has shown methods to develop, test and evaluate single trading systems. This final section deals with the question of how to combine different trading systems and markets to construct a portfolio.

到目前为止，本书已经展示了开发，测试和评估单一交易系统的方法。 最后一节讨论如何将不同的交易系统和市场结合起来构建投资组合的问题。

The topic is too large to provide a complete overview in this book, but in Chapter 8 and the appendix we have provided some practical tips from our own experience.

该主题太大，无法在本书中提供完整的概述，但在第8章和附录中，我们从我们自己的经验中提供了一些实用的技巧。

### 8.1 Introduction to portfolio construction

----------

Even if many traders are aware of the notion that trading a portfolio of multiple systems on the same asset, or the same system on multiple assets, or both, smooths the overall equity line, few traders test and optimise a system with this perspective in mind. One motive for this in the past may have been that the most common technical analysis packages did not allow traders to produce a portfolio equity line easily. Nowadays things have changed and many software houses offer products that allow traders to test a multimarket multi-systems portfolio.

即使许多交易者意识到在同一资产上交易多个系统的投资组合，或在多个资产上交易多个系统的组合，或两者兼而有之，这样可以平滑整体股权线，很少有交易者考虑到这一观点来测试和优化系统。。 过去的一个动机可能是，最常见的技术分析包不允许交易者轻松地创建投资组合股权线。 如今，情况发生了变化，许多软件公司都提供允许交易者测试多市场多系统产品组合的产品。

#### A list of the main available software

Market System Analyzer (www.adaptrade.com)

This is cheap and smart software that for as little as $349 can do whatever you need in the way of portfolio testing. It allows you to import system report data from TradeStation in Excel format, even if you need to do it for every single stock or future in the portfolio, (and this is quite time-demanding.) It performs equity line crossovers, Monte Carlo analysis, trade dependency and portfolio analysis.

MultiChart (www.tssupport.com)

This is a product that costs $1497 for a lifetime licence. It has a huge choice among different data feeds and it is Easy Language compatible.  It can perform different optimisation and back-testing tests over a portfolio.

Mechanica (www.mechanicasoftware.com)

The former Trading Recipes has been updated and, after reshaping, has taken this new name. It has a standard edition that costs $3000 and a Professional Edition that costs $25,000. An upgrade from the old Trading Recipes costs $900.

RINA Systems (www.rinasystems.com)

This was the main portfolio software provider compatible with TradeStation for a long time. Portfolio Maestro (www.rinafinancial.com) is the flagship of Rina Systems and costs $10,000 per year. Portfolio Evaluator ($1295) is the first step in portfolio building for TradeStation users and in order to build a portfolio you simply need to shoot your system report into the Portfolio Evaluator platforms by pushing on the blue button in the TradeStation system report. Then you can build the portfolio by sticking together all the individual  system  reports.  Portfolio  Stream  ($4995  individual  purchase,  $9995 professional purchase) does a lot more than Portfolio Evaluator, such as Monte Carlo analysis and walk forward analysis.

#### The role of correlations

Even though there are dozens of portfolio-building software programs available, the inclination to consider a single equity is still deeply rooted among traders. Nothing could be more wrong: with all the trading systems’ intricacies set aside, a mediocre system optimised on a bunch of assets will be likely to produce a reasonable portfolio equity line. This should always be kept in mind when you scan different assets’ prices with a newly-built trading system because what you are doing makes no sense if not included in a multi-market perspective. This is why we believe that approaching quantitative trading with a focus on a portfolio of assets, should they be stocks, futures, mutual funds or any other instrument, is a key element in surviving in the long run.

Today there is a deep flaw in the difference between what commonly-accepted financial theory predicates about portfolio construction, and what you can do with an average technical analysis software in practice.

Modern portfolio theory is built on the premise that in order to build an efficient portfolio you need to consider the correlations among the different assets. The more uncorrelated the assets the more efficient the portfolio, because if a position is losing, another position on a diverse asset will make money, dampening the overall effect on the portfolio equity line. The backbone of modern portfolio theory relies on the assumption that you cannot forecast the markets so that a systematic trader, who believes exactly the opposite, becomes confused on how to approach the topic.

Correlation is indeed a pivotal question for a systematic trader because if, for example, you are using the same system on different markets and this system is trend-following, it is clear in order to have two different positions – one losing and the other winning – you need to have some markets that trend and other markets that stay choppy (a situation that often occurs). But let’s assume that you are trading multiple assets with two different systems, one trend-following and the other counter-trend. In this case you do not need all markets to be trending to have an upward sloping portfolio equity line. Some markets can trend and others can zig-zag with no definitive trend, and notwithstanding the overall portfolio will be profitable.

Let’s move the reasoning a step ahead: let’s assume that we have both trend-following systems (prone to exploit trending markets) and counter-trend systems (prone to exploit choppy markets) applied over the same markets. How does correlation fit into this picture? It seems that a sane reply would be simply that when it boils down to building a real portfolio with real trading systems the complex traditional theory totters and it shows how difficult it is to move from a pure theoretical world to the everyday life of a systematic trader.

Another critique of a portfolio approach based on correlation among assets is that correlation is not a stationary measure of the relative behaviour of two different assets. By stationary we mean that a form of correlation is not bound to last forever, economics change correlations among assets, so that presuming that in one year’s time correlation will be the same as today could be fatal. Let’s take the example of oil: economies were much more dependent on oil during the 1973-74 and 1979 shocks than during the 2008 bubble. So inflation perspectives during the 2008 bubble were much less imperative then 30 years earlier because Western economies were much less dependent on oil. The unfixed character of correlations is a controversial area that theoretical portfolio construction seems not to consider in an appropriate way.

#### Publications and theoretical tools

Among  academic  papers  there  is  a  shortage  of  good  publications  about  portfolio construction with an algorithmic approach. One author that tried to fight against this situation is Thomas Stridsman. He wrote two inspiring books, Trading Systems That Work and Trading Systems and Money Management, where even without arriving at a final conclusion he tried to address all the relevant topics of portfolio construction properly. The rest of the technical literature on trading systems is almost silent on this approach. So, at this point it is impossible to go ahead with the sure support of an authoritative author and we need to navigate in uncharted waters.

Traders are often accused of being brutal and unfortunately we belong to this category. This is why our approach to portfolio construction is based on a practical approach that starts from a simple consideration: a trader, even a sophisticated one, should always be in  control  of  what  he  does. We  often  meet  professional  traders,  both  private  and institutional, that employ theoretical tools they do not fully understand or that they do not properly dominate. This is harmful when you come to real trading because markets are merciless. A trader, when using a trading system, needs to have total control of all its nuances. To employ complicated tools that require much time to be explored and understood is out of the reach of an average trader and portfolio manager. Time is short, markets are running all day long and you need to have a quick grasp of what to do without delving into complicated statistical problems.

#### Portfolio trading in practice

A sound approach to portfolio trading is something that is based on sound and prudent premises. Better, on sceptical premises. Scepticism in quantitative trading is the best rule you can apply since it lowers risk. It is hard to have doubts about everything but if you get accustomed to it you will arrive at the conclusion that there are just a few tenets that are really safe for a trader. We will now review some hard-earned lessons we have gained through experience:

The more the better

It would be unwise to dictate rules for the trading systems development field that should be abided only by traders who have huge programming and statistical skills or simply by professional traders that are backed by a powerful IT department. If you do not know how to make money in a discretionary way, every moderately good trading system (even a properly tested moving average crossover system) will be a better solution than merely following your gut feeling. Sometimes it can seem that to be a successful system trader you need to be a rocket scientist, though this is not the case at all. If you do not know how to make money in a discretionary way, whichever sound trading system you use will allow you to have an edge against the market.

It is useless to wonder if it is better to use a simple profitable moving average crossover system carefully optimised on a portfolio or a complex breakout and counter-trend system optimised with a detailed walk forward analysis if you are only able to have the first one. You can only trade with the tools and systems available to you and not with the tools and systems you would have in an ideal world. Time is money and sometimes it could be more rewarding to trade with a simple system rather than spending years developing a more complex system that is beyond your reach. A situation that often recurs in this business  is  the  very  sophisticated  would-be  trader  that  decade  after  decade  keeps improving his system without ever applying it with real money, since it was not yet accomplished. Perfectionism is not a good quality in trading systems’ development.

A price series is a price series and nothing more than a price series

A trading system should produce good results on a price series and not forcedly on a precise number of other price series. Thomas Stridsman argues that he usually tests a system over 30-60 markets along 20 years and he wants it to perform moderately well on at least two-thirds of all markets (see [1]). We think that this is a sophisticated approach and we agree with it, but we have encountered only a few trading systems that were successful on all markets. In many cases systems usually work with the same efficiency on futures that belong to the same category: bonds, currencies, stock indexes, cereals, etc. As stated above, there is not a clear recipe for success and you can only trade with the systems you have at your disposal today. If your systems work on all the markets you will trade on all the markets, but if they just work on three different markets they should not be discarded just for this reason.

We know what happened today but we have no means of knowing what will happen tomorrow

Cancel every “estimate” from your dictionary when you build a trading systems’ portfolio. There are some authors that claim that you need to figure out your “estimated portfolio return  and  variance”  in  order  to  decide  money  management,  systems  and  markets selection. This is the wrong approach because the very reason we are using trading systems is because we do not know how to predict the future and neither the expected average returns and variance can be estimated.

If we limit risks, profits will take care of themselves

We cannot control the profit of a position which we entered without the support of an estimate. What we control is the risk; that is the difference between the entry price and the stop loss. This is what we need to analyse in order to protect our capital.

This is a defensive approach to systematic portfolio trading and it must be clear that it does not exclude, once properly researched, other portfolio composition methodologies. As should be clear from the book, a trader should assess all the trading methodologies and tools the industry provides, but it is always prudent to apply only those methodologies that he can fully control and understand. The four points above are a kind of bottom line in systematic portfolio trading.

In the literature about trading systems there are really few ideas on how to compose a portfolio; that is, which markets to trade and which systems to apply to which markets. Usually in our business, where there is a lack of information about a specific topic it means that some gold nuggets are hidden somewhere. Portfolio composition is one such area that for years has not been able to overcome some useless ideas such as the Wilder’s Commodity Selection Index or other more sophisticated approaches full of estimates, the origins of which nobody knows.

Let’s look at some practical ways to build a systems portfolio. These approaches are real ones and have been applied either by us or by the best trading systems developers we have met in the last decade. We will not delve into the intricacies of each one because this would take us too far away from our path. Whichever method you decide upon, please test it carefully before trading. In this chapter we will pinpoint some hints about pros and cons you will encounter with every portfolio construction method.

Unfortunately we do not have a definite word about this subject: we believe that portfolio composition method can often depend on which systems you are adopting, and over all it will be affected by whether you are trading many markets with the same systems, many markets with many systems or one market with many systems.

#### Total vs. partial equity contribution

Once the system is tested against a basket of stocks and futures, and results are moderately positive on almost all the markets, the pivotal question will be whether to trade all the markets or to trade just those instruments where the system was best performing and discard the others. If you just follow this path, you will surely have the best historical equity line you ever saw, but you will probably go bust after a few trades. The common tenet here is that you need to trade all the markets because you do not know what will happen tomorrow. The futures that were the best performing could become choppy or the underperforming futures could become volatile and it may be easier to make money on them. Obviously there is no way for you to pretend you know which futures will be volatile tomorrow. Everybody would agree with this tenet. But before sticking to it without discrimination it is better we understand that it relies on some basic premises.

The first premise is that it assumes we just have a unique trend-following system or we just have a unique counter-trend system but not both of them. Only with one of these systems would we be worried if the market becomes respectively too choppy or too trendy. The second premise is that we need to apply the same system to all the same markets and not, for example, a counter-trend system to a traditionally choppy market and a trend-following system to a traditionally volatile market. If instead of having a single system to trade all the markets we have two different systems to trade all the markets this is surely a step ahead. We remind readers of our number 1 principle: the more the better. To arrive at a unique conclusion without specifying how many systems we have is impossible because we still need to make clear what the starting point is. If you just have a trend-following trading system it will be prudent to trade all the markets because you are not able to know in advance which market will trend and which market will be in congestion. If you have a trend-following system and a counter-trend system you can prudently trade all the markets or even apply the trend following system to the traditionally volatile markets and the counter trend to the traditionally choppy markets. This second solution is obviously more hazardous than the first but there are additional tools that can lower the risk.

Partial equity contribution

Another solution would be to test the systems on all the markets and then choose a fixed fraction of the best performing markets according to the broad category to which they belong: cereals, energies, currencies, stock indexes, bonds, etc. This portfolio is a kind of compromise between the total contribution and the all markets choice and it is neither too aggressive nor too defensive. This method could be the “golden middle”.

### 8.2 Correlation among equity lines

----------

As we have seen, this is one of the sacred topics of portfolio trading: look for those markets that are negatively correlated and trade them. In this way you can smooth the resulting portfolio equity line. The premise of this approach is always that you need to have the same system, set with the same inputs, on all the markets. If you trade a trendfollowing system and a counter-trend system the logic would require you to trade the same market in order to be sure that, whether it is trendy or choppy, you have a tool at your disposal that will fit the market situation and will make more money than the other one you trade. But there is a lot more in store for this approach. Nobody understands why you should check correlations on the price series instead of on the equity line itself. If you are a systematic trade  you will not build your portfolio considering  the  price correlation among the assets, but you will only watch the equity lines and the correlations among them. If equity lines are growing it means that the systems are suitable to trade that market, if they are decreasing you would be better off to stop them.

Correlation among assets varies according to the economic situation. These changes take a lot of time to shape but once they take root they go ahead for years. So there is no reason not to exploit them. What we believe is that equity lines are the most suitable indicators for checking correlations among systems and among markets. More precisely when we quote equity lines, ‘we want to measure the inter-correlations of daily equity changes among  the  different  market  systems’  [12].  Price  series  themselves  would  be  more important in terms of correlation if we were to manage assets using just fundamental analysis – their role in this case would be paramount in terms of asset allocation. It is not by accident that Portfolio Evaluator and Portfolio Maestro, the two flagship products of RINA Systems6, use a correlation matrix based on monthly equity lines to calculate correlations among the different markets, and this is also the same for Market System Analyzer7. As far as we are concerned we would advocate the use of a shorter measure of correlation in order to minimise drawdown (weekly correlation or some form of averaging and smoothing of daily correlation). In our experience it is very difficult to find negative correlations among futures’ monthly equity lines and even a negative correlation coefficient that amounts to -0.2 is really interesting in order to lower the portfolio drawdown (Figure 8.1).

<p align="left"><font size=2>Figure 8.1: Matrix of linear correlations among monthly equity lines of one of our portfolios traded with real money.</font></p>

![Figure 8.1](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_8.1.png)

As you can see there is no negative correlation lower than -0.30. By the way, this is a portfolio multimarket multisystem dating to May 2008. The average starting period is 2001-2002 when electronic markets were launched, but many trading systems – on FGBL (German Bund Futures) for example – are much older. The more uncorrelated asset seems to be the 10 years Treasury Bill (TY) which has a negative correlation with at least 7 other equity lines out of 14 (50% of the markets). The second most uncorrelated are GC (Gold) and JY (Japanese Yen). The most correlated asset is Wheat which has no negative correlation with any other. In second place, Eurodollar (EC), Swiss Franc (SF) and Soybean Meal (SM) have a negative correlation just one market out of 14.

The most common way to compose a portfolio with a matrix of correlation among equity lines is to attach more weight to those price series that are uncorrelated with the others in order to smooth the portfolio equity line. In the example of Figure 8.1 Eurodollar, Swiss Franc and Soybean Meal would be the price series with the lowest number of contracts to be traded while Gold and Treasury Bills should be weighed more than any other asset.

### 8.3 A dynamic approach: equity line crossover

----------

Every trader is haunted by the obsession of the possible failure of the systems he is trading. This is the psychological burden systematic traders need to withstand in order to achieve success. A common way to gauge a system’s failure is drawdown or a multiple of the drawdown. We believe that, even if the drawdown figure is important, it is not the key element in evaluating the performances of a trading system. If you do not pretend that subsequent trades are dependent on preceding ones, drawdown is just one of the possible sequences of losing trades a system can encounter. Moreover, drawdown is the direct misfortune a trader can encounter in his job, not something that he could enjoy, and it would be inappropriate to use drawdown, or even worse a multiple of it, as a final threshold before stopping a system.

So the idea is why not use a dynamic approach that indicates to the trader when the system starts faltering? And over all why not adopt a general objective approach that indicates not only which systems are stopped because they are out of synchronisation with the market but also which ones to activate because they start to be in synchronisation with the market? What we would like is to set criteria for discarding a system when it starts to lose money but also criteria for activating a dormant system when it fits the current market conditions. So the idea is to trade a system when the equity line crosses over the 15-30 period moving average of the equity line itself and stop trading with a system when the opposite is true (Figure 8.2). The same crossover rule could also be applied to the whole portfolio of systems as a second security measure after being applied to the single system. In this case it would be proper to distinguish between a portfolio of daily systems (it would not be advisable to exit a trade on a daily trading system simply because the portfolio equity line dropped below its average) and a portfolio of intraday trading systems.


In our experience it is not a sure thing that this equity line crossover approach will work equally well on all systems and all markets. If the system is a good one, if it does not have too many rules and if it is properly optimised and equally properly re-optimised at periodic intervals, it is likely that the equity line crossover approach will never encounter a downward crossover. So if the system is too good, applying this approach will never improve the overall system results. However, applying the equity line crossover to the whole portfolio of systems with a whole portfolio equity line is a tool that can help the trader prevent the nightmare of the “black swan” when everything goes wrong.

Usually the equity line crossover is a dynamic tool that reduces the risk more effectively than the use of the simple drawdown. Moreover, the simple drawdown rule or a multiple of it has no corresponding contrary rule to activate a “dormant” system, whereas our proposed security rule can give this indication.

<p align="left"><font size=2>Figure 8.2: The blue line is the 30-period moving average and the red line is the 1-period equity line. At point A there was a down crossover and trading was stopped. At point B there was an upward crossover and trading was resumed.</font></p>

![Figure 8.2](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_8.2.png)

### 8.4 Dynamic portfolio composition: the walk forward analysis activator

----------

This is a brand new approach. It was developed by Fabrizio Bocca and Cristiano Raco, two brilliant Italian systematic traders, and has not been disclosed so far. Let’s look at an example on an intraday trading system which is put under periodic optimisation every 3-months  inside  a  process  of  walk  forward  analysis.  If  during  the  3  month  periodic re-optimisation the system has a walk forward efficiency ratio of more than 50% then it is traded in real time and conversely if the walk forward efficiency ratio goes under 50% then the system is momentarily stopped. In this way we can decide which trading systems in our trading systems’ farm are to be applied and which ones are to be suspended. Fabrizio Bocca classifies all his systems in relation to the walk forward ratio every 3 months and then he allocates his trading capital to those systems that have the highest rank.

<p align="left"><font size=2>Figure 8.3: this is an example on how Fabrizio Bocca and Cristiano Raco rank their trading systems’ farm though WFA. On the right corner there is a column denominated RCD where the WFA results are condensed in a comprehensive index. If the index is positive the trading system is traded with real money, if it is negative (zero in the column) is it deactivated.</font></p>

![Figure 8.3](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_8.3.png)

### 8.5 Largest losing trade/largest losing streak/largest drawdown

----------

Another way to compose a portfolio of different markets and systems would be to normalise risk by the largest losing trade or drawdown. This is one of the most popular approaches. In this way the system with the highest losing trade, largest losing streak or largest losing drawdown will have the lowest number of contracts allotted to it and conversely the system with the smallest losing trade, losing streak or losing drawdown will have the highest number of contracts allotted. Obviously the loss figures on which this method is based make sense only if you do not consider WFA, otherwise these loss figures will vary with every WFA you periodically make. Moreover if you adopt this approach with largest losing streak or largest losing drawdown then you must believe that trade dependency has some value since otherwise it would be difficult to believe that the trade sequence will repeat itself in the future exactly as it did in the past. If the trade sequence varies drawdown will also vary. As for the use of the largest losing trade, you need to consider that a theoretical test will never encompass mistakes and slippages and in our experience these are the best candidates to be the largest losing trades. In any case, the largest losing trade, being precisely just one trade, has a low statistical significance but many traders use it because it is easy to grasp and apply. We have nothing against it, but – as with everything – it should be regarded with caution and the drawbacks it entails should be kept in mind.

### Conclusion

The trading system’s code: is this the pivotal issue in quantitative trading? We believe that  programming  is  just one of the many factors involved in trading systems development. The proof of this statement comes from experience on the field: in 15 years we have seen many successful systematic traders but in only a few instances were they professional  programmers.  So  where  was  the  edge?  We  believe  the  edge  was  in understanding how and when to apply a system and understanding when to stop it. No system  is  forever.  Markets  change,  traders  change,  systems  change.  Nothing  is everlasting. Success is easy to reach with a code and a limited period, but really rare over 10 or 20 years. So if you think that systematic trading is a job for life please do not overrate the importance of programming skill.

Let’s make a comparison with a lawyer: is the knowledge of law important for a lawyer? Of course it is. But also social relations, character and the family background are equally important. If you are a lawyer and you know the law perfectly, but you run your business in a little town, you will seldom become involved with a nationwide criminal case that will project you into the stratosphere. If your social environment is comprised of little shop-keepers and retired persons you will care about minor civil suits. If you play golf in New York with famous bankers and financial directors it is likely that you will care more about high-profile cases. The same applies with trading system development: it is important to have some basic programming capability but if you want to be successful a lot of other skills are required such as networking with other systematic traders, following publications and seminars on the topic, purchasing and trying new software and attending scientific meetings and the conferences of professional organisations, like those of I.F.T.A (International Federation of Technical Analysis).

Now we know what you think: if your ideas are disclosed to a programmer then he will make money with them. But there are many points against this idea. The first is that if your programmer makes money with your ideas this will not prevent you from making money with them all the same. We have already discussed that you can publish your system in the Wall Street Journal and people will not trade it. So do not be scared about giving away some “secrets”, provided these are really such as you presume they are. Second, it is very rare that a programmer will have the time, the feeling or the capability to understand if a code is really important. Programming and testing are two different jobs. It often happens that testing is not done in a systematic way. All traders believe they have a feeling with some particular markets and timeframes and there are few traders that test a system over 70 markets and 10 timeframes. So even if the programmer has the intention to steal something it may be that he will not grasp what he is really stealing. To test a system over many markets and timeframes, to understand if something is missing, how to cure its shortcomings and how to improve its efficiency is something that is a big job on its own, far away from the programming skill.

The best systems we developed were fixed by professional programmers that we are sure did not understand what they were programming. Then a last consideration: if you come up with two ideas per day and your programmer puts them into a code at the end of the year there will be so many ideas and codes that he will bored and he will never check anything more from you. Testing and fine-tuning a code is a really time consuming job, and very expensive also because you need to have many data sources and many data providers in order to easily cover all the markets and all the timeframes.

A good systematic trader does not have a single code but dozens of viable trading systems’ codes that he selects and applies according to the current market conditions. So a really good systematic trader will never refuse to exchange cards with you. If you have 40  systems  and  you  exchange  some  systems  (it  is  better  not  to  exchange  the  best performing systems on sensible timeframes, e.g. 1-3 minutes), with some other systems you will end up with more systems and no harm to your systems farm. A mediocre systematic trader has just one or two systems and he thinks that their codes will bring him success, so he keeps them in a safe and he would prefer to die rather than give them away.

The more complex the system the more easily it will be over-optimised with too many variables or inputs. If you are not a sophisticated programmer this could be good luck because you will never run the risk of writing codes that are too lengthy.

Another point comes to mind when you are considering our professional activity in the last 15 years from a historical point of view: codes and ideas are almost the same, there is nothing really conceptually new in trading systems. You have tons of opening range breakout codes, pivot points, channel breakouts, etc. The same stories are oft-repeated but still work intermittently in today’s markets. You can find thousands of these formulas for free on the internet with little effort. You can even know that Jim Simons, the best quant trader around, who made a huge personal fortune with his Magellan Fund, is trading mostly with Markov chains and on an intraday basis. Would this be enough for you to emulate his success? No, it can help you in going in a precise direction but it will never allow you to have any practical tips on the feeling, the approach and the theory that lies in his trading systems. So the key point is not the code, the key point is how to adapt existing codes to the current market conditions, how to build a portfolio and how to know when the moment comes to stop a system and start another one.

But let’s add another point which is more human than strictly technical. Like in many other human endeavours, persistence and determination are those qualities that sooner or later lead to success. The programming capability, the mathematical background, the creativity are all factors that surely help in algorithmic trading, but the most important thing will be the feeling you have with the markets, the trades and the systems. And this feeling is the relentless result of persistence and determination. To gauge systems, to develop systems, to evaluate quantitative trades it takes years. It could not be possible in any other way: success is always difficult to reach and for a systematic trader success is money.

The thread that occurred to us during this book is very clear: do not think that a powerful trading platform can transform you into a successful trader, do not think that one piece of code instead of another will bring you to success. It will take a lot of hard work and a little bit of chance.

This is why we did not merely write down our receipt for success, we did not fill the book with codes, and we did not use complex concepts to explain the simple steps for successful systematic trading. We recommend that you are always in control of what you do: do not listen to the sirens that pretend you will make money with their complicated software, their academic seminars and their 1000-page books. Be flexible, cynical and scared: a systematic trader is always sitting on the bomb that will sooner or later explode and kill him. As Thomas Stridsman put it, probabilities are that we all will go bust sooner or later. If you start from this point, chances are that you will survive a long time.

Every methodology we highlighted in this book alone will not be the ultimate key for a profitable systematic trading but all put together they will paint a clearer picture in which you can move comfortably just owning a simple trading system’s code.

Let’s review all the methodologies and try to summarise the pros and cons of each of them.

#### Rule complexity

It is better to trade with a system with few inputs, few variables and an equity line that is not historically exhilarating instead of 100 inputs or variables and a super equity line.

#### Testing

Do not put your focus on a bunch of markets and forget the other ones. Nobody could tell you that a system does not perform on a market but could be the winning tool for trading  the  remaining  50  markets.  Subscribe  to  a  data  vendor  such  as  CSI  data (www.csidata.com)  or  Pinnacle  data  (www.pinnacledata.com)  and  then  apply  your systems on at least 70 different futures daily price series before arriving at the conclusion that the code does not work.

#### Optimisation

Optimisation is good if it is performed in a savvy way. You should re-optimise regularly, after a fixed time period in order to keep the system in synchronisation with the market.

#### Monte Carlo analysis

This is a good process in order to check the stability of the system in a probabilistic way but its importance should not be over-stressed. If the systems is over-optimised the Monte Carlo analysis will be perfect but this does not mean anything.

#### Portfolio building

If you are trading an easy code like a channel breakout, or a moving average on a bunch of portfolios to choose the right prices series to be traded, this is a vital point for success. We depicted many ways to approach this problem, but the final solution will depend more on the experience of the trader than on a precise rule. 

#### Dynamic risk management

Do not rely on a fixed rule in order to activate or stop a system from trading. You need to run a farm of a dozen trading systems and then activate those that are fit for the current trading environment. The moving average equity line crossover is this kind of tool that can transform a mediocre system into a powerful trading machine.

#### Money management

This is one of the most important factors in trading, always keep your risk exposure less than 1% from the entry point per every trade, better to be 0.5% is you are able to afford such a low risk level.

As you can see from the above mentioned points, the systematic trader has at his disposal a long list of tools that can overcome the would-be higher efficacy of the programming complexity without hurting the profit attractiveness of a trading system. And we stress that you should pay heed to this list in order to improve results.

## Appendices (Systems and ideas)

In these appendices we have included three trading systems. We explained the first two in articles in Traders magazine and the third one was extensively treated within this book. These three systems can be used as a starting point to build portfolios with trading systems.

### Appendix 1: Bollinger Band system

#### 1.1 Idea

----------

In this book we already used a Bollinger Band system to show the effect of out-of-sample deterioration (Chapter 5.2). The Bollinger Band which we use now to build a simple, but robust portfolio, was described in detail in an earlier article in Traders magazine [14]. Its trading logic is explained with Figure A1.1.

The first third of the graph (August to October 2004) shows a phase of lower market activity. The volatility drops and the Bollinger Bands become narrower. During this period of lower volatility the market often tends sideways without any direction. Many market participants are unsure about the further development and stay on the sidelines.

Such phases of decreasing interest of market participants form the base of succeeding considerable movements. The longer the indecisive phase is the stronger is the subsequent breakout (see Figure A1.1, mid-October until December 2004). After the breakout the Bollinger Bands widen and follow the trending price very quickly. From Figure A1.1 you can calculate the profit of the trade which uses this impulsive long breakout. It brings 6 cents (=7500 US dollars in the euro future) although some of the gains have been given away. Shortly after the long exit a short signal was triggered (February 2005) which turned out to be a false breakout and was soon exited by the moving average stop.

#### 1.2 Entry logic and Easy Language code

----------

>Long entry:
>If the price crosses above the higher Bollinger Band. Enter the market intraday with a buy stop:
>Enter long: next bar at HigherBand stop;
>
>
>Short entry:
>The short entry is symmetrical to the long entry, enter intraday if the price crosses below the lower Bollinger Band.
>Enter short: next bar at LowerBand stop;
>
>
>Exit:
>Exit if the price crosses the moving average between the Bollinger Bands:
>Exit: next bar at Average(Close,60) stop;

The exact position of the higher and the lower Bollinger Band is determined by taking the simple moving average and adding (higher band) or subtracting (lower band) the following, volatility dependent amount: Distance * Standard deviation. The volatility dependent component is located within the standard deviation, whereas the distance is a fixed parameter which can be varied.

The Easy Language Code is just some lines:

>Inputs: Length(60), Distance(2);
>Vars: HigherBand(0),LowerBand(0);
>
>
>HigherBand = Average(Close, Length) + Distance * StdDev(Close, Length);
>LowerBand = Average(Close, Length) - Distance * StdDev(Close, Length);
>
>
>Buy next bar at HigherBand stop;
>Sell next bar at LowerBand stop;
>
>
>ExitLong next bar at Average(Close, Length) stop;
>ExitShort next bar at Average(Close, Length) stop;

The system has two input parameters, which are bold typed. One represents the length of the moving average, the other determines the distance (or width) of how far away from this moving average the Bollinger Bands are placed. Their default values are set to a length of 60 and distance of 2. By changing these parameters you can adjust the trade frequency. The smaller you set the length for the moving average, and the smaller you choose the distance of the Bollinger Bands, the faster the system will react to market changes and the more signals you will get. As well as this possibility to adjust the system code to your personal needs Bollinger Bands have further advantages for building mechanical trading systems. Due to their volatility-based component they can easily adapt to different market conditions. Additionally they provide a natural exit point by using the moving average between the Bollinger Bands.

#### 1.3 Application of the strategy to seven markets with same parameters

----------

The strategy is now applied to daily data of seven markets from three different market groups:

Three stock index futures:
Nasdaq-MINI, EURO STOXX 50 and Swiss Market Index

Two bond index futures:
Bund, US-T-Note (10year)

Two currency futures:
Euro and Swiss Franc

Daily data was taken from mid-1994 until mid-2005. Data source for the end-of-day data was CSI Unfair Advantage (csidata.com).

For all the performed tests exactly the same parameters (default: length=60, distance=2) were taken in order to minimise the effect of curve fitting. All results are based on a one contract  per  market  basis  and  are  presented  without  subtraction  of  slippage  and commissions.

#### 1.4 Results and conclusions

----------

The combined equity line of the seven markets looks like a good starting point for a viable trading system (Figure A1.2). For more detailed information have a look at the system figures (Table A1.1). You can take this system and combine it with other uncorrelated systems/markets within a bigger portfolio.

As mentioned, the system was not optimised concerning the input parameters for the entries. More important to note, however, is that we have not inserted and optimised any special exits into the system. If you do this in the way it was shown in Chapter 3.5 of this book, results can be improved, especially concerning risks and drawdowns.

<p align="left"><font size=2>Figure A1.1: Euro in US dollar, daily, with Bollinger Bands and 60-day moving average of closing prices. The entry and exit points are marked with circles. The crossing of the price and the Bollinger Bands generate the long and short entries. The crossing of the price and the moving average triggers the exits. Chart created with TradeStation 2000i.</font></p>

![Figure A1.1](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_A1.1.png)

<p align="left"><font size=2>Figure A1.2: Combined equity line of the Bollinger Band system for the portfolio of seven markets, 08/1994-09/2005, for daily data. The figure shows the added net profit on a bar-bybar basis of all trades on these markets without slippage and commissions. Chart created with RINA Systems.</font></p>

![Figure A1.2](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_A1.2.png)

<p align="left"><font size=2>Table A1.1: Key figures of the system tests based on end-of-day data. The second table below shows the main figures of the Bollinger Band system for the portfolio of seven markets, 08/1994-09/2005, applied to daily data. The table shows the added results of all trades on these markets without slippage and commissions.</font></p>

![Table A1.1](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Table_A1.1.png)

### Appendix 2: The triangle system

‘The symmetric triangle is one of the most profitable patterns for short-term trading.’

#### 2.1 Idea

----------

Figure A2.1 shows a chart of the continuous, back-adjusted euro/dollar future contract (Globex)  at  the  end  of  January  2007. You  see  that  within  three  days  a  very  nice, symmetrical triangle developed. The triangle pattern is a very strong, profitable pattern since the logic behind it is sound.

It uses a similar idea to the Bollinger system presented in Appendix A1. The triangle system is more exact in its entry however. Again, as with the Bollinger system, a phase of uncertainty leads at first to a compression in the market. The volatility decreases while the triangle pattern gets narrower. And again like in the Bollinger system, this phase of decreasing interest of the market participants is the reason for the succeeding movement. The longer the indecisive phase lasts, the stronger the subsequent breakout is. At a certain point,  when  the  consolidation  has  continued  for  a  longer  time  while  many  market participants are unsure about the further development, any distortion, e.g. a news event, can create a strong breakout. Many traders which had been standing on the sidelines before are now in a hurry to jump onto the driving train, and like this they amplify the emerging trend. This is underlined by the increasing volume when the breakout happens.

#### 2.2 Programming and coding

----------

Please note that we do not disclose this code but just describe its logic.

But,  as  you  might  have  recognised,  before  that  final  breakout  occurred  smaller movements out of the boundaries of the triangular figure took place. While a good discretionary trader might ignore the false breakouts, such “spikes” are difficult to program on a computer. First of all it is difficult to identify such a triangular pattern. Then if your algorithm has found it, to draw the legs of the triangle you must tell the PC where the triangle starts and which points define the legs. Will you ignore the spikes in your calculations  or  will  you  include  them?  This  will  be  different  for  each  situation. Furthermore when will the triangle end and how will you calculate the profit target from the triangular shape? For the discretionary trader these points are very easy to see, but on a PC it is a long list of programming tasks.

To overcome these issues we took a different, more abstract approach. We add a simple moving average of the last 200 closing prices and a volatility indicator of the last 300 bars to the same euro, 5 minute chart (Figure A2.2). On this example you see how the symmetrical triangle can be programmed. The figure shows that shortly before the breakout occurred, at the position of the black vertical line (called “set-up point”), two conditions were true at the same time:
1.     The volatility indicator of the last 300 bars has dropped to its lowest point.
2.     The moving average of the last 200 closing prices is moving nearly horizontal.

With these two clear simple conditions we can program the set-up of the triangle pattern, or better call it the low volatility/flat moving average pattern. Because like this we do not program a pattern recognition logic which is identifying symmetrical triangles. Instead we are only looking for low volatility phases and for phases in which the market tends sideways at the same time, described by the horizontal movement of the moving average. This is a much weaker condition than the exact pattern recognition but helps us to simplify our programmed trading system logic to put it into reality. Our two set-up conditions could well occur in other patterns, e.g. if the market consolidates within a rectangular small trading range.

Now the entry logic can be completed as following. If our set-up with the two conditions is true we place a long entry stop order a fixed amount above the current market price and symmetrically a short entry stop order the same amount below the current market price. The long and short entry levels act as a natural stop loss and reversal point of our initiated positions. So if we have entered the market long and the market shortly after proves us wrong and changes to the down side, we exit our long position and enter the market in the opposite direction short. Thus our logic lets the market decide about its breakout direction and just follows it. We exit the position at a profit target which we determine from the difference of the high and the low within the last 300 bars (see yellow vertical lines in Figure A2.2). If the profit target is not reached shortly after the breakout we exit the position with a trailing stop instead.

#### 2.3 Application to different liquid futures markets with same parameters

----------

We apply our gained system code to 5 minute data of four different markets from different liquid futures markets groups: the euro/dollar future as a currency market, the S&P 400 MidCap future as a stock index, the US-T-Bond-Future as a bond market and Light Crude Oil as a liquid commodity future. As data supplier we took the intraday data feed of TradeStation 8. We tested our system within the period of the last five years on backadjusted futures data from January 2002-January 2007 on all four markets with same system parameters. Our  computer simulation is calculated with $30 slippage and commissions per round turn ($30 S&C per RT).

The equity curves all grow very steadily with only minor drawdowns (Figures A2.3a-d). The best equity line seems to be Light Crude Oil. Also very steady over the tested five years were S&P 400 MidCap and US T-Bond Future. On the other side the euro future had a sideway phase for the last two years with its biggest drawdown happening just recently, in January 2007 (-$4,575). Overall the equity line, which you get by adding all trades, is however still clearly positive. If you watch the equity curves of the single markets more closely you see that they look a bit like stairs. The reasons for this behaviour are long lasting, flat periods between the signals. The system is only about 1-2% of the total time in the market, the rest of the time it is flat.

It is an important characteristic of our system that signals occur very seldom, but when trades are taken they tend to result in big profits.

#### 2.4 Advantages in building a portfolio

----------

A very positive side effect of the system’s low market exposure is a very low correlation of the system’s results when applied to the four different markets simultaneously (Table A2.1). You can see that the correlations of all four systems’ results are nearly 0, they vary between a very small negative correlation of -0.002 and a small positive coefficient of 0.024. This practically uncorrelated behaviour of the four markets helps to build a high return/low risk portfolio when combining them. You can also see that while the maximum equity drawdowns of the four single markets vary between -$2,440 (S&P400 MidCap) and -$4,590 (US Treasury Bond Future) the maximum equity drawdown of the fourmarket portfolio is in the same area with -$3,275. So while the profit of the portfolio grows in a linear way with the added markets to over $58,000, the maximum drawdown is kept in the area of one single market. This results in a very steady portfolio equity curve (Figure A2.4). It is worth mentioning that even within the four-market portfolio the system is only in the market for 10% of the time. So the market exposure is very low, which would allow you to add further systems or markets to the portfolio.

The trade statistics reveal that the gains of the system don’t come from a high winning percentage (53%), but from the fact that the average winning trade is a huge amount bigger (factor 1.4) than the average losing trade. Furthermore, the average time in trades is very small, at 0.3 days. This shows that the system captures mainly dynamic breakouts which happen very fast and only last for a short time.

The system figures reveal a further quality of the triangle system: the equal weight of long and short trades. From the total 625 trades long and shorts nearly have the same number (322 vs. 303) and the profits are nearly divided equally between the long and short side. This applies for the single markets and as well for the combined portfolio. This feature is the result of the construction of the trading logic, which lets the market itself decide in which direction it goes and just follows it, with the same probability in the long and in the short direction.

#### 2.5 Conclusion

----------

The example of the triangular pattern clearly shows the different tasks of discretionary and systematic traders. While discretionary traders can rely on their experiences and their ability to estimate the market correctly, systematic traders need to act in a different way. As many patterns which are easy visible with the human eye cannot be programmed directly, we took a different approach and simulated the pattern with common indicators:

a moving average, the volatility and the price itself. With this approach we could not exactly simulate the triangular pattern but we created a trading system which comes close to the conditions which are true within such a triangle pattern: decreasing volatility and sideways  market  direction.  Like this our trading logic was gained by pure market observation and not by optimisation or curve fitting. We are rewarded with a very robust system which stays profitable over different markets with the same input parameters. At the first glance it seems to be a disadvantage that signals occur very rarely and that the time in the market is very low, but it is this fact which makes different markets completely uncorrelated for our trading logic and allows us to build a profitable low risk portfolio.

<p align="left"><font size=2>Figure A2.1: Principle of the symmetrical triangle pattern, discretionary view. Euro, Globex, 5 Minute, 21-24 January 2007. A natural profit target can be derived from the width of the triangle. False breakouts usually occur which make triangles difficult to program for systematic trading. The final breakout takes place with volume increase and leads the price into the target region.</font></p>

![Figure A2.1](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_A2.1.png)

<p align="left"><font size=2>Figure A2.2: Principle of programmed triangle system. At the point before the breakout occurs (set-up point) the volatility is extremely low and the moving average tends sideways. If these two conditions are true, a long stop and a short stop entry order is placed. These entry levels also work as natural initial stop and reverse points. A profit target is derived from recent highs and lows (yellow lines).</font></p>

![Figure A2.2](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_A2.2.png)

<p align="left"><font size=2>Figures A2.3a-d: Result of triangle system on four different markets: 6/2/2002-6/2/2007, $30 S&C per RT, on a day-to-day basis.</font></p>

<p align="left"><font size=2>A2.3a: Euro/dollar Future (TradeStation symbol @EC)</font></p>

![Figure A2.3a](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_A2.3a.png)

<p align="left"><font size=2>A2.3b: S&P 400 MidCap Future (TradeStation symbol @EMD.D)</font></p>

![Figure A2.3b](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_A2.3b.png)

<p align="left"><font size=2>A2.3c: US T-Bond Future (TradeStation symbol @US.P)</font></p>

![Figure A2.3c](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_A2.3c.png)

<p align="left"><font size=2>A2.3d: Light Crude Oil Future (TradeStation symbol @CL.C)</font></p>

![Figure A2.3d](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_A2.3d.png)

<p align="left"><font size=2>Figure A2.4: Equity curve of 4-market portfolio. Triangle system applied with same system parameters to the following markets: euro/dollar Future, S&P400 MidCap Future, US T-Bond Future and Light Crude Oil Future. Equally weighted on a one-contract basis, including $30 S&C per RT, Jan 2002-Jan 2007, calculated on a day-to-day basis. Chart created with RINA Systems.</font></p>

![Figure A2.4](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_A2.4.png)

<p align="left"><font size=2>Table A2.1: Portfolio figures, Jan 2002-Jan 2007. Portfolio figures of Triangle system applied to the following markets: Euro/dollar Future, S&P400 MidCap future, US T-Bond-Future and Light Crude Oil Future. Same system parameters for all markets, $30 S&C per RT, calculated on a day-to-day basis.</font></p>

![Table A2.1](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Table_A2.1.png)

### Appendix 3: Portfolios with the LUXOR trading system

In Chapter 3 we presented the trend-following system called LUXOR and tested it extensively on the British pound/US dollar pair.

Now we are going to check this trading logic on other markets. We will outline how this strategy works on various bond markets and how to use it to construct robust portfolios.

#### 3.1 Idea

----------

Before trying to code an idea with the purpose of building a systematic trading methodology it is important to understand the inner nature of the different markets you are going to trade. The market most appreciated by traders is the equity indexes universe. Stocks, that are the components of the equity indexes, move more following psychology than real events. Just think how an event could impact a stock: it is always an indirect influence, very seldom a direct one. Oil prices are going up? An oil stock can benefit from this situation but it will benefit more or less depending on its corporate efficiency, from  the  relative  competitive  position  in  the  industry,  from  the  intelligence  of  its management, and so on. Surely it will benefit but how much it will benefit is always a matter of discussion. But if we are talking about oil, the true commodity, the real black gold, this is another story.

Commodity prices are influenced by real demand and real offer. Psychology is still important but not dominant. If China is growing 10% per year in the following 10 years, the demand of all kinds of commodities will perhaps double or triple, nobody knows for sure. This is a direct effect: Chinese importers are bidding for oil on the international cash markets and prices are going up. Nothing is more easy to understand. This is why psychology will be more important on stocks than on commodities.

But there will be another aspect to consider also. If we are talking about “indirect effects”, it means that there will be few events that everybody will agree will modify the picture of the equity indexes. On the equity indexes everything is smoothed by discussion, interpretation, indirect effects, and so on. When, on the contrary, news directly affects demands and offers, and the news is dramatic, there is no room for discussion and interpretation. Prices jump or they crash. Tertium non datur. So you will have limit up and limit down days, you will have huge price swings in one direction or another. But in this black and white world, in between psychology and real demand and offer, you have a third environment: bonds.

Monetary policy has a steady nature, no climax, no sudden changes. Economic swings are slow and seldom do they surprise markets. In a period of economic recession interest rates will go down for months after months, in a period of economic expansion interest rates will go up smoothly. Take for example the 17 interest rate increases in the US: at a certain point the market discounted them and it was obvious that they would then have to go up once again. A misunderstanding could only really have occurred if you were at the very beginning of the 17 interest rate increases or at the end of them. Please note, though, that we are talking about two situations out of 17.

In a more serious way we can say that elements of a macroeconomic series are quite autocorrelated, so that if they start rising they will go on for a while, if they will go down they will go continue down for a while. Monetary policy is not a kind of situation where one day you have an increase of 2% and tomorrow a decrease of 3% and then tomorrow again an increase of 1% and so on. This is why prices in bonds tend to follow the same direction without much noise and this is why moving averages on bonds are a good predictive tool, because they are simply able to catch this smoothing behaviour of prices.You should have no fear in trading bonds with moving averages. From all our performed quantitative tests and experience we can conclude: they work!

#### 3.2 The trading logic

----------

You can find all the details on the logic of the LUXOR system in Chapter 3 of this book, so we won’t discuss it further here, but will focus on the results of the strategy.

Please note that we do not apply any additional exits to the strategy at this point. Trades are only exited when the price crosses the slower moving average of the entry logic (in case of long positions). The system is built symmetrically concerning long and short trades.

Of course you can and should add exits which meet your personal needs to the strategy. You will find the appropriate methods on how to adjust them in Chapter 3.5 of this book.

#### 3.3 Results in the bond markets

----------

Let’s see how the LUXOR system works on the major bond markets. We want to check if bond markets really fit well with trend-following systems as we expected from our fundamental argumentation above.

All the following tests are based on a one-contract basis and are performed with the following input parameters of the system (fast moving average length=7, slow moving average  length=26).  No  adaptation  of  the  parameters  to  the  different  markets  was performed in order to keep the results comparable and to avoid the effect of curve fitting.

The strategy is applied to the daily data which was provided by CSI Unfair Advantage (csidata.com). The futures data was point-based back-adjusted to get rid of artificial gaps between different contract months. All results in the figures and tables are based on a one contract per market basis.

If you apply the LUXOR system to the bond markets, you see that in all of them you get more or less steady equity curves (Figure A3.1). Some work better, like the US T-Bond, the US T-Note (10 years) and the German Bund, and some look a little bit worse, like the not so well known Australian 10-year Treasury Bond or the Korean 3-year Government Bond. But with all of them you get positive results.

In order to add the results of all tested bond markets to a combined portfolio, you have different possibilities. You could first convert the point values and currency of each market and build a portfolio in US dollars. For this you must convert the Korean bond, Japanese bond etc, by using the dollar conversion rates $/won, $/yen etc and then add all equity-lines. To simplify these calculations we used another method here. We tested all the single bond markets in points. We made a simplification to add these point equity curves of all 12 markets to get a portfolio. This is not 100% mathematically correct but the result comes very close to what it would be if you were to use the exact currency conversion rates (for example 1 point in the Bund future is 1000 euro, 1 point in the US T-Bond and US T-Note is $1000 and so on).

The equity line becomes very nice and steady, you only get minor draw downs (Figure A3.2). The most significant one happened in 1994 during the bond market crash, when all markets turned their trend from upside to downside more or less at the same time. But on the combined, long-term equity line it looks more like a small accident than a big issue.

If you have the capability you could trade this portfolio in the three different time zones with all included markets. There is, however, one reason why we won’t advise you to do this, even if the equity line looks good enough: correlation! All the bond markets are so highly correlated that the possibility exists that the system might crash for all the markets at the same time, as happened partially in the year 1994 – just imagine if you were long in all 12 bond-markets and then they all go down at the same time. The high correlation increases the risk of your bond portfolio drastically.

In order to build a high return/low risk portfolio, the concept should be as follows: take a mixture of different systems and apply them to different markets in different timeframes. For example you could choose some liquid markets from the bond group and apply a medium-term trend-following system, like the one described here. Then you would add, for example, swing-trading systems for the currencies and day-trading systems for the Mini S&P and so on. Various possibilities exist which you must fit to your personality and your trading style. The whole topic is too big to treat it seriously here.

#### 3.4 Diversification with other market groups

----------

Here, to stay with our trend-following logic and to get a better feeling for it, we build a small portfolio of different market groups.

We use two bond markets, the German Bund and the US T-Note (10 year) but add other markets from different market groups: the euro/dollar as a currency, the Mini S&P as a stock index plus Gold and Light Crude oil as famous commodities. So we have a portfolio in which the successful bond markets still build the core but which is diversified with less correlated markets. It is important to mention here that the Mini S&P produces a negative equity line, the Gold goes just sideways and the euro/dollar weakened in the last 3 years as well (the equity lines are not shown here).

Even with these markets included the overall portfolio shows a steady upward equity line, since the two bond markets and the crude oil kept the portfolio running well. The equity line does not look as steady as for the complete bond portfolio, but that’s what we expected.

The idea here is to have a portfolio of less correlated markets in which there are always one or two that have big gains that compensate the losses of other markets.

Let’s have a look at the portfolio’s main figures (Table A3.1). The system figures which we get are typical for a trend-following system. Only 37% of all the 3168 performed have been profitable. The overall big gains of the system result from the high ratio of average win/average losing trade which is nearly 2.5. A very important fact to mention is the following: the system’s gains resulted from the 63 positive outlier trades. These outliers produced more profit ($606.487) than the final total net profit ($526.259)! This means that the extreme big winning trades made the profit of the system. This underlines again how important it is in trend-following systems to let the profits run. If you missed the positive outliers you would have no gain at all. The annoying point for you as a trader is, however, that such big gains occur very seldom, but when they do occur, you must catch them.

An interesting fact of the system is also that the average time in winning trades is more than four times longer than the average time which the system stays in losing trades (25 days versus 6 days). This shows again how the trend-following logic cuts the losses short and lets the profits run.

#### 3.5 Conclusion

----------

With the examples presented above we wanted to show you how important it is for successful trading to select the right systems for the right markets. With the bonds we have identified a group which could have been exploited perfectly with trend-following methods lasting recent decades. From the fundamental point of view the chances are good that they will continue to behave like this. We are aware that a trend-following system is not suited for every trader. It’s annoying to have only a small amount of profitable trades and to wait most of the time until the big moves take place but trend-following strategies work too well in bond markets to not use them. They are a key part in the most successful existing hedge funds. In our opinion they should be at least one component of your trading systems if you want to be successful in the long run.

<p align="left"><font size=2>Figure A3.1: Equity Lines of 12 major bond markets, in points. Conversion from point values to base currency: German Bund: 1 point = 1000 euro; US T-Bond, US T-Note (10 year) and US T-Note (5 year): 1 point = $1000; US T-Note (2 year): 1 point = $2000; Eurodollar (3 month) 1 point = $2500; Long Gilts: 1 point = £1000; Canadian Government Bond (10 year): 1 point = C$1000; Canadian Bankers Acceptance (3 month): 1 point = C$2500; Japanese Government Bond (10 year): 1 point = 10000 yen; Australian Bond (10 year): 1 point = AU$1000; Korean Government Bond (3 year): 1 point = 1 million. Korean won. End of test period in all markets: April 2006. Charts created with TradeStation 2000i.</font></p>

![Figure A3.1](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_A3.1.png)

<p align="left"><font size=2>Figure A3.2: Portfolio of 12 combined bond-markets. The system equities in points of the following markets were summarised: German Bund, Long Gilt, US T-Bond (30 year, electronic), US T-Note (10 year, electronic), US-T-Note (5 year, electronic), US-T-Note (2 year, electronic), Eurodollar (3 month, electronic), Canadian Government Bond (10 year), Canadian Bankers Acceptance (3 month), Australian 10 year Bond, Japanese Government Bond (10 year), Korean Government Bond (3 year). August 1977-April 2006. Chart created with RINA Systems.</font></p>

![Figure A3.2](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_A3.2.png)

<p align="left"><font size=2>Figure A3.3: Portfolio of 2 bond markets and 4 markets of different groups: German Bund, US T-Note (10 year), Mini S&P, Gold, Light Crude Oil, euro/dollar. $30 slippage and commissions per trade subtracted. May 1972-April 2006. Chart created with RINA Systems.</font></p>

![Figure A3.3](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Figure_A3.3.png)

<p align="left"><font size=2>Table A3.1: System figures for the 6-market portfolio consisting of German Bund, US T-Note (10 year), Mini S&P, Gold, Light Crude Oil, euro/dollar. May 1972-April 2006. All numbers are calculated with $30 slippage and commissions per trade.</font></p>

![Table A3.1](https://raw.githubusercontent.com/21moons/memo/master/res/img/Trading_Systems/Table_A3.1.png)